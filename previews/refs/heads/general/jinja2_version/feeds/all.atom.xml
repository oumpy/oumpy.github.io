<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>大阪大学医学部 Python会 (情報医科学研究会) (テスト用ページ)</title><link href="/previews/refs/heads/general/jinja2_version/" rel="alternate"></link><link href="/previews/refs/heads/general/jinja2_version/feeds/all.atom.xml" rel="self"></link><id>/previews/refs/heads/general/jinja2_version/</id><updated>2022-07-03T00:00:00+09:00</updated><subtitle>Now is better than never.</subtitle><entry><title>WSI＊自己教師あり学習のメモ</title><link href="/previews/refs/heads/general/jinja2_version/blog/2022/07/wsi_ssl.html" rel="alternate"></link><published>2022-07-03T00:00:00+09:00</published><updated>2022-07-03T00:00:00+09:00</updated><author><name>安部</name></author><id>tag:None,2022-07-03:/previews/refs/heads/general/jinja2_version/blog/2022/07/wsi_ssl.html</id><summary type="html">&lt;p&gt;最近病理の画像をバイトで扱うことが増えています。せっかくなので自己教師あり学習を使ってみたいと思い、病理 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;最近病理の画像をバイトで扱うことが増えています。せっかくなので自己教師あり学習を使ってみたいと思い、病理画像に自己教師あり学習を用いた論文をいくつか調べました。&lt;/p&gt;
&lt;h2&gt;WSIとは&lt;/h2&gt;
&lt;p&gt;Whole slide images（WSI）とは、バーチャルスライドとも呼ばれる病理組織プレパラート標本全体をスキャンしたものです。画像サイズが巨大なので128*128などのパッチに分割して扱うことが多いです。パッチの作成時に組織以外の余白を除くことが多いです。&lt;/p&gt;
&lt;h2&gt;自己教師あり学習とは&lt;/h2&gt;
&lt;p&gt;ラベルなしデータに対して、データ自身から独自のラベルを機械的に作成したものから画像の表現を獲得するタスクです。&lt;br&gt;
大まかに以下の3種類に分けることができると著者は考えています。&lt;br&gt;
1. 画像の一部をmaskして隠された部分を再構成できるように学習する
2. 画像A(正例)とそれにaugmentationを加えた画像A'、別画像B(負例)を用意して、それぞれを埋め込んだときに似ているAとA'が近く、異なるBは遠くになるように学習する
3. 画像Aに異なる摂動を加えたA'とA''を用意して別々に埋め込みを得た時にA'とA''が似ていることを学習する
例として、&lt;br&gt;
1. &lt;a href="https://arxiv.org/abs/2111.06377"&gt;MAE&lt;/a&gt;　&lt;br&gt;
2. &lt;a href="https://arxiv.org/abs/2002.05709"&gt;SIMCLR&lt;/a&gt;　&lt;br&gt;
3. &lt;a href="https://arxiv.org/abs/2104.14294"&gt;DINO&lt;/a&gt;　&lt;br&gt;&lt;/p&gt;
&lt;p&gt;などがあります。&lt;br&gt;
②の手法では正例と負例の類似度が高すぎるとうまくいかないこと、①は分類よりもセグメンテーションに強い特徴が得られること、③は分類には強いがセグメンテーションに適した特徴が得られない可能性があること、が&lt;a href="https://arxiv.org/pdf/2204.07141.pdf"&gt;最近の論文&lt;/a&gt;にて指摘されています。&lt;/p&gt;
&lt;h2&gt;Self supervised contrastive learning for digital histopathology&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://www.sciencedirect.com/science/article/pii/S2666827021000992"&gt;原著&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;概要&lt;/h3&gt;
&lt;p&gt;WSIにSIMCLRを適応。TCGAやCPTAC、コンペデータから得た多臓器の57のデータセットで事前学習させた。
評価は分類、回帰、セグメンテーションなど複数の下流タスクを行なった。&lt;/p&gt;
&lt;h3&gt;結果&lt;/h3&gt;
&lt;p&gt;少アノテーションにてimagenetで事前学習させたモデルに勝る結果が得られた。
&lt;img src="{attach}./images/wsi_ssl_figs/path_simclr_fig1.jpg" alt="path_simclr_fig1" width="400px"&gt;
教師なしでクラスタリングしてみると、似ている画像が近傍にあることが確認された。&lt;br&gt;
高解像度で事前学習させた方が性能が上がり、異なる解像度を組み合わせることでも性能が上がった。&lt;br&gt;
前立腺画像で学習させたモデルが、乳房画像で学習させたモデルよりも乳房画像での分類タスクの性能が良いことがあった。複数のデータセットを組み合わせるのが重要だった。&lt;br&gt;&lt;/p&gt;
&lt;h2&gt;Contrastive learning-based computational histopathology predict differential expression of cancer driver genes&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://arxiv.org/abs/2204.11994"&gt;原著&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;概要&lt;/h3&gt;
&lt;p&gt;WSIの扱いとして定番な「patch分割→patchの情報を集約」の手法にてpatchの埋め込み作成に対照学習(AdCo:https://arxiv.org/abs/2011.08435)を使用。集約にはattention poolingを使った。
下流タスクとして腫瘍診断と癌ドライバー遺伝子の差次的発現予測を行なった。&lt;/p&gt;
&lt;h3&gt;結果&lt;/h3&gt;
&lt;p&gt;対照学習を使用しない従来手法より性能が向上した。&lt;/p&gt;
&lt;p&gt;&lt;img src="{attach}./images/wsi_ssl_figs/histcode_fig1.png" alt="histcode_fig1" width="600px"&gt;
attentionを可視化すると病理医と類似した領域に注目していることが確認された。&lt;/p&gt;
&lt;p&gt;&lt;img src="{attach}./images/wsi_ssl_figs/histcode_fig2.png" alt="histcode_fig2" width="400px"&gt;
T/Bリンパ球に得意的なマーカーについてのアノテーションを追加で作成してみると、腫瘍細胞の場所とリンパ球が集まっていた場所が一致し、免疫細胞が固形腫瘍に浸潤する事実に一致する結果が得られた。
attentionをみることによりどこの組織に何の遺伝子が発現している細胞があるのかを可視化することができる。&lt;/p&gt;
&lt;h2&gt;Scaling Vision Transformers to Gigapixel Images via　Hierarchical Self-Supervised Learning&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://arxiv.org/pdf/2206.02647.pdf"&gt;原著&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;概要&lt;/h3&gt;
&lt;p&gt;「patch分割→patchの情報を集約」において、従来手法ではpatchの埋め込み作成だけに自己教師あり学習を使用していたが、埋め込みの集約の部分にも自己教師あり学習を使用した。自己教師あり学習の手法としてDINOを使用。&lt;/p&gt;
&lt;p&gt;&lt;img src="{attach}./images/wsi_ssl_figs/ireko_wsi_fig1.png" alt="ireko_wsi_fig1" width="600px"&gt;&lt;/p&gt;
&lt;p&gt;ViTのpatch埋め込みにresnet50を使用したハイブリットversionよろしく、上層のViTのpatch埋め込みに下層のViTを使用する。下層からDINOを学習していく。&lt;/p&gt;
&lt;h3&gt;結果&lt;/h3&gt;
&lt;p&gt;少アノテーションにて従来手法よりも高い性能を得た。&lt;/p&gt;
&lt;p&gt;&lt;img src="{attach}./images/wsi_ssl_figs/ireko_wsi_fig2.png" alt="ireko_wsi_fig2" width="600px"&gt;
&lt;img src="{attach}./images/wsi_ssl_figs/ireko_wsi_fig3.png" alt="ireko_wsi_fig3" width="600px"&gt;
最小patch単位のattentionではheadごと正常細胞、異型細胞、リンパ球、余白(内腔スペース、脂肪領域、エアポケット)といったミクロな特徴を捉えることができていた。また、集約層のattentionを見ると腫瘍の成長パターン、脂肪や間質領域への腫瘍浸潤、その他の組織-組織間の関係性を捉えることに成功していた。&lt;br&gt;&lt;/p&gt;
&lt;p&gt;制約として、最後の集約層はスライド単位の学習をしているので十分なデータを集めるのは困難である点や、事前学習を入れ子で行うにはマシンパワーが必要な点が挙げられる。&lt;/p&gt;
&lt;h2&gt;まとめ&lt;/h2&gt;
&lt;p&gt;patchレベルで自己教師あり学習を用いると、imagenetの事前学習済みモデルを使用したときよりも性能が向上したり、少アノテーションでも性能が担保されたりすることが確認されているようです。
上記論文中ではどの自己教師あり学習を使用すればよいかという比較はされていなかったので、下流タスクに応じて幾つか試す必要がありそうです。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category><category term="論文まとめ"></category></entry><entry><title>英語のカルテデータのコンペに参加してみた(際の失敗と反省)</title><link href="/previews/refs/heads/general/jinja2_version/blog/2022/06/medicalrecord_competition.html" rel="alternate"></link><published>2022-06-10T00:00:00+09:00</published><updated>2022-06-11T00:00:00+09:00</updated><author><name>杉原</name></author><id>tag:None,2022-06-10:/previews/refs/heads/general/jinja2_version/blog/2022/06/medicalrecord_competition.html</id><summary type="html">&lt;h2&gt;この記事の趣旨&lt;/h2&gt;
&lt;p&gt;医学生かつ技術がある程度わかる人としてkaggleに関わる機会を得た。
その経験を通して学んだことなど今から書く。臨床を …&lt;/p&gt;</summary><content type="html">&lt;h2&gt;この記事の趣旨&lt;/h2&gt;
&lt;p&gt;医学生かつ技術がある程度わかる人としてkaggleに関わる機会を得た。
その経験を通して学んだことなど今から書く。臨床を学んだ医師がコーディング以外の強みを活かしてテクノロジーに関わっていくとはどういった形のものなのか、イメージがつくようになってもらえたら嬉しい。なお、今回は自然言語処理周りの専門家の方と行ったのでモデル周りのことは全く把握していない。悪しからず。&lt;/p&gt;
&lt;h2&gt;コンペのタスクの概要&lt;/h2&gt;
&lt;p&gt;アメリカの医師試験で行われる、模擬診察の時の学生が書いたメモを扱ったコンペになる。
この医学生が書いたメモの自動採点をするために、その症例でこぼしてはならない重要な情報や症状を固有表現抽出 (NER) タスクをして抽出することを行う。
&lt;a href="https://www.kaggle.com/code/yufuin/nbme-japanese/notebook"&gt;詳しくはこちら&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;やったことと考えたこと&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;教師データと現状のモデルでの出力結果を眺める
    &lt;img alt="fig1" src="{attach}./images/medicalrecord_competition_figs/sugiharacompe_fig1.png"&gt;
    上記のデータは上が教師データ、下が&lt;a href="https://github.com/noroka/uth_bert"&gt;uth-bert&lt;/a&gt;を元に学習させて出力したデータになる。
    そもそも教師データ自体に何の法則性もなく、年齢が含まれていたり性別が含まれていなかったりした。
    あまりにもランダムだと感じられたので、次の手に移行。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;出てくる単語を診療科の単語毎に区分け
    まず教師データ、テストデータ、評価データの性質を均等化しようと考えた。
    ここで取り入れた評価軸は２つ。
    患者が男性or女性
    患者の想定される疾患「1.循環器,2.消化器,3.婦人科,4.精神科,5.循環器と消化器,6.その他」
    &lt;img alt="fig2" src="{attach}./images/medicalrecord_competition_figs/sugiharacompe_fig2.png"&gt;
    上記のように頻出単語にマークし、それを主訴により5種類の疾患分野に分類した。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;教師データとテストデータを均等化した学習結果
    〜1.循環器,2.消化器,3.婦人科,4.精神科,5.循環器と消化器,6.その他が教師データとテストデータに占める割合を調整してみた〜&lt;/p&gt;
&lt;p&gt;分け方1:何も分けない(下記)
&lt;img alt="分け方1" src="{attach}./images/medicalrecord_competition_figs/sugiharacompe_fig3.png"&gt;
分け方2:男性or女性で分ける,疾患で分けない(下記)
&lt;img alt="分け方2" src="{attach}./images/medicalrecord_competition_figs/sugiharacompe_fig4.png"&gt;
分け方3:男性or女性で分けない,疾患で分ける(下記)
&lt;img alt="分け方3" src="{attach}./images/medicalrecord_competition_figs/sugiharacompe_fig5.png"&gt;
分け方4:男性or女性で分ける,疾患で分ける(下記)
&lt;img alt="分け方4" src="{attach}./images/medicalrecord_competition_figs/sugiharacompe_fig6.png"&gt;
→分け方4はf1値が最高！分けてよかったね。(めっちゃ微差だけど)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;顛末
    モデルが完全一致の数で精度を測るものになってしまっており、部分一致を評価できないモデルだったらしく全員意気消沈。今回は諦めることに。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;最後に：感想戦
    記録上位のチームの記事を見てもらってもわかる通り、試行回数を積むことが大事だということがわかるだろう。
    &lt;a href="https://www.kaggle.com/competitions/nbme-score-clinical-patient-notes/discussion/323095"&gt;一位のチームの記事&lt;/a&gt;
    &lt;a href="https://www.kaggle.com/competitions/nbme-score-clinical-patient-notes/discussion/323085"&gt;二位のチームの記事&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;実は取り組み始めたのは締切の3週間前、1.の出力の法則性があまりないことに気づいたのは2週間前だった。とにかく試行して提出して改善を繰り返せたチームが勝つことを思い知らされた。みなさん、早めに取り組み始めてくださいね。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Data Science Competition"></category></entry><entry><title>CLIPを実装し理解する</title><link href="/previews/refs/heads/general/jinja2_version/blog/2022/05/clip_tutorial.html" rel="alternate"></link><published>2022-05-24T00:00:00+09:00</published><updated>2022-05-24T00:00:00+09:00</updated><author><name>池側</name></author><id>tag:None,2022-05-24:/previews/refs/heads/general/jinja2_version/blog/2022/05/clip_tutorial.html</id><summary type="html">&lt;h2&gt;目的&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;CLIPを理解するため、&lt;a href="https://github.com/openai"&gt;公式実装&lt;/a&gt;や他の記事を参考にしながらCLIPを自分で実装してみました。&lt;/li&gt;
&lt;li&gt;公式実装では他に様々な工夫がなされていますが、今回は最低限のコードでCLIPを分かり易く実装することを目的にしているため、性能については …&lt;/li&gt;&lt;/ul&gt;</summary><content type="html">&lt;h2&gt;目的&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;CLIPを理解するため、&lt;a href="https://github.com/openai"&gt;公式実装&lt;/a&gt;や他の記事を参考にしながらCLIPを自分で実装してみました。&lt;/li&gt;
&lt;li&gt;公式実装では他に様々な工夫がなされていますが、今回は最低限のコードでCLIPを分かり易く実装することを目的にしているため、性能については保証できません。&lt;/li&gt;
&lt;li&gt;本記事はCLIPの実装と解説を主な目的としているため、論文の詳しい解説に関しては他の記事を参照してください。&lt;/li&gt;
&lt;li&gt;自身で実装したモデルについて、学習は行っておりません。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;CLIPとは&lt;/h2&gt;
&lt;p&gt;CLIP(Contrastive Language-Image Pre-Training)は、&lt;a href="https://arxiv.org/abs/2103.00020"&gt;Learning Transferable Visual Models From Natural Language Supervision&lt;/a&gt;においてOpenAIが発表した画像分類モデルの事前学習手法です。
CLIPでは、従来のようなラベル付き画像データセットを用いた教師あり学習ではなく、大量の画像とテキストのペアデータセットを用いて画像分類器を学習させています。この学習方法では、従来とは異なりデータセットに含まれるラベルの種類が限定されないため、幅広い種類の画像に対しての分類能力を得ることができます。その結果、初めて見るデータセットに関しても高い分類性能を示し、zero-shot性能が非常に高いモデルを作成することができます。&lt;/p&gt;
&lt;h2&gt;実装解説&lt;/h2&gt;
&lt;h3&gt;1. CLIPの全体的なアーキテクチャについて&lt;/h3&gt;
&lt;p&gt;CLIPのアーキテクチャは以下の通りです。
CLIPは大きく画像をEmbeddingするImage Encoderと、文章をEmbeddingするText Encoderから構成されています。&lt;br&gt;
Embeddingとは、自然言語を計算が可能な形、すなわちベクトル表現に変換することを言います。CLIPのImage EncoderやText Encoderでは、1つの画像や文章をそれぞれ512次元のベクトルに変換しています。
Embeddingの詳しい説明に関しては&lt;a href="https://qiita.com/sakabe/items/5f14999ded1de087c9b5"&gt;こちら&lt;/a&gt;を参考にしてください。&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="https://raw.githubusercontent.com/openai/CLIP/main/CLIP.png"&gt;&lt;/p&gt;
&lt;h3&gt;2. Text Encoder&lt;/h3&gt;
&lt;p&gt;CLIPのTextEncoderとしては、TransformerのEncoderが用いられています。&lt;br&gt;
Transformerは自然言語処理では必須のモデルで、全体として以下のようなアーキテクチャを持つモデルです。
TransformerのEncoderでは、次のように入力テキストの処理が行われます。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;トークン化された入力文章をEmbeddingする。&lt;/li&gt;
&lt;li&gt;Positional Encodingを1でのEmbeddingに足し合わせることで文章中での位置情報を付与する。&lt;/li&gt;
&lt;li&gt;MultiHeadAttention層とFeedForward層、これら層の後にそれぞれ続くResidual層+LayerNorm層の計4層からなるEncoderBlockに2での出力が渡され、順に処理が行われる。  &lt;/li&gt;
&lt;li&gt;EncoderBlockでの処理がN回繰り返される。  &lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;各層の詳しい処理の説明はここでは割愛します。参考文献にある記事に詳しく説明がなされているのでそちらを参考にしてください。&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="https://user-images.githubusercontent.com/57289763/160270884-e1901241-a1e6-4890-a5e8-165e87f0c4da.png"&gt;&lt;/p&gt;
&lt;p&gt;TransformerのEncoderBlockの実装は次のようになります。&lt;br&gt;
ただし、CLIP内のTransformerのEncoderBlockでは、元のTransformerのものと異なり、LayerNormalizationをMultiHeadAttentionやFeedForwardNetwork層の後(=Post-Norm)ではなく前(=Pre-Norm)で行っています。  (参考：&lt;a href="https://twitter.com/hillbig/status/1182438709095854080?s=19"&gt;Pre-Normを採用する理由&lt;/a&gt;)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;TransformerEncoderBlock&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Module&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;heads&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;attn_mask&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Tensor&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;
        &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;multi_head_attention&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;MultiheadAttention&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;heads&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;layer_norm_1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;LayerNorm&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ffn&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Sequential&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Linear&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;width&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
            &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GELU&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt;
            &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Linear&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;width&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;layer_norm_2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;LayerNorm&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;attn_mask&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;attn_mask&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;forward&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Tensor&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="c1"&gt;# Layer正規化した後にMultiHeadAttentionに入力し、その出力と元の値を足し合わせる&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;multi_head_attention&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;layer_norm_1&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;layer_norm_1&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;layer_norm_1&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;attn_mask&lt;/span&gt;&lt;span class="p"&gt;)[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
        &lt;span class="c1"&gt;# Layerした後にFeedForwardNetworkに入力し、その出力と元の値を足し合わせる&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ffn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;layer_norm_2&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# LayerNorm-&amp;gt;FeedForwardNetwork-&amp;gt;Add&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;TransformerのEncoderは、上で定義した&lt;code&gt;TransformerEncoderBlock&lt;/code&gt;を用いて以下のように実装できます。ただし、オリジナルのTransformerでは、Positional Encodingはsin関数やcos関数を用いていますが、実装では0~1の一様分布からランダムに選択した値を持つ学習可能なパラメータとなっています。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;TransformerEncoder&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Module&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;context_length&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;vocab_size&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;layers&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;heads&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;attn_mask&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Tensor&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;None&lt;/span&gt;
        &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;token_embedding&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Embedding&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;vocab_size&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;positional_embedding&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Parameter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;randn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;context_length&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;width&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;width&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;n_layers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;layers&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;transformer_encoder_blocks&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Sequential&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;TransformerEncoderBlock&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;heads&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;attn_mask&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;_&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;layers&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
            &lt;span class="p"&gt;)&lt;/span&gt; 

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;forward&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Tensor&lt;/span&gt;
        &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Tensor&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;token_embedding&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  &lt;span class="c1"&gt;# 1. トークン化された文章をベクトル表現に変換&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;positional_embedding&lt;/span&gt;  &lt;span class="c1"&gt;# 2. Positional Encodingにより位置情報を付与&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;permute&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;transformer_encoder_blocks&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# 3+4. TransformerEncoderBlockでの処理をN回くり返す&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;permute&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;3. Image Encoderの実装&lt;/h3&gt;
&lt;p&gt;CLIPのImage EncoderとしてはResNetやVisionTransformerが用いられています。今回はVisionTransformerを用いて実装を行っていきます。
VisionTransformerは上で実装したTransformer Encoderを、自然言語処理ではなく画像分類に適用するためのモデルです。
VisionTransformerでは以下のような順番で画像の処理が行われます。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;元の画像を分割したもの(=パッチ)を作成し、これをEmbeddingしたものを横に並べる。&lt;/li&gt;
&lt;li&gt;1で作成したパッチの列の先頭に分類用のclass tokenをEmbeddingしたものを追加する。&lt;/li&gt;
&lt;li&gt;2で作成したパッチとclass tokenのEmbeddingにPositional Embeddingを足し合わせ、パッチ列中での位置情報を付与する。&lt;ul&gt;
&lt;li&gt;ViTのPositional Encodingでは、学習可能なパラメータを用いている。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;3の出力をTransformer Encoderに掛ける&lt;/li&gt;
&lt;li&gt;class tokenに相当する部分のEmbeddingをMLPに入力する。&lt;/li&gt;
&lt;li&gt;5の出力を元にクラス分類を行う。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img alt="" src="https://storage.googleapis.com/zenn-user-upload/aa5ae6bcb822784d6021ea6a.png"&gt;&lt;/p&gt;
&lt;p&gt;Image Encoderでは、画像1枚1枚に対して通常のVisionTransformerと同様に1~4の処理を行います。具体的な実装は以下の通りです。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;VisionTransformer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Module&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;image_size&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;patch_size&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;layers&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;heads&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;output_dim&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;
        &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="n"&gt;image_height&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;image_width&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;image_size&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;image_size&lt;/span&gt;
        &lt;span class="n"&gt;patch_height&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;patch_width&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;patch_size&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;patch_size&lt;/span&gt;
        &lt;span class="n"&gt;num_patches&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;image_height&lt;/span&gt; &lt;span class="o"&gt;//&lt;/span&gt; &lt;span class="n"&gt;patch_height&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;image_width&lt;/span&gt; &lt;span class="o"&gt;//&lt;/span&gt; &lt;span class="n"&gt;patch_width&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;conv1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Conv2d&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;in_channels&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;out_channels&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;kernel_size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;patch_size&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;stride&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;patch_size&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;class_embedding&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Parameter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;randn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="c1"&gt;# class_tokenのEmbeddingに相当&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;positional_embedding&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Parameter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;randn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;num_patches&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="c1"&gt;# num_pathes + 1 = patch数+class_embedding&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;layer_norm_pre&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;LayerNorm&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;transformer_encoder&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Sequential&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;TransformerEncoderBlock&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;heads&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;_&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;layers&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
        &lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;layers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;layers&lt;/span&gt;

        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;layer_norm_post&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;LayerNorm&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;proj&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Parameter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;randn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;output_dim&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__image_to_patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Tensor&lt;/span&gt;
        &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Tensor&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span class="sd"&gt;            入力画像をパッチに変換する。&lt;/span&gt;
&lt;span class="sd"&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;conv1&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;reshape&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;shape&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;shape&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;permute&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;forward&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Tensor&lt;/span&gt;
        &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Tensor&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;__image_to_patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  &lt;span class="c1"&gt;# 1. 画像をパッチに変換しEmbeddingする&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cat&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;class_embedding&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;expand&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;shape&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;dim&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  &lt;span class="c1"&gt;# 2. class tokenのembeddingをパッチの先頭に追加&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;positional_embedding&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;expand&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;shape&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  &lt;span class="c1"&gt;# 3. positional encodingで位置情報を追加&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;layer_norm_pre&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; 

        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;permute&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;transformer_encoder&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  &lt;span class="c1"&gt;# 4. パッチのembeddingをTransformerEncoderに入力&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;permute&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;4. CLIPの実装&lt;/h3&gt;
&lt;p&gt;次に、上の1,2で実装した&lt;code&gt;TransformerEncoder&lt;/code&gt;や&lt;code&gt;VisionTransformer&lt;/code&gt;を用いて、CLIPを実装していきます。&lt;br&gt;
CLIPの実装は以下のようになります。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;CLIP&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Module&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;image_size&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;224&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;patch_size&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;32&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;768&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;layers&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;12&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;heads&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;context_length&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;77&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;vocab_size&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;49408&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;output_dim&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;512&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

        &lt;span class="c1"&gt;# image encoder&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;image_encoder&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;VisionTransformer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;image_size&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;image_size&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;patch_size&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;patch_size&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;width&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;layers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;layers&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;heads&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;heads&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;output_dim&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;output_dim&lt;/span&gt;
            &lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;image_projection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Parameter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;randn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;output_dim&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

        &lt;span class="c1"&gt;# text encoder&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;context_length&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;context_length&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;text_encoder&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;TransformerEncoder&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;context_length&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;context_length&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;vocab_size&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;vocab_size&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;width&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;layers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;layers&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;heads&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;heads&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;text_projection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Parameter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;randn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;output_dim&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;temperature_parameter&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Parameter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ones&lt;/span&gt;&lt;span class="p"&gt;([])&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="mf"&gt;0.07&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;encode_image&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;images&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Tensor&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span class="sd"&gt;            Image Encoderを用いて画像をImage Embeddingに変換&lt;/span&gt;
&lt;span class="sd"&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;image_encoder&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;images&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;[:,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;:]&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;image_projection&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;encode_text&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;texts&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Tuple&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;]):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span class="sd"&gt;            Text Encoderを用いてテキストをText Embeddingに変換&lt;/span&gt;
&lt;span class="sd"&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="n"&gt;tokens&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;__tokenize&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;texts&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;text_encoder&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tokens&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="c1"&gt;# print(x)&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arange&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;shape&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]),&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argmax&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tokens&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;axis&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt; &lt;span class="c1"&gt;# EOT tokenのembeddingのみ使用する&lt;/span&gt;
        &lt;span class="c1"&gt;# print(x[0])&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;text_projection&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__tokenize&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;texts&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;truncate&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;bool&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;False&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span class="sd"&gt;            byte-pair Encodingの手法を用いて、テキストをtokenに変換する。&lt;/span&gt;
&lt;span class="sd"&gt;            byte-pair Encodingの詳細は本記事では省略する。&lt;/span&gt;
&lt;span class="sd"&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="n"&gt;_tokenizer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;_Tokenizer&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="n"&gt;sot_token&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;_tokenizer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;encoder&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;lt;|startoftext|&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
        &lt;span class="n"&gt;eot_token&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;_tokenizer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;encoder&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;lt;|endoftext|&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
        &lt;span class="n"&gt;all_tokens&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[[&lt;/span&gt;&lt;span class="n"&gt;sot_token&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;_tokenizer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;encode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;text&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;eot_token&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;texts&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
        &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;zeros&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;all_tokens&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;context_length&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;dtype&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tokens&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;enumerate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;all_tokens&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tokens&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;context_length&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;truncate&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                    &lt;span class="n"&gt;tokens&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tokens&lt;/span&gt;&lt;span class="p"&gt;[:&lt;/span&gt;&lt;span class="n"&gt;context_length&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
                    &lt;span class="n"&gt;tokens&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;eot_token&lt;/span&gt;
                &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                    &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="ne"&gt;RuntimeError&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;f&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Input &lt;/span&gt;&lt;span class="si"&gt;{&lt;/span&gt;&lt;span class="n"&gt;texts&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt; is too long for context length &lt;/span&gt;&lt;span class="si"&gt;{&lt;/span&gt;&lt;span class="n"&gt;context_length&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tokens&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tensor&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tokens&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__l2_normalization&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Tensor&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot; L2正規化を行うメソッド &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="n"&gt;x_l2_norm&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sum&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;dim&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="mf"&gt;0.5&lt;/span&gt;
        &lt;span class="n"&gt;x_l2_norm&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;x_l2_norm&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;unsqueeze&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;expand&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;64&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;512&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="n"&gt;x_l2_norm&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;forward&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;images&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;texts&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span class="sd"&gt;            logitsを計算する。&lt;/span&gt;
&lt;span class="sd"&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="c1"&gt;# L2 Normalization&lt;/span&gt;
        &lt;span class="n"&gt;image_embeddings&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;__l2_normalization&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;encode_image&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;images&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
        &lt;span class="n"&gt;text_embeddings&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;__l2_normalization&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;encode_text&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;texts&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

        &lt;span class="c1"&gt;# logitsを計算&lt;/span&gt;
        &lt;span class="n"&gt;logits_per_image&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;image_embeddings&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt; &lt;span class="n"&gt;text_embeddings&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;temperature_parameter&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exp&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="n"&gt;logits_per_text&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;text_embeddings&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt; &lt;span class="n"&gt;image_embeddings&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;temperature_parameter&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exp&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;logits_per_image&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;logits_per_text&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;encode_image&lt;/code&gt;では、&lt;code&gt;VisionTransformer&lt;/code&gt;の&lt;code&gt;TransformerEncoder&lt;/code&gt;の最終出力のうち、class_token、すなわち&lt;code&gt;index==0&lt;/code&gt;の位置にあるEmbeddingを取り出します。その後、&lt;code&gt;image_projection&lt;/code&gt;により512次元のベクトルに変換し、最終的なCLIPの画像特徴量とします。&lt;br&gt;
また、&lt;code&gt;encode_text&lt;/code&gt;では、&lt;code&gt;TransformerEncoder&lt;/code&gt;の最終出力のうち、EOT(End Of Text)、すなわち最も大きいtokenの値を持つindexにあるEmbeddingを取り出します。その後、&lt;code&gt;text_projection&lt;/code&gt;により512次元のベクトルに変換し、最終的なCLIPの文章特徴量とします。&lt;br&gt;
&lt;code&gt;forward&lt;/code&gt;では、与えられた画像とテキストの入力をエンコードし、logitsを計算します。具体的には以下のような順番で処理を行っています。
1. encode_imageやencode_textを用いて画像やテキストをCLIPのEmbeddingに変換
2. 1で変換したEmbeddingをL2正規化
    - L2正規化については&lt;a href="https://qiita.com/panda531/items/4ca6f7e078b749cf75e8"&gt;こちらの記事&lt;/a&gt;を参照
3. 画像とテキストのCLIP特徴量の行列積を計算することで、画像/テキスト毎のlogitsを取得&lt;/p&gt;
&lt;h3&gt;4. Symmetric Lossの実装&lt;/h3&gt;
&lt;p&gt;CLIPでは対照学習を行っています。具体的には、1バッチ内の画像とテキストについて、元々のペアを正例、それ以外のペアを負例とすると、学習時には正例との類似度が高く、負例との類似度が低くなるように学習を行います。
論文中では以下のような疑似コードが掲載されていました。この疑似コードに関しては&lt;a href="https://data-analytics.fun/2021/03/24/understanding-openai-clip/"&gt;こちらの記事&lt;/a&gt;で詳しく解説されています。&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="https://data-analytics.fun/wp-content/uploads/2021/01/image-58.png"&gt;&lt;/p&gt;
&lt;p&gt;また、この疑似コードを元にSymmetric Lossの実装を行ってみました。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;SymmetricLoss&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Module&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;criterion&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;nn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CrossEntropyLoss&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;device&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;cuda&amp;quot;&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;torch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cuda&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;is_available&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;cpu&amp;quot;&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;forward&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;logits_per_image&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;logits_per_text&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;labels&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;labels&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;labels&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;device&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;loss_i&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;criterion&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;logits_per_image&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;labels&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# 画像に対するloss&lt;/span&gt;
        &lt;span class="n"&gt;loss_t&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;criterion&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;logits_per_text&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;labels&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# テキストに対するloss&lt;/span&gt;
        &lt;span class="n"&gt;loss&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loss_i&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;loss_t&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;loss&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;感想&lt;/h2&gt;
&lt;p&gt;初めての記事執筆でした。読みにくい箇所もあるかと思いますがご容赦下さい。&lt;br&gt;
普段からCLIPに関してはOpenAIが提供している事前学習済みモデルを使用しているのですが、自分で実装しながら記事を書いてみると、TransformerやViT、CLIPへの理解がより深まりました。&lt;/p&gt;
&lt;h2&gt;参考文献&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href="https://deepsquare.jp/2021/01/clip-openai/"&gt;話題のOpenAIの新たな画像分類モデルCLIPを論文から徹底解説！&lt;/a&gt;  &lt;/li&gt;
&lt;li&gt;&lt;a href="https://data-analytics.fun/2021/03/24/understanding-openai-clip/#toc3"&gt;【論文解説】自然言語処理と画像処理の融合 – OpenAI 『CLIP』を理解する(1)&lt;/a&gt;  &lt;/li&gt;
&lt;li&gt;&lt;a href="https://zenn.dev/yukiyada/articles/59f3b820c52571#3.6-encoder"&gt;Python(PyTorch)で自作して理解するTransformer&lt;/a&gt;  &lt;/li&gt;
&lt;li&gt;&lt;a href="https://zenn.dev/ronly/articles/5a0d3527c2945d#vision-transformer"&gt;【Vision Transformer】 コード解説&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://qiita.com/panda531/items/4ca6f7e078b749cf75e8"&gt;PythonでベクトルをL2正規化(normalization)する方法一覧&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category></entry><entry><title>株式会社GramEyeが資金調達を実施</title><link href="/previews/refs/heads/general/jinja2_version/news/2022/04/grameye.html" rel="alternate"></link><published>2022-04-04T00:00:00+09:00</published><updated>2022-04-04T00:00:00+09:00</updated><author><name>Python会</name></author><id>tag:None,2022-04-04:/previews/refs/heads/general/jinja2_version/news/2022/04/grameye.html</id><content type="html">&lt;p&gt;弊団体OB平岡悠の起業した大阪大学発ベンチャー株式会社GramEyeが2度目プレシリーズA資金調達を実施いたしました。&lt;/p&gt;
&lt;p&gt;詳細は&lt;a href="https://prtimes.jp/main/html/rd/p/000000002.000098814.html"&gt;こちら&lt;/a&gt;です。&lt;/p&gt;
&lt;p&gt;おめでとうございます！&lt;/p&gt;</content><category term="お知らせ"></category><category term="News"></category></entry><entry><title>クローン病の予後予測と脂肪組織萎縮の関係</title><link href="/previews/refs/heads/general/jinja2_version/blog/2022/04/crohn.html" rel="alternate"></link><published>2022-04-02T00:00:00+09:00</published><updated>2022-04-02T00:00:00+09:00</updated><author><name>安部</name></author><id>tag:None,2022-04-02:/previews/refs/heads/general/jinja2_version/blog/2022/04/crohn.html</id><summary type="html">&lt;p&gt;共同第一著者として携わった研究がthe American Journal of Pathologyに受理されました。&lt;/p&gt;
&lt;p&gt;テーマは『&lt;strong&gt;手術時に取得した切片からクローン病の2年以内の再発を予測するモデルを作成→モデルの出力 …&lt;/strong&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;共同第一著者として携わった研究がthe American Journal of Pathologyに受理されました。&lt;/p&gt;
&lt;p&gt;テーマは『&lt;strong&gt;手術時に取得した切片からクローン病の2年以内の再発を予測するモデルを作成→モデルの出力を解析して再発に関わる因子を調べる&lt;/strong&gt;』でした。コードは&lt;a href="https://github.com/abebe9849/Crohn_wsi"&gt;github&lt;/a&gt;に公開されています。&lt;/p&gt;
&lt;p&gt;全文は&lt;a href="https://www.sciencedirect.com/science/article/pii/S0002944022001067?CMX_ID=&amp;amp;SIS_ID=&amp;amp;dgcid=STMJ_AUTH_SERV_PUBLISHED&amp;amp;utm_acid=107243843&amp;amp;utm_campaign=STMJ_AUTH_SERV_PUBLISHED&amp;amp;utm_in=DM243789&amp;amp;utm_medium=email&amp;amp;utm_source=AC_"&gt;ここ&lt;/a&gt;をご確認ください。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;"Deep learning analysis of histologic images from intestinal specimen reveal "adipocyte shrinkage" and mast cell infiltration to predict post-operative Crohn's disease."　Hiroki Kiyokawa, &lt;a href="/previews/refs/heads/general/jinja2_version/author/an-bu.html"&gt;&lt;strong&gt;Masatoshi Abe&lt;/strong&gt;&lt;/a&gt;, Takahiro Matsui, Masako Kurashige, Kenji Ohshima, Shinichiro Tahara, Satoshi Nojima, Takayuki Ogino, Yuki Sekido, Tsunekazu Mizushima, Eiichi Morii(https://doi.org/10.1016/j.ajpath.2022.03.006).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3&gt;クローン病とは&lt;/h3&gt;
&lt;p&gt;主に若者に多い消化管の至る所に発生しうる慢性炎症性疾患です。&lt;/p&gt;
&lt;h3&gt;ノイズと背景の多いWSIへの対処&lt;/h3&gt;
&lt;p&gt;WSIは病理組織プレパラート全体をデジタルスキャンしたものです。&lt;br&gt;&lt;/p&gt;
&lt;p&gt;WSIの前処理はkaggleの&lt;a href="https://www.kaggle.com/competitions/prostate-cancer-grade-assessment/overview"&gt;PANDAコンペ&lt;/a&gt;などでも扱われており、背景は白で組織はピンク〜紫なので巨大画像を256*256などのpatchに分割→ほとんど余白であるpatchは捨てる、といった前処理がされます。&lt;/p&gt;
&lt;p&gt;今回のデータでは、組織以外の余白部分が多いだけでなく、①スライドガラスの縁があれば黒い線として写ってしまう。②手術で取得したものであるというデータ作成過程上の特徴により組織以外の紫~黒の物体(血液など)が小さいながらも写っている。という2点が前処理上ネックとなりkaggle上の前処理をするだけではうまくいきませんでした。&lt;/p&gt;
&lt;p&gt;そこで、一旦元画像上で組織部分だけ2値化→組織以外の部分は白に塗り直す、という処理をあらかじめ行うことにより色の濃いノイズに対応しました。組織のpatch作成は&lt;a href="https://www.kaggle.com/code/rftexas/better-image-tiles-removing-white-spaces"&gt;PANDAコンペで紹介されていた組織部分をより効率的に除く処理&lt;/a&gt;を参考にしました。&lt;/p&gt;
&lt;p&gt;&lt;img src="{attach}./images/Crohn_figs/pathology_fig1.jpg" alt="pathology_figs_1" width="400px"&gt;&lt;/p&gt;
&lt;h3&gt;モデル作成&lt;/h3&gt;
&lt;p&gt;取得したpatchを入力としてWSIについていた再発するかどうかの2値のラベルを予測するモデルを学習させました。モデルはお馴染みの"tf_efficientnet_b5_ns"を使っています。&lt;br&gt;
augmentationには&lt;a href="https://www.kaggle.com/competitions/bengaliai-cv19?rvi=1"&gt;ベンガルコンペ&lt;/a&gt;で紹介されていた&lt;a href="https://www.kaggle.com/code/haqishen/augmix-based-on-albumentations"&gt;augmix&lt;/a&gt;と&lt;a href="https://www.kaggle.com/code/haqishen/gridmask"&gt;gridmask&lt;/a&gt;を使用しました。手元の実験ではcutmixも有効でした。GeM poolingは若干良い程度でavg poolingで十分だった気もします。細胞診の分類でもcutmixが有効だったのでpatch分割とcutmixは相性が良いのではないかと個人的に考えています。&lt;/p&gt;
&lt;h3&gt;予測の解析&lt;/h3&gt;
&lt;p&gt;予測値が両極に近いpatchを見てみると漿膜下脂肪組織に差があるのではないかという仮説が生まれました。
&lt;img src="{attach}./images/Crohn_figs/pathology_fig3.jpg" alt="pathology_figs_3" width="400px"&gt;&lt;/p&gt;
&lt;p&gt;そこで脂肪細胞数/細胞の面積/細胞間距離/細胞の丸み(楕円fittingしたときの長軸)/短軸の割合/間質の面積を計測しました。この作業にはインスタンスセグメンテーションが必要だったのですが自分でmaskを作成してモデルを構築だけのパワーがなかったので深層学習は使用せずに&lt;a href="http://labs.eecs.tottori-u.ac.jp/sd/Member/oyamada/OpenCV/html/py_tutorials/py_imgproc/py_watershed/py_watershed.html"&gt;opencv&lt;/a&gt;などを駆使しました。&lt;br&gt;&lt;/p&gt;
&lt;p&gt;以下が脂肪細胞の解析結果です。
&lt;img src="{attach}./images/Crohn_figs/pathology_fig5.jpg" alt="pathology_figs5" width="400px"&gt;&lt;/p&gt;
&lt;p&gt;結果として『&lt;strong&gt;脂肪細胞の収縮が、疾患の再発に関係する&lt;/strong&gt;』ことが示唆されました。&lt;/p&gt;
&lt;h3&gt;感想&lt;/h3&gt;
&lt;p&gt;解析実際にやっていたのは2020年冬~2021年春でまだkaggleは"見る専"だった頃のものですが見よう見真似でkaggle上から引っ張ってきたアイデアが効いたり、自分なりに前処理を変更したりと楽しかった記憶があります。&lt;/p&gt;
&lt;h3&gt;引用&lt;/h3&gt;
&lt;p&gt;この記事の画像が全て&lt;a href="https://doi.org/10.1016/j.ajpath.2022.03.006"&gt;元の論文&lt;/a&gt;から引用されました。&lt;/p&gt;
&lt;h3&gt;謝辞&lt;/h3&gt;
&lt;p&gt;本研究の計算はすべて&lt;a href="https://oumpy.github.io/student_server.html"&gt;大阪大学医学部医学科学生用計算機&lt;/a&gt;上にて行いました。&lt;/p&gt;
&lt;h3&gt;WSI関連雑記&lt;/h3&gt;
&lt;p&gt;WSIをタイル分割してモデル作成→分散表現を得て後段タスクに活用(https://arxiv.org/abs/1901.11112)&lt;br&gt;
自己教師あり学習を用いて表現を得るなどの工夫のしがいがあって楽しそうです。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category></entry><entry><title>清麗戦の研究：早く負けるが得か？</title><link href="/previews/refs/heads/general/jinja2_version/blog/2022/03/seirei.html" rel="alternate"></link><published>2022-03-31T00:00:00+09:00</published><updated>2022-04-10T00:00:00+09:00</updated><author><name>小川</name></author><id>tag:None,2022-03-31:/previews/refs/heads/general/jinja2_version/blog/2022/03/seirei.html</id><summary type="html">&lt;p&gt;本稿は第2期以降の&lt;a href="https://www.shogi.or.jp/match/seirei/"&gt;清麗戦&lt;/a&gt;の予選方式「再挑戦トーナメント」の妥当性に関する研究です。
敗退回別に敗者トーナメントを行う …&lt;/p&gt;</summary><content type="html">&lt;p&gt;本稿は第2期以降の&lt;a href="https://www.shogi.or.jp/match/seirei/"&gt;清麗戦&lt;/a&gt;の予選方式「再挑戦トーナメント」の妥当性に関する研究です。
敗退回別に敗者トーナメントを行う現行形式では、1回戦負けが却って得となるような逆転現象が生じるのではないか？という仮説に対し、女流棋士レーティング値に基づくシミュレーションと確率計算により検証を行いました。&lt;/p&gt;
&lt;h2&gt;序論&lt;/h2&gt;
&lt;h3&gt;清麗戦の予選方式&lt;/h3&gt;
&lt;p&gt;2022年3月末現在、&lt;a href="https://www.shogi.or.jp/match/seirei/4/yosen.html"&gt;第4期清麗戦予選&lt;/a&gt;が進行中です。&lt;/p&gt;
&lt;p&gt;この棋戦は、どれも一度負けたら終わりの女流棋戦（正棋士棋戦も殆どがそう）の中で、画期的な予選2敗失格方式を掲げて登場。
&lt;a href="https://www.shogi.or.jp/match/hakurei/"&gt;女流順位戦&lt;/a&gt;創設の伏線になったと言えるかもしれない棋戦です。
最高棋戦の地位は白玲戦・女流順位戦（正棋士の名人戦・順位戦に相当）に譲ったものの、序列2位、うっすらと竜王戦を思わせる棋戦でもあります。&lt;/p&gt;
&lt;p&gt;第1期予選はスイス式でしたが、わかりにくかったからなのか、第2期から現行の「再挑戦トーナメント」方式となりました。
竜王戦1組と同じく、予選トーナメント（以下、本予選と呼称）での1回戦負け同士のトーナメント、2回戦負け同士のトーナメント、、を独立に行います。
再挑戦トーナメントの組み合わせ順は本予選と同じです（お互い勝っていれば本予選で当たっていた者同士が、お互いに負けても当たる）。&lt;/p&gt;
&lt;p&gt;最後にそれぞれの優勝者（本予選決勝敗者は無条件）計6名から2名ずつ抽選でプレーオフを行い、本戦決勝トーナメント進出者3名（あと1名は予選優勝者）を決める、というものです。&lt;/p&gt;
&lt;p&gt;今期はちょうど64名で、加藤桃子清麗（強さを表すレーティング値は2021年12月末時点で3位 &lt;a href="#note01"&gt;[注1]&lt;/a&gt;。以下順位表示については全て同じ）への挑戦権を争っています。&lt;/p&gt;
&lt;h3&gt;死の再挑戦トーナメント&lt;/h3&gt;
&lt;p&gt;今回の主なテーマはこの再挑戦トーナメントです。
あとのない潰し合いになるわけですが、実際の主要メンバーを見ていきます。&lt;/p&gt;
&lt;p&gt;まずは&lt;strong&gt;1回戦負けトーナメント（32名）&lt;/strong&gt;。
レート最上位は清水市代女流七段（14位タイ）。
すでに準決勝まで終わり、決勝は【清水女流七段 vs 中澤沙耶女流初段（24位）】です。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2回戦負けトーナメント（16名）&lt;/strong&gt;は石本さくら女流二段（11位）、中井広恵女流六段（12位） &lt;a href="#note02"&gt;[注2]&lt;/a&gt;、加藤圭女流二段（13位）、中村真梨花女流三段（14位タイ）が4トップで、決勝【中井女流六段 vs 中村女流三段】を残すところまで進みました。&lt;/p&gt;
&lt;p&gt;そして本予選3回戦（ベスト16）では【里見香奈女流四冠（1位） vs 西山朋佳白玲・女王（2位）】、【甲斐智美女流五段（6位） vs 渡部愛女流三段（10位） &lt;a href="#note03"&gt;[注3]&lt;/a&gt;】、がありました。
&lt;strong&gt;3回戦負けトーナメント（8名）&lt;/strong&gt;の1回戦はその敗者同士、【里見四冠 vs 渡部女流三段】で、渡部女流三段の予選敗退が決定。
鈴木環那女流三段（9位）も同じく別の山で敗退。&lt;/p&gt;
&lt;p&gt;さらに上にいくと、&lt;strong&gt;4回戦（準々決勝）敗退トーナメント（4名）&lt;/strong&gt;は西山白玲、上田初美女流四段（7位タイ） &lt;a href="#note04"&gt;[注4]&lt;/a&gt;、
香川愛生女流四段（7位タイ）、本田小百合女流三段（19位）。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;準決勝敗退&lt;/strong&gt;は、【甲斐女流五段 vs 伊藤沙恵女流名人（4位）】の決戦です。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;本予選決勝&lt;/strong&gt;は【山根ことみ女流二段（5位） vs 山口恵梨子女流二段（20位）】になりました。
山口女流二段の活躍が光ります。&lt;/p&gt;
&lt;p&gt;以上、敗者組プレーオフ枠も6名なので厳しくなるのは仕方ないけれど、&lt;strong&gt;上にいくほど死のブロック&lt;/strong&gt;にもみえます。
どうでしょうか？&lt;/p&gt;
&lt;h3&gt;負けるが得？&lt;/h3&gt;
&lt;p&gt;上位敗退者再挑戦トーナメントの壮絶さを見たところで、タイトルにもある通りの疑問が頭をかすめます。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;本予選の序盤（特に1回戦）で敗退した方が、むしろ本戦進出のハードルが下がる可能性がある&lt;/strong&gt;のでは？&lt;/p&gt;
&lt;p&gt;理由は主に、全体の実力差（レート差）が大きいからです（竜王戦1組と比べると顕著）。
だからといって彼女らが故意に負けるなどは勿論ありえませんが、それでも本当にそんな現象があれば問題ですね。&lt;/p&gt;
&lt;p&gt;とはいえ今のところ、それは少ない実例からの印象論にすぎません。
そこで実際にレーティング値を用いたシミュレーションを行い、検証してみよう！というのが本稿の趣旨となります。&lt;/p&gt;
&lt;h2&gt;シミュレーション&lt;/h2&gt;
&lt;h3&gt;条件と設定&lt;/h3&gt;
&lt;p&gt;第4期清麗戦の&lt;strong&gt;出場メンバー64名&lt;/strong&gt;と&lt;strong&gt;レーティング値（2021年12月末時点）&lt;/strong&gt;を固定し、トーナメントをシミュレートします。
各局の勝利確率は単純にレーティングに従って決まると仮定します。
（もちろん実際には相性などもありますが、大勢に影響はないとみてここでは無視します。）&lt;/p&gt;
&lt;p&gt;これにより各女流棋士の予選優勝、プレーオフ進出、本戦進出、挑戦権獲得、の確率をそれぞれ求めます。&lt;/p&gt;
&lt;p&gt;また、各女流棋士について、&lt;strong&gt;自分だけ1回戦で必ず負ける場合&lt;/strong&gt;、についてもそれぞれシミュレートおよび計算を行います。
これで本人の本戦進出や挑戦の確率が最初のシミュレーションを上回るケースが出てくるか否か、確認できるわけです。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;トーナメント表&lt;/strong&gt;については、
1. 実際の第4期清麗戦のトーナメント組み合わせによる場合
2. レーティング順にシードを決めていった場合
3. ランダムに抽選し直した場合&lt;/p&gt;
&lt;p&gt;の3通りを別々に考えてみることにします。&lt;/p&gt;
&lt;h3&gt;方法と実装&lt;/h3&gt;
&lt;p&gt;本節は将棋とほぼ何も関係ないので、全部飛ばしても大丈夫です。&lt;/p&gt;
&lt;p&gt;コードはすべてPythonで実装しました。
なお著者のプログラミングスキルは&lt;a href="https://atcoder.jp"&gt;AtCoder&lt;/a&gt;水色です &lt;a href="#note05"&gt;[注5]&lt;/a&gt;。&lt;/p&gt;
&lt;h4&gt;レーティングのデータと勝率計算&lt;/h4&gt;
&lt;p&gt;レーティング値は &lt;a href="https://shogidata.info"&gt;shogidata.info&lt;/a&gt;で計算・公開されているもの（&lt;a href="https://shogidata.info/list/ratechange21w.html"&gt;こちら&lt;/a&gt;、2021年12月末時点の数値）を使用させていただきました。
開幕時の方がいいのかもしれませんが、大差はないはずです。&lt;/p&gt;
&lt;p&gt;例えば里見香奈女流四冠（レート1964、1位）と里見咲紀女流初段（レート1499、38位）が対戦した場合、レート差465なのでオッズは&lt;span class="math"&gt;\(10^{465/400} \simeq 14.54\)&lt;/span&gt;。
よって里見香奈四冠の勝利確率はおよそ 93.6% となります。&lt;/p&gt;
&lt;p&gt;レーティングはこの値で固定であり、勝敗による変動はないものとします。&lt;/p&gt;
&lt;h4&gt;トーナメントのシミュレートと確率計算&lt;/h4&gt;
&lt;p&gt;挑戦者決定までの全対局は、本予選トーナメント63局、再挑戦トーナメント57局、プレーオフ3局、本戦決勝トーナメント3局、合計126局です。&lt;/p&gt;
&lt;p&gt;このうち、実際にサイコロを振ってシミュレーションを行うのは本予選63局のみです。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;simulate_match&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;rates&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;rng&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Generator&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;tuple&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;win_prob&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;rates&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;rates&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;rng&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt; &lt;span class="c1"&gt;# 期待勝率が[0,1)乱数より大きければ勝ち&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt; &lt;span class="c1"&gt;# 勝者, 敗者&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;残りは単純な1敗失格式トーナメントになるので、厳密な確率計算が可能です。
プレーオフは15通り、本戦は3通りの組み合わせ抽選結果があり得ますが、全ての場合を単純に平均すればよいです。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;prob_match&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;B&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;rates&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;ret&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;defaultdict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;float&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;pa&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;items&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;     &lt;span class="c1"&gt;# 左の山に登場する女流棋士とその確率&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;pb&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;B&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;items&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt; &lt;span class="c1"&gt;# 右の山について同様&lt;/span&gt;
            &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;win_prob&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;rates&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;rates&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
            &lt;span class="n"&gt;ret&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;pa&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;pb&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;       &lt;span class="c1"&gt;# 左が勝つ場合&lt;/span&gt;
            &lt;span class="n"&gt;ret&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;pa&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;pb&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;   &lt;span class="c1"&gt;# 右が勝つ場合&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ret&lt;/span&gt;  &lt;span class="c1"&gt;# 勝者の分布リストを返す&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;1局の確率計算はこのようになります。
ここに出てくる辞書 &lt;code&gt;A&lt;/code&gt;, &lt;code&gt;B&lt;/code&gt;, &lt;code&gt;ret&lt;/code&gt; はいずれも、各女流棋士がその対局に登場する確率を保持しています。
各再挑戦トーナメントの一番下には該当する本予選対局の敗者を確率1とする辞書を入れます。
また本戦の枠のひとつには予選優勝者が同様に確率1で入ります。&lt;/p&gt;
&lt;p&gt;辞書を並べて配列にし、隣同士順番に当てていけば自動的にトーナメントができます。
今期は出場者がちょうど64名で半端な山がないこともあり、実装がとても楽です。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;prob_match_together&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;players&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;rates&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;prob_match&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;players&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;rates&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;players&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;//&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt; &lt;span class="c1"&gt;# 勝ち残り者の分布リストを返す&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;prob_tournament&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;players&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;rates&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;players&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;players&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;prob_match_together&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;players&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;rates&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;players&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;   &lt;span class="c1"&gt;# 優勝者の分布を返す&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;以上のようにして、本予選のシミュレーションを &lt;span class="math"&gt;\(10^6\)&lt;/span&gt; 回行い、全ての場合についての確率を計算・平均すれば、かなり正確な期待値を得ることができます。&lt;/p&gt;
&lt;p&gt;1条件あたり延べ &lt;span class="math"&gt;\(2 \times 10^9\)&lt;/span&gt; 局程度。
計算時間は2時間半程度でした。&lt;/p&gt;
&lt;h4&gt;トーナメント表&lt;/h4&gt;
&lt;p&gt;前述通り、3通りの場合をそれぞれ考えます。&lt;/p&gt;
&lt;h5&gt;第4期の組み合わせ&lt;/h5&gt;
&lt;p&gt;端から順番にトーナメント1回戦の順番を書き写したリストをファイルに保存しておき、読み込みます。
毎回のシミュレーションで同じものを使います。&lt;/p&gt;
&lt;h5&gt;シード方式&lt;/h5&gt;
&lt;p&gt;強い者同士ほど後から当たるようにする方式です。
こちらもトーナメント表は固定です。&lt;/p&gt;
&lt;p&gt;「端からの位置（0, 1, 2,...）を2進数で表し、ビット順を逆転した順位の者（0: 里見, 1:西山,...）を入れる」という簡便なアルゴリズムが使われます（表の見た目は里見西山が両端にならないですが、対戦順は同じです）。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;seed_bracket&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;players&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;rates&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="c1"&gt;# 引数playersには第4期予選出場メンバー64名を並べて入れる。順番は任意。&lt;/span&gt;
    &lt;span class="c1"&gt;# 実際は第4期の対戦表をそのまま入れればOK。&lt;/span&gt;
    &lt;span class="n"&gt;N&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;players&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;M&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;bin&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;
    &lt;span class="n"&gt;players&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;sorted&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;players&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;lambda&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;rates&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt; &lt;span class="c1"&gt;# 強い順に並べる&lt;/span&gt;
    &lt;span class="n"&gt;ret&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;bin&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;)[:&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;   &lt;span class="c1"&gt;# iの2進数表記を逆順に並べる&lt;/span&gt;
        &lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;M&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  &lt;span class="c1"&gt;# 桁数が足りない分は0埋め&lt;/span&gt;
        &lt;span class="n"&gt;ret&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;players&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ret&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h5&gt;ランダムドロー&lt;/h5&gt;
&lt;p&gt;シミュレーションごとに毎回、 &lt;code&gt;rng.shuffle(players)&lt;/code&gt; を行います。&lt;/p&gt;
&lt;h4&gt;手抜きの負け&lt;/h4&gt;
&lt;p&gt;本予選の特定回戦で、指定した特定の人が確率によらず無条件に負ける、という設定をすればよいです。&lt;/p&gt;
&lt;p&gt;実装として一番安直なのは、上の &lt;code&gt;simulate_match()&lt;/code&gt;の中に条件判定を入れることです。
もちろんもっとちゃんとした方法を使ってもよいです。&lt;/p&gt;
&lt;h2&gt;結果&lt;/h2&gt;
&lt;p&gt;お待ちかねの結果はオムニバス・ストーリー形式でのお届けです。&lt;/p&gt;
&lt;h3&gt;Episode 1 : 里見香奈さんの場合&lt;/h3&gt;
&lt;p&gt;里見香奈女流四冠のレートは1964（1位）。
女流棋界に君臨するスーパースターです。
西山白玲とはお互いがラスボス。
レート4位の伊藤女流名人に対してですら、67%の期待勝率を誇ります。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;里見香奈女流四冠&lt;/th&gt;
&lt;th&gt;挑戦&lt;/th&gt;
&lt;th&gt;本戦出場&lt;/th&gt;
&lt;th&gt;予選優勝&lt;/th&gt;
&lt;th&gt;プレーオフ勝利&lt;/th&gt;
&lt;th&gt;プレーオフ出場&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;第4期組み合わせ・全力&lt;/td&gt;
&lt;td&gt;0.3677&lt;/td&gt;
&lt;td&gt;0.6848&lt;/td&gt;
&lt;td&gt;0.2622&lt;/td&gt;
&lt;td&gt;0.4226&lt;/td&gt;
&lt;td&gt;0.5203&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;第4期組み合わせ・1回戦負け&lt;/td&gt;
&lt;td&gt;0.2587&lt;/td&gt;
&lt;td&gt;0.5022&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.5022&lt;/td&gt;
&lt;td&gt;0.6203&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;シード方式・全力&lt;/td&gt;
&lt;td&gt;0.3941&lt;/td&gt;
&lt;td&gt;0.7538&lt;/td&gt;
&lt;td&gt;0.3394&lt;/td&gt;
&lt;td&gt;0.4144&lt;/td&gt;
&lt;td&gt;0.5062&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;シード方式・1回戦負け&lt;/td&gt;
&lt;td&gt;0.2597&lt;/td&gt;
&lt;td&gt;0.4978&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.4978&lt;/td&gt;
&lt;td&gt;0.6127&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ランダムドロー・全力&lt;/td&gt;
&lt;td&gt;0.3967&lt;/td&gt;
&lt;td&gt;0.7492&lt;/td&gt;
&lt;td&gt;0.3413&lt;/td&gt;
&lt;td&gt;0.4079&lt;/td&gt;
&lt;td&gt;0.4984&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ランダムドロー・1回戦負け&lt;/td&gt;
&lt;td&gt;0.2515&lt;/td&gt;
&lt;td&gt;0.4791&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.4791&lt;/td&gt;
&lt;td&gt;0.5866&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;計算結果は表の通り。&lt;/p&gt;
&lt;p&gt;すさまじい強さですが、第4期のトーナメントはやや当たりがきつく、不利になっているようです。
全力（通常）の場合、予選優勝より挑戦の確率が高いこともポイントです。
一発入れば敗退、とならないところはやはり強者有利。 &lt;a href="#note06"&gt;[注6]&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;さて肝心の1回戦手抜きは、全ての場合で成績が下がります。
もともと予選優勝確率が3割前後あり、それを放棄しているのも大きいです。
それだけでなく、「予選優勝できなかった場合のプレーオフ出場割合」でも、全力の場合（7割程度以上）が1回戦手抜き（6割程度）を上回っています。&lt;/p&gt;
&lt;p&gt;そもそも、1回戦負けトーナメントを勝ち抜ける割合が6割程度しかない。
「里見四冠くらい強ければ無双できるのでは？」というのは、やや甘すぎるようです。
あくまでレーティング計算上の話ではありますが。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;結論：里見香奈四冠は1回戦敗退の利点はない。最初から全力で指す方が有利である。&lt;/strong&gt;&lt;/p&gt;
&lt;h3&gt;Episode 2 : 山根ことみさんの場合&lt;/h3&gt;
&lt;p&gt;山根ことみ女流二段のレートは1739（5位）。
里見四冠への期待勝率は約21%。&lt;/p&gt;
&lt;p&gt;4位・伊藤女流名人との間には壁（レート100差）がありますが、山根・甲斐・香川・上田の4人で5位集団を形成しています。
まぎれもない強豪。
今期は予選決勝進出を果たし、プレーオフ以上が確定しています。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;山根ことみ女流二段&lt;/th&gt;
&lt;th&gt;挑戦&lt;/th&gt;
&lt;th&gt;本戦出場&lt;/th&gt;
&lt;th&gt;予選優勝&lt;/th&gt;
&lt;th&gt;プレーオフ勝利&lt;/th&gt;
&lt;th&gt;プレーオフ出場&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;第4期組み合わせ・全力&lt;/td&gt;
&lt;td&gt;0.0299&lt;/td&gt;
&lt;td&gt;0.2082&lt;/td&gt;
&lt;td&gt;0.0346&lt;/td&gt;
&lt;td&gt;0.1737&lt;/td&gt;
&lt;td&gt;0.3228&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;第4期組み合わせ・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0176&lt;/td&gt;
&lt;td&gt;0.1257&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.1257&lt;/td&gt;
&lt;td&gt;0.2369&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;シード方式・全力&lt;/td&gt;
&lt;td&gt;0.0314&lt;/td&gt;
&lt;td&gt;0.2333&lt;/td&gt;
&lt;td&gt;0.0413&lt;/td&gt;
&lt;td&gt;0.1920&lt;/td&gt;
&lt;td&gt;0.3547&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;シード方式・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0164&lt;/td&gt;
&lt;td&gt;0.1258&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.1258&lt;/td&gt;
&lt;td&gt;0.2374&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ランダムドロー・全力&lt;/td&gt;
&lt;td&gt;0.0302&lt;/td&gt;
&lt;td&gt;0.2192&lt;/td&gt;
&lt;td&gt;0.0371&lt;/td&gt;
&lt;td&gt;0.1821&lt;/td&gt;
&lt;td&gt;0.3359&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ランダムドロー・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0143&lt;/td&gt;
&lt;td&gt;0.1076&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.1076&lt;/td&gt;
&lt;td&gt;0.2001&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;プレーオフ経由の本戦出場確率は全力の方が1.4倍〜1.7倍程度高く、もともと優勝確率もそれなりにあるのでトータルでは2倍前後の違いになります。
1回戦負け32人中での優勝確率は20%〜24%。
可能性をここだけに絞るのはやはり悪手のようです。
どこをどう見ても、1回戦負けが有利になるところはありません。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;結論：山根ことみ女流二段も最初から全力で指す方が有利である。&lt;/strong&gt;&lt;/p&gt;
&lt;h3&gt;Episode 3 : 渡部愛さんの場合&lt;/h3&gt;
&lt;p&gt;渡部愛女流三段のレートは1687（10位）。
里見四冠相手の期待勝率は約17%。&lt;/p&gt;
&lt;p&gt;5位グループに次ぐ集団。
ほかに鈴木環那女流三段（9位）、石本さくら女流二段（11位）ら。
この周辺以上が強豪と呼ばれる、という位置かと思います。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;渡部愛女流三段&lt;/th&gt;
&lt;th&gt;挑戦&lt;/th&gt;
&lt;th&gt;本戦出場&lt;/th&gt;
&lt;th&gt;予選優勝&lt;/th&gt;
&lt;th&gt;プレーオフ勝利&lt;/th&gt;
&lt;th&gt;プレーオフ出場&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;第4期組み合わせ・全力&lt;/td&gt;
&lt;td&gt;0.0114&lt;/td&gt;
&lt;td&gt;0.1120&lt;/td&gt;
&lt;td&gt;0.0146&lt;/td&gt;
&lt;td&gt;0.0974&lt;/td&gt;
&lt;td&gt;0.2092&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;第4期組み合わせ・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0053&lt;/td&gt;
&lt;td&gt;0.0548&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0548&lt;/td&gt;
&lt;td&gt;0.1195&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;シード方式・全力&lt;/td&gt;
&lt;td&gt;0.0111&lt;/td&gt;
&lt;td&gt;0.1164&lt;/td&gt;
&lt;td&gt;0.0129&lt;/td&gt;
&lt;td&gt;0.1035&lt;/td&gt;
&lt;td&gt;0.2228&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;シード方式・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0065&lt;/td&gt;
&lt;td&gt;0.0740&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0740&lt;/td&gt;
&lt;td&gt;0.1619&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ランダムドロー・全力&lt;/td&gt;
&lt;td&gt;0.0127&lt;/td&gt;
&lt;td&gt;0.1325&lt;/td&gt;
&lt;td&gt;0.0183&lt;/td&gt;
&lt;td&gt;0.1142&lt;/td&gt;
&lt;td&gt;0.2419&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ランダムドロー・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0057&lt;/td&gt;
&lt;td&gt;0.0613&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0613&lt;/td&gt;
&lt;td&gt;0.1312&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;山根女流二段とレート差は大きくないですが、結果は結構差が出ます。&lt;/p&gt;
&lt;p&gt;全力の場合、予選優勝の可能性が少しあります。
1回戦負けするとプレーオフ出場確率自体が約半分に激減。
本戦出場確率も半分前後となります。
やはり1回戦負けの利点はないようです。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;結論：渡部愛女流三段も最初から全力で指す方が有利である。&lt;/strong&gt;&lt;/p&gt;
&lt;h3&gt;Episode 4 : 山口恵梨子さんの場合&lt;/h3&gt;
&lt;p&gt;山口恵梨子女流二段のレートは1594（20位）。
里見四冠相手の期待勝率は約11%。&lt;/p&gt;
&lt;p&gt;強豪と呼ばれるにはまだ少し届かない位置ですが、今期清麗戦は山根女流二段とともに決勝進出。
計算上の期待値を上回る活躍を見せています。
山根女流二段への勝利確率は約30%です。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;山口恵梨子女流二段&lt;/th&gt;
&lt;th&gt;挑戦&lt;/th&gt;
&lt;th&gt;本戦出場&lt;/th&gt;
&lt;th&gt;予選優勝&lt;/th&gt;
&lt;th&gt;プレーオフ勝利&lt;/th&gt;
&lt;th&gt;プレーオフ出場&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;第4期組み合わせ・全力&lt;/td&gt;
&lt;td&gt;0.0019&lt;/td&gt;
&lt;td&gt;0.0398&lt;/td&gt;
&lt;td&gt;0.0042&lt;/td&gt;
&lt;td&gt;0.0355&lt;/td&gt;
&lt;td&gt;0.1006&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;第4期組み合わせ・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0009&lt;/td&gt;
&lt;td&gt;0.0178&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0178&lt;/td&gt;
&lt;td&gt;0.0517&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;シード方式・全力&lt;/td&gt;
&lt;td&gt;0.0016&lt;/td&gt;
&lt;td&gt;0.0359&lt;/td&gt;
&lt;td&gt;0.0024&lt;/td&gt;
&lt;td&gt;0.0335&lt;/td&gt;
&lt;td&gt;0.0964&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;シード方式・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0009&lt;/td&gt;
&lt;td&gt;0.0200&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0200&lt;/td&gt;
&lt;td&gt;0.0589&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ランダムドロー・全力&lt;/td&gt;
&lt;td&gt;0.0020&lt;/td&gt;
&lt;td&gt;0.0417&lt;/td&gt;
&lt;td&gt;0.0042&lt;/td&gt;
&lt;td&gt;0.0375&lt;/td&gt;
&lt;td&gt;0.1055&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ランダムドロー・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0008&lt;/td&gt;
&lt;td&gt;0.0176&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0176&lt;/td&gt;
&lt;td&gt;0.0501&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;予選優勝確率はほぼ無視でき、プレーオフだけ見ればよいです。
やはり1回戦負けは確率がほぼ半分になっています。
このクラスで既に、1回戦負け32人の中で優勝できる確率は5%程度に下がります。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;結論：山口恵梨子女流二段も最初から全力で指す方が有利である。&lt;/strong&gt;&lt;/p&gt;
&lt;h3&gt;Episode 5 : 武富礼衣さんの場合&lt;/h3&gt;
&lt;p&gt;武富礼衣女流初段のレートは1505（35位）。
里見四冠相手の期待勝率は6.6%。&lt;/p&gt;
&lt;p&gt;女流棋士として平均的な強さといえますが、上位進出は難しい位置です。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;武富礼衣女流初段&lt;/th&gt;
&lt;th&gt;挑戦&lt;/th&gt;
&lt;th&gt;本戦出場&lt;/th&gt;
&lt;th&gt;予選優勝&lt;/th&gt;
&lt;th&gt;プレーオフ勝利&lt;/th&gt;
&lt;th&gt;プレーオフ出場&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;第4期組み合わせ・全力&lt;/td&gt;
&lt;td&gt;0.0001&lt;/td&gt;
&lt;td&gt;0.0058&lt;/td&gt;
&lt;td&gt;0.0003&lt;/td&gt;
&lt;td&gt;0.0055&lt;/td&gt;
&lt;td&gt;0.0218&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;第4期組み合わせ・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0001&lt;/td&gt;
&lt;td&gt;0.0033&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0033&lt;/td&gt;
&lt;td&gt;0.0132&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;シード方式・全力&lt;/td&gt;
&lt;td&gt;0.0001&lt;/td&gt;
&lt;td&gt;0.0065&lt;/td&gt;
&lt;td&gt;0.0002&lt;/td&gt;
&lt;td&gt;0.0063&lt;/td&gt;
&lt;td&gt;0.0254&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;シード方式・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0001&lt;/td&gt;
&lt;td&gt;0.0054&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0054&lt;/td&gt;
&lt;td&gt;0.0219&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ランダムドロー・全力&lt;/td&gt;
&lt;td&gt;0.0002&lt;/td&gt;
&lt;td&gt;0.0100&lt;/td&gt;
&lt;td&gt;0.0007&lt;/td&gt;
&lt;td&gt;0.0092&lt;/td&gt;
&lt;td&gt;0.0357&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ランダムドロー・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0001&lt;/td&gt;
&lt;td&gt;0.0039&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0039&lt;/td&gt;
&lt;td&gt;0.0152&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;プレーオフ出場は元々厳しめの確率ですが、1回戦で負けるとさらに下がります。
1回戦負け再挑戦トーナメント優勝確率も2%いかないくらいで、32人の平均を下回ります。
正直、初戦で手を抜いている場合ではありません。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;結論：武富礼衣女流初段も最初から全力で指す方が有利である。&lt;/strong&gt;&lt;/p&gt;
&lt;h3&gt;Episode 6 : 中村桃子さんの場合&lt;/h3&gt;
&lt;p&gt;中村桃子女流二段のレートは1430（54位）。
里見四冠相手の期待勝率は4.4%。&lt;/p&gt;
&lt;p&gt;上位進出は非常に厳しい位置と言えます。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;中村桃子女流二段&lt;/th&gt;
&lt;th&gt;挑戦&lt;/th&gt;
&lt;th&gt;本戦出場&lt;/th&gt;
&lt;th&gt;予選優勝&lt;/th&gt;
&lt;th&gt;プレーオフ勝利&lt;/th&gt;
&lt;th&gt;プレーオフ出場&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;第4期組み合わせ・全力&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0025&lt;/td&gt;
&lt;td&gt;0.0001&lt;/td&gt;
&lt;td&gt;0.0024&lt;/td&gt;
&lt;td&gt;0.0125&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;第4期組み合わせ・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0014&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0014&lt;/td&gt;
&lt;td&gt;0.0076&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;シード方式・全力&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0015&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0015&lt;/td&gt;
&lt;td&gt;0.0081&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;シード方式・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0010&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0010&lt;/td&gt;
&lt;td&gt;0.0058&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ランダムドロー・全力&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0023&lt;/td&gt;
&lt;td&gt;0.0001&lt;/td&gt;
&lt;td&gt;0.0021&lt;/td&gt;
&lt;td&gt;0.0113&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ランダムドロー・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0008&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0008&lt;/td&gt;
&lt;td&gt;0.0045&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;こちらも傾向は全く同じ。
プレーオフ出場確率がおよそ半分程度に落ちます。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;結論：中村桃子女流二段も最初から全力で指す方が有利である。&lt;/strong&gt;&lt;/p&gt;
&lt;h3&gt;Episode 7 : 石高澄恵さんの場合&lt;/h3&gt;
&lt;p&gt;石高澄恵女流二段のレートは1295（68位）。
里見四冠相手の期待勝率は2%。&lt;/p&gt;
&lt;p&gt;女流棋士中の最下位です。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;石高澄恵女流二段&lt;/th&gt;
&lt;th&gt;挑戦&lt;/th&gt;
&lt;th&gt;本戦出場&lt;/th&gt;
&lt;th&gt;予選優勝&lt;/th&gt;
&lt;th&gt;プレーオフ勝利&lt;/th&gt;
&lt;th&gt;プレーオフ出場&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;第4期組み合わせ・全力&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0005&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;第4期組み合わせ・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0003&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;シード方式・全力&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0001&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0001&lt;/td&gt;
&lt;td&gt;0.0008&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;シード方式・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0004&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ランダムドロー・全力&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0001&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0001&lt;/td&gt;
&lt;td&gt;0.0009&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ランダムドロー・1回戦負け&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0000&lt;/td&gt;
&lt;td&gt;0.0003&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;ここでもきれいに同じ傾向となりました。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;結論：石高澄恵女流二段も最初から全力で指す方が有利である。&lt;/strong&gt;&lt;/p&gt;
&lt;h3&gt;みんなの結論&lt;/h3&gt;
&lt;p&gt;上に挙げた以外にも全員分を計算していますが、&lt;strong&gt;全員が、1回戦負けで本戦出場や挑戦の確率が減少&lt;/strong&gt;しています。
また表には示していませんが、2回戦以降に必ず負ける場合で計算しても、やはり逆転することはありません。&lt;a href="#note07"&gt;[注7]&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;多くの女流棋士で、本戦進出等の確率は1回戦負けの場合、全力の半分程度に下がります。
ただタイトルホルダー級の超強豪（伊藤女流名人以上、特に里見四冠と西山白玲）では、下げ幅が相対的にそこまで大きくありません。&lt;/p&gt;
&lt;p&gt;あらためて考えてみると、本戦出場の椅子はもともと64名に対して4つ。
そのうち、1回戦負け組32名への割り当ては0.5個（プレーオフ枠）です。&lt;/p&gt;
&lt;p&gt;つまり単純比較すると待遇に4倍の開きがあるのに、結果は2倍程度の差にしかならない。
トーナメント表を見たときの&lt;strong&gt;「1回戦負けが有利そうな感じ」は、この部分に数字として表れている&lt;/strong&gt;とは言えます。
差し引きおよそ2倍分、タイトルホルダー級はさらにそれ以上、有利になっている部分があります。&lt;/p&gt;
&lt;p&gt;とはいえ、4倍の待遇差を逆転するまでには至らない、というのが結論となりました。&lt;/p&gt;
&lt;h2&gt;まとめ&lt;/h2&gt;
&lt;p&gt;本研究の結果、&lt;strong&gt;仮説は無事、否定的に解決されました&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;実力の上位下位に関わらず、負けても良いことは何もありません。
&lt;strong&gt;常に全力の真剣勝負が、理論上も清麗戦の最適戦略である&lt;/strong&gt;ことが明らかになりました。
とても喜ばしい結果だと思います。&lt;/p&gt;
&lt;p&gt;清麗戦の主催者である&lt;a href="https://www.shogi.or.jp"&gt;公益社団法人日本将棋連盟&lt;/a&gt;様、&lt;a href="https://www.taisei.co.jp"&gt;大成建設株式会社&lt;/a&gt;様、第2期までの主催者である&lt;a href="https://www.hulic.co.jp"&gt;ヒューリック株式会社&lt;/a&gt;様には、謹んでお詫び申し上げます。&lt;/p&gt;
&lt;p&gt;「疑ってごめんなさい。」&lt;/p&gt;
&lt;p&gt;今後も清麗戦を楽しみにしております。
またより一層の発展を祈念致しております。&lt;/p&gt;
&lt;h2&gt;謝辞&lt;/h2&gt;
&lt;p&gt;本研究の数値結果はすべて&lt;a href="https://oumpy.github.io/student_server.html"&gt;大阪大学医学部医学科学生用計算機&lt;/a&gt;上で、延べ500CPU時間以上を使って計算されました。&lt;/p&gt;
&lt;h2&gt;注記&lt;/h2&gt;
&lt;h3&gt;&lt;span id="note01"&gt;注1&lt;/span&gt; : レーティングの順位と値&lt;/h3&gt;
&lt;p&gt;初見でもわかりやすいよう順位だけ表示していますが、レーティングの値は&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;里見(1964) ≒ 西山(1931) &amp;gt;&amp;gt;&amp;gt;&amp;gt; 加藤(1851) ≒ 伊藤(1839) &amp;gt;&amp;gt;&amp;gt;&amp;gt; 山根その他(〜1739)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;です。&lt;/p&gt;
&lt;p&gt;1位と5位グループでは昭和東京オリンピックと享保の改革くらいの差があります。
期待勝率で4-1程度です。&lt;/p&gt;
&lt;h3&gt;&lt;span id="note02"&gt;注2&lt;/span&gt; : 中井広恵女流六段&lt;/h3&gt;
&lt;p&gt;著者の推しナンバー1。&lt;/p&gt;
&lt;p&gt;昨期倉敷藤花挑戦、女流順位戦現役A級。
まさにレジェンド。&lt;/p&gt;
&lt;h3&gt;&lt;span id="note03"&gt;注3&lt;/span&gt; : 渡部愛女流三段&lt;/h3&gt;
&lt;p&gt;わたなべまな。
&lt;a href="https://joshi-shogi.com/"&gt;日本女子プロ将棋協会（LPSA）&lt;/a&gt;の生え抜きかつ看板。&lt;/p&gt;
&lt;p&gt;第1期白玲戦挑決では里見香奈四冠にここ一番で勝ち、久々にタイトル戦登場（7番勝負は渡部0-4西山）。
ぜひまたタイトルに返り咲いてほしいです。&lt;/p&gt;
&lt;h3&gt;&lt;span id="note04"&gt;注4&lt;/span&gt; : 上田初美女流四段&lt;/h3&gt;
&lt;p&gt;著者は気が強い子は嫌いじゃないです。&lt;/p&gt;
&lt;h3&gt;&lt;span id="note05"&gt;注5&lt;/span&gt; : AtCoder水色&lt;/h3&gt;
&lt;p&gt;人類の平均程度らしいです [DeepMind, 2022]。&lt;/p&gt;
&lt;h3&gt;&lt;span id="note06"&gt;注6&lt;/span&gt; : 強者有利&lt;/h3&gt;
&lt;p&gt;この「強者」、実は里見四冠と西山白玲の2人しかいません。
伊藤女流名人さえ割を食っています。&lt;/p&gt;
&lt;h3&gt;&lt;span id="note07"&gt;注7&lt;/span&gt; : 2回戦以降に必ず負ける場合&lt;/h3&gt;
&lt;p&gt;2回戦以降の特定回戦で必ず負けるように設定した場合、やはり負けるのが遅いほど、成績がよくなります。
1回遅くなると1割から2割程度です。&lt;/p&gt;
&lt;p&gt;第4期トーナメント固定では若干逆転する場合あり。
またタイトルホルダーは、負ける場所による変化がやはり非常に緩やかです。&lt;/p&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="技術ブログ"></category><category term="Simulation"></category><category term="Python"></category></entry><entry><title>”車割り”を最適化</title><link href="/previews/refs/heads/general/jinja2_version/blog/2022/03/car_allocate_linebot.html" rel="alternate"></link><published>2022-03-13T00:00:00+09:00</published><updated>2022-03-13T00:00:00+09:00</updated><author><name>富本</name></author><id>tag:None,2022-03-13:/previews/refs/heads/general/jinja2_version/blog/2022/03/car_allocate_linebot.html</id><summary type="html">&lt;p&gt;”車割り”という作業を競プロ力で自動化→lineのbotで運用　ということをやってみました。&lt;/p&gt;
&lt;h3&gt;車割り　とは&lt;/h3&gt;
&lt;p&gt;部活の帰りに親切な部員数名が …&lt;/p&gt;</summary><content type="html">&lt;p&gt;”車割り”という作業を競プロ力で自動化→lineのbotで運用　ということをやってみました。&lt;/p&gt;
&lt;h3&gt;車割り　とは&lt;/h3&gt;
&lt;p&gt;部活の帰りに親切な部員数名が他の部員を最寄駅付近などまで送り届けてあげるとき、どの部員が誰の車に乗るか割り振る　というシステムです。&lt;br&gt;
「自分の帰り道から大きく外れる場所を通るのはなるべく避けたいが、できるだけ多くの人数が乗車しているのが望ましい」という考えのもと毎回数人の知恵を結集して割り振りが決められています。&lt;br&gt;
この作業にはかなりの時間がかかるので自動化できれば嬉しいはずです。&lt;/p&gt;
&lt;h3&gt;車割りを最適化問題に落とす(富本part)&lt;/h3&gt;
&lt;p&gt;車割り問題は重み付き二部グラフ最大マッチング問題に帰着できます。&lt;br&gt;
まず各車と各部員に対応する頂点を用意し、次に各車に各部員を乗せたときの利益(たとえば送っていける距離)を事前に決めてその利益分の辺を張っていきます。&lt;br&gt;
すると、このグラフは二部グラフとなり、できるだけ利益が大きくなるようにマッチングさせる問題になります。&lt;br&gt;
このままだと各車に一人の部員しかマッチングできませんが、たとえばある車に運転手以外に人が４人乗れる場合は、その車に対応する頂点を４つ用意しておくことで、最大４人の部員をマッチングさせられます。&lt;br&gt;
(実際には頂点を４つ用意するのではなく、後で説明する最小費用流アルゴリズムにおいて張る辺の容量を4にします。)&lt;/p&gt;
&lt;h3&gt;アルゴリズムの解説　(富本part)&lt;/h3&gt;
&lt;p&gt;重み付き二部グラフ最大マッチングは最小費用流アルゴリズムを用いると以下のようにして解くことができます。&lt;br&gt;
1. 各車と各部員の頂点のほかに２つの頂点SとTを用意し、十分大きい整数をINFと置く&lt;br&gt;
2. Sから各車に辺(容量:その車に乗れる人数、コスト:0)を張る&lt;br&gt;
3. 各車から各部員に辺(容量:1、コスト:INF-利益)を張る(ただし、利益＜0の場合は辺を張らない)&lt;br&gt;
4. 各部員からTに辺(容量:1、コスト:0)を張る&lt;br&gt;
5. SからTにフローを流せるだけ流す&lt;br&gt;
6. 車(Aとする)から部員(Bとする)に張られており(正の)フローが流れているようなすべての辺について、部員Bは車Aに乗ることにする&lt;br&gt;&lt;/p&gt;
&lt;h3&gt;アルゴリズムをline botに載せる&lt;/h3&gt;
&lt;p&gt;line botの作成は&lt;a href="https://developers.line.biz/ja/docs/messaging-api/overview/"&gt;公式のドキュメント&lt;/a&gt;が丁寧なのでそれに従いました。
"サンプルボットを作成する"の項目にある&lt;a href="https://github.com/line/line-bot-sdk-python"&gt;pythonのtoolkit&lt;/a&gt;を使用します。
まず、&lt;a href="https://github.com/line/line-bot-sdk-python/tree/master/examples/flask-echo"&gt;echobotの例&lt;/a&gt;をそのまま実行して動作確認をしました。&lt;/p&gt;
&lt;p&gt;次に、実装されたアルゴリズムを組み込んでいきます。
1. 各部員に対して学年、最寄り駅の経度緯度、車に対して乗車可能人数を初期値として持っておきます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;grades&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;name1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;name2&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mf"&gt;2.&lt;/span&gt;&lt;span class="o"&gt;...&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="n"&gt;places&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;start1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:(&lt;/span&gt;&lt;span class="mi"&gt;000&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;000&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;name1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:(&lt;/span&gt;&lt;span class="mi"&gt;000&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;000&lt;/span&gt;&lt;span class="p"&gt;),,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;name1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:(&lt;/span&gt;&lt;span class="mi"&gt;000&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;000&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;...&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="n"&gt;car&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;name1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;name5&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="o"&gt;...&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;ol&gt;
&lt;li&gt;入力に応じて出力を変えるように場合わけをします。
①割り振り②初期値の更新③初期値の一部確認④helpを想定される入力の様式としてそれ以外は"helpとうって期待する入力形式を確認するように"とエラーを出します。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;①割り振り、では　車のスタート地点、割り振られる部員を入力として&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nd"&gt;@app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/callback&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;methods&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;POST&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="o"&gt;~~~~&lt;/span&gt;
    &lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;has_error&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;check_input&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;has_error&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;posst&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;入力が違います...&amp;quot;&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;members&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;start_place&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;absent&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;guest&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;input&lt;/span&gt;
        &lt;span class="n"&gt;posst&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;assignment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;members&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;members&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;start_place&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;start_place&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;absent&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;absent&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;guest&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;guest&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="c1"&gt;#重み付き二部グラフ最大マッチング実行&lt;/span&gt;


    &lt;span class="n"&gt;line_bot_api&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;reply_message&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;reply_token&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;TextSendMessage&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;text&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;posst&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;#&amp;gt;&amp;gt;posst&lt;/span&gt;
&lt;span class="c1"&gt;#out_of_car:[name1,name2,name3, ...]&lt;/span&gt;
&lt;span class="c1"&gt;#name4&amp;#39;s car: [name5,name6,name7]&lt;/span&gt;
&lt;span class="c1"&gt;#name8&amp;#39;s car: [name9,name10,name11]&lt;/span&gt;
&lt;span class="c1"&gt;#name12&amp;#39;s car: [name13,name14,name15]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;という出力を得ます。&lt;/p&gt;
&lt;p&gt;②初期値の更新、では変数をglobalにすると動きました。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;X&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;....&lt;/span&gt;

&lt;span class="nd"&gt;@app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/callback&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;methods&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;POST&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="o"&gt;~~~~&lt;/span&gt;
    &lt;span class="k"&gt;global&lt;/span&gt; &lt;span class="n"&gt;X&lt;/span&gt;
    &lt;span class="n"&gt;X&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new_X&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;実際には、membersはあらかじめ数個に分かれているgroups(X=[ ],Y=[ ],Z..)のlistを使用することで入力の文字列をできるだけ短くしています。
　&lt;/p&gt;
&lt;h3&gt;感想&lt;/h3&gt;
&lt;p&gt;いままで触ってみたら楽しいかもしれないけれどとっつきにくい、と感じていたflaskやbotに1mmでもタッチできたのは良い経験でした。&lt;br&gt;
競技プログラミングが実生活に役立つ瞬間がみれて感動しました。&lt;br&gt;
最適化の部分はcolabに貼り付けて自分で変数を書き換え→実行すれば動くようになっていましたがほとんど利用されなかったこともあり、休みを利用してlineのbotに載せました。
botの部分はサンプルをいじっただけでしたが、競プロerの力を借りることで巷によるあるbotよりも良さそうなものが作れたのではないかと思います。&lt;/p&gt;
&lt;h4&gt;参考&lt;/h4&gt;
&lt;p&gt;https://www.youtube.com/watch?v=jBsvdgFMZtg
heroku login:https://qiita.com/WEByamori/items/4cab4be8ce336ed3e4d6&lt;/p&gt;</content><category term="技術ブログ"></category><category term="自動化"></category><category term="競技プログラミング"></category></entry><entry><title>Kaggle Tabular Playground Series - Dec 2021</title><link href="/previews/refs/heads/general/jinja2_version/blog/2022/03/kaggle-tabular-playground-series-dec-2021.html" rel="alternate"></link><published>2022-03-10T00:00:00+09:00</published><updated>2022-03-10T00:00:00+09:00</updated><author><name>石本</name></author><id>tag:None,2022-03-10:/previews/refs/heads/general/jinja2_version/blog/2022/03/kaggle-tabular-playground-series-dec-2021.html</id><summary type="html">&lt;h2&gt;やったこと&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;baseline作成（&lt;a href="https://www.kaggle.com/chryzal/features-engineering-for-you"&gt;参考記事&lt;/a&gt;）　public score = 0.95102&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Sequential モデル&lt;/strong&gt;を使用&lt;/li&gt;
&lt;li&gt;データフレームからあまり重要でなさそうな行や列を削除&lt;/li&gt;
&lt;li&gt;Aspectはコンパスの方向のことなので0~359の範囲に入っていないものは±360して …&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;</summary><content type="html">&lt;h2&gt;やったこと&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;baseline作成（&lt;a href="https://www.kaggle.com/chryzal/features-engineering-for-you"&gt;参考記事&lt;/a&gt;）　public score = 0.95102&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Sequential モデル&lt;/strong&gt;を使用&lt;/li&gt;
&lt;li&gt;データフレームからあまり重要でなさそうな行や列を削除&lt;/li&gt;
&lt;li&gt;Aspectはコンパスの方向のことなので0~359の範囲に入っていないものは±360して&lt;strong&gt;正規化&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;x_dist_hydrlgy, y_dist_hydrlgyをマンハッタン距離とユークリッド距離に変換&lt;/li&gt;
&lt;li&gt;hilshadeが0~255に入っていない場合は外れ値とみなして0または255に&lt;strong&gt;正規化&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;RobustScalerでデータのスケール変換・移動&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;メモリ節約&lt;/strong&gt;のためにデータフレームのデータ型を変換&lt;/li&gt;
&lt;li&gt;試運転のため、epoch数を200 -&amp;gt; 1に変更&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;soil_typeの合計とwilderness_areaの合計を特徴量に加えた。（&lt;a href="https://www.kaggle.com/c/tabular-playground-series-dec-2021/discussion/292823"&gt;参考記事&lt;/a&gt;）&lt;/li&gt;
&lt;li&gt;進捗を見ながら学習を進めるために、tqdmを導入した。&lt;/li&gt;
&lt;li&gt;epoch数を1 -&amp;gt; 200に変更　public score = 0.95664&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;結果・感想&lt;/h2&gt;
&lt;p&gt;結果は、273位でした。baselineに手を加えられたのは初めてだったので成長を感じることができました。とはいえ、baselineのモデルを完全に理解できたわけではなかったので有効な改善ができたかは不明です。
これからも積極的にコンペに参加していきたいです。&lt;/p&gt;
&lt;h2&gt;参考にした本&lt;/h2&gt;
&lt;p&gt;今回のコンペでは&lt;a href="https://www.amazon.co.jp/Kaggle%E3%81%A7%E5%8B%9D%E3%81%A4%E3%83%87%E3%83%BC%E3%82%BF%E5%88%86%E6%9E%90%E3%81%AE%E6%8A%80%E8%A1%93-%E9%96%80%E8%84%87-%E5%A4%A7%E8%BC%94/dp/4297108437"&gt;『kaggleで勝つデータ分析の技術』&lt;/a&gt;を参考にし、モデルの改善に取り組みました。特に、「特徴量の作成」の項が参考になりました。部分的にしか読めていないので、今後コンペに参加していく中で完読を目指していきます。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Data Science Competition"></category></entry><entry><title>ゼータ・メビウス変換</title><link href="/previews/refs/heads/general/jinja2_version/blog/2022/03/zetamebiusubian-huan.html" rel="alternate"></link><published>2022-03-01T00:00:00+09:00</published><updated>2022-03-02T00:00:00+09:00</updated><author><name>富本</name></author><id>tag:None,2022-03-01:/previews/refs/heads/general/jinja2_version/blog/2022/03/zetamebiusubian-huan.html</id><summary type="html">&lt;p&gt;競技プログラミングにおいて、ゼータ・メビウス変換はよく用いられる手法です。
この言葉はいくつかの文脈(用途)で …&lt;/p&gt;</summary><content type="html">&lt;p&gt;競技プログラミングにおいて、ゼータ・メビウス変換はよく用いられる手法です。
この言葉はいくつかの文脈(用途)で使われるので、それを分類します。
以下では、&lt;span class="math"&gt;\(f\)&lt;/span&gt;を多次元配列として、&lt;span class="math"&gt;\(f\)&lt;/span&gt;をゼータ変換したものを&lt;span class="math"&gt;\(g\)&lt;/span&gt;と表します。&lt;/p&gt;
&lt;p&gt;①累積和と差分&lt;/p&gt;
&lt;p&gt;ゼータ変換は多次元累積和、メビウス変換は多次元差分をとることに相当します。
たとえば&lt;span class="math"&gt;\(f\)&lt;/span&gt;という&lt;span class="math"&gt;\(N\)&lt;/span&gt;次元配列&lt;code&gt;np.array&lt;/code&gt;は&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
  &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cumsum&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;axis&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;out&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;とすることでゼータ変換できます。
&lt;span class="math"&gt;\(f\)&lt;/span&gt;全体から&lt;span class="math"&gt;\(g\)&lt;/span&gt;全体を計算するというものです。&lt;/p&gt;
&lt;p&gt;②包除原理&lt;/p&gt;
&lt;p&gt;&lt;span class="math"&gt;\(f\)&lt;/span&gt;のある要素は、&lt;span class="math"&gt;\(g\)&lt;/span&gt;のいくつかの要素を求めてそれらを足したり引いたりすることで求めることができます。
たとえば&lt;span class="math"&gt;\(f\)&lt;/span&gt;が&lt;span class="math"&gt;\(2\)&lt;/span&gt;次元配列とすると、&lt;span class="math"&gt;\(f[2][5]=g[2][5]-g[1][5]-g[2][4]+g[1][4]\)&lt;/span&gt;となります。&lt;/p&gt;
&lt;p&gt;&lt;span class="math"&gt;\(g[i]=\sum_{j|i}f[i]\)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;という変換はゼータ変換に相当しており、この場合の包除原理にはメビウスの反転公式という名前がついています。&lt;/p&gt;
&lt;p&gt;③&lt;span class="math"&gt;\(max\)&lt;/span&gt;(または&lt;span class="math"&gt;\(min\)&lt;/span&gt;)に相当する畳み込みの高速化&lt;/p&gt;
&lt;p&gt;長さ&lt;span class="math"&gt;\(N\)&lt;/span&gt;の&lt;span class="math"&gt;\(2\)&lt;/span&gt;つの配列&lt;span class="math"&gt;\(A,B\)&lt;/span&gt;に対して、&lt;/p&gt;
&lt;p&gt;&lt;span class="math"&gt;\(C[k]=\sum_{\max(i,j)=k}A[i]B[j]\)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;となる&lt;span class="math"&gt;\(C\)&lt;/span&gt;を計算したいとします。
愚直に計算すると&lt;span class="math"&gt;\(O(N^2)\)&lt;/span&gt;ですが、&lt;span class="math"&gt;\(A,B,C\)&lt;/span&gt;をそれぞれ&lt;span class="math"&gt;\(A',B',C'\)&lt;/span&gt;とすると&lt;/p&gt;
&lt;p&gt;&lt;span class="math"&gt;\(A'[i]*B'[i]=C'[i] (i=1,2,...,N)\)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;が成り立つので、&lt;span class="math"&gt;\(A,B\)&lt;/span&gt;をゼータ変換した&lt;span class="math"&gt;\(A',B'\)&lt;/span&gt;から&lt;span class="math"&gt;\(C'\)&lt;/span&gt;を求め、さらにそれをメビウス変換することで&lt;span class="math"&gt;\(C\)&lt;/span&gt;を&lt;span class="math"&gt;\(O(N)\)&lt;/span&gt;で求めることができます。
&lt;span class="math"&gt;\(lcm\)&lt;/span&gt;や&lt;span class="math"&gt;\(or\)&lt;/span&gt;は&lt;span class="math"&gt;\(max\)&lt;/span&gt;に相当するので、&lt;/p&gt;
&lt;p&gt;&lt;span class="math"&gt;\(C[k]=\sum_{\mathrm{lcm}(i,j)=k}A[i]B[j]\)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class="math"&gt;\(C[k]=\sum_{i\,\mathrm{or}\,j=k}A[i]B[j]\)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;も高速に求めることができます。
同様に、&lt;span class="math"&gt;\(min\)&lt;/span&gt;に相当する演算についての畳み込みも高速に計算できます。&lt;/p&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="技術ブログ"></category><category term="競技プログラミング"></category></entry><entry><title>SwinTransformerで物体検出</title><link href="/previews/refs/heads/general/jinja2_version/blog/2021/12/kaggle_advent_2021_18.html" rel="alternate"></link><published>2021-12-18T00:00:00+09:00</published><updated>2021-12-18T00:00:00+09:00</updated><author><name>安部</name></author><id>tag:None,2021-12-18:/previews/refs/heads/general/jinja2_version/blog/2021/12/kaggle_advent_2021_18.html</id><summary type="html">&lt;h2&gt;なんの記事か&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://qiita.com/advent-calendar/2021/kaggle"&gt;Kaggle Advent Calendar 2021&lt;/a&gt;の2枚目の18日目の記事です。&lt;/p&gt;
&lt;p&gt;最近流行りのSwinTransformerを使って物体検出を触ってみます。&lt;a href="https://www.kaggle.com/c/siim-covid19-detection/discussion/263654"&gt;SIIM2021 3rd解法&lt;/a&gt;では Swin Transformer with RepPoints(mmdetection)がアンサンブルの種として使用されています。自分 …&lt;/p&gt;</summary><content type="html">&lt;h2&gt;なんの記事か&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://qiita.com/advent-calendar/2021/kaggle"&gt;Kaggle Advent Calendar 2021&lt;/a&gt;の2枚目の18日目の記事です。&lt;/p&gt;
&lt;p&gt;最近流行りのSwinTransformerを使って物体検出を触ってみます。&lt;a href="https://www.kaggle.com/c/siim-covid19-detection/discussion/263654"&gt;SIIM2021 3rd解法&lt;/a&gt;では Swin Transformer with RepPoints(mmdetection)がアンサンブルの種として使用されています。自分で手を動かせばわかることがあるかもしれないと思い過去コンペで追試をしてみます。&lt;/p&gt;
&lt;p&gt;行った追試は以下の通りです。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;swin_tiny mask_r_cnnの公式configをいじって使う&lt;/li&gt;
&lt;li&gt;augmentationを追加&lt;/li&gt;
&lt;li&gt;さらにaugmentationを強める&lt;/li&gt;
&lt;li&gt;backboneを大きいモデルに変更する&lt;/li&gt;
&lt;li&gt;他のモデルを試す&lt;/li&gt;
&lt;li&gt;cocoの事前学習が有効か見てみる&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;追試に用いたデータ&lt;/h3&gt;
&lt;p&gt;kaggleの過去コンペ&amp;amp;csv提出ができる&amp;amp;自分のドメインに近い、という理由で&lt;a href="https://www.kaggle.com/c/vinbigdata-chest-xray-abnormalities-detection/overview"&gt;VinBig&lt;/a&gt; を追試の対象としました。&lt;br&gt;
アノテーションはdiscussionに多く挙げられていた「複数のアノテーターのbboxはナイーブにWBFで統合する」という方法で前処理し、single foldで学習、subをしています。手元のmAP0.5とprivateでのスコアを確認していきます。(スコアの確認が歯切れの悪い形になっています。ご了承ください)&lt;br&gt;以下全てのsubに&lt;a href="https://www.kaggle.com/c/vinbigdata-chest-xray-abnormalities-detection/discussion/210351"&gt;2cls fillter&lt;/a&gt; をつけています。コンペ特有の課題(複数のアノテーターへの対処)は本記事では扱いません。推論のコードは&lt;a href="https://www.kaggle.com/kc3222/mmdet-pytorch-framework-infer-vfnet"&gt;これ&lt;/a&gt;を参考にしました。&lt;/p&gt;
&lt;h3&gt;実験&lt;/h3&gt;
&lt;h4&gt;1. swin_tiny mask_r_cnnの公式configをいじって使う&lt;/h4&gt;
&lt;p&gt;&lt;a href="https://github.com/open-mmlab/mmdetection/tree/master/configs/swin"&gt;mmdetectionの公式のレポジトリ&lt;/a&gt;にはmask_Rcnn系列のbackboneにswin_tiny/smallを用いた場合のconfig/log/weightが存在します。&lt;br&gt;
まずこれをそのまま使用したいのですがmaskの情報はvinbigには無いのでmask headを消しておきます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;   &lt;span class="n"&gt;roi_head&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
       &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;StandardRoIHead&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;bbox_roi_extractor&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
           &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;SingleRoIExtractor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="n"&gt;roi_layer&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;RoIAlign&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;output_size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;7&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;sampling_ratio&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
           &lt;span class="n"&gt;out_channels&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;256&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="n"&gt;featmap_strides&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;16&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;32&lt;/span&gt;&lt;span class="p"&gt;]),&lt;/span&gt;
       &lt;span class="n"&gt;bbox_head&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
           &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Shared2FCBBoxHead&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="n"&gt;in_channels&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;256&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="n"&gt;fc_out_channels&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1024&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="n"&gt;roi_feat_size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;7&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="n"&gt;num_classes&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;14&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="n"&gt;bbox_coder&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
               &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;DeltaXYWHBBoxCoder&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
               &lt;span class="n"&gt;target_means&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mf"&gt;0.&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mf"&gt;0.&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mf"&gt;0.&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mf"&gt;0.&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
               &lt;span class="n"&gt;target_stds&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mf"&gt;0.1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mf"&gt;0.1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mf"&gt;0.2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mf"&gt;0.2&lt;/span&gt;&lt;span class="p"&gt;]),&lt;/span&gt;
           &lt;span class="n"&gt;reg_class_agnostic&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;False&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="n"&gt;loss_cls&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
               &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;CrossEntropyLoss&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;use_sigmoid&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;False&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;loss_weight&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;1.0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
           &lt;span class="n"&gt;loss_bbox&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;L1Loss&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;loss_weight&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;1.0&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;
       &lt;span class="n"&gt;mask_roi_extractor&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
           &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;SingleRoIExtractor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="n"&gt;roi_layer&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;RoIAlign&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;output_size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;14&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;sampling_ratio&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
           &lt;span class="n"&gt;out_channels&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;256&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="n"&gt;featmap_strides&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;16&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;32&lt;/span&gt;&lt;span class="p"&gt;]),&lt;/span&gt;
       &lt;span class="c1"&gt;#mask_head=dict(&lt;/span&gt;
       &lt;span class="c1"&gt;#    type=&amp;#39;FCNMaskHead&amp;#39;,&lt;/span&gt;
       &lt;span class="c1"&gt;#    num_convs=4,&lt;/span&gt;
       &lt;span class="c1"&gt;#    in_channels=256,&lt;/span&gt;
       &lt;span class="c1"&gt;#    conv_out_channels=256,&lt;/span&gt;
       &lt;span class="c1"&gt;#    num_classes=14,&lt;/span&gt;
       &lt;span class="c1"&gt;#    loss_mask=dict(&lt;/span&gt;
       &lt;span class="c1"&gt;#        type=&amp;#39;CrossEntropyLoss&amp;#39;, use_mask=True, loss_weight=1.0))&lt;/span&gt;
       &lt;span class="p"&gt;),&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;次にbackboneを変更します。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;   &lt;span class="n"&gt;backbone&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
       &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;SwinTransformer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;embed_dims&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;96&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;depths&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
       &lt;span class="n"&gt;num_heads&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;12&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;24&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
       &lt;span class="n"&gt;window_size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;7&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;mlp_ratio&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;qkv_bias&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;qk_scale&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;drop_rate&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;attn_drop_rate&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;drop_path_rate&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;patch_norm&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;out_indices&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
       &lt;span class="n"&gt;with_cp&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;False&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;convert_weights&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;init_cfg&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Pretrained&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;checkpoint&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://github.com/SwinTransformer/storage/releases/download/v1.0.0/swin_tiny_patch4_window7_224.pth&amp;#39;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;

   &lt;span class="n"&gt;neck&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
       &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;FPN&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;in_channels&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;96&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;192&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;384&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;768&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
       &lt;span class="n"&gt;out_channels&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;256&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;num_outs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;load_from = ”~/mmdetection/checkpoints/mask_rcnn_swin-t-p4-w7_fpn_ms-crop-3x_coco_20210906_131725-bacf6f7b.pth”のように指定すれば事前学習済みの重みを使用できます。&lt;br&gt;
結果は以下です。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;val_mAP@0.5&lt;/th&gt;
&lt;th&gt;private LB&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;tiny&lt;/td&gt;
&lt;td&gt;0.3600&lt;/td&gt;
&lt;td&gt;0.223&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;small&lt;/td&gt;
&lt;td&gt;0.3560&lt;/td&gt;
&lt;td&gt;0.221&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4&gt;2. augmentationを追加&lt;/h4&gt;
&lt;p&gt;&lt;a href="https://github.com/open-mmlab/mmdetection/blob/master/configs/albu_example/mask_rcnn_r50_fpn_albu_1x_coco.py"&gt;albumentationsの使用例&lt;/a&gt;があったのでそのままコピペします。SIIM2021の3rd解法のものを借用したものも試しました。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;val_mAP@0.5&lt;/th&gt;
&lt;th&gt;private LB&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;small&lt;/td&gt;
&lt;td&gt;0.3560&lt;/td&gt;
&lt;td&gt;0.221&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;small+aug&lt;/td&gt;
&lt;td&gt;0.3790&lt;/td&gt;
&lt;td&gt;0.240&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;small+aug_3rd&lt;/td&gt;
&lt;td&gt;0.3840&lt;/td&gt;
&lt;td&gt;0.234&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;augmentationの追加は気兼ねなくできる＆伸び代もありそうなので良さそうです。&lt;/p&gt;
&lt;h4&gt;3. さらにaugmentationを強める&lt;/h4&gt;
&lt;p&gt;mmdetetionでのmosaic/mixupの使用には&lt;a href="https://github.com/open-mmlab/mmdetection/blob/master/configs/yolox/yolox_s_8x8_300e_coco.py"&gt;yoloxのconfig&lt;/a&gt;をみれば良さそうです。datasetのtypeをMultiImageMixDatasetにするなどの修正が必要です。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;img_scale&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1024&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;1024&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# (1333, 800)&lt;/span&gt;
&lt;span class="n"&gt;train_pipeline&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;
    &lt;span class="c1"&gt;#dict(type=&amp;#39;LoadImageFromFile&amp;#39;),&lt;/span&gt;
    &lt;span class="c1"&gt;#dict(type=&amp;#39;LoadAnnotations&amp;#39;, with_bbox=True),&lt;/span&gt;
    &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Mosaic&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;img_scale&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;img_scale&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;pad_val&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;114.0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
    &lt;span class="c1"&gt;#dict(&lt;/span&gt;
    &lt;span class="c1"&gt;#    type=&amp;#39;RandomAffine&amp;#39;,&lt;/span&gt;
    &lt;span class="c1"&gt;#    scaling_ratio_range=(0.1, 2),&lt;/span&gt;
    &lt;span class="c1"&gt;#    border=(-img_scale[0] // 2, -img_scale[1] // 2)),&lt;/span&gt;
    &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Albu&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;transforms&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;albu_train_transforms&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;bbox_params&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;BboxParams&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="nb"&gt;format&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;pascal_voc&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;label_fields&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;gt_labels&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
            &lt;span class="n"&gt;min_visibility&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;filter_lost_elements&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
        &lt;span class="n"&gt;keymap&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="s1"&gt;&amp;#39;img&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;image&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="c1"&gt;#&amp;#39;gt_masks&amp;#39;: &amp;#39;masks&amp;#39;,&lt;/span&gt;
            &lt;span class="s1"&gt;&amp;#39;gt_bboxes&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;bboxes&amp;#39;&lt;/span&gt;
        &lt;span class="p"&gt;},&lt;/span&gt;
        &lt;span class="n"&gt;update_pad_shape&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;False&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;skip_img_without_anno&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
    &lt;span class="c1"&gt;#dict(&lt;/span&gt;
    &lt;span class="c1"&gt;#    type=&amp;#39;MixUp&amp;#39;,&lt;/span&gt;
    &lt;span class="c1"&gt;#    img_scale=img_scale,&lt;/span&gt;
    &lt;span class="c1"&gt;#    ratio_range=(0.8, 1.6),&lt;/span&gt;
    &lt;span class="c1"&gt;#    pad_val=114.0),&lt;/span&gt;
    &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Resize&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;img_scale&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;img_scale&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;keep_ratio&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
    &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;RandomFlip&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flip_ratio&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.5&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
    &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Normalize&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;img_norm_cfg&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
    &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Pad&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size_divisor&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;32&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
    &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;DefaultFormatBundle&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
    &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Collect&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;keys&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;img&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;gt_bboxes&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;gt_labels&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]),&lt;/span&gt;
&lt;span class="p"&gt;]&lt;/span&gt;

&lt;span class="n"&gt;train_dataset&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;MultiImageMixDataset&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;dataset&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;dataset_type&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;classes&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;classes&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;ann_file&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;~/vinbig/dataset/fold0/annotations/train.json&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;img_prefix&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;~/vinbig/dataset/fold0/train2017/&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;pipeline&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;
            &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;LoadImageFromFile&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
            &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;LoadAnnotations&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;with_bbox&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;],&lt;/span&gt;
        &lt;span class="n"&gt;filter_empty_gt&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;False&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="p"&gt;),&lt;/span&gt;
    &lt;span class="n"&gt;pipeline&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;train_pipeline&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;samples_per_gpu&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;workers_per_gpu&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;12&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="c1"&gt;#train=dict(&lt;/span&gt;
    &lt;span class="c1"&gt;#    type=dataset_type,&lt;/span&gt;
    &lt;span class="c1"&gt;#    classes=classes,&lt;/span&gt;
    &lt;span class="c1"&gt;#    ann_file=&amp;#39;~/vinbig/dataset/fold0/annotations/train.json&amp;#39;,&lt;/span&gt;
    &lt;span class="c1"&gt;#    img_prefix=&amp;#39;~/vinbig/dataset/fold0/train2017/&amp;#39;,&lt;/span&gt;
    &lt;span class="c1"&gt;#    pipeline=train_pipeline),&lt;/span&gt;
    &lt;span class="n"&gt;train&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;train_dataset&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;val&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;dataset_type&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;classes&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;classes&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;ann_file&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;~/vinbig/dataset/fold0/annotations/val.json&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;img_prefix&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;~/vinbig/dataset/fold0/val2017/&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;pipeline&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;test_pipeline&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;val_mAP@0.5&lt;/th&gt;
&lt;th&gt;private LB&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;small+aug&lt;/td&gt;
&lt;td&gt;0.3790&lt;/td&gt;
&lt;td&gt;0.240&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;small+mosaic&lt;/td&gt;
&lt;td&gt;0.3310&lt;/td&gt;
&lt;td&gt;0.208&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;適当に使って良いものでは無さそうです。&lt;/p&gt;
&lt;h4&gt;4. backboneを大きいモデルに変更する&lt;/h4&gt;
&lt;p&gt;&lt;a href="https://github.com/yujiariyasu/siim_covid19_detection/blob/main/ian-siim/mmdetection/configs/swin"&gt;SIIM2021の3rd解法のレポジトリ&lt;/a&gt;にはモデルの大きさを大きくしてみるという実験を行った痕跡が残されているので倣ってみます。(swin_rsna000.py swin_rsna001.py)&lt;br&gt;backboneとneckの値をいじればなんとかなりそうです。以下はtiny→baseの変更をおこなったものです。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;   &lt;span class="n"&gt;backbone&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
       &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;SwinTransformer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="c1"&gt;#embed_dims=96,&lt;/span&gt;
       &lt;span class="n"&gt;embed_dim&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;128&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="c1"&gt;#embed_dim=192, #large&lt;/span&gt;
       &lt;span class="c1"&gt;#depths=[2, 2, 6, 2],&lt;/span&gt;
       &lt;span class="n"&gt;depths&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;18&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="c1"&gt;#largeもおなじ&lt;/span&gt;
       &lt;span class="c1"&gt;#num_heads=[3, 6, 12, 24],&lt;/span&gt;
       &lt;span class="n"&gt;num_heads&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;16&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;32&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
       &lt;span class="c1"&gt;#num_heads=[6, 12, 24, 48], #large&lt;/span&gt;
       &lt;span class="c1"&gt;#window_size=7,&lt;/span&gt;
       &lt;span class="n"&gt;window_size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;12&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;mlp_ratio&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;qkv_bias&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;qk_scale&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;drop_rate&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;attn_drop_rate&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;drop_path_rate&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;patch_norm&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;out_indices&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
       &lt;span class="n"&gt;with_cp&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;False&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;convert_weights&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;init_cfg&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Pretrained&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;checkpoint&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://github.com/SwinTransformer/storage/releases/download/v1.0.0/swin_base_patch4_window12_384_22kto1k.pth&amp;#39;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;

   &lt;span class="n"&gt;neck&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
       &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;FPN&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="c1"&gt;#in_channels=[96, 192, 384, 768],&lt;/span&gt;
       &lt;span class="n"&gt;in_channels&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;128&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;256&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;512&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1024&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
       &lt;span class="c1"&gt;#in_channels=[192, 384, 768, 1536],, #large&lt;/span&gt;
       &lt;span class="n"&gt;out_channels&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;256&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
       &lt;span class="n"&gt;num_outs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;base large smallの結果は以下です。モデルを大きくすると収束が遅くなるのでは無いかと思ったのでlargeを長めに学習させるものも試しました。augmentationはSIIM2021の3rd解法のものを使用しています。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;TH&lt;/th&gt;
&lt;th&gt;val_mAP@0.5&lt;/th&gt;
&lt;th&gt;private LB&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;small&lt;/td&gt;
&lt;td&gt;0.3840&lt;/td&gt;
&lt;td&gt;0.234&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;base&lt;/td&gt;
&lt;td&gt;0.3770&lt;/td&gt;
&lt;td&gt;0.246&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;lagre&lt;/td&gt;
&lt;td&gt;0.3330&lt;/td&gt;
&lt;td&gt;0.230&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;lagre(3x)&lt;/td&gt;
&lt;td&gt;0.3640&lt;/td&gt;
&lt;td&gt;0.234&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;largeは収束が遅い&amp;amp;脳死で使って良いわけでは無さそうです。&lt;/p&gt;
&lt;h4&gt;5. 他のモデルを試す&lt;/h4&gt;
&lt;p&gt;CascadeRcnn,retinanet,HTCもsubしてみます。各々backboneとneckを書き換えれば使用可能です。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;TH&lt;/th&gt;
&lt;th&gt;val_mAP@0.5&lt;/th&gt;
&lt;th&gt;private LB&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Cascade&lt;/td&gt;
&lt;td&gt;0.3840&lt;/td&gt;
&lt;td&gt;0.226&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;retinanet&lt;/td&gt;
&lt;td&gt;0.3790&lt;/td&gt;
&lt;td&gt;0.232&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;HTC&lt;/td&gt;
&lt;td&gt;0.3640&lt;/td&gt;
&lt;td&gt;0.229&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;使いこなせないですね...&lt;/p&gt;
&lt;h4&gt;6. cocoの事前学習が有効か見てみる&lt;/h4&gt;
&lt;p&gt;mask R cnnでのcoco2017の事前学習済みの重みはmmdetectionに公開されていますが、他のモデルについては公式のmmdetectionには見当たりません。ネットを探しても見つからない場合、自分でcoco2017の事前学習をすることになります。A100１枚でswin smallのretinanetを12epoch学習させるのに2.5日ほどかかるので非常にしんどいです。&lt;br&gt;
事前学習でのmAPが高ければ高いほどよいのか確認するため8epoch終了時(学習途中)と12epoch終了時(最終epoch)の2つの重みを用いました。2つのcocoでのmAP_valは以下の通りです。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;TH&lt;/th&gt;
&lt;th&gt;val_mAP@0.5:0.95&lt;/th&gt;
&lt;th&gt;val_mAP@0.5&lt;/th&gt;
&lt;th&gt;val_mAP@0.75&lt;/th&gt;
&lt;th&gt;val_mAP small&lt;/th&gt;
&lt;th&gt;val_mAP medium&lt;/th&gt;
&lt;th&gt;val_mAP large&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;8epoch&lt;/td&gt;
&lt;td&gt;0.407&lt;/td&gt;
&lt;td&gt;0.619&lt;/td&gt;
&lt;td&gt;0.438&lt;/td&gt;
&lt;td&gt;0.245&lt;/td&gt;
&lt;td&gt;0.450&lt;/td&gt;
&lt;td&gt;0.542&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;12epoch&lt;/td&gt;
&lt;td&gt;0.457&lt;/td&gt;
&lt;td&gt;0.670&lt;/td&gt;
&lt;td&gt;0.492&lt;/td&gt;
&lt;td&gt;0.300&lt;/td&gt;
&lt;td&gt;0.498&lt;/td&gt;
&lt;td&gt;0.605&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;結果は以下です。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;TH&lt;/th&gt;
&lt;th&gt;val_mAP@0.5&lt;/th&gt;
&lt;th&gt;private LB&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;without pretraining&lt;/td&gt;
&lt;td&gt;0.3790&lt;/td&gt;
&lt;td&gt;0.232&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;8epoch&lt;/td&gt;
&lt;td&gt;0.3820&lt;/td&gt;
&lt;td&gt;0.239&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;12epoch&lt;/td&gt;
&lt;td&gt;0.3940&lt;/td&gt;
&lt;td&gt;0.238&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;cocoの事前学習を用いればLBが上昇しました。事前学習でのmAPが高ければ高いほどよいとも言いきれ無さそうです。&lt;/p&gt;
&lt;h3&gt;まとめ&lt;/h3&gt;
&lt;p&gt;mmdetectionを使用してSwinTransformerを物体検出に適用しました。勘所は不明ですがmmdetectionを気兼ねなく使えるようになったのはよかったと思います。追試はモチベがなかなか出ない問題がありますが一日のsub数など気にせず実験のフィードバックが得られるので楽しかったです。&lt;/p&gt;
&lt;h3&gt;おまけ&lt;/h3&gt;
&lt;p&gt;mmdetection以外でもswinで物体検出が可能です。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href="https://github.com/yl305237731/flexible-yolov5"&gt;yolov5&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;yolov5のbackboneなどを自分で変えて実験できます。coco2017で事前学習した重みは載っていません。&lt;a href="https://github.com/nvnnghia/siim2021/tree/main/detection"&gt;SIIM2021の2ndのレポジトリ&lt;/a&gt;に似たようなものがありました。
&lt;br&gt;
これをvinbigに試しても散々でした。
nvnn氏曰く「SIIM2021の検出タスクは解像度が低くても&amp;amp;cocoの精度が低いものでもcv/lbがそんなに変わらなかったのでcocoで事前学習されていないモデルでも構わず使用した。有効かどうかはデータセット依存だよ」とのことです。”そんなに変わらない”の肌感は不明です｡｡｡&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href="https://github.com/xiaohu2015/SwinT_detectron2"&gt;detectron2&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;detectron2でswin_Tinyのretinanetを36epoch事前学習させた重みなどがあります。詳細は未確認です。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category></entry><entry><title>自転車コンペ</title><link href="/previews/refs/heads/general/jinja2_version/blog/2021/11/cyclecompe.html" rel="alternate"></link><published>2021-11-08T00:00:00+09:00</published><updated>2021-11-08T00:00:00+09:00</updated><author><name>梅津</name></author><id>tag:None,2021-11-08:/previews/refs/heads/general/jinja2_version/blog/2021/11/cyclecompe.html</id><summary type="html">&lt;h1&gt;シェアサイクルコンペ&lt;/h1&gt;
&lt;p&gt;2021/10/01~2021/10/27にsignateで開催された&lt;a href="https://signate.jp/competitions/550"&gt;SIGNATE Student Cup 2021秋【予測部門】&lt;/a&gt;で377人中26位になり銀メダルを獲得しました。&lt;/p&gt;
&lt;h2&gt;コンペの概要&lt;/h2&gt;
&lt;p&gt;予測する日以前のデータを使用し、予測当 …&lt;/p&gt;</summary><content type="html">&lt;h1&gt;シェアサイクルコンペ&lt;/h1&gt;
&lt;p&gt;2021/10/01~2021/10/27にsignateで開催された&lt;a href="https://signate.jp/competitions/550"&gt;SIGNATE Student Cup 2021秋【予測部門】&lt;/a&gt;で377人中26位になり銀メダルを獲得しました。&lt;/p&gt;
&lt;h2&gt;コンペの概要&lt;/h2&gt;
&lt;p&gt;予測する日以前のデータを使用し、予測当日での70ヶ所の駐輪場での利用可能な自転車数を予測する回帰問題。
時系列データで1時間ごとの値が与えられた。&lt;br&gt;
予測する日は複数あり、それらは全てが連続しているわけではなく前後に訓練に回せるデータがある場合もある。
しかし、上記に書いた通り予測する日に対し翌日からのデータを使用するのは禁止。
リークに注意する必要があった。&lt;br&gt;
利用可能な自転車数から気候など様々な特徴量が4つのテーブルから与えられた。&lt;br&gt;
評価指標はRMSE(root mean squared error)&lt;/p&gt;
&lt;h2&gt;したこと&lt;/h2&gt;
&lt;p&gt;今回は単独での参加だったのでEDAからモデリングまで自分でやりました。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;feature engineering&lt;br&gt;
平日、祝日、休日や春夏秋冬の季節を作成しました。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;train &amp;amp; validation&lt;br&gt;
予測する日以前のデータの全てをtrainにまわしました。欠損したところはその直前の予測日以前のデータでtrainしたモデルでの予測値を代入し、pseudo labelingをしました。
1つ目のlgbmでoptunaを使いハイパーパラメータを最適化し、他にも流用しました。
120個のlgbmをtrainすることになりましたが、結局は月毎で12個つくった方が精度が出るみたいです。
validationを上記の訓練する状況に似せようと1日だけにしたのが悪手なのかも...
seed値を変えた３つの120個のlgbmのセットをensambleに使いました。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;他にやりたかったこと&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;LSTMやTabnetなどのNNも試してみたかった。&lt;/li&gt;
&lt;li&gt;ラグ特徴量のような時系列データで効果的な特徴量も作りたかった。&lt;/li&gt;
&lt;li&gt;RFのハイパーパラメータを最適化し使おうとしたが何時間たっても終わる気配がせず断念。
最適化しなかった場合、lgbmとensambleするとlgbmのRandom Seed Averageよりも精度が低かった。&lt;/li&gt;
&lt;li&gt;station毎にモデルを訓練させたかった。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;反省点&lt;/h2&gt;
&lt;p&gt;多くありますが、&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;最初にEDAがあまく、予測フラグが立っていない行の目的変数がNaNであることがありえることに気付かず、精度が出ませんでした。
EDAは大切！  &lt;/li&gt;
&lt;li&gt;train用のデータの説明変数に目的変数を入れたままなのに気付かず、お手上げ状況になった。
GBDTへの理解が足らず、リークした際の状況を推測できなかったのが原因。  &lt;/li&gt;
&lt;li&gt;カテゴリ変数のencodingを一切関数を使わずに行ったため、次からは使いたい。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;とても参考になったもの&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.amazon.co.jp/Kaggle%E3%81%A7%E5%8B%9D%E3%81%A4%E3%83%87%E3%83%BC%E3%82%BF%E5%88%86%E6%9E%90%E3%81%AE%E6%8A%80%E8%A1%93-%E9%96%80%E8%84%87-%E5%A4%A7%E8%BC%94/dp/4297108437/"&gt;Kaggleで勝つデータ分析の技術&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.coursera.org/learn/competitive-data-science"&gt;How to Win a Data Science Competition: Learn from Top Kagglers&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;使ったコードは&lt;a href="https://github.com/yumezu121/signate_bikes/tree/main"&gt;こちら&lt;/a&gt;です。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Data Science Competition"></category><category term="Machine Learning"></category></entry><entry><title>医学科学生用計算機の管理委員長変更</title><link href="/previews/refs/heads/general/jinja2_version/news/2021/09/server_news.html" rel="alternate"></link><published>2021-09-22T00:00:00+09:00</published><updated>2021-09-22T00:00:00+09:00</updated><author><name>Python会</name></author><id>tag:None,2021-09-22:/previews/refs/heads/general/jinja2_version/news/2021/09/server_news.html</id><summary type="html">&lt;p&gt;このたび、&lt;a href="{filename}/pages/student_server.md"&gt;医学科学生用計算機&lt;/a&gt;の管理委員長が以下のとおり変更となりましたのでお知らせいたします。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;山本 拓都 → 安 …&lt;/strong&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;このたび、&lt;a href="{filename}/pages/student_server.md"&gt;医学科学生用計算機&lt;/a&gt;の管理委員長が以下のとおり変更となりましたのでお知らせいたします。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;山本 拓都 → 安部 政俊&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;今後ともよろしくお願いいたします。また、医学科学生用計算機の管理委員を募集しております。学年問わず1年から広く受け付けておりますので、興味のある方は &lt;a href="{filename}/pages/contact.md"&gt;Contact&lt;/a&gt; までご連絡ください！&lt;/p&gt;</content><category term="お知らせ"></category><category term="News"></category></entry><entry><title>宇宙人コンペ</title><link href="/previews/refs/heads/general/jinja2_version/blog/2021/08/seti.html" rel="alternate"></link><published>2021-08-28T00:00:00+09:00</published><updated>2021-08-30T00:00:00+09:00</updated><author><name>安部</name></author><id>tag:None,2021-08-28:/previews/refs/heads/general/jinja2_version/blog/2021/08/seti.html</id><summary type="html">&lt;p&gt;2021/05/10~2021/08/18(UTC)にkaggleで開催された &lt;a href="https://www.kaggle.com/c/seti-breakthrough-listen"&gt;SETI Breakthrough Listen - E.T. Signal Search&lt;/a&gt;　にて自分が所属しているチームが768チーム中7位となり金メダルを獲得しました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="seti_LB" src="{attach}./images/seti_figs/seti_LB.png"&gt;&lt;/p&gt;
&lt;h2&gt;初コンペ本格参加&lt;/h2&gt;
&lt;p&gt;何度かkaggleのコンペを覗いてきたのですが、最終日まで走 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;2021/05/10~2021/08/18(UTC)にkaggleで開催された &lt;a href="https://www.kaggle.com/c/seti-breakthrough-listen"&gt;SETI Breakthrough Listen - E.T. Signal Search&lt;/a&gt;　にて自分が所属しているチームが768チーム中7位となり金メダルを獲得しました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="seti_LB" src="{attach}./images/seti_figs/seti_LB.png"&gt;&lt;/p&gt;
&lt;h2&gt;初コンペ本格参加&lt;/h2&gt;
&lt;p&gt;何度かkaggleのコンペを覗いてきたのですが、最終日まで走り切ることができずメダルも取れない..というのが続いていました。そんな中、コンペ序盤で運良く&lt;a href="https://twitter.com/16uatWhpXTk7QB8/status/1392640187830652928?s=20"&gt;public１位&lt;/a&gt;となったことでどっぷり沼にハマり、SETIでは最後まで続けることができました。&lt;/p&gt;
&lt;h2&gt;計算環境&lt;/h2&gt;
&lt;p&gt;医学科学生用計算機(2080ti)などが使用できたのでサクサク実験が回せました。csv提出形式でありローカルでの実験がしやすかったのも良かったです。&lt;/p&gt;
&lt;h2&gt;激強チームメイト&lt;/h2&gt;
&lt;p&gt;序盤からずっと組んでいたSinさんとはコンペ期間中、毎日連絡を取っていました。上位解法でおなじみの方々もチームに入ってくださり心強かったです。中盤２人だったときにチームメイトのほうが格上だけれども自分がきゃりーするんだという強い気持ちで実験を回したり、終盤自分の実験が詰まったときに挫折せずに続けることができたりしたのは自分にとって良い経験でした。技術面でも盗めたことが数多くあり、チームメイトには非常に感謝しています。&lt;/p&gt;
&lt;h2&gt;教訓&lt;/h2&gt;
&lt;p&gt;domain shiftが激しかったこのコンペでの教訓は２つです。&lt;br&gt;
1:データやをよく見る。(gradCAM,直接)&lt;br&gt;
2:過去の類似コンペでの上位解法を読んで、&lt;strong&gt;すべて&lt;/strong&gt;試す。&lt;br&gt;&lt;/p&gt;
&lt;p&gt;この２つはわかったつもりになっていてもなかなか実行できずコンペが終了してしまいました。
次回は息をするようにこの２つを実行したいです。&lt;/p&gt;
&lt;h2&gt;取り組みなど&lt;/h2&gt;
&lt;p&gt;以下のスライドが自分のチームの取り組みです。&lt;/p&gt;
&lt;p&gt;&lt;p&gt;&lt;span class="videobox"&gt;
  &lt;iframe width=640" height="390"
    src="{attach}./attach/seti/宇宙人コンペ振り返り.pdf"
    frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen&gt;
  &lt;/iframe&gt;&lt;/span&gt;&lt;/p&gt;&lt;/p&gt;
&lt;p&gt;自分が使用したコードは&lt;a href="https://www.kaggle.com/abebe9849/poor-baseline"&gt;これ&lt;/a&gt;です。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category><category term="Data Science Competition"></category></entry><entry><title>甲状腺細胞診分類モデル＠日本臨床細胞学会</title><link href="/previews/refs/heads/general/jinja2_version/blog/2021/06/cytology.html" rel="alternate"></link><published>2021-06-24T00:00:00+09:00</published><updated>2022-03-05T00:00:00+09:00</updated><author><name>安部</name></author><id>tag:None,2021-06-24:/previews/refs/heads/general/jinja2_version/blog/2021/06/cytology.html</id><summary type="html">&lt;p&gt;自分が大阪大学データビリティフロンティア機構の技術補佐員としてモデル開発に携わっている研究が、6/4~6/6に開催された第６２回日本臨床細胞学会総会にて発表がありました …&lt;/p&gt;</summary><content type="html">&lt;p&gt;自分が大阪大学データビリティフロンティア機構の技術補佐員としてモデル開発に携わっている研究が、6/4~6/6に開催された第６２回日本臨床細胞学会総会にて発表がありました。
テーマは『&lt;strong&gt;甲状腺細胞診画像から癌の種類を予測する&lt;/strong&gt;』でした。&lt;/p&gt;
&lt;p&gt;この&lt;a href="https://jscc2021.jp/files/jscc2021_abstractse.pdf"&gt;抄録&lt;/a&gt;のp112にある
「s3-3AI を用いた甲状腺細胞診支援システム(ADDICT)の開発に向けて」です。&lt;/p&gt;
&lt;h2&gt;初学会参加&lt;/h2&gt;
&lt;p&gt;旅費を援助して頂いたので幕張まで行って学会に参加してきました。様々な研究を聞いて新たな着想を得たり、質問をする過程で議論が深まったりと良い経験となりました。&lt;/p&gt;
&lt;h2&gt;ドメイン知識&lt;/h2&gt;
&lt;p&gt;モデル作成にあたってCAMを見る必要があったのですが、4月にはCAMが妥当か全くわかりませんでした。しかし、かの有名な病理総論のテスト勉強のおかげで~~癌は~~という特徴があるから~~な細胞に注目していると妥当だろう！というような判断が少しできました。深層学習モデル作成に必要なドメイン知識が辛い？テスト勉強から得られたのは貴重な経験でした。&lt;/p&gt;
&lt;p&gt;&lt;img src="{attach}./images/cytology_figs/cytology_photo.jpg" alt="cytology_img" width="400px"&gt;&lt;/p&gt;
&lt;h2&gt;追記(2022/03/05)&lt;/h2&gt;
&lt;p&gt;この研究が以下の雑誌に掲載されました！&lt;/p&gt;
&lt;p&gt;新岡 宏彦, 廣川 満良, 鈴木 彩菜,&lt;a href="/previews/refs/heads/general/jinja2_version/author/an-bu.html"&gt;&lt;strong&gt;安部 政俊&lt;/strong&gt;&lt;/a&gt;, 新井 悠介, 式見 彰浩, 長原 一, 宮内 昭
“深層学習を用いた甲状腺細胞診自動診断システム (AI differential diagnosis for cytology of the thyroid:ADDICT)の開発とその現状”
PHARM TECH JAPAN, Vol. 38, No. 2, pp. 87 - 94.&lt;/p&gt;
&lt;p&gt;廣川満良, 新岡宏彦, 鈴木彩菜, &lt;a href="/previews/refs/heads/general/jinja2_version/author/an-bu.html"&gt;&lt;strong&gt;安部 政俊&lt;/strong&gt;&lt;/a&gt;, 式見彰浩, 長原一, 宮内昭
AIを用いた甲状腺細胞診支援システム(AI differential diagnosis for cytology of the thyroid:ADDICT)の開発と利用 
Journal of the Japanese Society of Clinical Cytology 61(3) 200-207 2022年6月&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category></entry><entry><title>【論文まとめ】DINO: Emerging Properties in Self-Supervised Vision Transformers</title><link href="/previews/refs/heads/general/jinja2_version/blog/2021/05/dino.html" rel="alternate"></link><published>2021-05-07T00:00:00+09:00</published><updated>2021-05-07T00:00:00+09:00</updated><author><name>山本</name></author><id>tag:None,2021-05-07:/previews/refs/heads/general/jinja2_version/blog/2021/05/dino.html</id><summary type="html">&lt;p&gt;本記事ではFacebook AI Researchの研究者らによって提案された&lt;strong&gt;DINO&lt;/strong&gt;という，画像モデルにおける自己教師あり学習の解説を行います．&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Caron, Mathilde, Hugo Touvron, Ishan Misra, Hervé Jégou, Julien Mairal, Piotr Bojanowski, and …&lt;/p&gt;&lt;/blockquote&gt;</summary><content type="html">&lt;p&gt;本記事ではFacebook AI Researchの研究者らによって提案された&lt;strong&gt;DINO&lt;/strong&gt;という，画像モデルにおける自己教師あり学習の解説を行います．&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Caron, Mathilde, Hugo Touvron, Ishan Misra, Hervé Jégou, Julien Mairal, Piotr Bojanowski, and Armand Joulin. 2021. “Emerging Properties in Self-Supervised Vision Transformers.” arXiv [cs.CV].  &lt;a href="http://arxiv.org/abs/2104.14294"&gt;http://arxiv.org/abs/2104.14294&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;(cf.) &lt;a href="https://ai.facebook.com/blog/dino-paws-computer-vision-with-self-supervised-transformers-and-10x-more-efficient-training"&gt;Facebook ブログ&lt;/a&gt;, &lt;a href="https://github.com/facebookresearch/dino"&gt;GitHub&lt;/a&gt;, &lt;a href="https://www.youtube.com/watch?v=h3ij3F3cPIk"&gt;Yannic Kilcher氏の解説動画&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;要点&lt;/strong&gt;：画像モデル (e.g. ResNet, Vision transformers)における，ラベル無しの自己教師あり学習の新しい手法DINOを考案したよ．ImageNetの画像をDINOで学習されたモデルを用いて特徴空間に埋め込むと，物体の種類ごとにクラスターが生まれ，線形回帰あるいはkNNを適応するだけで教師あり学習に匹敵する精度の物体認識ができたよ．特に画像モデルにVision Transformersを用いたとき，各headのself-attention mapは物体を識別し，segmentationのようなことができていたよ （下図参照: Caron et al., 2021; Fig.1）．&lt;/p&gt;
&lt;p&gt;&lt;img alt="fig1" src="{attach}./images/dino_figs/fig1_dino.jpg"&gt;&lt;/p&gt;
&lt;h2&gt;背景&lt;/h2&gt;
&lt;h3&gt;Self-supervised learning&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;自己教師あり学習 (Self-supervised learning; SSL)&lt;/strong&gt; は機械学習モデルの訓練方法の一種です．自己教師あり学習では，欠損のないデータを用意し，データの一部分（欠損したデータ）だけをモデルに入力し，残りのデータを予測するようにモデルを訓練します．下図は自己教師あり学習の概念図です (&lt;a href="https://ai.facebook.com/blog/self-supervised-learning-the-dark-matter-of-intelligence/"&gt;Self-supervised learning: The dark matter of intelligence&lt;/a&gt;から引用)．&lt;/p&gt;
&lt;p&gt;&lt;img alt="ssl" src="{attach}./images/dino_figs/ssl.png"&gt;&lt;/p&gt;
&lt;p&gt;データ全体を大きな直方体に見立てたとき，入力されるデータは緑色の部分，予測するデータは残りの灰色の部分となります．自己教師あり学習の例として，言語モデルではある単語から周囲の単語を予測するSkip-gramや，文中の隠された単語を残りの単語から予測するCBOWやBERT (&lt;a href="https://arxiv.org/abs/1810.04805"&gt;Devlin et al., 2018&lt;/a&gt;) などがあります (CBOWとBERTに差異はありますが割愛します)．画像モデルでは，画像の一部を塗りつぶして残りの部分から塗りつぶされた部分を予測するInpainting (e.g. DeepFill; &lt;a href="https://arxiv.org/abs/1801.07892"&gt;Yu et al., CVPR. 2018&lt;/a&gt;; &lt;a href="https://arxiv.org/abs/1806.03589"&gt;Yu et al., CVPR. 2019&lt;/a&gt;)や，現在のフレームから未来のフレームを予測する動画予測 (e.g. PredNet; &lt;a href="https://arxiv.org/abs/1605.08104"&gt;Lotter et al., ICLR. 2017&lt;/a&gt;)などがあります．計算論的神経科学における視覚モデルとしても，こうした自己教師あり学習/教師なし学習のモデルは生物学的妥当性 (biologically plausible)があるとされて研究が進められています (&lt;a href="https://www.pnas.org/content/118/3/e2014196118.long"&gt;Zhuang et al., PNAS. 2021&lt;/a&gt;)．&lt;/p&gt;
&lt;p&gt;この記事で紹介するDINOは&lt;strong&gt;自己教師あり表現学習 (Self-supervised representation learning)&lt;/strong&gt; の一種と言えます．自己教師あり表現学習には多数の研究がありますが，2つの系統について説明します．まず，&lt;strong&gt;対照学習 (contrastive learning) &lt;/strong&gt;を用いた手法としては，MoCo (&lt;a href="https://arxiv.org/abs/1911.05722"&gt;He et al., 2019&lt;/a&gt;), SimCLR (&lt;a href="https://arxiv.org/abs/2002.05709"&gt;Chen et al., 2020&lt;/a&gt;)などが代表的です．対照学習を用いた手法では，元画像とそれをaugmentした画像 (positive sample)，関係ない画像 (negative sample)の3つの画像を入力し，元画像とpositive sampleとの表現の類似度が小さく，negative sampleとの表現の類似度が大きくなるように学習を進めます．次に，2020年後半頃より，&lt;strong&gt;非対称的な2つのネットワークを用いる手法&lt;/strong&gt;が複数考案されてきました．&lt;strong&gt;BYOL&lt;/strong&gt; (&lt;a href="https://arxiv.org/abs/2006.07733"&gt;Grill et al., 2020&lt;/a&gt;), SimSiam (&lt;a href="https://arxiv.org/abs/2011.10566"&gt;Chen &amp;amp; He, 2020&lt;/a&gt;), Barlow Twins (&lt;a href="https://arxiv.org/abs/2103.03230"&gt;Zbontar et al., 2021&lt;/a&gt;) などが該当します．これらの手法ではaugmentationを用いた非対称的な入力と，stop-gradientを用いた非対称的な重み更新による2つの非対称性を生み出し，2つのネットワークの出力の類似度を小さくするように学習を行います．この記事で紹介するDINOはBYOLに似た手法ですが，以下の3つが異なります．&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;BYOLとは異なる類似度損失を用いている．&lt;/li&gt;
&lt;li&gt;2つのネットワークが同じモデル構造をしている．&lt;/li&gt;
&lt;li&gt;手法をVision Transformerにも適応している．&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;Vision Transformers&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Vision Transformer (ViT）&lt;/strong&gt; は言語モデルにおいてRNNを置き換えるモジュールとして考案されたTransformerを画像モデルに適応したモデルのことです (&lt;a href="https://openreview.net/forum?id=YicbFdNTTy"&gt;Dosovitskiy et al., ICLR. 2021&lt;/a&gt;)．医学系の方は，ViTはビタミンの略称でないことに注意しましょう．&lt;/p&gt;
&lt;p&gt;ViTでは，入力画像をパッチに分割（基本的に16×16のような格子状に分割）し，画像パッチをベクトルに埋め込んだ後，Transformerのencoderに入力するという操作をします（下図参照: Dosovitskiy et al., 2021; Fig.1）．&lt;/p&gt;
&lt;p&gt;&lt;img alt="vit" src="{attach}./images/dino_figs/vit.jpg"&gt;&lt;/p&gt;
&lt;p&gt;この記事ではViTに関して詳しい解説はしませんが，以下の資料が参考になります．&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.slideshare.net/cvpaperchallenge/transformer-247407256"&gt;Transformer メタサーベイ - Slideshare&lt;/a&gt; &lt;/li&gt;
&lt;li&gt;&lt;a href="https://qiita.com/omiita/items/0049ade809c4817670d7"&gt;画像認識の大革命。AI界で話題爆発中の「Vision Transformer」を解説！ - Qiita&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;DINO : self-&lt;em&gt;di&lt;/em&gt;stillation with &lt;em&gt;no&lt;/em&gt; labels&lt;/h2&gt;
&lt;h3&gt;モデル構造&lt;/h3&gt;
&lt;p&gt;Caronらが提案するDINO (self-&lt;strong&gt;di&lt;/strong&gt;stillation with &lt;strong&gt;no&lt;/strong&gt; labels) とは「&lt;strong&gt;ラベル無しでの自己蒸留&lt;/strong&gt;」を意味します．ここでの&lt;strong&gt;蒸留 (distillation) &lt;/strong&gt;とは，枝刈り (pruning) や量子化 (quantization)に並ぶニューラルネットワークのモデル圧縮手法です．通常の蒸留では，ラベル付きデータセットとパラメータ数が多いモデル（&lt;strong&gt;教師モデル; teacher model&lt;/strong&gt;）を用意し，ラベルと教師モデルの出力を教師信号 (hard &amp;amp; soft target) としてパラメータ数が少ないモデル（&lt;strong&gt;生徒モデル; student model&lt;/strong&gt;）を訓練します (&lt;a href="https://arxiv.org/abs/1503.02531"&gt;Hinton, Vinyals &amp;amp; Dean, NIPS, 2014&lt;/a&gt;)．データセットだけでscratchから生徒モデルを訓練するより，教師モデルを用いた方が生徒モデルの性能は高くなるということが知られています．&lt;/p&gt;
&lt;p&gt;DINOは教師モデルと生徒モデルを用いるところは通常の蒸留と同じですが，ラベル付きデータは用いず，&lt;strong&gt;教師モデルは生徒モデルから&lt;/strong&gt;作られるという違いがあります．このことを念頭に置いて，モデルの構造を見てみましょう．以下はモデルの概略図です（&lt;a href="https://ai.facebook.com/blog/dino-paws-computer-vision-with-self-supervised-transformers-and-10x-more-efficient-training"&gt;Facebook ブログ&lt;/a&gt;より引用および改変）．生徒モデルを&lt;span class="math"&gt;\(g _ {\theta s}\)&lt;/span&gt;，教師モデルを &lt;span class="math"&gt;\(g _ {\theta t}\)&lt;/span&gt;とし，入力画像を &lt;span class="math"&gt;\(\mathbf{x}\)&lt;/span&gt;とします．&lt;/p&gt;
&lt;p&gt;&lt;img alt="model1" src="{attach}./images/dino_figs/model1.jpg"&gt;&lt;/p&gt;
&lt;p&gt;論文中には次のようなPytorch-likeな擬似コードが掲載されています (Caron et al., 2021; Algorithm 1)．以下ではこの擬似コードを用いながら解説を行います．&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# gs, gt: student and teacher networks&lt;/span&gt;
&lt;span class="c1"&gt;# C: center (K)&lt;/span&gt;
&lt;span class="c1"&gt;# tps, tpt: student and teacher temperatures&lt;/span&gt;
&lt;span class="c1"&gt;# l, m: network and center momentum rates&lt;/span&gt;
&lt;span class="n"&gt;gt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gs&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;loader&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="c1"&gt;# load a minibatch x with n samples&lt;/span&gt;
    &lt;span class="n"&gt;x1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;x2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;augment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;augment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# random views&lt;/span&gt;
    &lt;span class="n"&gt;s1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;gs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# student output n-by-K&lt;/span&gt;
    &lt;span class="n"&gt;t1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;t2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gt&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;gt&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# teacher output n-by-K&lt;/span&gt;
    &lt;span class="n"&gt;loss&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;H&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;t1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;H&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;t2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;
    &lt;span class="n"&gt;loss&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;backward&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="c1"&gt;# back-propagate&lt;/span&gt;
    &lt;span class="c1"&gt;# student, teacher and center updates&lt;/span&gt;
    &lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# SGD&lt;/span&gt;
    &lt;span class="n"&gt;gt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;gt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;gs&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt;
    &lt;span class="n"&gt;C&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;C&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;cat&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="n"&gt;t1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;t2&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;mean&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dim&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;H&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;t&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;detach&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="c1"&gt;# stop gradient&lt;/span&gt;
    &lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;softmax&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="n"&gt;tps&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;dim&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;t&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;softmax&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="n"&gt;tpt&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;dim&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# center + sharpen&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sum&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dim&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;mean&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;Augmentation&lt;/h3&gt;
&lt;p&gt;各モデルに対して&lt;span class="math"&gt;\(\mathbf{x}\)&lt;/span&gt;はそのまま入力せず，画像 &lt;span class="math"&gt;\(\mathbf{x}\)&lt;/span&gt; を切り出す(crop)ようなaugmentationした画像を入力します．切り出し方は，入力画像 &lt;span class="math"&gt;\(\mathbf{x}\)&lt;/span&gt;から2つのglobal 画像 &lt;span class="math"&gt;\(x_1^g, x_2^g\)&lt;/span&gt;，および複数のlocal画像 &lt;span class="math"&gt;\(x_j^\ell\ (\ell = 1, 2, \ldots)\)&lt;/span&gt;を生成するようにします．Global画像とlocal画像は切り出す範囲（解像度）が異なり，例えばglobal画像は元画像の50%以上，local画像は元画像の50%未満などとします．ここで，生徒モデルには集合 &lt;span class="math"&gt;\(V\)&lt;/span&gt;の全ての要素，すなわちglobal画像とlocal画像の両方を入力しますが，教師モデルにはglobal画像 &lt;span class="math"&gt;\(x_1^g, x_2^g\)&lt;/span&gt; のみを入力します．こうすることで，localからglobal (local-to-global)への対応関係が生み出されると，Caronらは述べています．&lt;/p&gt;
&lt;p&gt;擬似コードで対応する部分は以下のようになっています．この擬似コードでは両方のモデルに&lt;code&gt;x1, x2&lt;/code&gt;を入力しているので，&lt;code&gt;x1, x2&lt;/code&gt;はglobal画像であると思われます（誤解している可能性があります）．&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;loader&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="c1"&gt;# load a minibatch x with n samples&lt;/span&gt;
    &lt;span class="n"&gt;x1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;x2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;augment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;augment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# random views&lt;/span&gt;
    &lt;span class="n"&gt;s1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;gs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# student output n-by-K&lt;/span&gt;
    &lt;span class="n"&gt;t1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;t2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gt&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;gt&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# teacher output n-by-K&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;Sharpeningとcentering&lt;/h3&gt;
&lt;p&gt;モデルの出力には&lt;strong&gt;sharpening&lt;/strong&gt;と&lt;strong&gt;centering&lt;/strong&gt;の2つの操作を行います．生徒モデルにはsharpeningのみ，教師モデルには両方の操作を適応します．2つの操作はモデルの崩壊を避けるため，特にsharpeningは出力の一様分布化，centeringは出力が1つだけ高い値を取り続けるといった状況を避けるために適応されます．&lt;/p&gt;
&lt;p&gt;まず，sharpeningは通常使われるSoftmax関数を修正することで実装されます．&lt;/p&gt;
&lt;div class="math"&gt;$$
P(x)^{(i)}=\frac{\exp \left(g_{\theta}(x)^{(i)} / \tau\right)}{\sum_{k=1}^{K} \exp \left(g_{\theta}(x)^{(k)} / \tau \right)}
$$&lt;/div&gt;
&lt;p&gt;ここで&lt;span class="math"&gt;\(\tau\)&lt;/span&gt;は温度のパラメータ（Softmaxの元となったカノニカル分布に由来する名称）であり，分布の鋭さ (sharpness)に影響します．DINOでは生徒，教師モデルで異なる温度パラメータ &lt;span class="math"&gt;\(\tau_{s}, \tau_{t}\)&lt;/span&gt;をそれぞれ用います．なお，&lt;span class="math"&gt;\(\tau&amp;gt;1\)&lt;/span&gt;の場合，分布はむしろ緩やかになるので，&lt;span class="math"&gt;\(0&amp;lt;\tau&amp;lt;1\)&lt;/span&gt;の値が用いられます．&lt;/p&gt;
&lt;p&gt;次に，centeringは教師モデルの出力から&lt;span class="math"&gt;\(C\)&lt;/span&gt;を除算することで出力の分布を平均に近づける操作です．ここで&lt;span class="math"&gt;\(C\)&lt;/span&gt;はスカラーではなく，出力と同じサイズのベクトルであることに注意してください（softmaxの入力からスカラーを除算しても同じ値しか出力されません）．&lt;span class="math"&gt;\(C\)&lt;/span&gt;はゼロベクトルで初期化され，次のように&lt;span class="math"&gt;\(g_{\theta_{t}}\)&lt;/span&gt;の出力の指数移動平均で更新されます．&lt;/p&gt;
&lt;div class="math"&gt;$$
c \leftarrow m c+(1-m) \frac{1}{B} \sum_{i=1}^{B} g_{\theta_{t}}\left(x_{i}\right)
$$&lt;/div&gt;
&lt;p&gt;なお，&lt;span class="math"&gt;\(B\)&lt;/span&gt;はバッチサイズです．擬似コードでは次のように実装されます．&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;C&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;C&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;cat&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="n"&gt;t1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;t2&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;mean&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dim&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;softmax&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="n"&gt;tps&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;dim&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;t&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;softmax&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="n"&gt;tpt&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;dim&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# center + sharpen&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;それぞれの効果は次のようになります．&lt;/p&gt;
&lt;p&gt;&lt;img alt="sharpening_centering" src="{attach}./images/dino_figs/sharpening_centering.png"&gt;&lt;/p&gt;
&lt;p&gt;上図を描画するPythonコードは以下の通りです．&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;numpy&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;np&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;matplotlib.pyplot&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;plt&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;softmax&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;ex&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;max&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ex&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sum&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ex&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;K&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;B&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tau&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mf"&gt;0.07&lt;/span&gt; &lt;span class="c1"&gt;# output dims, batch size, temp param&lt;/span&gt;
&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;C&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;rand&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;K&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;mean&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;rand&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;K&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;axis&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# input, center&lt;/span&gt;
&lt;span class="n"&gt;pos&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;K&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# for bar plot&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;figure&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;figsize&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;12&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;dpi&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;100&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;subplot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;bar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pos&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;$x  \in \mathbb&lt;/span&gt;&lt;span class="si"&gt;{R}&lt;/span&gt;&lt;span class="s2"&gt;^K$&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;subplot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;bar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pos&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;softmax&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt; &lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;softmax&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;$(x)$&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;subplot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;bar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pos&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;softmax&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;tau&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt; &lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Sharpening: softmax&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;$(x/\tau)$&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;subplot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;bar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pos&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;softmax&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt; &lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Centering: softmax&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;$(x-C)$&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tight_layout&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;損失関数とパラメータの更新&lt;/h3&gt;
&lt;p&gt;以下は損失関数の計算とパラメータの更新の概略図です（&lt;a href="https://ai.facebook.com/blog/dino-paws-computer-vision-with-self-supervised-transformers-and-10x-more-efficient-training"&gt;Facebook ブログ&lt;/a&gt;より引用および改変）．&lt;/p&gt;
&lt;p&gt;&lt;img alt="model2" src="{attach}./images/dino_figs/model2.jpg"&gt;&lt;/p&gt;
&lt;p&gt;まず，生徒モデルの出力 &lt;span class="math"&gt;\(P_s\)&lt;/span&gt;と教師モデルの出力 &lt;span class="math"&gt;\(P_t\)&lt;/span&gt;を用い，損失関数 &lt;span class="math"&gt;\(H(P_s, P_t):=-P_t\log P_s\)&lt;/span&gt;を計算します．次に損失関数を最小化するように生徒モデルのパラメータ &lt;span class="math"&gt;\(\theta_s\)&lt;/span&gt; をbackpropで更新します．なお，損失関数および生徒モデルの最適化問題は，Augmentationの節で述べたglobal画像&lt;span class="math"&gt;\(x_1^g, x_2^g\)&lt;/span&gt;とlocal画像&lt;span class="math"&gt;\(x_j^\ell\ (\ell = 1, 2, \ldots)\)&lt;/span&gt;，および切り出した画像全ての集合 &lt;span class="math"&gt;\(V = \left\{x_1^g, x_2^g, x_j^\ell\right\} \ (\ell = 1, 2, \ldots)\)&lt;/span&gt; を用いると次のように表されます．&lt;/p&gt;
&lt;div class="math"&gt;$$
\min _{\theta_{s}} \sum_{x \in\left\{x_{1}^{g}, x_{2}^{g}\right\}} \sum_{x^{\prime} \in V \atop x^{\prime} \neq x} H\left(P_{t}(x), P_{s}\left(x^{\prime}\right)\right)
$$&lt;/div&gt;
&lt;p&gt;一方，教師モデルのパラメータ &lt;span class="math"&gt;\(\theta_t\)&lt;/span&gt; は&lt;span class="math"&gt;\(\theta_s\)&lt;/span&gt; を&lt;strong&gt;指数移動平均 (exponential moving average; EMA)&lt;/strong&gt; することにより生成されます．&lt;/p&gt;
&lt;div class="math"&gt;$$
\theta_t \leftarrow \lambda \theta_t + (1-\lambda) \theta_s
$$&lt;/div&gt;
&lt;p&gt;なお，&lt;span class="math"&gt;\(\theta_t\)&lt;/span&gt;の初期値は&lt;span class="math"&gt;\(\theta_s\)&lt;/span&gt;とします．これに対応する擬似コードは以下の部分です．&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;loss&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;H&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;t1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;H&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;t2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;
&lt;span class="n"&gt;loss&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;backward&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="c1"&gt;# back-propagate&lt;/span&gt;
&lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# SGD&lt;/span&gt;
&lt;span class="n"&gt;gt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;gt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;gs&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;学習後のDINOモデルの特徴&lt;/h3&gt;
&lt;p&gt;学習後のDINOモデルの特徴としては，次の2点があります．&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ImageNetの画像をDINOで学習されたモデルを用いて特徴空間に埋め込むと，物体の種類ごとにクラスターが生まれ，線形変換あるいはkNNを適応するだけで教師あり学習に匹敵する精度の物体認識ができた．&lt;/li&gt;
&lt;li&gt;画像モデルにViTを用いたとき，各headのself-attention mapは物体を識別し，segmentationのようなことができた．&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;1番目の特徴ですが，ImageNetの画像を特徴空間に埋め込んだときの結果は次図のようになります（&lt;a href="https://ai.facebook.com/blog/dino-paws-computer-vision-with-self-supervised-transformers-and-10x-more-efficient-training"&gt;Facebook ブログ&lt;/a&gt;より引用）．&lt;/p&gt;
&lt;p&gt;&lt;img alt="output_clusters" src="{attach}./images/dino_figs/output_clusters.jpg"&gt;&lt;/p&gt;
&lt;p&gt;物体の種類ごとにクラスター化していることがわかります．この結果を線形回帰 (linear regression)あるいはkNNで分類すると，全てのパラメータを教師あり学習で最適化したモデルに匹敵する分類精度が得られました（論文中Table2参照）．&lt;/p&gt;
&lt;p&gt;2番目の特徴ですが，画像モデルにViTを用いた場合，画像中最も注目される物体（視覚系の用語で言うところの&lt;strong&gt;core object&lt;/strong&gt;）上にself-attentionがかかっており，segmentationのようなことができていたということです（本記事最上部の画像参照）．特に，教師あり学習を行ったViTモデルのself-attention mapと比較すると，DINOで学習したモデルの方がより物体を捉えることができていました（下図参照: Caron et al., 2021; Fig.4）．&lt;/p&gt;
&lt;p&gt;&lt;img alt="fig4_dino" src="{attach}./images/dino_figs/fig4_dino.jpg"&gt;&lt;/p&gt;
&lt;h3&gt;Self-attentionを可視化するColab notebook&lt;/h3&gt;
&lt;p&gt;今回，&lt;a href="https://github.com/facebookresearch/dino"&gt;DINOのGitHubリポジトリ&lt;/a&gt;の&lt;code&gt;visualize_attention.py&lt;/code&gt;コードを元に，&lt;strong&gt;Self-attentionを可視化するnotebookを作成&lt;/strong&gt;しました：&lt;a href="https://colab.research.google.com/github/oumpy/hp_management/blob/master/content/articles/2021sy/blog/attach/dino/dino_visualize_attention.ipynb"&gt;&lt;strong&gt;Colab notebook link&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;実行結果は次図のようになります．&lt;/p&gt;
&lt;p&gt;&lt;img alt="notebook" src="{attach}./images/dino_figs/notebook.png"&gt;&lt;/p&gt;
&lt;p&gt;一番左が入力画像（よく見ると中央に鳥がいます），中央が各headのself-attention map，一番右がself-attention mapの平均値となっています．ヒト（少なくとも私）でも鳥がいるか見分けづらいにも関わらず，その形状を捉えられていることが分かります．&lt;/p&gt;
&lt;h3&gt;DINOが学習可能である理由についての仮説&lt;/h3&gt;
&lt;p&gt;DINOを含め，自己教師あり表現学習が可能である理由について，&lt;a href="https://www.youtube.com/watch?v=h3ij3F3cPIk"&gt;Yannic Kilcher氏の解説動画&lt;/a&gt;中で「AugmentationとDatasetが帰納バイアスになっている」という仮説が述べられていました．&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Augmentationについて：色調や明度，切り出す位置のズレなどは物体を認識する際に影響しないという情報を与えている．&lt;/li&gt;
&lt;li&gt;Datasetについて：写真を取るときは，自分が注目する物体を視野の中に入れる．道路の脇に草が少し生えているような画像はインターネット上に普通アップロードしない．特にImageNetはインターネット上から画像を集めているため，こうした写真で学習をさせることには暗に画像内に物体があるという情報を与えているといえる．&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;また，本会のOB会員である秋山さん (&lt;a href="https://twitter.com/osciiart"&gt;@osciiart&lt;/a&gt;) がツイッター上で以下のような指摘をされていました．&lt;/p&gt;
&lt;blockquote class="twitter-tweet" data-theme="light"&gt;&lt;p lang="ja" dir="ltr"&gt;no labelで学習しましたっていうけどよ…ImageNetはlabelを使わなかったとしても暗にcategoricalなcluster構造をもったdatasetじゃねえのかよ。&lt;/p&gt;&amp;mdash; OsciiArt◆SPNEXTcRxQ (@osciiart) &lt;a href="https://twitter.com/osciiart/status/1389128939193335813?ref_src=twsrc%5Etfw"&gt;May 3, 2021&lt;/a&gt;&lt;/blockquote&gt;
&lt;script async src="https://platform.twitter.com/widgets.js" charset="utf-8"&gt;&lt;/script&gt;

&lt;p&gt;これに関して否定はできず，例えばヘッドマウントカメラを付けて日常生活を送らせた動画フレームで学習すると，どのような結果になるのかというのは気になるところです．ただし，SAYCam (&lt;a href="https://psyarxiv.com/fy8zx/"&gt;Sullivan et al., 2020&lt;/a&gt;) という生後6～32か月の乳児にヘッドマウントカメラを装着させた動画データセットに対し，自己教師あり学習を適応したという研究 (&lt;a href="https://arxiv.org/abs/2007.16189"&gt;Orhan et al., NeurIPS. 2020&lt;/a&gt;) の結果を踏まえると，膨大な視覚入力を受けていればImageNetのような高品質なデータセットで学習しなくてもよいと考えられます．&lt;/p&gt;
&lt;h3&gt;自己教師あり学習の展望&lt;/h3&gt;
&lt;p&gt;この記事を書く上で自己教師あり学習の論文を複数読み，手法がよりシンプルかつ効果的なものになってきていることが分かりました．手法がシンプルというのには実装が楽になる，メモリを節約できるなどの利点があります．一方で，(&lt;a href="https://www.pnas.org/content/118/3/e2014196118.long"&gt;Zhuang et al., PNAS. 2021&lt;/a&gt;) のように，自分は計算論的神経科学における視覚モデルという観点で自己教師あり学習に注目しています．このため，今後よりシンプルで生物学的妥当性の高い自己教師あり学習モデルが考案されるのではないかと期待をしています．&lt;/p&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category><category term="論文まとめ"></category></entry><entry><title>令和2年度自主研究奨励事業『眼底画像から緑内障か否か判断する深層学習モデル開発』</title><link href="/previews/refs/heads/general/jinja2_version/blog/2021/05/jisyukenkyu.html" rel="alternate"></link><published>2021-05-06T00:00:00+09:00</published><updated>2021-05-06T00:00:00+09:00</updated><author><name>安部</name></author><id>tag:None,2021-05-06:/previews/refs/heads/general/jinja2_version/blog/2021/05/jisyukenkyu.html</id><summary type="html">&lt;p&gt;2021/04/30に銀杏会館でとりおこなわれた令和2年度学部学生による自主研究奨励事業、全学選抜自主研究成果発表会にて優秀賞をいただきました。&lt;/p&gt;
&lt;p&gt;&lt;img src="{attach}./images/jisyukenkyu_figs/8519.jpg" alt="jisyukenkyu_figs8519" width="400px"&gt;&lt;/p&gt;
&lt;p&gt;テーマは『&lt;strong&gt;眼底画像から緑内障か否か判断する深 …&lt;/strong&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;2021/04/30に銀杏会館でとりおこなわれた令和2年度学部学生による自主研究奨励事業、全学選抜自主研究成果発表会にて優秀賞をいただきました。&lt;/p&gt;
&lt;p&gt;&lt;img src="{attach}./images/jisyukenkyu_figs/8519.jpg" alt="jisyukenkyu_figs8519" width="400px"&gt;&lt;/p&gt;
&lt;p&gt;テーマは『&lt;strong&gt;眼底画像から緑内障か否か判断する深層学習モデル開発&lt;/strong&gt;』でした。
アドバイザー教員の三木 篤也先生をはじめ、様々な方にご支援いただきましたことを心から感謝申し上げます。計算機として、&lt;a href="{filename}/pages/student_server.md"&gt;医学科学生用計算機&lt;/a&gt;を活用しました。&lt;/p&gt;
&lt;h2&gt;研究内容について&lt;/h2&gt;
&lt;p&gt;研究の詳細は&lt;a href="http://hdl.handle.net/11094/80643"&gt;こちら&lt;/a&gt;を参照してください。モデルの訓練に用いたコードは&lt;a href="https://github.com/abebe9849/glaucoma_cls/tree/main"&gt;こちら&lt;/a&gt;で公開しています。&lt;/p&gt;
&lt;h3&gt;前処理の一部&lt;/h3&gt;
&lt;p&gt;モルフォロジー変換などで血管を消去する前処理について、元画像（左）と前処理後（右）の画像。&lt;/p&gt;
&lt;p&gt;&lt;img src="{attach}./images/jisyukenkyu_figs/preprocessing.jpg" alt="preprocessing" width="500px"&gt;&lt;/p&gt;
&lt;h3&gt;各実験の条件とその結果&lt;/h3&gt;
&lt;p&gt;&lt;img alt="result" src="{attach}./images/jisyukenkyu_figs/result.jpg"&gt;&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category></entry><entry><title>RNA-seq pipeline ikra v2.0 リリース</title><link href="/previews/refs/heads/general/jinja2_version/blog/2021/05/ikra_v2.html" rel="alternate"></link><published>2021-05-05T00:00:00+09:00</published><updated>2021-05-05T00:00:00+09:00</updated><author><name>山崎</name></author><id>tag:None,2021-05-05:/previews/refs/heads/general/jinja2_version/blog/2021/05/ikra_v2.html</id><summary type="html">&lt;p&gt;阪大医学部Python会では、RNA-Seqのパイプラインである &lt;strong&gt;ikra&lt;/strong&gt; (&lt;a href="https://github.com/yyoshiaki/ikra"&gt;https://github.com/yyoshiaki/ikra&lt;/a&gt;)をリリースしておりました (cf. &lt;a href="https://oumpy.github.io/blog/2019/03/original_rnaseq_pipeline.html"&gt;阪医Python会特製 RNA-seq pipeline ver. 1.0 リリース&lt;/a&gt;)。このたびikraの機能を大幅にアップデートし、ikra v2.0としてリリースしました。アップデ …&lt;/p&gt;</summary><content type="html">&lt;p&gt;阪大医学部Python会では、RNA-Seqのパイプラインである &lt;strong&gt;ikra&lt;/strong&gt; (&lt;a href="https://github.com/yyoshiaki/ikra"&gt;https://github.com/yyoshiaki/ikra&lt;/a&gt;)をリリースしておりました (cf. &lt;a href="https://oumpy.github.io/blog/2019/03/original_rnaseq_pipeline.html"&gt;阪医Python会特製 RNA-seq pipeline ver. 1.0 リリース&lt;/a&gt;)。このたびikraの機能を大幅にアップデートし、ikra v2.0としてリリースしました。アップデートのポイントは以下の通りです。&lt;/p&gt;
&lt;h2&gt;aligner optionの追加&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;-a, --align (hisat2 or star)&lt;/code&gt;モードを付けて実行すると、salmonによる定量化と同時にリファレンスゲノムへのマッピングを行う機能を実装しました。alignerはhisat2とSTARのいずれかを選べます。&lt;/li&gt;
&lt;li&gt;マッピングではbamファイルとbwファイルが生成されますので、これらをIGVブラウザで直接閲覧することができます。IGVとはマッピング結果を可視化できるツールです。下の画像は、テストデータのマッピング結果のうち、Actb（βアクチン）遺伝子にマップされたtranscriptを可視化したものです。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="IGV" src="{attach}./images/ikra_v2_figs/IGV_Actb.png"&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;リファレンスゲノムは、humanならGRCh38、mouseならGRCm38です。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;gencode optionの追加&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;-g, --gencode (version)&lt;/code&gt;モードを付けて実行すると、salmonに利用するreference transcriptomeのバージョンを指定できるようにしました。&lt;/li&gt;
&lt;li&gt;デフォルトは、humanならv37、mouseならvM26です。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;ツールのアップデート&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;ikraの実行に用いるツール群をアップデートし、新しいものに入れ替えました。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;今後とも、阪医Python会およびikraをどうぞよろしくお願いいたします。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Bioinformatics"></category></entry><entry><title>LaTeX の展開</title><link href="/previews/refs/heads/general/jinja2_version/blog/2021/03/tex_expand.html" rel="alternate"></link><published>2021-03-30T00:00:00+09:00</published><updated>2021-03-30T00:00:00+09:00</updated><author><name>河村</name></author><id>tag:None,2021-03-30:/previews/refs/heads/general/jinja2_version/blog/2021/03/tex_expand.html</id><summary type="html">&lt;h2&gt;TeXの処理動作&lt;/h2&gt;
&lt;p&gt;TeXは前からソースコードを認識し、&lt;code&gt;\textbackslash（英字）&lt;/code&gt;というカタマリ&lt;sup id="sf-tex_expand-1-back"&gt;&lt;a href="#sf-tex_expand-1" class="simple-footnote" title=" 制御綴に使える文字はcatcodeが11の文字（英字・日本語）。 従って、日本語の混ざった制御綴も作れる。 \relax␣あの場合は、\relaxという制御綴と「あ」という文字として認識されるが、\relaxあの場合は、\relaxあという制御綴として認識され（定義しない限り）エラーを吐く。 "&gt;1&lt;/a&gt;&lt;/sup&gt;
を一つの制御綴（コントロールシークエンス）として処理します。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;\csone\cstwo&lt;/span&gt;            &lt;span class="k"&gt;\csthree&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;この場合の制御 …&lt;/p&gt;</summary><content type="html">&lt;h2&gt;TeXの処理動作&lt;/h2&gt;
&lt;p&gt;TeXは前からソースコードを認識し、&lt;code&gt;\textbackslash（英字）&lt;/code&gt;というカタマリ&lt;sup id="sf-tex_expand-1-back"&gt;&lt;a href="#sf-tex_expand-1" class="simple-footnote" title=" 制御綴に使える文字はcatcodeが11の文字（英字・日本語）。 従って、日本語の混ざった制御綴も作れる。 \relax␣あの場合は、\relaxという制御綴と「あ」という文字として認識されるが、\relaxあの場合は、\relaxあという制御綴として認識され（定義しない限り）エラーを吐く。 "&gt;1&lt;/a&gt;&lt;/sup&gt;
を一つの制御綴（コントロールシークエンス）として処理します。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;\csone\cstwo&lt;/span&gt;            &lt;span class="k"&gt;\csthree&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;この場合の制御綴は&lt;code&gt;\csone&lt;/code&gt;, &lt;code&gt;\cstwo&lt;/code&gt;, &lt;code&gt;\csthree&lt;/code&gt;です（空白は制御綴に使われない）。&lt;/p&gt;
&lt;p&gt;TeXは制御綴を認識した後、前から順番に展開（定義の代入）を行います。
例えば、次の制御綴を用意します。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;\csone&lt;/code&gt;の定義：one;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;\cstwo&lt;/code&gt;の定義：two;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;\csthree&lt;/code&gt;の定義：three;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;この場合は、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;\csone\cstwo&lt;/span&gt;            &lt;span class="k"&gt;\csthree&lt;/span&gt;
&lt;span class="k"&gt;\csone\cstwo\csthree&lt;/span&gt;
one;&lt;span class="k"&gt;\cstwo\csthree&lt;/span&gt;
one;two;&lt;span class="k"&gt;\csthree&lt;/span&gt;
one;two;three;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;と展開されます（複数の空白は1個の空白として処理され、制御綴の直後の空白は無視される）。&lt;/p&gt;
&lt;h2&gt;展開の制御&lt;/h2&gt;
&lt;p&gt;先程の例の通り、TeXは基本的に前から展開を行いますが、時には展開の順序を入れ替えたりしたい場合があります。
そのために、いくつかの命令が存在します：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;\expandafter&lt;/code&gt;。直後の制御綴の展開を一回遅らせる、&lt;/li&gt;
&lt;li&gt;&lt;code&gt;\edef&lt;/code&gt;。制御綴の中身を全て展開して定義、&lt;/li&gt;
&lt;li&gt;&lt;code&gt;\noexpand&lt;/code&gt;。&lt;code&gt;\edef&lt;/code&gt;中で使用すると、定義の際に展開されない（実行時は展開される）。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;例として、次の制御綴を用意します。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;\def\A&lt;/span&gt;#1#2&lt;span class="nb"&gt;{&lt;/span&gt;#1 is #2&lt;span class="nb"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;\def\B&lt;/span&gt;&lt;span class="nb"&gt;{&lt;/span&gt;&lt;span class="k"&gt;\BB\BB&lt;/span&gt;&lt;span class="nb"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;\def\BB&lt;/span&gt;&lt;span class="nb"&gt;{&lt;/span&gt;foo&lt;span class="nb"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;\def\C&lt;/span&gt;&lt;span class="nb"&gt;{&lt;/span&gt;bar&lt;span class="nb"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;それぞれの制御綴の意味は、&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;\A&lt;/code&gt;：引数は2個（#1, #2）で、展開すると「#1 is #2」（#1, #2が制御綴なら展開される）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;\B&lt;/code&gt;：展開すると「&lt;code&gt;\BB``\BB&lt;/code&gt;」（&lt;code&gt;\BB&lt;/code&gt;は展開される）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;\BB&lt;/code&gt;：展開すると「foo」（それ以上展開されない）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;\C&lt;/code&gt;：展開すると「bar」（それ以上展開されない）&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;例1&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;\A\B\C&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;\A\B\C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; \B is \C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; \BB\BB is \C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; foo\BB is \C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; foofoo is \C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; foofoo is bar&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;1行目で&lt;code&gt;\A&lt;/code&gt;を展開する際の、&lt;code&gt;\A&lt;/code&gt;の引数は&lt;code&gt;\B&lt;/code&gt;, &lt;code&gt;\C&lt;/code&gt;です。&lt;/p&gt;
&lt;h3&gt;例2&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;\expandafter\A\B\C&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;\expandafter\A\B\C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; \A\BB\BB\C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; \BB is \BB\C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; foo is \BB\C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; foo is foo\C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; foo is foobar&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;先ず、&lt;code&gt;\expandafter\A&lt;/code&gt;によって、&lt;code&gt;\A&lt;/code&gt;の展開は抑制され、先に&lt;code&gt;\B&lt;/code&gt;が展開されます。&lt;/p&gt;
&lt;h3&gt;例3&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;\expandafter\expandafter\A\B\C&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;\expandafter\expandafter\A\B\C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; \expandafter\B is \C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; \B is \C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; \BB\BB is \C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; foo\BB is \C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; foofoo is \C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; foofoo is bar&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;1行目で、先頭の&lt;code&gt;\expandafter&lt;/code&gt;は直後の&lt;code&gt;\expandafter&lt;/code&gt;を抑制するため、先に&lt;code&gt;\A&lt;/code&gt;が展開されます。
2行目で、&lt;code&gt;\expandafter\B&lt;/code&gt;の\textbf{直後}は制御綴でないため、特に効果はありません。&lt;/p&gt;
&lt;h3&gt;例4&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;\expandafter\expandafter\expandafter\A\B\C&lt;/code&gt;。&lt;code&gt;\expandafter&lt;/code&gt;が3連続の場合は次のように、2つ後の制御綴が先ず展開されます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;\expandafter\expandafter\expandafter\A\B\C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; \expandafter\A\BB\BB\C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; \Afoo\BB\C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; f is oo\BB\C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; f is oofoo\C&lt;/span&gt;
&lt;span class="c"&gt;% -&amp;gt; f is oofoobar&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;3行目で&lt;code&gt;\A&lt;/code&gt;の第1引数は&lt;code&gt;f&lt;/code&gt;、第2引数は&lt;code&gt;o&lt;/code&gt;です。&lt;/p&gt;
&lt;h3&gt;例5&lt;/h3&gt;
&lt;p&gt;さらに命令を追加してみます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;\def\hoge&lt;/span&gt;&lt;span class="nb"&gt;{&lt;/span&gt;&lt;span class="k"&gt;\B\C&lt;/span&gt;&lt;span class="nb"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;\A\hoge&lt;/span&gt; &lt;span class="c"&gt;% -&amp;gt; error&lt;/span&gt;
&lt;span class="k"&gt;\expandafter\A\hoge&lt;/span&gt; &lt;span class="c"&gt;% -&amp;gt; \A\B\C -&amp;gt; foofoo is bar&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;\A\hoge&lt;/code&gt;は&lt;code&gt;\A&lt;/code&gt;の第2引数が存在しないので、エラーとなります。&lt;/p&gt;
&lt;h3&gt;例6&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;\def&lt;/code&gt;の代わりに&lt;code&gt;\edef&lt;/code&gt;で&lt;code&gt;\hoge&lt;/code&gt;を定義します。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;\edef\hoge&lt;/span&gt;&lt;span class="nb"&gt;{&lt;/span&gt;&lt;span class="k"&gt;\B\C&lt;/span&gt;&lt;span class="nb"&gt;}&lt;/span&gt; &lt;span class="c"&gt;% -&amp;gt; \def\hoge{foofoobar}&lt;/span&gt;
&lt;span class="k"&gt;\A\hoge&lt;/span&gt; &lt;span class="c"&gt;% -&amp;gt; error&lt;/span&gt;
&lt;span class="k"&gt;\expandafter\A\hoge&lt;/span&gt; &lt;span class="c"&gt;% -&amp;gt; \Afoofoobar -&amp;gt; f is oofoobar&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;例7&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;\edef&lt;/code&gt;中で&lt;code&gt;\noexpand&lt;/code&gt;をつければ、その直後の制御綴は（定義の際には）展開されません。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;\edef\hoge&lt;/span&gt;&lt;span class="nb"&gt;{&lt;/span&gt;&lt;span class="k"&gt;\noexpand\B\C&lt;/span&gt;&lt;span class="nb"&gt;}&lt;/span&gt; &lt;span class="c"&gt;% -&amp;gt; \def\hoge{\Bbar}&lt;/span&gt;
&lt;span class="k"&gt;\A\hoge&lt;/span&gt; &lt;span class="c"&gt;% -&amp;gt; error&lt;/span&gt;
&lt;span class="k"&gt;\expandafter\A\hoge&lt;/span&gt; &lt;span class="c"&gt;% -&amp;gt; \A\Bbar -&amp;gt; \B is bar -&amp;gt; \BB\BB is bar -&amp;gt; foofoo is bar&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;\A\Bbar&lt;/code&gt;で、第1引数は&lt;code&gt;\B&lt;/code&gt;、第1引数は&lt;code&gt;b&lt;/code&gt;です。&lt;/p&gt;
&lt;h3&gt;例8&lt;/h3&gt;
&lt;p&gt;別の例。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;\def\twice&lt;/span&gt;#1&lt;span class="nb"&gt;{&lt;/span&gt;#1#1&lt;span class="nb"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;\twice\twice&lt;/span&gt; hoge &lt;span class="c"&gt;% -&amp;gt; error&lt;/span&gt;
&lt;span class="k"&gt;\expandafter\twice\twice&lt;/span&gt;&lt;span class="nb"&gt;{&lt;/span&gt;ho&lt;span class="nb"&gt;}&lt;/span&gt;ge &lt;span class="c"&gt;% -&amp;gt; \twicehohoge -&amp;gt; hhohoge&lt;/span&gt;
&lt;span class="k"&gt;\expandafter\twice\twice&lt;/span&gt;&lt;span class="nb"&gt;{{&lt;/span&gt;ho&lt;span class="nb"&gt;}}&lt;/span&gt;ge &lt;span class="c"&gt;% -&amp;gt; \twice{ho}hoge -&amp;gt; hohohoge&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;1つ目は無限ループになります。&lt;/p&gt;
&lt;h2&gt;脚注&lt;/h2&gt;&lt;ol class="simple-footnotes"&gt;&lt;li id="sf-tex_expand-1"&gt;
制御綴に使える文字はcatcodeが11の文字（英字・日本語）。
従って、日本語の混ざった制御綴も作れる。
&lt;code&gt;\relax␣あ&lt;/code&gt;の場合は、&lt;code&gt;\relax&lt;/code&gt;という制御綴と「あ」という文字として認識されるが、&lt;code&gt;\relaxあ&lt;/code&gt;の場合は、&lt;code&gt;\relaxあ&lt;/code&gt;という制御綴として認識され（定義しない限り）エラーを吐く。
 &lt;a href="#sf-tex_expand-1-back" class="simple-footnote-back"&gt;↩&lt;/a&gt;&lt;/li&gt;&lt;/ol&gt;</content><category term="技術ブログ"></category><category term="その他言語"></category></entry><entry><title>プレゼン形式の動画からスライドのpdfを自動作成する＋OCRをつける</title><link href="/previews/refs/heads/general/jinja2_version/blog/2021/03/movie2pdf.html" rel="alternate"></link><published>2021-03-23T00:00:00+09:00</published><updated>2021-03-31T00:00:00+09:00</updated><author><name>山田</name></author><id>tag:None,2021-03-23:/previews/refs/heads/general/jinja2_version/blog/2021/03/movie2pdf.html</id><summary type="html">&lt;p&gt;昨年度はずっとオンラインの授業であったため、それに役立つようなプログラムを作ったりしていました。
中でも、
「プ …&lt;/p&gt;</summary><content type="html">&lt;p&gt;昨年度はずっとオンラインの授業であったため、それに役立つようなプログラムを作ったりしていました。
中でも、
「プレゼン形式の動画からスライドのpdfを自動作成する＋OCRをつける」
はかなり役立っています。&lt;/p&gt;
&lt;p&gt;zoomなどで授業がある際、教員によってはレジュメを配ってくれない場合もあります。
そんなときは授業動画を録画してmp4ファイルを準備すれば、自動でpdfを作ってくれる、というものです。&lt;/p&gt;
&lt;h2&gt;仕組み&lt;/h2&gt;
&lt;p&gt;流れとしては、&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;mp4を一定時間（10秒など）ごとの画像に分割&lt;/li&gt;
&lt;li&gt;それぞれの画像に対して、opencvで1つ前の画像との差分を取る&lt;/li&gt;
&lt;li&gt;差分を数値化してある値以上のものをはじく&lt;/li&gt;
&lt;li&gt;残った画像をpdfに変換して、まとめる&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;という感じです。詳しくはコードを見てみて下さい。
実行時間は数分なので、待てないほどではないです。&lt;/p&gt;
&lt;h2&gt;OCR&lt;/h2&gt;
&lt;p&gt;OCRを付けたい場合は、&lt;strong&gt;ocrmypdf&lt;/strong&gt;が無料で使える中では精度がいいので、学習データを少しいじって、スライド向けのオプションにすればそれなりに認識してくれます。&lt;/p&gt;
&lt;p&gt;&lt;a href="https://github.com/jbarlow83/OCRmyPDF"&gt;https://github.com/jbarlow83/OCRmyPDF&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;コーデックの変換&lt;/h2&gt;
&lt;p&gt;mp4についても、コーデックをH.265に変換してあげると、画質はほとんど変わらず容量がかなり削減されます。&lt;br&gt;
もしmp4も残しておきたいといった場合は、変換はffmpegで簡単にできるので、おすすめです。
（この変換はかなり時間がかかりますが...）&lt;/p&gt;
&lt;p&gt;参考：&lt;a href="https://life.craftz.dog/entry/save-storage-with-h265-ffmpeg"&gt;https://life.craftz.dog/entry/save-storage-with-h265-ffmpeg&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;プログラム&lt;/h2&gt;
&lt;p&gt;プログラムを載せておくので、使い方が分からない時は聞いて下さい。&lt;/p&gt;
&lt;h3&gt;movie2pdf.py&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# 使い方&lt;/span&gt;
&lt;span class="c1"&gt;# python movie2pdf.py -dir 実行フォルダのパス&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;argparse&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;subprocess&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;glob&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;cv2&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;shutil&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;
&lt;span class="c1"&gt;# pdfへ変換&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;PIL&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Image&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;img2pdf&lt;/span&gt;
&lt;span class="c1"&gt;# pdfをまとめる&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;re&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;PyPDF2&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;send2trash&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;send2trash&lt;/span&gt;

&lt;span class="c1"&gt;# コマンドライン引数の取得&lt;/span&gt;
&lt;span class="n"&gt;parser&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;argparse&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ArgumentParser&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;parser&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_argument&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;-dir&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;parser&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_argument&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;-num_f&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;default&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.5&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;args&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;parser&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parse_args&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dir&lt;/span&gt;
&lt;span class="n"&gt;num_frames&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;num_f&lt;/span&gt;
&lt;span class="c1"&gt;# floatに変換&lt;/span&gt;
&lt;span class="n"&gt;num_frames&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;float&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;num_frames&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# avi→mp4へ変換&lt;/span&gt;
&lt;span class="n"&gt;input_avi&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;input.avi&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exists&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;input_avi&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;cmd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;ffmpeg -i &lt;/span&gt;&lt;span class="si"&gt;{0}&lt;/span&gt;&lt;span class="s1"&gt; -vcodec libx265 -tag:v hvc1 &lt;/span&gt;&lt;span class="si"&gt;{1}&lt;/span&gt;&lt;span class="s1"&gt;input.mp4&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;input_avi&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;base_dir&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;subprocess&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cmd&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;shell&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Done! - avi2mp4&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Not Avi file&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# mp4→連番のpng&lt;/span&gt;
&lt;span class="n"&gt;input_mp4&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;input.mp4&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;makedirs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;photo&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;# 5秒に1枚のpngへ&lt;/span&gt;
&lt;span class="c1"&gt;# -rは1秒あたりのコマ数&lt;/span&gt;
&lt;span class="n"&gt;cmd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;ffmpeg -i &lt;/span&gt;&lt;span class="si"&gt;{0}&lt;/span&gt;&lt;span class="s1"&gt; -vcodec png -r &lt;/span&gt;&lt;span class="si"&gt;{1}&lt;/span&gt;&lt;span class="s1"&gt; &lt;/span&gt;&lt;span class="si"&gt;{2}&lt;/span&gt;&lt;span class="s1"&gt;photo/&lt;/span&gt;&lt;span class="si"&gt;%05d&lt;/span&gt;&lt;span class="s1"&gt;.png&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;input_mp4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;num_frames&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;base_dir&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;subprocess&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cmd&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;shell&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Done! - mp4topng&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# 連番png→重複除いてpdf作成&lt;/span&gt;
&lt;span class="c1"&gt;# ２値化&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;binarization&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;img&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;threshold&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;100&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;ret&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;img&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cv2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;threshold&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;img&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;threshold&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;cv2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;THRESH_BINARY&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;img&lt;/span&gt;

&lt;span class="c1"&gt;# 関数&lt;/span&gt;
&lt;span class="c1"&gt;# 差分を数値化&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;getDiff&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;path1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;path2&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c1"&gt;# 画像の読み込み&lt;/span&gt;
    &lt;span class="n"&gt;img1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cv2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;imread&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;path1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;img2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cv2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;imread&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;path2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="c1"&gt;# グレースケール変換&lt;/span&gt;
    &lt;span class="n"&gt;img1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cv2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cvtColor&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;img1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;cv2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;COLOR_BGR2GRAY&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;img2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cv2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cvtColor&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;img2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;cv2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;COLOR_BGR2GRAY&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="c1"&gt;# 差分取得&lt;/span&gt;
    &lt;span class="n"&gt;mask&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cv2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;absdiff&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;img1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;img2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="c1"&gt;# ２値化&lt;/span&gt;
    &lt;span class="n"&gt;mask&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;binarization&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mask&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;cv2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;countNonZero&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mask&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  &lt;span class="c1"&gt;# 白の要素数&lt;/span&gt;


&lt;span class="c1"&gt;# 重複を除く&lt;/span&gt;
&lt;span class="n"&gt;files&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;glob&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;glob&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;photo/*.png&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;files&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;sorted&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;files&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;list_frame_save&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt;  &lt;span class="c1"&gt;# 保存する画像のリスト&lt;/span&gt;
&lt;span class="n"&gt;threshold&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;10000&lt;/span&gt;  &lt;span class="c1"&gt;# しきい値&lt;/span&gt;

&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;files&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;diff&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;getDiff&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;files&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;files&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;diff&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;files&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remove&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;files&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
        &lt;span class="k"&gt;elif&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;diff&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;threshold&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;files&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remove&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;files&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;files&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
            &lt;span class="n"&gt;list_frame_save&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;files&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
            &lt;span class="n"&gt;files&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remove&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;files&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;

    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;break&lt;/span&gt;

&lt;span class="n"&gt;list_frame_save&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;list_frame_save&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;files&lt;/span&gt;

&lt;span class="c1"&gt;# ファイルのコピー&lt;/span&gt;
&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;makedirs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;save&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;list_frame_save&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;file_name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basename&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;shutil&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;copyfile&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;save/&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;file_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# pdfへ変換&lt;/span&gt;
&lt;span class="c1"&gt;# png→jpg&lt;/span&gt;
&lt;span class="c1"&gt;# 保存先のディレクトリを作成&lt;/span&gt;
&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;makedirs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;jpg&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;list_png&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;list_frame_save&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;list_png&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ext&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;splitext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;name_png&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)[&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;.jpg&amp;quot;&lt;/span&gt;
    &lt;span class="c1"&gt;# 変換&lt;/span&gt;
    &lt;span class="n"&gt;im&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Image&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;rgb_im&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;im&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;convert&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;RGB&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;rgb_im&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;save&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;jpg/&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;name_png&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# jpg→pdf&lt;/span&gt;
&lt;span class="n"&gt;path_jpg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;jpg/*.jpg&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;list_jpg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;glob&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;glob&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;path_jpg&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;# 保存先のディレクトリを作成&lt;/span&gt;
&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;makedirs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;pdf&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;list_jpg&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ext&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;splitext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;name_pdf&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)[&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;.pdf&amp;quot;&lt;/span&gt;
    &lt;span class="c1"&gt;# 変換&lt;/span&gt;
    &lt;span class="c1"&gt;# Pillowモジュールを使用し画像の読み込み&lt;/span&gt;
    &lt;span class="n"&gt;img&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Image&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="c1"&gt;# 画像→pdfファイルに変換&lt;/span&gt;
    &lt;span class="n"&gt;cov_pdf&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;img2pdf&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;convert&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="c1"&gt;# pdfファイルを読み込み（pdf_nameで指定したpdfがない場合、pdf_nameをファイル名として新規にpdfファイルを作成）&lt;/span&gt;
    &lt;span class="n"&gt;file&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;pdf/&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;name_pdf&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;wb&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="c1"&gt;# pdfファイルを書き込み&lt;/span&gt;
    &lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cov_pdf&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="c1"&gt;# 開いているファイルを閉じる&lt;/span&gt;
    &lt;span class="n"&gt;img&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="c1"&gt;# 複数のpdfファイルを結合する&lt;/span&gt;
&lt;span class="n"&gt;pdf_path&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;pdf/&amp;quot;&lt;/span&gt;

&lt;span class="n"&gt;merge&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;PyPDF2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;PdfFileMerger&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;j&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;sorted&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;listdir&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pdf_path&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;lambda&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;search&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;\d+&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;group&lt;/span&gt;&lt;span class="p"&gt;())):&lt;/span&gt;
    &lt;span class="n"&gt;merge&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pdf_path&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;/&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;merge&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;slide.pdf&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;merge&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="c1"&gt;# フォルダとファイルを削除&lt;/span&gt;
&lt;span class="n"&gt;shutil&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;rmtree&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;jpg&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;shutil&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;rmtree&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;pdf&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;send2trash&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;photo&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  &lt;span class="c1"&gt;# photoフォルダはごみ箱へ移動&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exists&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;input_avi&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;send2trash&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;base_dir&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;input.avi&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;pass&lt;/span&gt;

&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Done! All&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;実行方法&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;python movie2pdf.py -dir 実行フォルダのパス
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;movie2pdf_folder_ocr.sh&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;for&lt;/span&gt; file &lt;span class="k"&gt;in&lt;/span&gt; *.mp4&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt;
&lt;span class="c1"&gt;# echo $file&lt;/span&gt;
&lt;span class="nv"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;basename &lt;span class="nv"&gt;$file&lt;/span&gt; .mp4&lt;span class="k"&gt;)&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="nv"&gt;$name&lt;/span&gt;
&lt;span class="c1"&gt;# タイトルのフォルダを作成&lt;/span&gt;
mkdir &lt;span class="nv"&gt;$name&lt;/span&gt;
&lt;span class="c1"&gt;# mp4を移動＆名前変更&lt;/span&gt;
mv &lt;span class="nv"&gt;$file&lt;/span&gt; &lt;span class="nv"&gt;$name&lt;/span&gt;/input.mp4

&lt;span class="c1"&gt;# 変換実行&lt;/span&gt;
python ~/python/program/201214_mp4pdf/script/movie2pdf.py -dir ./&lt;span class="nv"&gt;$name&lt;/span&gt;/ -num_f &lt;span class="m"&gt;0&lt;/span&gt;.5
&lt;span class="c1"&gt;# OCR&lt;/span&gt;
ocrmypdf -l jpn --output-type pdfa --tesseract-pagesegmode &lt;span class="m"&gt;6&lt;/span&gt; --sidecar &lt;span class="nv"&gt;$name&lt;/span&gt;/output.txt &lt;span class="nv"&gt;$name&lt;/span&gt;/slide.pdf &lt;span class="nv"&gt;$name&lt;/span&gt;/slide_ocr.pdf
&lt;span class="c1"&gt;# outputのslide.pdfのタイトル変更&lt;/span&gt;
mv &lt;span class="nv"&gt;$name&lt;/span&gt;/slide.pdf &lt;span class="nv"&gt;$name&lt;/span&gt;/&lt;span class="nv"&gt;$name&lt;/span&gt;.pdf
mv &lt;span class="nv"&gt;$name&lt;/span&gt;/slide_ocr.pdf &lt;span class="nv"&gt;$name&lt;/span&gt;/&lt;span class="nv"&gt;$name_ocr&lt;/span&gt;.pdf
&lt;span class="k"&gt;done&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;指定のフォルダ内にて、  &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;sh movie2pdf_folder_ocr.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;注意事項&lt;/h2&gt;
&lt;p&gt;授業の録画は禁止されている場合もあると思うので、プログラムの利用は全て自己責任でお願いします。&lt;/p&gt;
&lt;p&gt;オンライン授業はテックに強いと快適に過ごせるため、今後もずっとオンラインでいいなと思ってしまいます。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="自動化"></category><category term="勉学支援"></category></entry><entry><title>attention勉強会2.5</title><link href="/previews/refs/heads/general/jinja2_version/blog/2021/03/studymeeting_attention25.html" rel="alternate"></link><published>2021-03-23T00:00:00+09:00</published><updated>2021-03-23T00:00:00+09:00</updated><author><name>安部</name></author><id>tag:None,2021-03-23:/previews/refs/heads/general/jinja2_version/blog/2021/03/studymeeting_attention25.html</id><summary type="html">&lt;p&gt;2021/03/21開催の勉強会の資料です。&lt;/p&gt;
&lt;h2&gt;スライド&lt;/h2&gt;
&lt;p&gt;&lt;p&gt;&lt;span class="videobox"&gt;
  &lt;iframe width=640" height="390"
    src="{attach}./attach/studymeeting_attention2.5/transformer勉強会2.5.pdf"
    frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen&gt;
  &lt;/iframe&gt;&lt;/span&gt;&lt;/p&gt;&lt;/p&gt;
&lt;p&gt;atma6,10にこっそり参加していました。
6はがちで何もわからず10はattentionが散ったので悲しみは深いですが、大変勉強になったので感謝しております。n番煎じですが軽くまとめてみました。&lt;/p&gt;
&lt;p&gt;非言語データについてw2vでの埋め込み　は　医療分野でも使用さ …&lt;/p&gt;</summary><content type="html">&lt;p&gt;2021/03/21開催の勉強会の資料です。&lt;/p&gt;
&lt;h2&gt;スライド&lt;/h2&gt;
&lt;p&gt;&lt;p&gt;&lt;span class="videobox"&gt;
  &lt;iframe width=640" height="390"
    src="{attach}./attach/studymeeting_attention2.5/transformer勉強会2.5.pdf"
    frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen&gt;
  &lt;/iframe&gt;&lt;/span&gt;&lt;/p&gt;&lt;/p&gt;
&lt;p&gt;atma6,10にこっそり参加していました。
6はがちで何もわからず10はattentionが散ったので悲しみは深いですが、大変勉強になったので感謝しております。n番煎じですが軽くまとめてみました。&lt;/p&gt;
&lt;p&gt;非言語データについてw2vでの埋め込み　は　医療分野でも使用されているというのをRSNA2019を一緒にやった中村さんのスライドで見た気もするので大反省です...&lt;/p&gt;
&lt;p&gt;皆さんは初手BERT,w2vをキメれるようにこれを思い出していただけると幸いです。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="勉強会"></category><category term="Machine Learning"></category><category term="Data Science Competition"></category></entry><entry><title>attention勉強会2</title><link href="/previews/refs/heads/general/jinja2_version/blog/2021/03/studymeeting_attention2.html" rel="alternate"></link><published>2021-03-14T00:00:00+09:00</published><updated>2021-03-19T00:00:00+09:00</updated><author><name>安部</name></author><id>tag:None,2021-03-14:/previews/refs/heads/general/jinja2_version/blog/2021/03/studymeeting_attention2.html</id><summary type="html">&lt;p&gt;2021/03/14開催の勉強会の資料です。
最近attentionの流行を肌で感じだし、焦って勉強しています。&lt;/p&gt;
&lt;h2&gt;スライド&lt;/h2&gt;
&lt;p&gt;&lt;p&gt;&lt;span class="videobox"&gt;
  &lt;iframe width=640" height="390"
    src="{attach}./attach/studymeeting_attention2/transformer勉強会2.pdf"
    frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen&gt;
  &lt;/iframe&gt;&lt;/span&gt;&lt;/p&gt;&lt;/p&gt;
&lt;h2&gt;maskについての訂正&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;softmax(QK)についてではなく、QKにmaskをかけます。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Linformer&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;D(Q,K,V)=softmax(QK)VのQKが低ランク&lt;/li&gt;
&lt;li&gt;L(Q,K,V)=softmax(Q(EK))(FV)と、E …&lt;/li&gt;&lt;/ul&gt;</summary><content type="html">&lt;p&gt;2021/03/14開催の勉強会の資料です。
最近attentionの流行を肌で感じだし、焦って勉強しています。&lt;/p&gt;
&lt;h2&gt;スライド&lt;/h2&gt;
&lt;p&gt;&lt;p&gt;&lt;span class="videobox"&gt;
  &lt;iframe width=640" height="390"
    src="{attach}./attach/studymeeting_attention2/transformer勉強会2.pdf"
    frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen&gt;
  &lt;/iframe&gt;&lt;/span&gt;&lt;/p&gt;&lt;/p&gt;
&lt;h2&gt;maskについての訂正&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;softmax(QK)についてではなく、QKにmaskをかけます。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Linformer&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;D(Q,K,V)=softmax(QK)VのQKが低ランク&lt;/li&gt;
&lt;li&gt;L(Q,K,V)=softmax(Q(EK))(FV)と、E,Fをかけて次元を落とす&lt;/li&gt;
&lt;li&gt;maskはQKにかけるのではなく、K,V,(Q)にかける&lt;/li&gt;
&lt;li&gt;高速化は未確認...&lt;/li&gt;
&lt;/ul&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category><category term="勉強会"></category><category term="論文まとめ"></category></entry><entry><title>Atcoder 緑になりました</title><link href="/previews/refs/heads/general/jinja2_version/blog/2020/09/atcoder_green.html" rel="alternate"></link><published>2020-09-25T00:00:00+09:00</published><updated>2020-09-25T00:00:00+09:00</updated><author><name>淡田</name></author><id>tag:None,2020-09-25:/previews/refs/heads/general/jinja2_version/blog/2020/09/atcoder_green.html</id><summary type="html">&lt;p&gt;9月から実習が始まって進捗が落ちてます、5年生の淡田です。&lt;/p&gt;
&lt;p&gt;先週のABC179コンテストで緑になりました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="green" src="{attach}./images/atcoder_green_figs/rating_graph.png"&gt;&lt;/p&gt;
&lt;p&gt;（GREEEN　( ´ ▽ ` )）&lt;/p&gt;
&lt;h2&gt;やったこと&lt;/h2&gt;
&lt;p&gt;問題を解きまくりました（現在Atcoderで400ACくらい）。&lt;/p&gt;
&lt;p&gt;8月はC問題を中心に、9月からD問題からE問題を中心に解いた感じです。&lt;/p&gt;
&lt;p&gt;Cあたりはちょっと工夫する全探索、みたいなのが多く、片っ端から解いて知らないア …&lt;/p&gt;</summary><content type="html">&lt;p&gt;9月から実習が始まって進捗が落ちてます、5年生の淡田です。&lt;/p&gt;
&lt;p&gt;先週のABC179コンテストで緑になりました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="green" src="{attach}./images/atcoder_green_figs/rating_graph.png"&gt;&lt;/p&gt;
&lt;p&gt;（GREEEN　( ´ ▽ ` )）&lt;/p&gt;
&lt;h2&gt;やったこと&lt;/h2&gt;
&lt;p&gt;問題を解きまくりました（現在Atcoderで400ACくらい）。&lt;/p&gt;
&lt;p&gt;8月はC問題を中心に、9月からD問題からE問題を中心に解いた感じです。&lt;/p&gt;
&lt;p&gt;Cあたりはちょっと工夫する全探索、みたいなのが多く、片っ端から解いて知らないアルゴリズムは覚えてパターンを習得する、を繰り返せば躓くことは減ったと思います、&lt;/p&gt;
&lt;p&gt;Dあたりから考察系が増えて、「このアルゴリズム使ったらいちころやん！」系が減って１問あたりに時間をかけることが増えた印象です。&lt;/p&gt;
&lt;p&gt;勿論、アルゴリズムも大事でむしろそれは前提に考察を加えて応用できるかが重要になっているなぁという感じ。&lt;/p&gt;
&lt;p&gt;まぁこっからが大変なんでしょうね・・・。&lt;/p&gt;
&lt;p&gt;他にはAtCoderでは&lt;a href="https://qiita.com/e869120/items/eb50fdaece12be418faa"&gt;有名なこの記事&lt;/a&gt;の100問を現在60問くらい解きました。&lt;/p&gt;
&lt;p&gt;流石は天才高校生（レッドコーダの方・・・）、超良記事ですね。&lt;/p&gt;
&lt;p&gt;まじこの記事の100問やればメキメキ上達するんじゃないでしょうか。&lt;/p&gt;
&lt;p&gt;もしやってない方は是非見てください。&lt;/p&gt;
&lt;h2&gt;これから&lt;/h2&gt;
&lt;p&gt;水色になりたい（直球）。&lt;/p&gt;
&lt;p&gt;最近のコンテストはD,E系の難易度が低めで早解きでパフォが出てる感が否めないのでコッテリしたセットが来たら叩きのめされる未来しか・・・。&lt;/p&gt;
&lt;p&gt;今週はABCがないので次回までに精進を重ねます。&lt;/p&gt;
&lt;h2&gt;補足&lt;/h2&gt;
&lt;p&gt;競プロといえばC++、という感じですが、pythonでも強い方は探すといるにはいるみたいです。&lt;/p&gt;
&lt;p&gt;&lt;a href="https://maspypy.com"&gt;この方&lt;/a&gt;の記事とかよく見たりしてます。よければどうぞ。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="競技プログラミング"></category></entry><entry><title>【勉強会資料 2020 第8回】 視覚とSparse coding</title><link href="/previews/refs/heads/general/jinja2_version/blog/2020/08/studymeeting2020_08.html" rel="alternate"></link><published>2020-08-21T00:00:00+09:00</published><updated>2020-08-21T00:00:00+09:00</updated><author><name>山本</name></author><id>tag:None,2020-08-21:/previews/refs/heads/general/jinja2_version/blog/2020/08/studymeeting2020_08.html</id><summary type="html">&lt;p&gt;2020.08.21に行われた第8回勉強会のオンライン勉強会の資料を公開します。視覚生理学の基礎と第一次視覚野(V1)のモデルであるSparse codingモデル (Olshausen &amp;amp; Field, 1996) の説明を行いました。Sparse codingモデルをPythonで実装し、ガボールフィルタ …&lt;/p&gt;</summary><content type="html">&lt;p&gt;2020.08.21に行われた第8回勉強会のオンライン勉強会の資料を公開します。視覚生理学の基礎と第一次視覚野(V1)のモデルであるSparse codingモデル (Olshausen &amp;amp; Field, 1996) の説明を行いました。Sparse codingモデルをPythonで実装し、ガボールフィルタが生じることを確認しました 。また、単純細胞の受容野をよく再現するガボールフィルタの描画と画像への適応や、自然画像に対するICA・PCAについても紹介しました。&lt;/p&gt;
&lt;h2&gt;使用したNotebook&lt;/h2&gt;
&lt;p&gt;&lt;a href="{attach}./attach/studymeeting2020_08/第8回勉強会_sparse_coding.ipynb"&gt;Jupyter Notebook&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;紹介スライド&lt;/h2&gt;
&lt;p&gt;&lt;p&gt;&lt;span class="videobox"&gt;
  &lt;iframe width=640" height="500"
    src="{attach}./attach/studymeeting2020_08/第8回勉強会_視覚とSparsecoding.pdf"
    frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen&gt;
  &lt;/iframe&gt;&lt;/span&gt;&lt;/p&gt;&lt;/p&gt;
&lt;h2&gt;参考資料&lt;/h2&gt;
&lt;p&gt;発表者が作成しているサイトに、Sparse codingモデルの生成モデルとしての解説を掲載しています (Julia実装)。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://compneuro-julia.github.io/11-2_sparse-coding.html"&gt;11.2 Sparse coding (Olshausen &amp;amp; Field, 1996) モデル — Juliaで学ぶ計算論的神経科学&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><category term="技術ブログ"></category><category term="勉強会"></category><category term="Neuroscience"></category></entry><entry><title>医学部公認団体として正式承認されました</title><link href="/previews/refs/heads/general/jinja2_version/news/2020/07/officialize_accept.html" rel="alternate"></link><published>2020-07-06T00:00:00+09:00</published><updated>2020-07-08T00:00:00+09:00</updated><author><name>Python会</name></author><id>tag:None,2020-07-06:/previews/refs/heads/general/jinja2_version/news/2020/07/officialize_accept.html</id><summary type="html">&lt;p&gt;これまでのお知らせの通り、本会 (情報医科学研究会) は大阪大学医学部に&lt;a href="/previews/refs/heads/general/jinja2_version/news/2020/05/officialize_request.html"&gt;公認団体申請&lt;/a&gt;を行っていましたが、このたび&lt;strong&gt;その承認が正式に決定&lt;/strong&gt;した旨の通知を受けましたのでお知らせします。&lt;/p&gt;
</summary><content type="html">&lt;p&gt;これまでのお知らせの通り、本会 (情報医科学研究会) は大阪大学医学部に&lt;a href="/previews/refs/heads/general/jinja2_version/news/2020/05/officialize_request.html"&gt;公認団体申請&lt;/a&gt;を行っていましたが、このたび&lt;strong&gt;その承認が正式に決定&lt;/strong&gt;した旨の通知を受けましたのでお知らせします。&lt;/p&gt;
&lt;!-- PELICAN_END_SUMMARY --&gt;

&lt;h2&gt;公認許可&lt;/h2&gt;
&lt;p&gt;「&lt;strong&gt;医学部公認学生団体結成届の審議結果について&lt;/strong&gt;」と題する医学科学生支援委員会委員長名の文書が、本日 (7/6) 付で交付されました。
以下はその全文です。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;標記について、医学部学生支援委員会等で審議の結果、承認されましたことをお知らせします。
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;規約の修正&lt;/h2&gt;
&lt;p&gt;公認審査の過程で、&lt;a href="/previews/refs/heads/general/jinja2_version/news/2020/06/formalname.html"&gt;先に改定&lt;/a&gt;した規約の一部に再度指摘を受け、修正を行うことになりました。
一部を再改定した&lt;a href="{filename}/pages/constitution.md"&gt;規約の全文&lt;/a&gt;は、改定予定日付である7/11頃より掲載いたします。
修正はいずれも公認に伴う技術的なもので、実際の会運営・会活動等への影響はありません。&lt;/p&gt;
&lt;h2&gt;御礼&lt;/h2&gt;
&lt;p&gt;これまで有形無形にご支援を頂いてきた学内外の皆様、公認審査を頂いた大阪大学医学部医学科学生支援委員会、医学部教務室学生支援係をはじめ、関係者の皆様に厚く御礼申し上げます。&lt;/p&gt;
&lt;p&gt;今後とも大阪大学医学部Python会 (情報医科学研究会) を何卒よろしくお願いいたします。&lt;/p&gt;</content><category term="お知らせ"></category><category term="News"></category></entry><entry><title>Python会とPythonとPython会で使われているPython</title><link href="/previews/refs/heads/general/jinja2_version/blog/2020/07/pythonparty_and_python.html" rel="alternate"></link><published>2020-07-03T00:00:00+09:00</published><updated>2020-07-03T00:00:00+09:00</updated><author><name>小川</name></author><id>tag:None,2020-07-03:/previews/refs/heads/general/jinja2_version/blog/2020/07/pythonparty_and_python.html</id><summary type="html">&lt;p&gt;Python会は、Pythonを主に勉強したり研究に使ったりしています。
また、会の運営上の道具としてもPythonを利用しています。&lt;/p&gt;
&lt;p&gt;なぜPython会ではPythonなのか、そして研究以外で例えばどのように使っているか、あらためて紹介し …&lt;/p&gt;</summary><content type="html">&lt;p&gt;Python会は、Pythonを主に勉強したり研究に使ったりしています。
また、会の運営上の道具としてもPythonを利用しています。&lt;/p&gt;
&lt;p&gt;なぜPython会ではPythonなのか、そして研究以外で例えばどのように使っているか、あらためて紹介してみたいと思います。&lt;/p&gt;
&lt;p&gt;(主に新入会員向けの内容です。
すべて個人の見解です。
あと技術ブログなのに技術的内容には乏しいですがご容赦を。。)&lt;/p&gt;
&lt;h2&gt;なぜPythonか？&lt;/h2&gt;
&lt;p&gt;まず前半ではあらためて、なぜPython会ではPythonを学んでいるのか？
についての僕なりの説明を試みてみたいと思います。&lt;/p&gt;
&lt;h3&gt;プログラミング言語宗教戦争&lt;/h3&gt;
&lt;p&gt;プログラミング言語の選択は宗教であるとも言われます。
実際に、プログラミング言語宗教論争あるいは宗教戦争のようなものは、人類誕生以来幾度となく繰り返されてきました。&lt;/p&gt;
&lt;p&gt;これはとても根強いもので、例えば本会「Python会」の名前を見るだけで、あいつらも宗教だ、などと言う人もきっといます。
[&lt;a href="#note1"&gt;注1&lt;/a&gt;]&lt;/p&gt;
&lt;p&gt;そういう全ての言語が敵に見えるような仁義なき宗教戦争の中にあって、とりわけPythonは、支持者も多いが敵も多い、といった印象があります。
また他の言語ではC++などもそうです。
なぜでしょうか。&lt;/p&gt;
&lt;h3&gt;汎用言語としてのPython&lt;/h3&gt;
&lt;p&gt;これもまったく個人的な見解ですが、PythonとC++、両者の共通点は、きわめて汎用的で、あらゆるところで使われていることです。
[&lt;a href="#note2"&gt;注2&lt;/a&gt;]&lt;br&gt;
それゆえ、あらゆる分野で他言語派から敵視されたりもするわけです。&lt;/p&gt;
&lt;p&gt;Python会では名前の通り、主にPythonを中心に (「だけ」ではないですが) 学ぶことにしています。
Pythonを選ぶことの利点を、新入会員の人たちは勉強会などでもいくつか聞いたかもしれませんが、僕は&lt;strong&gt;この汎用性が最大のポイント&lt;/strong&gt;だと思います。
実際、これほどあらゆる分野で、＜高度かつ不安定な技術で無理矢理に＞などではなく、普通に一線の言語として使えるものは他に選択肢がないと言っても過言ではありません。&lt;/p&gt;
&lt;p&gt;Python会では、やはり基本的に多くの人が医科学系の学術研究に興味を持っているので、その観点の話を聞くことは多いでしょう。
それだけでも、内容・分野は多様多岐にわたります。
でも同じPythonで、さらにその他にももっと色々なことができます。
その例はこのブログの記事にも多数あります。
最近のリレー投稿でも時々登場していますよね。
本稿の後半で紹介するのも、そのような例の一部です。&lt;/p&gt;
&lt;p&gt;あるいは例えばMacにはPythonが標準で入っていますが、それはシステムの一部がPythonで書かれているからです。
&lt;a href="https://www.youtube.com"&gt;YouTube&lt;/a&gt;や&lt;a href="https://www.dropbox.com"&gt;Dropbox&lt;/a&gt;など多くのサービスやアプリケーションも、Pythonを主力として開発されています。&lt;/p&gt;
&lt;h3&gt;広い世界を見る&lt;/h3&gt;
&lt;p&gt;逆の方向を考えてみましょう。
各個別分野には、それぞれのガラパゴス化した世界が確かにあります。
様々な言語が使われています。
研究室などに入っても、Pythonなんかやめてウチの業界ではこの言語を使え、このソフトを使え、とか&lt;s&gt;偉そうに言ってくる&lt;/s&gt;おすすめしてくれる人たちはいるかもしれません。&lt;/p&gt;
&lt;p&gt;でも基本的には&lt;strong&gt;できるだけ耳を貸さない方がいい&lt;/strong&gt;です。
タコ壺です。
その人たちには物凄く狭い世界しか見えていません。
その人たちとは違ってこれから多くの可能性と選択肢のある若者が、真に受けてはいけません。
[&lt;a href="#note3"&gt;注3&lt;/a&gt;]&lt;br&gt;
実際の個別分野の研究でも、Pythonが使い物にならない分野なんてどこにあるのか？とも思います。
[&lt;a href="#note4"&gt;注4&lt;/a&gt;]&lt;/p&gt;
&lt;p&gt;まあともかく、Pythonはそんな言語です。
もちろん多くの言語を習得し、場面に応じて使いこなせればそれが一番です。
でも医学系の人は基本的にはそれが本職でも、そこまで暇でもありません。
それなら、適所だといってガラパゴス言語に集中するより、&lt;strong&gt;Pythonを通して色んな分野や世界を見る&lt;/strong&gt;ことができた方がいい。
どちらも高いレベルでできるなら勿論よいですが、どちらかであれば圧倒的に後者がいい。
僕はそう考えています。&lt;/p&gt;
&lt;h2&gt;Python会で使われているPython&lt;/h2&gt;
&lt;p&gt;ここから後半です。
Python会自身が、会の運営用途などでどのようにPythonを活用しているか、各主要開発者等了承のもとで少しだけ例をあげて紹介します。&lt;/p&gt;
&lt;p&gt;同じ言語で同じPython会ですが、&lt;strong&gt;研究用途とは全く違う使い方&lt;/strong&gt;です。
(繰り返しですが、それができるのがPythonです。)&lt;/p&gt;
&lt;h3&gt;会Webサイトの作成運営&lt;/h3&gt;
&lt;p&gt;この&lt;a href="https://oumpy.github.io"&gt;Python会Webサイト&lt;/a&gt;は、Pythonで作られています。
正確にはPythonで書かれた&lt;a href="https://blog.getpelican.com"&gt;Pelican&lt;/a&gt;というシステムを使い、各ページのhtmlファイルなどを自動生成しています。
[&lt;a href="#note5"&gt;注5&lt;/a&gt;]&lt;/p&gt;
&lt;p&gt;設定ファイルはすべてPythonコードで (変数の値などを) 書き、独自機能を追加したい時はPythonでプラグインを書きます (現在、Python会Webサイトオリジナルのものが10個程度あります) 。
その他の補助ツール群も、Pythonとシェルスクリプトの組み合わせで作られています。&lt;/p&gt;
&lt;p&gt;この用途に限れば、Python一択ということは別段ありません。
GitHubが標準として採用しているのはPelicanと似た&lt;a href="https://jekyllrb.com"&gt;Jekyll&lt;/a&gt;というシステムで、こちらはPythonでなくRubyです。
[&lt;a href="#note6"&gt;注6&lt;/a&gt;]&lt;br&gt;
またJavaScriptベースのものなども人気があります。&lt;/p&gt;
&lt;p&gt;しかし前記の通り、共通言語のPythonで書かれていれば、最低限のことは会員誰でも見ればわかります。
興味を持ったらすぐに勉強することができます。
コード資産のロストテクノロジー化を防ぐ意味でも、これは結構大事です。
&lt;strong&gt;Rubyの得意な先輩が卒業したらシステムを管理できる人がいなくなった&lt;/strong&gt;、では笑えないですからね。&lt;/p&gt;
&lt;p&gt;なお現Webサイトの原型はPelicanの選択も含めてOBの&lt;a href="/previews/refs/heads/general/jinja2_version/author/ping-gang.html"&gt;平岡&lt;/a&gt;さんによるもので、さすがの慧眼だと思います。&lt;/p&gt;
&lt;h3&gt;Slack Botの作成運用&lt;/h3&gt;
&lt;p&gt;Slackで自動的にお知らせなどを流してくれる、あれです。
現在はoumpyというBotをSlackに配置し、その裏で2種類のPythonプログラムを独立に動かしています。&lt;/p&gt;
&lt;p&gt;Bot作成に関しても再び、これだけなら必ずしもPythonでなくてもいいです。
Web検索してみると、むしろJavaScript系言語の方が多いくらいです。
でもPythonを選んでいるのは、やはり上記と同じ理由です。
例えば&lt;strong&gt;医科学研究で解析にJavaScriptを使う人&lt;/strong&gt;などはさすがにあまり聞いたことがないし、そのあたりが再び、狭い特定用途だけを見ていてはわからない違いになります。&lt;/p&gt;
&lt;h4&gt;リレー投稿の順番お知らせ&lt;/h4&gt;
&lt;p&gt;リレー投稿ちゃんねるのメンバーリストを見て、次週の担当をお知らせするBot。
会ではすっかりお馴染みに？なりました。&lt;/p&gt;
&lt;p&gt;順番を保ちつつ、途中の入退会にも対応するとか、祝日はお休みとか、実はそれなりに複雑な要素があります。
順番予定を投稿したり、リマインダを出したり、スレッド内とチャンネル投稿を切り替えるなど、必要に応じて使える豊富なオプション機能もあります。&lt;/p&gt;
&lt;p&gt;会員有志により、すべてPythonで一から書かれています。
[&lt;a href="#note7"&gt;注7&lt;/a&gt;]&lt;/p&gt;
&lt;h4&gt;AtCoder AC数ランキング&lt;/h4&gt;
&lt;p&gt;毎週毎月、あるいは半期や年度ごとに、&lt;a href="https://kenkoooo.com/atcoder/"&gt;AtCoder Problems&lt;/a&gt;をチェックし、各人が&lt;a href="https://atcoder.jp"&gt;AtCoder&lt;/a&gt;で期間内に新しく解いた問題数 (AC数) を、会内ランキングにして発表。
途中経過を出す機能もあり、実際に利用しています。&lt;/p&gt;
&lt;p&gt;実は作られたのはこちらが先で、上記のリレー投稿Botはその改造版です (競プロのPython会への貢献例) 。
他の人が頑張っているのをランキングで見ると、自分もちょっとやる気になったりしますよね。&lt;/p&gt;
&lt;h3&gt;競技プログラミング&lt;/h3&gt;
&lt;p&gt;Python会存立に必須と言っても過言ではない (個人的見解) 競技プログラミング (主にAtCoder) には、もちろん多くの会員がPythonを主力言語として参戦しています。&lt;/p&gt;
&lt;p&gt;今年行われたシステム更新で、実行速度上のハンデは従来よりもさらに小さくなりました。
少なくとも初心者向けのABC (AtCoder Beginner Contest) の範囲では、Pythonで時間内に解けないような問題はまず出ません。
&lt;strong&gt;Python一本で、イエローコーダー (レート2000以上) までは最低でも到達可能&lt;/strong&gt;です。
その先はそれが見えてから考えればいいです。&lt;/p&gt;
&lt;h2&gt;まとめ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Pythonは汎用言語&lt;ul&gt;
&lt;li&gt;これを通じて色んな分野、色んな世界を見よう&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;研究以外にもPython会で実用的に使っているPython&lt;ul&gt;
&lt;li&gt;Webサイト作成、Bot作成、競プロなど&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;何でもPythonでやってみよう！！&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;おしまい。&lt;/p&gt;
&lt;h2&gt;注記&lt;/h2&gt;
&lt;h3&gt;&lt;span id="note1"&gt;&lt;/span&gt;注1 : 「Python会は宗教」&lt;/h3&gt;
&lt;p&gt;まあ大抵、こういうことを言う人自身の方が実はもっとずっと、プログラミング言語の宗教性に囚われているものではあります。&lt;/p&gt;
&lt;h3&gt;&lt;span id="note2"&gt;&lt;/span&gt;注2 : PythonとC++の汎用性&lt;/h3&gt;
&lt;p&gt;この2言語の間でも、汎用性の意味や形はかなり異なります。
両言語が直接競合する場面は比較的限定的で、相互補完的に使われることが多いと思います。
例えば医科学研究でC++をガリガリ書く場面などは、
(分子シミュレーションなど一部分野を除き)
そう中々あるものではないでしょう。&lt;/p&gt;
&lt;p&gt;また元々Pythonで確立・実装されたソフトウェアやライブラリを、実行速度その他のためにC++で再実装することなどは珍しくありません。
(例 : &lt;a href="https://chainer.org"&gt;Chainer&lt;/a&gt; → &lt;a href="https://pytorch.org"&gt;PyTorch&lt;/a&gt;)&lt;/p&gt;
&lt;h3&gt;&lt;span id="note3"&gt;&lt;/span&gt;注3 : 耳を貸さない、真に受けない&lt;/h3&gt;
&lt;p&gt;一方で&lt;strong&gt;大人の事情&lt;/strong&gt;はどこにもありますから、社会人としてのお付き合いもほどほどに大切ではあります。&lt;/p&gt;
&lt;p&gt;あとPythonをやめるのではなく他のものもちょっとやってみること自体は、もちろん勉強にもなるし全く悪いことではありません。&lt;/p&gt;
&lt;h3&gt;&lt;span id="note4"&gt;&lt;/span&gt;注4 : Pythonが使い物にならない分野&lt;/h3&gt;
&lt;p&gt;汎用性の低い特定言語等が分野内で業界標準となっており、技術的にはともかくコミュニティとして、それを使わないと相手にされないケースなどはなくはないと思います。&lt;/p&gt;
&lt;p&gt;ただ、そういうところは遠からず分野コミュニティごと滅びないか、と側から見て心配ではあります。&lt;/p&gt;
&lt;h3&gt;&lt;span id="note5"&gt;&lt;/span&gt;注5 : Pelican&lt;/h3&gt;
&lt;p&gt;システムはすばらしいのですが名前が一般名詞すぎて、ググラビリティが異常に低いのが難点です。
公式サイトには、名前の由来として&lt;strong&gt;なんとかのアナグラムであるとか意味不明なこと&lt;/strong&gt;が書かれています。
アナグラム前の方がましだよ。。&lt;/p&gt;
&lt;h3&gt;&lt;span id="note6"&gt;&lt;/span&gt;注6 : Ruby&lt;/h3&gt;
&lt;p&gt;まつもとゆきひろ氏開発の日本原産プログラミング言語。
中途半端なPythonとは違い完全オブジェクト志向であるなど、それ自体は非常に優れた言語です
(と、理解しています。
普段自分では全く使いませんが) 。&lt;/p&gt;
&lt;p&gt;現在はWeb系言語の色彩が強いですが、環境が整えば、将来&lt;strong&gt;Pythonに匹敵する汎用言語として台頭する可能性&lt;/strong&gt;も、あるんじゃないのかなと思っています。
今すぐ、とはいきませんが。。&lt;/p&gt;
&lt;h3&gt;&lt;span id="note7"&gt;&lt;/span&gt;注7 : Pythonで一から書かれている&lt;/h3&gt;
&lt;p&gt;PythonはC/C++などと同じく、配列添字が &lt;code&gt;0&lt;/code&gt; から始まる 0-indexed 言語です。
なので仮に完全フルスクラッチなら、「&lt;strong&gt;零から書かれている&lt;/strong&gt;」と言う方が正しいです。
しかし本Botの場合、さすがにライブラリの類は&lt;a href="https://github.com/slackapi/python-slackclient"&gt;Slack API&lt;/a&gt;をはじめ色々使われており、零からは言い過ぎ、よって一から、ということになります。
(うん、つまんないですね、、失礼しました。)&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Python"></category></entry><entry><title>幅優先探索の話 (競プロの話)</title><link href="/previews/refs/heads/general/jinja2_version/blog/2020/06/competition_bfs.html" rel="alternate"></link><published>2020-06-27T00:00:00+09:00</published><updated>2020-06-27T00:00:00+09:00</updated><author><name>淡田</name></author><id>tag:None,2020-06-27:/previews/refs/heads/general/jinja2_version/blog/2020/06/competition_bfs.html</id><summary type="html">&lt;p&gt;こんばんは、医学部5年の淡田です。&lt;/p&gt;
&lt;p&gt;自粛につぐ自粛でどうぶつの森で魚ばっか釣ってる日々であんま話すことがなかったのでちょっと競プロの話&lt;/p&gt;
&lt;h2&gt;競プロって？&lt;/h2&gt;
&lt;p&gt;競技プログラミングの略 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;こんばんは、医学部5年の淡田です。&lt;/p&gt;
&lt;p&gt;自粛につぐ自粛でどうぶつの森で魚ばっか釣ってる日々であんま話すことがなかったのでちょっと競プロの話&lt;/p&gt;
&lt;h2&gt;競プロって？&lt;/h2&gt;
&lt;p&gt;競技プログラミングの略で、問題が与えられてそれをプログラミングで解決していくコンテスト。&lt;/p&gt;
&lt;p&gt;問題によって縛りがあって
「○○時間内に解けよ」
って制約がある。
なので愚直に解こうとすると
「あなたの書いたコードは終わるのに5秒も掛かっちゃってます！遅すぎ！」
ってなる。
よって問題によっては工夫が必要になる。&lt;/p&gt;
&lt;h2&gt;アルゴリズム&lt;/h2&gt;
&lt;p&gt;他にも単純に問題むずくて工夫しないと汗、パターンもあるので難易度が上がると手の込んだ手法・手順が必要となる。&lt;/p&gt;
&lt;p&gt;それがアルゴリズム（ざっくりしすぎ・・・？）&lt;/p&gt;
&lt;p&gt;今回はその中で幅優先探索というやり方を説明する。
といってもそんなに難しくないので気軽に聞いてくださいまし。&lt;/p&gt;
&lt;h2&gt;実際の問題&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://atcoder.jp/contests/abc168/tasks/abc168_d"&gt;https://atcoder.jp/contests/abc168/tasks/abc168_d&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;↑問題はこれ。
詳しい説明は省きますが、ざっくり言うと&lt;/p&gt;
&lt;p&gt;&lt;img alt="graph-image" src="{attach}./images/competition_BFS_figs/image.png"&gt;&lt;/p&gt;
&lt;p&gt;「上記のような感じで部屋と部屋とが繋がってるぞ
(入力のところでどの部屋と部屋が繋がってるかが与えられる。
上のはそれを図にした) 。
それぞれの部屋から最短で①に行く方法を探せ (３→４→２→１みたいな) 。
探したら最短経路を辿るためには、例えばaの部屋は次にどこに向かえばいいかを出力しろ。
複数あったら一個でいいぞ」&lt;/p&gt;
&lt;p&gt;って問題。
なんとなくやることはわかるけど実際にプログラミングじゃどう書くのだろうってなる。&lt;/p&gt;
&lt;h2&gt;幅優先探索について&lt;/h2&gt;
&lt;p&gt;結論からいうとこれは幅優先探索を使えば簡単に解ける。&lt;/p&gt;
&lt;p&gt;はじめの状態→最短1回の遷移 (移動) でたどり着ける状態を探す→最短2回の遷移 (移動) でたどり着ける状態探す・・・&lt;/p&gt;
&lt;p&gt;を上の例で行けば「①から1回で移動できるのは②、⑤→②、⑤から1回で移動できるのは④・・・という風に探索していく。&lt;/p&gt;
&lt;p&gt;イメージ数学の問題で出てきた「点Aから点Bへの最短で行くのは何通りか？」みたいなのと似ている。&lt;/p&gt;
&lt;h2&gt;実装&lt;/h2&gt;
&lt;p&gt;実際にコードを書いてみる
(初めて書いたからスマートでないところはあるかも・・・。
悪しからず)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;まずは入力される &lt;code&gt;n&lt;/code&gt;, &lt;code&gt;m&lt;/code&gt; をget。&lt;/p&gt;
&lt;p&gt;今回はゴールである①の部屋にはどうすればいけるか？
というのが問題。
すると繰り返し上の例でいくと①の部屋には②と⑤が隣り合ってるから②と⑤は最短1回。
②と⑤と隣り合っているのは④だから・・・という風に探索していくと、「どの部屋とどの部屋が隣り合っているか」が重要になる。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;list_tonari&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[[]&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;ここで空の &lt;code&gt;[]&lt;/code&gt; が &lt;code&gt;n&lt;/code&gt; 個あるリストを作る。
1個目の &lt;code&gt;[]&lt;/code&gt; には①と隣り合った部屋の番号を、2個目には②と隣り合った部屋の番号を入れていく。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
  &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
  &lt;span class="n"&gt;list_tonari&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="n"&gt;list_tonari&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;以上で隣り合うリスト完成。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;ans&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;ここで答え用のリストを作る。
たとえば「5の部屋から最短で1に向かうには次に3の部屋いけばいいんやで」となったら &lt;code&gt;ans&lt;/code&gt; の5番目の &lt;code&gt;0&lt;/code&gt; を &lt;code&gt;3&lt;/code&gt; に変える、という風にしていく。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;temp&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;temp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;今現在どこの部屋にいるかのリストをつくる。
上の例だと最初は &lt;code&gt;1&lt;/code&gt;、次は &lt;code&gt;2&lt;/code&gt;、&lt;code&gt;5&lt;/code&gt; みたいな。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;temp2&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;temp&lt;/code&gt; を随時更新するので臨時の別のリストもつくる。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
  &lt;span class="n"&gt;temp2&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;temp&lt;/span&gt;
  &lt;span class="n"&gt;temp&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt;

  &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;temp2&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;temp2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;list_tonari&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;]:&lt;/span&gt;
      &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;ans&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;ans&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;
        &lt;span class="n"&gt;list_tonari&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remove&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;temp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

  &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;temp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;break&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;まず今どの部屋にいるか &lt;code&gt;temp2&lt;/code&gt; にいれて &lt;code&gt;temp&lt;/code&gt; を一旦空に。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;pop()&lt;/code&gt; で &lt;code&gt;temp2&lt;/code&gt; の先頭の数字を取ってくる ( &lt;code&gt;get&lt;/code&gt; のこと) 。
その部屋と隣り合っている部屋全てに対して以下の処理を行う。
まだその部屋に訪れていない ( &lt;code&gt;ans&lt;/code&gt; のリストでその部屋の値が &lt;code&gt;0&lt;/code&gt; ) なら、その部屋からは &lt;code&gt;get&lt;/code&gt; に向かえば最小経路を辿るので &lt;code&gt;get&lt;/code&gt; の部屋番号を入れる。
部屋を行ったり来たりしないので &lt;code&gt;get&lt;/code&gt; の部屋と隣り合っている部屋の隣り合っている部屋のリストから &lt;code&gt;get&lt;/code&gt; を削除。
そして &lt;code&gt;temp&lt;/code&gt; を改めて更新していく。&lt;/p&gt;
&lt;p&gt;もう行ってない部屋ないよってなったら &lt;code&gt;break&lt;/code&gt; で処理終了。
以上でOK&lt;/p&gt;
&lt;h2&gt;まとめ&lt;/h2&gt;
&lt;p&gt;なんか言葉で説明するとグダってしまった感がある・・・。
申し訳ねぇ。&lt;/p&gt;
&lt;p&gt;こういうのって習うより慣れろなんでしょうかね？&lt;/p&gt;
&lt;p&gt;ただ一回自力で書けば2回目以降はそんな苦労しないんじゃないでしょうか？&lt;/p&gt;
&lt;p&gt;同じアルゴリズムで解ける&lt;a href="https://atcoder.jp/contests/abc007/tasks/abc007_3"&gt;問題&lt;/a&gt;と、本記事は&lt;a href="https://www.amazon.co.jp/dp/B00CY9256C/ref=dp-kindle-redirect?_encoding=UTF8&amp;amp;btkr=1"&gt;蟻本&lt;/a&gt;と呼ばれる本を参考にしました。
ただC++で書かれているので、pythonで説明してくれてる&lt;a href="https://juppy.hatenablog.com"&gt;サイト&lt;/a&gt;も載っけときます。
よければどうぞ。&lt;/p&gt;
&lt;p&gt;という訳でもっと競プロ、勉強します。&lt;/p&gt;
&lt;h2&gt;(編集注記)&lt;/h2&gt;
&lt;p&gt;発展的な話となりますが、今回の本文コードで使われている&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;list_tonari&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remove&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;の部分は実は少しだけ危険で、時間切れの恐れがあります。&lt;/p&gt;
&lt;p&gt;リストからの要素削除は、リストの長さに比例した時間がかかります。
よって意地悪な入力では、トータルでほぼ頂点数の2乗に比例する時間がかかる可能性があります。
AtCoderのテストデータでは実際に本文のコードで正解と判定されるのですが、時間切れになる (正解に数時間程度かかる) 入力は問題制約の範囲で作れると思います。&lt;/p&gt;
&lt;p&gt;ではどうすればいいか。
最初に &lt;code&gt;list_tonari&lt;/code&gt; を作る部分を、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;list_tonari&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;set&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;と、リスト &lt;code&gt;[]&lt;/code&gt; でなく集合 &lt;code&gt;set()&lt;/code&gt; を使うように変更します。
これに伴い、その下の &lt;code&gt;append()&lt;/code&gt; は &lt;code&gt;add()&lt;/code&gt; に変更します。&lt;br&gt;
それだけです。
(&lt;code&gt;remove()&lt;/code&gt; の行自体はそのままでOKです。)&lt;/p&gt;
&lt;p&gt;同じ &lt;code&gt;remove()&lt;/code&gt; でも、集合では要素数の対数に比例した時間しかかかりません。
したがって全体の計算量が頂点数の2乗で爆発する可能性もなく、どんな入力でも確実に時間内で正解することができます。&lt;/p&gt;
&lt;p&gt;また &lt;code&gt;set()&lt;/code&gt; に変更するかわりに、上記の &lt;code&gt;remove()&lt;/code&gt; の行だけを削除してもいいです。
削除しなかったものはいずれ呼ばれますが、&lt;code&gt;ans[]&lt;/code&gt; に値が入っているので &lt;code&gt;if&lt;/code&gt; でスキップされます。
これは事前に削除しておくより高速です。
逆に &lt;code&gt;remove()&lt;/code&gt; がある場合、&lt;code&gt;if&lt;/code&gt; 判定は実はなくても構いません。&lt;/p&gt;
&lt;p&gt;(注記担当：&lt;a href="/previews/refs/heads/general/jinja2_version/author/xiao-chuan.html"&gt;小川&lt;/a&gt;)&lt;/p&gt;</content><category term="技術ブログ"></category><category term="競技プログラミング"></category></entry><entry><title>会正式名称の制定等について</title><link href="/previews/refs/heads/general/jinja2_version/news/2020/06/formalname.html" rel="alternate"></link><published>2020-06-25T00:00:00+09:00</published><updated>2020-06-25T00:00:00+09:00</updated><author><name>Python会</name></author><id>tag:None,2020-06-25:/previews/refs/heads/general/jinja2_version/news/2020/06/formalname.html</id><summary type="html">&lt;p&gt;&lt;a href="/previews/refs/heads/general/jinja2_version/news/2020/05/officialize_and_officialname.html"&gt;前回 (5/29) のお知らせ&lt;/a&gt;の通り、本会では公認申請に対する大阪大学医学部学生支援委員会よりの回答を受け、医学部公 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;a href="/previews/refs/heads/general/jinja2_version/news/2020/05/officialize_and_officialname.html"&gt;前回 (5/29) のお知らせ&lt;/a&gt;の通り、本会では公認申請に対する大阪大学医学部学生支援委員会よりの回答を受け、医学部公認、会正式名称およびそれらに関連する事項について、検討を重ねてまいりました。&lt;/p&gt;
&lt;p&gt;本日 (6/25) までに、本会運営会での議論・決議により関連事項を全て決定致しましたので、以下の通りお知らせいたします。&lt;/p&gt;
&lt;h2&gt;会正式名称&lt;/h2&gt;
&lt;p&gt;本会は本日より、下記名称を正式名称といたします。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;大阪大学医学部 情報医科学研究会
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;「Python会」を通称とすることについて&lt;/h2&gt;
&lt;p&gt;本会は今後も引き続き、「大阪大学医学部Python会」を通称とし、日常活動での主たる名称として使用します。
また必要に応じ、「Python会 (情報医科学研究会) 」等の表記を用いてまいります。&lt;/p&gt;
&lt;p&gt;このため、正式名称変更に伴い部分改定した&lt;a href="{filename}/pages/constitution.md"&gt;会規約&lt;/a&gt;第1条に新たな項を設け、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;本会は「大阪大学医学部Python会」を通称とする。
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;と明記いたしました。&lt;/p&gt;
&lt;h2&gt;大阪大学医学部への公認申請書類再提出&lt;/h2&gt;
&lt;p&gt;再申請の期限とされていた本日までに、新たな正式名称による申請書類の再提出を完了いたしました。&lt;/p&gt;
&lt;p&gt;不備等がなけば、後日、医学部学生支援委員会より正式に公認が許可されるものと見込んでいます。&lt;/p&gt;
&lt;p&gt;設立3年でここまで来ることができたのも、学内外の多くの方々のご支援ご声援を頂いてきたからこそと考えております。
今後とも大阪大学医学部Python会 (情報医科学研究会) を何卒よろしくお願いいたします。&lt;/p&gt;</content><category term="お知らせ"></category><category term="News"></category></entry><entry><title>【勉強会資料 2020 第6回】 機械学習とCNN入門</title><link href="/previews/refs/heads/general/jinja2_version/blog/2020/06/studymeeting2020_06.html" rel="alternate"></link><published>2020-06-24T00:00:00+09:00</published><updated>2020-07-01T00:00:00+09:00</updated><author><name>安部</name></author><id>tag:None,2020-06-24:/previews/refs/heads/general/jinja2_version/blog/2020/06/studymeeting2020_06.html</id><content type="html">&lt;p&gt;2020.06.24に行われた第6回勉強会のオンライン勉強会の資料を公開します。&lt;/p&gt;
&lt;h2&gt;紹介スライド&lt;/h2&gt;
&lt;p&gt;&lt;p&gt;&lt;span class="videobox"&gt;
  &lt;iframe width=640" height="500"
    src="{attach}./attach/studymeeting2020_06/第6回勉強会_機械学習とCNN入門.pdf"
    frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen&gt;
  &lt;/iframe&gt;&lt;/span&gt;&lt;/p&gt;&lt;/p&gt;</content><category term="技術ブログ"></category><category term="勉強会"></category><category term="Machine Learning"></category></entry><entry><title>やさしいYouTube APIのはなし</title><link href="/previews/refs/heads/general/jinja2_version/blog/2020/06/youtube_api.html" rel="alternate"></link><published>2020-06-24T00:00:00+09:00</published><updated>2020-06-24T00:00:00+09:00</updated><author><name>川崎</name></author><id>tag:None,2020-06-24:/previews/refs/heads/general/jinja2_version/blog/2020/06/youtube_api.html</id><summary type="html">&lt;p&gt;&lt;a href="/previews/refs/heads/general/jinja2_version/blog/2019/01/twitter_automation.html"&gt;前回&lt;/a&gt;は Twitter API を取得して定期ツイートする方法について書きましたが、今回の記事では &lt;strong&gt;YouTube API&lt;/strong&gt; を試してみたいと思いま …&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;a href="/previews/refs/heads/general/jinja2_version/blog/2019/01/twitter_automation.html"&gt;前回&lt;/a&gt;は Twitter API を取得して定期ツイートする方法について書きましたが、今回の記事では &lt;strong&gt;YouTube API&lt;/strong&gt; を試してみたいと思います。&lt;/p&gt;
&lt;h2&gt;APIとは？&lt;/h2&gt;
&lt;p&gt;APIとは何かざっくり説明いたしますと、&lt;br&gt;
あるアプリケーションにまつわる操作を、&lt;br&gt;
プログラミングを通じて自動化やらなんやら、といったものです。&lt;br&gt;
例えば Twitter ならツイート検索や投稿などがPythonで実行できます。&lt;/p&gt;
&lt;p&gt;&lt;img alt="image9" src="{attach}./images/youtube_api_figs/image9.jpg"&gt;&lt;/p&gt;
&lt;p&gt;Youtube にまつわるAPIは様々ありますが今回は &lt;strong&gt;YouTube Data API v3&lt;/strong&gt; を使っていきます。
YouTube Data API v3 は、動画、プレイリスト、チャンネルなどのYouTubeデータへのアクセスを提供するAPIです。&lt;/p&gt;
&lt;h2&gt;準備&lt;/h2&gt;
&lt;p&gt;まずは
&lt;a href="https://www.google.com"&gt;Google&lt;/a&gt;
が提供しているクラウドコンピューティングサービスである、
Google Cloud Platform (&lt;a href="https://console.cloud.google.com"&gt;https://console.cloud.google.com&lt;/a&gt;)
にアクセスし、「プロジェクトの選択」から新しいプロジェクトを作成します。
次に「スタートガイド」の「APIを探索して有効にする」をクリック。&lt;/p&gt;
&lt;p&gt;&lt;img alt="image7" src="{attach}./images/youtube_api_figs/image7.jpg"&gt;&lt;/p&gt;
&lt;p&gt;左側のタブからライブラリを選んでAPIが検索できます。
検索窓に YouTube と入力し、 "YouTube Data API v3" を選択して「有効にする」ボタンをクリック。
「認証情報」の画面から「認証情報作成」のボタンを押下し、APIキーを取得しておきます。&lt;/p&gt;
&lt;p&gt;&lt;img alt="image6" src="{attach}./images/youtube_api_figs/image5.jpg"&gt;&lt;/p&gt;
&lt;p&gt;今回は「&lt;a href="https://colab.research.google.com"&gt;&lt;strong&gt;Google Colabotratory&lt;/strong&gt;&lt;/a&gt;」での実装を試してみます。
「Google Colabotratory」は Google ドライブ上で使えるJupyter Notebookのようなものです。
ドライブ上にコードを保管できるほか、予め構築されたGoogleの仮想環境上で動かすことができるので大変便利です。
&lt;code&gt;google-api-python-client&lt;/code&gt; モジュールを用いますが、これは Google Colab に始めからインストールされているようです。
&lt;code&gt;!pip list&lt;/code&gt; を実行して確認できます。&lt;/p&gt;
&lt;p&gt;&lt;img alt="image6" src="{attach}./images/youtube_api_figs/image6.jpg"&gt;&lt;/p&gt;
&lt;h2&gt;実際に動かしてみる&lt;/h2&gt;
&lt;p&gt;早速YouTube APIで動画の情報を収集してみましょう。
例えば、ある投稿者の最新の動画を調べたい場合にも、APIを使って検索が可能です。
今回は&lt;strong&gt;HIKAKINさんのチャンネルで新しく投稿された動画&lt;/strong&gt;について調べてみたいと思います。&lt;/p&gt;
&lt;p&gt;さて、実は Youtube ではチャンネル毎に固有の ID が割り振られています。&lt;/p&gt;
&lt;p&gt;&lt;img alt="image4" src="{attach}./images/youtube_api_figs/image4.jpg"&gt;&lt;/p&gt;
&lt;p&gt;これを &lt;code&gt;search()&lt;/code&gt; 関数に与えることでAPI上で動画の検索ができます。
早速試してみます。
先程取得したAPIキーを使って、YouTubeにAPI経由でアクセスします。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;apiclient.discovery&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;build&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;apiclient.errors&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;HttpError&lt;/span&gt;

&lt;span class="n"&gt;YOUTUBE_API_KEY&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;AI*************************************&amp;quot;&lt;/span&gt;

&lt;span class="n"&gt;youtube&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;build&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;youtube&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;v3&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;developerKey&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;YOUTUBE_API_KEY&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;search_response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;youtube&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;search&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;span class="n"&gt;part&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;snippet&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="n"&gt;channelId&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;UCZf__ehlCEBPop-_sldpBUQ&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="n"&gt;maxResults&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="n"&gt;order&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;date&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;execute&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;titles&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;snippet&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;title&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;item&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;search_response&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;items&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]]&lt;/span&gt;
&lt;span class="n"&gt;titles&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;出力結果は以下のようになりました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="image8" src="{attach}./images/youtube_api_figs/image8.jpg"&gt;&lt;/p&gt;
&lt;p&gt;HIKAKINさんの新着動画のタイトルが取得出来ています。&lt;/p&gt;
&lt;p&gt;このようにYouTubeのサイトに直接アクセスしなくても、APIを叩くだけでちょっとした調べものが出来てしまいます。&lt;/p&gt;
&lt;h2&gt;自動化とOAuth2.0認証の実装&lt;/h2&gt;
&lt;p&gt;さらにAPIはプログラミング言語で動かすことが出来るという特性上、一連の操作をすべて自動でできるという利点があります。
例えば &lt;strong&gt;自分が登録しているチャンネルを全て取得して、そのどれかが新しく動画をアップロードし、それが特定のワードを含む場合にメールでお知らせしてくれるようなシステム&lt;/strong&gt; を作りたいとします。&lt;/p&gt;
&lt;p&gt;まずは自分が登録しているチャンネルの一覧を取得してみましょう。
登録チャンネルは非公開情報ですので、取得するにはログイン権限が必要です。
Googleアカウントでログイン認証する際には、 &lt;strong&gt;OAuth2 (オーオースツー) 認証方式&lt;/strong&gt; が使われています。
下のような画面に見覚えがある方も多いと思います。&lt;/p&gt;
&lt;p&gt;&lt;img alt="image2" src="{attach}./images/youtube_api_figs/image2.png"&gt;&lt;/p&gt;
&lt;p&gt;この画面を作ることで、自分の Google アカウントにログインし登録チャンネルを取得します。
幸いPythonには &lt;strong&gt;&lt;code&gt;oauth2client&lt;/code&gt;&lt;/strong&gt; というモジュールが存在し、これを使えば &lt;strong&gt;OAuth2認証&lt;/strong&gt; が簡単に実装できるようになっています。
早速やってみましょう。&lt;/p&gt;
&lt;p&gt;まずはプログラムにOAuth認証を組み込むのに必要な、 &lt;strong&gt;クライアントIDとクライアントシークレット&lt;/strong&gt; を取得します。
これは先程のAPI認証情報のページから容易に手に入ります。
これを使用してOAuth2認証を実装してみた結果が以下になります。&lt;/p&gt;
&lt;p&gt;&lt;img alt="image3" src="{attach}./images/youtube_api_figs/image3.png"&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;エラーが出ています。&lt;/strong&gt;
何がいけなかったのでしょうか。&lt;/p&gt;
&lt;p&gt;&lt;img alt="image1" src="{attach}./images/youtube_api_figs/image1.png"&gt;&lt;/p&gt;
&lt;p&gt;公式サイト
(&lt;a href="https://developers.google.com/youtube/v3/code_samples/python?hl=ja#add_a_channel_subscription"&gt;https://developers.google.com/youtube/v3/code_samples/python?hl=ja#add_a_channel_subscription&lt;/a&gt;)
にAPI実装のサンプルコードが載っていました。
自力では無理でもこのサンプルをコピペすれば…&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;CLIENT_SECRETS_FILE&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;client_secrets.json&amp;quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;json&lt;/strong&gt;？？？
その json はどっから出てきたんや？？？&lt;/p&gt;
&lt;p&gt;&lt;img alt="image12" src="{attach}./images/youtube_api_figs/image12.png"&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;storage&lt;/strong&gt;？？？
そんなものは無いが？？？&lt;/p&gt;
&lt;p&gt;……。&lt;/p&gt;
&lt;p&gt;&lt;img alt="image10" src="{attach}./images/youtube_api_figs/image10.png"&gt;&lt;/p&gt;
&lt;p&gt;というわけでまったくやさしくないOAuth2認証のお話でした。&lt;/p&gt;
&lt;p&gt;&lt;img alt="image11" src="{attach}./images/youtube_api_figs/image11.png"&gt;
&lt;em&gt;↑ 未知のモノを実装するにはその構造を理解する必要がある&lt;/em&gt;&lt;/p&gt;
&lt;h2&gt;まとめ&lt;/h2&gt;
&lt;p&gt;残念ながら今回はYouTube APIを使いこなすことが出来ませんでした。&lt;/p&gt;
&lt;p&gt;プログラミングを学ぶ中で分からない概念に出会って心が折れてしまったこと、誰でも一度は経験があると思います。&lt;/p&gt;
&lt;p&gt;そんな時には&lt;strong&gt;見極め&lt;/strong&gt;が大事です。
本当に使う必要があるのか？
別のルートで迂回は出来ないか？
それを覚える時間は無駄にならないか？
自身のスキルアップに繋がるか？
などなど……&lt;/p&gt;
&lt;p&gt;見極めた上で本当に必要だと思った知識は、是非時間を掛け学んで自分の武器にしてみてください。&lt;/p&gt;
&lt;p&gt;次回は「&lt;strong&gt;やさしいOAuth2認証のはなし&lt;/strong&gt;」について投稿予定です。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="自動化"></category></entry><entry><title>【勉強会資料 2020 第5回】 統計入門</title><link href="/previews/refs/heads/general/jinja2_version/blog/2020/06/studymeeting2020_05.html" rel="alternate"></link><published>2020-06-17T00:00:00+09:00</published><updated>2020-06-17T00:00:00+09:00</updated><author><name>竹内</name></author><id>tag:None,2020-06-17:/previews/refs/heads/general/jinja2_version/blog/2020/06/studymeeting2020_05.html</id><summary type="html">&lt;p&gt;2020.06.17に行われた第5回勉強会のオンライン勉強会の資料を公開します。
『統計入門』という題で、主に医学の中で統計学がどのように用いられるか、またその重要性について話しました …&lt;/p&gt;</summary><content type="html">&lt;p&gt;2020.06.17に行われた第5回勉強会のオンライン勉強会の資料を公開します。
『統計入門』という題で、主に医学の中で統計学がどのように用いられるか、またその重要性について話しました。&lt;/p&gt;
&lt;h2&gt;紹介スライド&lt;/h2&gt;
&lt;p&gt;&lt;p&gt;&lt;span class="videobox"&gt;
  &lt;iframe width=640" height="500"
    src="{attach}./attach/studymeeting2020_05/第5回勉強会_統計入門.pdf"
    frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen&gt;
  &lt;/iframe&gt;&lt;/span&gt;&lt;/p&gt;&lt;/p&gt;</content><category term="技術ブログ"></category><category term="勉強会"></category><category term="Statistics"></category></entry><entry><title>【勉強会資料 2020 第4回】 ライブラリを用いたデータ処理</title><link href="/previews/refs/heads/general/jinja2_version/blog/2020/06/studymeeting2020_04.html" rel="alternate"></link><published>2020-06-10T00:00:00+09:00</published><updated>2020-06-12T00:00:00+09:00</updated><author><name>山崎</name></author><id>tag:None,2020-06-10:/previews/refs/heads/general/jinja2_version/blog/2020/06/studymeeting2020_04.html</id><summary type="html">&lt;p&gt;2020.06.10に行われた第4回勉強会のオンライン勉強会の資料を公開します。
ライブラリを用いたデータ処理を主題とし、以下のようなことを行いました。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;def&lt;/code&gt; による関数の定義&lt;/li&gt;
&lt;li&gt;Numpy：&lt;code&gt;array&lt;/code&gt;を使っ …&lt;/li&gt;&lt;/ol&gt;</summary><content type="html">&lt;p&gt;2020.06.10に行われた第4回勉強会のオンライン勉強会の資料を公開します。
ライブラリを用いたデータ処理を主題とし、以下のようなことを行いました。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;def&lt;/code&gt; による関数の定義&lt;/li&gt;
&lt;li&gt;Numpy：&lt;code&gt;array&lt;/code&gt;を使ってみよう&lt;/li&gt;
&lt;li&gt;Pandasによるデータ処理とその可視化&lt;/li&gt;
&lt;li&gt;演習問題&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;使用したNotebook&lt;/h2&gt;
&lt;p&gt;&lt;a href="{attach}./attach/studymeeting2020_04/勉強会第4回.ipynb"&gt;Jupyter Notebook&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;紹介スライド&lt;/h2&gt;
&lt;p&gt;&lt;p&gt;&lt;span class="videobox"&gt;
  &lt;iframe width=640" height="500"
    src="{attach}./attach/studymeeting2020_04/第4回勉強会_ライブラリを用いたデータ処理.pdf"
    frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen&gt;
  &lt;/iframe&gt;&lt;/span&gt;&lt;/p&gt;&lt;/p&gt;</content><category term="技術ブログ"></category><category term="勉強会"></category><category term="Python"></category></entry><entry><title>【勉強会資料 2020 第3回】 競プロの基礎</title><link href="/previews/refs/heads/general/jinja2_version/blog/2020/06/studymeeting2020_03.html" rel="alternate"></link><published>2020-06-03T00:00:00+09:00</published><updated>2020-06-05T00:00:00+09:00</updated><author><name>梅田</name></author><id>tag:None,2020-06-03:/previews/refs/heads/general/jinja2_version/blog/2020/06/studymeeting2020_03.html</id><summary type="html">&lt;p&gt;2020.06.03に行われた第3回勉強会では、プログラミングを書く練習の手段としての競技プログラミング紹介と、その基礎の内容を扱いました。
AtCoder Beginner ContestでA …&lt;/p&gt;</summary><content type="html">&lt;p&gt;2020.06.03に行われた第3回勉強会では、プログラミングを書く練習の手段としての競技プログラミング紹介と、その基礎の内容を扱いました。
AtCoder Beginner ContestでA,B問題が解ける程度のレベルを目標としています。&lt;/p&gt;
&lt;h2&gt;使用したNotebook&lt;/h2&gt;
&lt;p&gt;&lt;a href="{attach}./attach/studymeeting2020_03/勉強会第3回.ipynb"&gt;Jupyter Notebook&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;紹介スライド&lt;/h2&gt;
&lt;p&gt;&lt;p&gt;&lt;span class="videobox"&gt;
  &lt;iframe width=640" height="390"
    src="{attach}./attach/studymeeting2020_03/第3回勉強会_競プロの基礎.pdf"
    frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen&gt;
  &lt;/iframe&gt;&lt;/span&gt;&lt;/p&gt;&lt;/p&gt;</content><category term="技術ブログ"></category><category term="競技プログラミング"></category><category term="勉強会"></category></entry><entry><title>医学部公認と正式名称の検討について</title><link href="/previews/refs/heads/general/jinja2_version/news/2020/05/officialize_and_officialname.html" rel="alternate"></link><published>2020-05-29T00:00:00+09:00</published><updated>2020-05-30T00:00:00+09:00</updated><author><name>Python会</name></author><id>tag:None,2020-05-29:/previews/refs/heads/general/jinja2_version/news/2020/05/officialize_and_officialname.html</id><summary type="html">&lt;p&gt;本日、大阪大学医学部学生支援委員会より、本会の公認についての審議結果が通知されましたのでご報告します。&lt;/p&gt;
&lt;h2&gt;名称 …&lt;/h2&gt;</summary><content type="html">&lt;p&gt;本日、大阪大学医学部学生支援委員会より、本会の公認についての審議結果が通知されましたのでご報告します。&lt;/p&gt;
&lt;h2&gt;名称条件付きの公認許可&lt;/h2&gt;
&lt;p&gt;通知では、「Python会」の名称は永続的な公認団体の名称として不適切であると指摘した上で、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;例えば「医学部バイオ情報処理研究会」のような団体名に変更することを条件に、新規結成を承認します。
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;とされました。
これを受け入れて公認団体新規結成を希望する場合、6月25日までに新名称で必要書類を提出するようにとのことです。&lt;/p&gt;
&lt;h2&gt;会正式名称の検討&lt;/h2&gt;
&lt;p&gt;これを受けて本会では、公認団体としての会正式名称についての検討を、指定された期限までに行うことと致しました。&lt;/p&gt;
&lt;p&gt;「Python会」の名称は結成以来多くの方々に親しんでいただき、ご支援を頂いてきたものでもあることから、今後の正式名称との併用・併記等のあり方につきましても同時に検討してまいります。&lt;/p&gt;
&lt;p&gt;今後、本件に関する経過につきましては主に
&lt;a href="https://twitter.com/oumed_python"&gt;Twitter&lt;/a&gt;
にてお伝えする予定です。
ご意見ご感想なども歓迎します。
何卒よろしくお願いいたします。&lt;/p&gt;</content><category term="お知らせ"></category><category term="News"></category></entry><entry><title>【勉強会資料 2020 第2回】Pythonの基本文法</title><link href="/previews/refs/heads/general/jinja2_version/blog/2020/05/studymeeting2020_02.html" rel="alternate"></link><published>2020-05-27T00:00:00+09:00</published><updated>2020-05-28T00:00:00+09:00</updated><author><name>富田</name></author><id>tag:None,2020-05-27:/previews/refs/heads/general/jinja2_version/blog/2020/05/studymeeting2020_02.html</id><content type="html">&lt;p&gt;2020.05.27開催のオンライン勉強会の資料を公開します。
内容としては、intとstring、配列、if、forなどの非常に初歩的なお話です。
リストやwhileを用いた変則的なFizzBuzzが組めることをゴールとしています。&lt;/p&gt;
&lt;h2&gt;Pythonの基本文法&lt;/h2&gt;
&lt;p&gt;&lt;a href="{attach}./attach/studymeeting2020_02/勉強会_python基本文法.ipynb"&gt;Jupyter Notebook&lt;/a&gt;&lt;/p&gt;</content><category term="技術ブログ"></category><category term="勉強会"></category><category term="Python"></category></entry><entry><title>【勉強会資料 2020 第1回】Python会とは? / Pythonの基礎</title><link href="/previews/refs/heads/general/jinja2_version/blog/2020/05/studymeeting2020_01.html" rel="alternate"></link><published>2020-05-19T00:00:00+09:00</published><updated>2020-05-23T00:00:00+09:00</updated><author><name>山本</name></author><id>tag:None,2020-05-19:/previews/refs/heads/general/jinja2_version/blog/2020/05/studymeeting2020_01.html</id><summary type="html">&lt;p&gt;2020.05.19に開催したオンライン勉強会の資料を公開します。&lt;/p&gt;
&lt;p&gt;今回のみ、会外部の一般の方々にも参加頂く形で行われました。
次回からは会内部のみとなりますが、資料は公開してゆく予定です。&lt;/p&gt;
&lt;h2&gt;スライド&lt;/h2&gt;
&lt;p&gt;&lt;p&gt;&lt;span class="videobox"&gt;
  &lt;iframe width=640" height="390"
    src="{attach}./attach/studymeeting2020_01/200519_python会入門.pdf"
    frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen&gt;
  &lt;/iframe&gt;&lt;/span&gt;&lt;/p&gt;&lt;/p&gt;
&lt;h2&gt;Pythonの環境構築 …&lt;/h2&gt;</summary><content type="html">&lt;p&gt;2020.05.19に開催したオンライン勉強会の資料を公開します。&lt;/p&gt;
&lt;p&gt;今回のみ、会外部の一般の方々にも参加頂く形で行われました。
次回からは会内部のみとなりますが、資料は公開してゆく予定です。&lt;/p&gt;
&lt;h2&gt;スライド&lt;/h2&gt;
&lt;p&gt;&lt;p&gt;&lt;span class="videobox"&gt;
  &lt;iframe width=640" height="390"
    src="{attach}./attach/studymeeting2020_01/200519_python会入門.pdf"
    frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen&gt;
  &lt;/iframe&gt;&lt;/span&gt;&lt;/p&gt;&lt;/p&gt;
&lt;h2&gt;Pythonの環境構築&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.python.org/"&gt;Pythonの公式サイト&lt;/a&gt;からPythonだけをinstallしても使えるが、パッケージ管理や環境管理のためにAnacondaを使うと便利（ここで不要じゃという声が飛んでくる）。&lt;/li&gt;
&lt;li&gt;少なくともWindowsだと使った方が楽&lt;/li&gt;
&lt;li&gt;Anacondaそのままは全部盛りに近い（＝要らないものなども自動でinstallされる）ので、最小限のパッケージに留めたMinicondaをinstallする方がよい&lt;/li&gt;
&lt;li&gt;Miniconda入れる前にpyenv入れた方が良いという話もある(MacOS, Linux)&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Pythonファイルの実行&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;python hoge.py
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;で実行可能。
IDEでは簡単に実行出来たり、他にはJupyter notebookを用いる手法も。&lt;/p&gt;
&lt;h2&gt;Python Tutorial&lt;/h2&gt;
&lt;p&gt;&lt;a href="{attach}./attach/studymeeting2020_01/Python_tutorial.ipynb"&gt;Jupyter Notebook&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;コードのみ以下に掲載します。&lt;/p&gt;
&lt;h3&gt;NumPyで数値計算&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;numpy&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;np&lt;/span&gt;
&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arange&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mf"&gt;0.1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;x:&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;y&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mi"&gt;10&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;y:&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;Matplotlibで図を描画する&lt;/h3&gt;
&lt;p&gt;Matplotlibは図を描画するためのライブラリ。
どんな図が描画できるかは公式ドキュメントの&lt;a href="https://matplotlib.org/gallery/index.html"&gt;ギャラリー&lt;/a&gt;を参照。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;numpy&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;np&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;matplotlib.pyplot&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;plt&lt;/span&gt;

&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arange&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mf"&gt;0.1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;y&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mi"&gt;10&lt;/span&gt;

&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;plot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;show&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;Seabornによる回帰直線の描画&lt;/h3&gt;
&lt;p&gt;SeabornはMatplotlibがベースのライブラリ。
より綺麗で複雑な図を簡単に描画できる。
公式ドキュメントの&lt;a href="https://seaborn.pydata.org/examples/index.html"&gt;ギャラリー&lt;/a&gt;を参照。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;seaborn&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;sns&lt;/span&gt;
&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;seed&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# 乱数seedの設定&lt;/span&gt;

&lt;span class="c1"&gt;# Toyデータ(y=2*x+10+noise)の作成&lt;/span&gt;
&lt;span class="n"&gt;n_data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;100&lt;/span&gt; &lt;span class="c1"&gt;# データ数&lt;/span&gt;
&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;randn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n_data&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;y&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;randn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n_data&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mi"&gt;10&lt;/span&gt;

&lt;span class="c1"&gt;# 回帰直線のplot&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;figure&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;figsize&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;sns&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;regplot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# 回帰(regression)の実行&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;show&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="c1"&gt;# 画像表示&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;Markdownについて&lt;/h3&gt;
&lt;p&gt;Markdownはプレーンテキスト形式で手軽に書いた文書からHTMLを生成するための言語
- 書き方は&lt;a href="https://qiita.com/tbpgr/items/989c6badefff69377da7"&gt;Markdown記法サンプル集&lt;/a&gt;等を見るとよい
- 普段から使う場合は&lt;a href="https://typora.io/"&gt;Typora&lt;/a&gt;を使うのがおススメ。
TeX形式の数式も書ける。
PandocをインストールすればWordやLaTeXなどに変換可能。&lt;/p&gt;
&lt;h3&gt;Google Colabについて&lt;/h3&gt;
&lt;p&gt;&lt;a href="https://colab.research.google.com"&gt;Google Colaboratory&lt;/a&gt;はJupyter Notebookをブラウザ上で使えるようにGoogleが提供しているサービス。
Pythonをインストールする必要はありません。
また、Python会の一部のブログは記事をそのままGoogle Colabで開くことができます(GitHubにアップロードしたJupyter Notebookファイル(.ipynb)はURLを修正するだけでColabで開くことができます)。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="勉強会"></category><category term="Python"></category></entry><entry><title>赤外線対応エアコンをインターネットを用いて操作する方法</title><link href="/previews/refs/heads/general/jinja2_version/blog/2020/05/aircon_via_internet.html" rel="alternate"></link><published>2020-05-18T00:00:00+09:00</published><updated>2020-05-23T00:00:00+09:00</updated><author><name>吉田</name></author><id>tag:None,2020-05-18:/previews/refs/heads/general/jinja2_version/blog/2020/05/aircon_via_internet.html</id><summary type="html">&lt;p&gt;著者Twitter：&lt;a href="https://twitter.com/y7tsy"&gt;https://twitter.com/y7tsy&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;注:この記事は、作成の時間の都合と読みやすさを優先するために論文のフォーマットは採用してい …&lt;/p&gt;</summary><content type="html">&lt;p&gt;著者Twitter：&lt;a href="https://twitter.com/y7tsy"&gt;https://twitter.com/y7tsy&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;注:この記事は、作成の時間の都合と読みやすさを優先するために論文のフォーマットは採用していません。
また、新規性に欠けるところはおよそリンクを貼るだけとしております。&lt;/p&gt;
&lt;h2&gt;&lt;span id="sec01"&gt;&lt;/span&gt;システム概要&lt;/h2&gt;
&lt;figure id="fig11"&gt;
  &lt;img src="{attach}./images/aircon_via_internet_figs/fig1-1.png" alt="図1-1 システム概略" /&gt;
  &lt;figcaption&gt;図1-1 システム概略&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;システムの概略を上&lt;a href="#fig11"&gt;図1-1&lt;/a&gt;に示す。
スマートフォンやパソコンで、特定のサイトを開くこと、また、google assistantに「OK google,冷房/除湿/暖房をいれて」「OK google、エアコンを止めて」と指示することで、IFTTT、beebotte、rapsberry pi、ESP32を経由し、ESP32が特定の赤外線のシグナルを発信する。
これによってエアコンを操作するのである。
なお、ラインへの通知はおよそデバッグ用である。&lt;/p&gt;
&lt;h2&gt;ブラウザでの情報処理について&lt;/h2&gt;
&lt;p&gt;多くのインターネット上のブログでは、スマートスピーカから情報を送信するものが多くみられる。
しかし、外出先からの動作を考慮し、また、拡張性の高さを求め、ブラウザからの指令を行えるように設計した。
もちろん、このブラウザは作成者しかリンクを知らないため、第三者は利用できない。
それに加え、パスワードも実装してある。&lt;/p&gt;
&lt;p&gt;執筆時のブラウザ画面を下図1-2に載せる。&lt;/p&gt;
&lt;figure id="fig12"&gt;
  &lt;img src="{attach}./images/aircon_via_internet_figs/fig1-2.png" alt="図1-2 ブラウザ画面" /&gt;
  &lt;figcaption&gt;図1-2 ブラウザ画面&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;ここで、サーバーはXSERVERを利用している。
これは、オンラインのレンタルサーバであり、無料でPHPサーバを作成できる。
当初、raspberry piにこのサーバ機能を持たせようと考えたが、ipアドレスの設定に手間がかかることを踏まえ、却下した。
さて、このサーバにはいくつかのファイルが存在する。
上&lt;a href="#fig12"&gt;図1-2&lt;/a&gt;内上のボタンにリンクが紐づけられており、指定したPHPを実行するように設定されている。
このPHPがwebhookを介し、IFTTTに指示を出す。
&lt;a href="#appendix01"&gt;附録1&lt;/a&gt;として、PHPからwebhookを介してIFTTTTのトリガーを起動させる最低限のプログラムを載せておく。
上&lt;a href="#fig12"&gt;図1-2&lt;/a&gt;において、最後に操作された日時と時間が表示されているのが分かる。
ブラウザから操作されたタイミングをテキストファイルで保存しており、その最新の日時を表示させているのである。
これはrapberry piにサーバを担わせていた仕様の名残でもある。
この情報を機械学習などを用いて解析することで、エアコンを操作するタイミングの特徴を抽出し、ラインなどに「冷房をつけましょうか」といった通知を送るような機能の実装を計画していた。&lt;/p&gt;
&lt;h2&gt;google assistant、IFTTT及びbeebotteの処理について&lt;/h2&gt;
&lt;p&gt;先に述べておくが、開発はIFTTTよりもbeebotteの設定を先に行った。
これは、IFTTTの設定時にbeebotteの情報が必要だからである。&lt;/p&gt;
&lt;p&gt;さて、google assistantとIFTTTの連携は非常にシンプルに構成できる。
私は
&lt;a href="https://qiita.com/sesame525/items/fba27b41bec3aebd3de0"&gt;https://qiita.com/sesame525/items/fba27b41bec3aebd3de0&lt;/a&gt;
を主に参考にした。
また、IFTTTからbeebotteの設定は
&lt;a href="https://qiita.com/minatomirai21/items/4c4e777b43ede1e42900"&gt;https://qiita.com/minatomirai21/items/4c4e777b43ede1e42900&lt;/a&gt;
 (*3-1) を参考にした。
 さて、肝心のIFTTTの設定だが、ブラウザ側から、PHPがwebhookを介してIFTTTにPOSTする場合、IFTTTのIF、THIS、THEN、THATのTHISをwebhookに設定する。
 THATの設定は *3-1 に従う。
 即ち、THIS、THAT両方ともwebhookというアップレットが必要である。
 ここで、実装した機能は、冷房ON、除湿ON、暖房ON、エアコンOFFの4種類である。
 これをブラウザとgoogle assistantからそれぞれ情報を得るため、合計8個のアップレットが必要となるのである。
 IFTTTの設定を下&lt;a href="#table31"&gt;表3-1&lt;/a&gt;に示す。
 なお、ラインへの通知はデバッグ用のため省略した。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;THIS&lt;/th&gt;
&lt;th&gt;THAT&lt;/th&gt;
&lt;th&gt;POSTデータ(JSON)&lt;br&gt;※あくまで一例&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;ブラウザ⇒冷房ON&lt;/td&gt;
&lt;td&gt;webhooks&lt;/td&gt;
&lt;td&gt;webhooks&lt;/td&gt;
&lt;td&gt;A&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ブラウザ⇒除湿ON&lt;/td&gt;
&lt;td&gt;webhooks&lt;/td&gt;
&lt;td&gt;webhooks&lt;/td&gt;
&lt;td&gt;B&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ブラウザ⇒暖房ON&lt;/td&gt;
&lt;td&gt;webhokks&lt;/td&gt;
&lt;td&gt;webhooks&lt;/td&gt;
&lt;td&gt;C&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ブラウザ⇒エアコンOFF&lt;/td&gt;
&lt;td&gt;webhooks&lt;/td&gt;
&lt;td&gt;webhooks&lt;/td&gt;
&lt;td&gt;D&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Google assistant⇒冷房ON&lt;/td&gt;
&lt;td&gt;Google assistant&lt;/td&gt;
&lt;td&gt;webhooks&lt;/td&gt;
&lt;td&gt;A&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Google assistant⇒除湿ON&lt;/td&gt;
&lt;td&gt;Google assistant&lt;/td&gt;
&lt;td&gt;webhooks&lt;/td&gt;
&lt;td&gt;B&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Google assistant⇒暖房ON&lt;/td&gt;
&lt;td&gt;Google assistant&lt;/td&gt;
&lt;td&gt;webhooks&lt;/td&gt;
&lt;td&gt;C&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Google assistant⇒エアコンOFF&lt;/td&gt;
&lt;td&gt;Google assistant&lt;/td&gt;
&lt;td&gt;webhooks&lt;/td&gt;
&lt;td&gt;D&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;span id="table31"&gt;表3-1&lt;/span&gt; IFTTTの設定&lt;/p&gt;
&lt;h2&gt;MQTT及びrapsberry piのプログラムについて&lt;/h2&gt;
&lt;p&gt;raspberry piがMQTT通信を用いて、beebotteからの情報を受け取る。
pythonで処理できるため、処理が簡単になる。
&lt;a href="https://qiita.com/msquare33/items/9f0312585bb4707c686b"&gt;https://qiita.com/msquare33/items/9f0312585bb4707c686b&lt;/a&gt;
を主に参考にした。
ここで、簡単にraspberry piについて説明する。
raspberry piは数千円で購入できる、linux様のコンピュータである。
wifiやbluetooth、usbなどインターフェースも申し分なく、サーバーコンピュータとしては省電力である。
詳しくはこちらを参考にされたい。
今回、常に起動させておく必要があり省エネであることが求められ、また、スレーブの増設への対応の設定を行うためのユーザーインターフェースが整っており、安価であるという点からこのraspberry piを選定した。 &lt;/p&gt;
&lt;h2&gt;pythonからbluetoothを用いたESP32との通信&lt;/h2&gt;
&lt;p&gt;raspberry piはサーバであり、そこから複数の距離の離れたスレーブに情報を送信する。
そしてそのスレーブが各々の家電を操作するのである。サーバとスレーブ(クライアント)間の無線通信は技適を取得している製品を用いるのが望ましい。
また、電子回路を制御するためのマイコンがあれば、赤外線LEDを制御しやすい。
このような、技適を取得し、扱いやすいマイコンの機能を有するESP32を採用した。
これは900円という安さながら、wifi、bluetoothも利用できるマイコンである。
その中でも扱いやすくなったこのモジュールを利用した。
bluetoothを利用するにあたって、raspberry piはpythonで、ESP32がarduino IDEというC++様な言語を用いた。
&lt;a href="#appendix02"&gt;附録2&lt;/a&gt;として、pythonでbluetoothを送信するプログラムを、&lt;a href="#appendix03"&gt;附録3&lt;/a&gt;としてESP32でbluetoothを受信するプログラムを載せる。&lt;/p&gt;
&lt;h2&gt;赤外線LED及び受信機の回路設計とプログラムについて&lt;/h2&gt;
&lt;p&gt;どのような赤外線信号を出せばエアコンが動くかは、その付属のリモコンの信号を解析するのが正確である。
ここで、それぞれ受信と送信を行う回路を組まなければならない。
受信機の回路は
&lt;a href="https://qiita.com/takjg/items/e6b8af53421be54b62c9"&gt;https://qiita.com/takjg/items/e6b8af53421be54b62c9&lt;/a&gt;
を参考に、赤外線LEDの回路は
&lt;a href="https://www.hibihogehoge.com/2017/04/arduinomosfet1.html"&gt;https://www.hibihogehoge.com/2017/04/arduinomosfet1.html&lt;/a&gt;
を参考に組んだ。&lt;/p&gt;
&lt;p&gt;プログラムは二つ用意する必要がある。
最初にリモコンの赤外線シグナルを受信し解析するプログラムで赤外線シグナルのデータを読み込むプログラム(プログラム6-Aとする)と、そこで出力されたデータをもとに赤外線LEDを発行させるプログラムである(プログラム6-Bとする)。
ESP32で赤外線LEDを利用するためのライブラリであるIRremoteESP8266を用いた。
プログラム6-AはサンプルスケッチのIRrecvDumpV2のピン番号を設定し直したプログラムである。
これを書き込み、シリアルモニタを起動させ、リモコンのボタンを押すと赤外線のシグナルの構造データを得られる。
プログラム6-BはサンプルスケッチのIRsendDEMOにプログラム6-Aで得られたデータを書き込んだものである。&lt;/p&gt;
&lt;h2&gt;今後の展望&lt;/h2&gt;
&lt;p&gt;&lt;a href="#sec01"&gt;1章&lt;/a&gt;でも述べたように、それぞれの操作と時間の関係を解析し、ユーザに提案するようなシステムを構築したい。&lt;/p&gt;
&lt;p&gt;また、寝室の蛍光灯やカーテンの開閉をこのシステムに組み込みたい(下&lt;a href="#fig71"&gt;図7-1&lt;/a&gt;)。
これは起床を促進させる可能性があると考えている。そして、&lt;a href="#fig12"&gt;図1-2&lt;/a&gt;のブラウザ画面のような見た目が良くないものを、CSSを用いて扱いやすく、視覚的に好印象を与えるようなものに改良したい。&lt;/p&gt;
&lt;p&gt;今、新型コロナウイルスにより加工機械が利用できないため、新しい端末の開発の速度が低迷している。&lt;/p&gt;
&lt;figure id="fig71"&gt;
  &lt;img src="{attach}./images/aircon_via_internet_figs/fig7-1.png" alt="図7-1 今後の展望" /&gt;
  &lt;figcaption&gt;図7-1 今後の展望&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h2&gt;附録&lt;/h2&gt;
&lt;h3&gt;&lt;span id="appendix01"&gt;附録1&lt;/span&gt; : PHPからwebhookを介してIFTTTTのトリガーを起動させるプログラム&lt;/h3&gt;
&lt;p&gt;参考にしたサイト &lt;a href="https://amg-solution.jp/blog/14245"&gt;https://amg-solution.jp/blog/14245&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;＜著作権を鑑み、消去しました＞&lt;/p&gt;
&lt;h3&gt;&lt;span id="appendix02"&gt;附録2&lt;/span&gt; : pythonでbluetoothを用いてテキストデータを送信するプログラム&lt;/h3&gt;
&lt;p&gt;参考にしたサイト &lt;a href="https://stackoverrun.com/ja/q/10556918"&gt;https://stackoverrun.com/ja/q/10556918&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;＜著作権を鑑み、消去しました＞&lt;/p&gt;
&lt;h3&gt;&lt;span id="appendix03"&gt;附録3&lt;/span&gt; : arduino IDEでbluetoothを用いてテキストデータを受信するプログラム&lt;/h3&gt;
&lt;p&gt;以下はセミコロン(;)までを読み込むプログラムである。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="cp"&gt;#include&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="cpf"&gt;&amp;quot;BluetoothSerial.h&amp;quot;&lt;/span&gt;&lt;span class="cp"&gt;&lt;/span&gt;

&lt;span class="n"&gt;BluetoothSerial&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;SerialBT&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="kt"&gt;void&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nf"&gt;setup&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="n"&gt;Serial&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;begin&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;115200&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="n"&gt;SerialBT&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;begin&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;ESP32test&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="kt"&gt;void&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nf"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SerialBT&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;available&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;receiveDeta&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kt"&gt;char&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;gotchar&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;do&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="n"&gt;gotchar&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;SerialBT&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="n"&gt;receiveData&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;receiveDeta&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gotchar&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;while&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gotchar&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;!=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;59&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;receiveDeta&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content><category term="技術ブログ"></category><category term="自動化"></category></entry><entry><title>医学部公認団体申請を行いました</title><link href="/previews/refs/heads/general/jinja2_version/news/2020/05/officialize_request.html" rel="alternate"></link><published>2020-05-15T00:00:00+09:00</published><updated>2020-05-15T00:00:00+09:00</updated><author><name>Python会</name></author><id>tag:None,2020-05-15:/previews/refs/heads/general/jinja2_version/news/2020/05/officialize_request.html</id><summary type="html">&lt;p&gt;大阪大学医学部に、学部公認学生団体となるための申請書類を提出しました。&lt;/p&gt;
&lt;p&gt;2019年度にも申請していましたが、2017年結成の本会は活動実績不足などの理由から公認が見送られています。
今回の申請書類には昨年度の新た …&lt;/p&gt;</summary><content type="html">&lt;p&gt;大阪大学医学部に、学部公認学生団体となるための申請書類を提出しました。&lt;/p&gt;
&lt;p&gt;2019年度にも申請していましたが、2017年結成の本会は活動実績不足などの理由から公認が見送られています。
今回の申請書類には昨年度の新たな活動実績も多く盛り込みました。&lt;/p&gt;
&lt;p&gt;今年度こそ医学部から正式に承認されることを期待しています！&lt;/p&gt;</content><category term="お知らせ"></category><category term="News"></category></entry><entry><title>線形混合効果モデル</title><link href="/previews/refs/heads/general/jinja2_version/blog/2020/04/linear_mixed_model.html" rel="alternate"></link><published>2020-04-08T00:00:00+09:00</published><updated>2020-04-08T00:00:00+09:00</updated><author><name>竹内</name></author><id>tag:None,2020-04-08:/previews/refs/heads/general/jinja2_version/blog/2020/04/linear_mixed_model.html</id><summary type="html">&lt;h2&gt;経時測定データ解析&lt;/h2&gt;
&lt;p&gt;複数の対象者に対して、ある反応変数を時間の経過とともに繰り返し測定したデータを、&lt;strong&gt;経時測 …&lt;/strong&gt;&lt;/p&gt;</summary><content type="html">&lt;h2&gt;経時測定データ解析&lt;/h2&gt;
&lt;p&gt;複数の対象者に対して、ある反応変数を時間の経過とともに繰り返し測定したデータを、&lt;strong&gt;経時測定データ&lt;/strong&gt;（longitudinal data）という。経済学分野では、パネルデータ解析として知られている。&lt;/p&gt;
&lt;h3&gt;経時測定データ解析の特徴&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;個体間誤差だけでなく、個体内誤差も考慮する必要がある。&lt;/li&gt;
&lt;li&gt;個体内の各観測値は独立ではない為、相関を考慮する必要がある。&lt;/li&gt;
&lt;li&gt;ランダム化比較試験 (RCT) では個体毎の測定回数は同じであることが多いが、観察研究では個体毎に測定回数がバラバラであることが多い。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;線形混合効果モデル&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;span class="math"&gt;\(N\)&lt;/span&gt;人 (&lt;span class="math"&gt;\(i=1, 2, \cdots, N\)&lt;/span&gt;)の被験者を対象とする。&lt;/li&gt;
&lt;li&gt;&lt;span class="math"&gt;\(i\)&lt;/span&gt; 番目の被験者は &lt;span class="math"&gt;\(n_i\)&lt;/span&gt; 回測定されるとする。&lt;/li&gt;
&lt;li&gt;&lt;span class="math"&gt;\(Y_{ij}\)&lt;/span&gt; は、&lt;span class="math"&gt;\(i\)&lt;/span&gt; 番目の被験者の、&lt;span class="math"&gt;\(j\)&lt;/span&gt; 番目 (&lt;span class="math"&gt;\(j=1, 2, \cdots, n_i\)&lt;/span&gt;) の時点における被説明変数とする。&lt;/li&gt;
&lt;li&gt;この時、線形混合モデルはベクトル表記にて、以下のように表される。&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="math"&gt;$$
\boldsymbol{Y}_i = X_i \boldsymbol{\beta} + Z_i \boldsymbol{b}_i + \epsilon_i
$$&lt;/div&gt;
&lt;p&gt;ただし、&lt;span class="math"&gt;\(\boldsymbol{\beta}\)&lt;/span&gt;は固定効果、&lt;span class="math"&gt;\(\boldsymbol{b}_i\)&lt;/span&gt;はランダム効果（変量効果）を表すベクトルとした。また、&lt;span class="math"&gt;\(X_i, Z_i\)&lt;/span&gt;は計画行列である。&lt;/p&gt;
&lt;p&gt;ベクトル表現を書き下し、&lt;span class="math"&gt;\(i\)&lt;/span&gt; 番目の被験者の &lt;span class="math"&gt;\(j\)&lt;/span&gt; 番目時点の被説明変数 &lt;span class="math"&gt;\(Y_{ij}\)&lt;/span&gt; を線形混合効果モデルにて表現すると、以下のようになる。&lt;/p&gt;
&lt;div class="math"&gt;$$
Y_{ij}=\beta_1+\beta_2 t_{ij}+b_{1i}+b_{2i}t_{ij}+\epsilon_{ij}\qquad (j=1, 2, \cdots, n_i)
$$&lt;/div&gt;
&lt;p&gt;ただし、&lt;span class="math"&gt;\(t_{ij}\)&lt;/span&gt;は&lt;span class="math"&gt;\(i\)&lt;/span&gt;番目の被験者の&lt;span class="math"&gt;\(j\)&lt;/span&gt;番目の(イベント)時点である。以下ではモデルを図で表す。&lt;/p&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}./images/linear_mixed_model_figs/001.JPG"&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="2" src="{attach}./images/linear_mixed_model_figs/002.JPG"&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="3" src="{attach}./images/linear_mixed_model_figs/003.JPG"&gt;&lt;/p&gt;
&lt;h2&gt;固定効果とランダム効果&lt;/h2&gt;
&lt;p&gt;線形混合効果モデルは、&lt;strong&gt;固定効果&lt;/strong&gt;（fixed effect）と &lt;strong&gt;ランダム効果&lt;/strong&gt;（random effect）から構成される。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;固定効果（fixed effect）: population characteristics shared by all individuals&lt;/li&gt;
&lt;li&gt;ランダム効果（random effect）: specific effects that are unique to particular individual&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;非線形混合効果モデル&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;データが線形モデルで表せない際に用いる。&lt;/li&gt;
&lt;li&gt;母集団薬物動態解析、動物の成長曲線等の解析で用いられる。&lt;/li&gt;
&lt;li&gt;数式では、以下のように書ける。&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="math"&gt;$$
Y_{ij}=f(t_{ij}, \boldsymbol{\beta}, \boldsymbol{b_i})+\epsilon_{ij}
$$&lt;/div&gt;
&lt;p&gt;ここで&lt;span class="math"&gt;\(\boldsymbol{\beta}\)&lt;/span&gt;は 固定効果、&lt;span class="math"&gt;\(\boldsymbol{b_i}\)&lt;/span&gt;はランダム効果（変量効果）を表すベクトルとした。また、&lt;span class="math"&gt;\(f(\cdot)\)&lt;/span&gt;は非線形関数であり、データの性状に応じて適切な関数を当てはめる&lt;/p&gt;
&lt;h2&gt;引用文献&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;船渡川伊久子、船渡川隆（2015）統計解析スタンダート　経時データ解析. 朝倉書店.&lt;/li&gt;
&lt;li&gt;田中豊、森川敏彦、山中竹春、冨田誠（2008）一般化線形モデル入門（原著第2版）. 共立出版.&lt;/li&gt;
&lt;li&gt;Scott L. Zeger, Kung-Yee Liang, Paul S. Albert. Models for longitudinal data: a generalized estimating equation approach. Biometrics 1988;44:1049-1060.&lt;/li&gt;
&lt;/ul&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="技術ブログ"></category><category term="Statistics"></category></entry><entry><title>会規約を制定しました</title><link href="/previews/refs/heads/general/jinja2_version/news/2020/04/establish_constitution.html" rel="alternate"></link><published>2020-04-01T00:00:00+09:00</published><updated>2020-05-27T00:00:00+09:00</updated><author><name>Python会</name></author><id>tag:None,2020-04-01:/previews/refs/heads/general/jinja2_version/news/2020/04/establish_constitution.html</id><summary type="html">&lt;p&gt;このたび本会は、
&lt;a href="{filename}/pages/constitution.md"&gt;大阪大学医学部Python会規約&lt;/a&gt;
をSlack上での会議 (運営会) により、付属の施行細則とともに承認・制定しました。&lt;/p&gt;
&lt;p&gt;今回の規約制定 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;このたび本会は、
&lt;a href="{filename}/pages/constitution.md"&gt;大阪大学医学部Python会規約&lt;/a&gt;
をSlack上での会議 (運営会) により、付属の施行細則とともに承認・制定しました。&lt;/p&gt;
&lt;p&gt;今回の規約制定は、会の持続的な運営体制を整備するとともに、大阪大学医学部での公認や今後の対外的活動にも備えたものです。
規約の内容は従来からの会運営体制に沿ったものであり、規約の施行に伴う直接の体制変更などはありません。&lt;/p&gt;
&lt;p&gt;今後ともPython会をよろしくお願いいたします。&lt;/p&gt;</content><category term="お知らせ"></category><category term="News"></category></entry><entry><title>技術ブログをWebサイトに統合しました</title><link href="/previews/refs/heads/general/jinja2_version/news/2020/03/website_integration.html" rel="alternate"></link><published>2020-03-29T00:00:00+09:00</published><updated>2020-03-29T00:00:00+09:00</updated><author><name>Python会</name></author><id>tag:None,2020-03-29:/previews/refs/heads/general/jinja2_version/news/2020/03/website_integration.html</id><content type="html">&lt;p&gt;技術ブログは一時的にはてなブログで開設していましたが、本日、GitHub上の本サイトに統合しました。&lt;/p&gt;
&lt;p&gt;みんなでgitを使ってブログ記事をどんどん掲載していけるように頑張ります！&lt;/p&gt;</content><category term="お知らせ"></category><category term="News"></category></entry><entry><title>Webサイトをリニューアルしました！</title><link href="/previews/refs/heads/general/jinja2_version/news/2020/03/website_renewal.html" rel="alternate"></link><published>2020-03-24T00:00:00+09:00</published><updated>2020-03-29T00:00:00+09:00</updated><author><name>Python会</name></author><id>tag:None,2020-03-24:/previews/refs/heads/general/jinja2_version/news/2020/03/website_renewal.html</id><content type="html">&lt;p&gt;Python会の&lt;a href="https://oumpy.github.io"&gt;Webサイト&lt;/a&gt;と技術ブログがリニューアルしました。&lt;/p&gt;
&lt;p&gt;(2020/3/29 追記)&lt;br&gt;
技術ブログはWebサイトに統合しました。  &lt;/p&gt;
&lt;p&gt;参照：&lt;a href="/previews/refs/heads/general/jinja2_version/news/2020/03/website_integration.html"&gt;技術ブログをWebサイトに統合しました&lt;/a&gt;&lt;/p&gt;</content><category term="お知らせ"></category><category term="News"></category></entry><entry><title>UNIX系OSのファイルアクセス権</title><link href="/previews/refs/heads/general/jinja2_version/blog/2020/03/unix_permission.html" rel="alternate"></link><published>2020-03-17T00:00:00+09:00</published><updated>2020-05-13T00:00:00+09:00</updated><author><name>小川</name></author><id>tag:None,2020-03-17:/previews/refs/heads/general/jinja2_version/blog/2020/03/unix_permission.html</id><summary type="html">&lt;p&gt;Python会が管理する&lt;a href="{filename}/pages/student_server.md"&gt;医学科学生用計算サーバ&lt;/a&gt; (以下、医学科計算サーバ) が本格的に使える状態に (ほぼ) なりました。
OS は Ubuntu 18.04 LTS です。&lt;/p&gt;
&lt;p&gt;計算 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;Python会が管理する&lt;a href="{filename}/pages/student_server.md"&gt;医学科学生用計算サーバ&lt;/a&gt; (以下、医学科計算サーバ) が本格的に使える状態に (ほぼ) なりました。
OS は Ubuntu 18.04 LTS です。&lt;/p&gt;
&lt;p&gt;計算サーバのようにUNIX系OSをマルチユーザで使う場合、ファイルの所有権／アクセス権の理解が必須です。
本稿ではその基本と、その拡張であるACL (Access Control List) を&lt;strong&gt;とても雑に&lt;/strong&gt;説明します。&lt;/p&gt;
&lt;p&gt;Ubuntu 18.04を念頭に置きますが、他のLinuxでもほぼ同じです。
macOSでのACL操作は方法が少し異なりますが、基本の仕組みは全て同じです。&lt;/p&gt;
&lt;h2&gt;ファイルの所有者とアクセス権&lt;/h2&gt;
&lt;p&gt;医学科計算サーバでは、一人ひとりに独立のアカウントを発行します。
このような環境では、自分のデータは自分だけが読み書きできるようにしたりできます。
以下がその仕組みです。&lt;/p&gt;
&lt;p&gt;各ファイルやディレクトリには「所有者」「所有グループ」「アクセス権 (パーミッション) 」の情報がそれぞれ記録されています。
所有者は、自分だけが操作できるか、他人にも読み書きを許すかなどを、「アクセス権」の設定によってファイル毎に自由に決められます。&lt;/p&gt;
&lt;p&gt;これらの情報は &lt;code&gt;ls -l&lt;/code&gt; で確認できます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ ls -l
-rw-r----- &lt;span class="m"&gt;1&lt;/span&gt; ogawa  ogawa  &lt;span class="m"&gt;4462&lt;/span&gt;  &lt;span class="m"&gt;3&lt;/span&gt; &lt;span class="m"&gt;16&lt;/span&gt; &lt;span class="m"&gt;22&lt;/span&gt;:38 &lt;span class="m"&gt;202003&lt;/span&gt;-ACL.md
-rwxr-xr-- &lt;span class="m"&gt;1&lt;/span&gt; ogawa  users    &lt;span class="m"&gt;32&lt;/span&gt;  &lt;span class="m"&gt;1&lt;/span&gt; &lt;span class="m"&gt;10&lt;/span&gt; &lt;span class="m"&gt;14&lt;/span&gt;:43 test.py
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;冒頭の &lt;code&gt;-rw-r--r--&lt;/code&gt; などがアクセス権設定、&lt;code&gt;ogawa&lt;/code&gt; が所有者。
&lt;code&gt;202003-ACL.md&lt;/code&gt; は所有グループも同名の &lt;code&gt;ogawa&lt;/code&gt; (ubuntuではこれが普通)、&lt;code&gt;test.py&lt;/code&gt; は &lt;code&gt;users&lt;/code&gt; が所有グループです。  &lt;/p&gt;
&lt;p&gt;アクセス権は &lt;code&gt;rwx&lt;/code&gt; の3文字が1セットで、これが3セット並びます。
1セット目が所有者、2セット目が所有グループ、3セット目がそれ以外に対するアクセス権を表します。
&lt;code&gt;rwx&lt;/code&gt;は読み取り (&lt;code&gt;r&lt;/code&gt;) 、書き込み (&lt;code&gt;w&lt;/code&gt;) 、実行 (&lt;code&gt;x&lt;/code&gt;) です。
&lt;code&gt;-&lt;/code&gt; に変わっている操作はできません。
(左端の &lt;code&gt;-&lt;/code&gt; にはディレクトリの場合に &lt;code&gt;d&lt;/code&gt; が入る。)&lt;/p&gt;
&lt;p&gt;上の例の場合、&lt;code&gt;202003-ACL.md&lt;/code&gt; は、&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;所有者は読み取りと書き込みが可能。 (実行はできない)&lt;/li&gt;
&lt;li&gt;所有グループ（に属する所有者以外のユーザ）は読み取りが可能。 (書き込みと実行は不可)&lt;/li&gt;
&lt;li&gt;その他のユーザはファイル内容への一切のアクセスが不可。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;test.py&lt;/code&gt; は&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;所有者は読み取り・書き込み・実行すべて可能。&lt;/li&gt;
&lt;li&gt;所有グループ (に属する所有者以外のユーザ) は読み取りと実行が可能。 (書き込みは不可)&lt;/li&gt;
&lt;li&gt;その他のユーザは読み取りのみ可能。 (書き込みと実行は不可)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;またこれらはしばしば、r=4、w=2、x=1 の足し算による3桁の8進数で表します。
&lt;code&gt;202003-ALC.md&lt;/code&gt; はパーミッション &lt;code&gt;640&lt;/code&gt;、&lt;code&gt;test.py&lt;/code&gt; はパーミッション &lt;code&gt;754&lt;/code&gt; です。&lt;/p&gt;
&lt;p&gt;アクセス権設定コマンド &lt;code&gt;chmod&lt;/code&gt; を使い、例えば&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ chmod &lt;span class="m"&gt;700&lt;/span&gt; hogehoge.py
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;とすれば、ファイル &lt;code&gt;hogehoge.py&lt;/code&gt; は自分のみ読み書き実行全て可能、他人は一切アクセス不可となります。
Ubuntuなどではホームディレクトリの初期パーミッションが &lt;code&gt;755&lt;/code&gt; だったりするため、気になる場合はこのように変更するのもおすすめです。&lt;/p&gt;
&lt;h2&gt;データ共有／共同作業／共同研究がしたい&lt;/h2&gt;
&lt;p&gt;では、共同研究などで「特定の人」にだけアクセスを許すにはどうしたらいいか？&lt;/p&gt;
&lt;p&gt;一つの方法は、一緒に作業したい仲間を含むグループを作り、ファイルの所有グループとアクセス権を適当に設定することです。
しかしグループを作るには&lt;strong&gt;システム管理者にその都度依頼&lt;/strong&gt;しなければならず、あまり良い方法ではありません。&lt;/p&gt;
&lt;p&gt;そこで登場するのが &lt;strong&gt;POSIX ACL&lt;/strong&gt; という、&lt;strong&gt;上記のアクセス権に詳細な例外条項を加える&lt;/strong&gt;仕組みです。
例えば&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ setfacl -m user:otomodachi:rwx hogehoge.py
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;のようにすると、他人に対するパーミッションが0のファイルでも、指定したユーザ (&lt;code&gt;otomodachi&lt;/code&gt;) にだけファイルの読み書き実行、全てを許可することができます。
ディレクトリに対して設定することもできます。これで共同作業や共同研究も自由自在です。&lt;/p&gt;
&lt;p&gt;おしまい。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Unix"></category></entry><entry><title>シェルコマンドに触れてみよう</title><link href="/previews/refs/heads/general/jinja2_version/blog/2020/02/shellscript_tutorial.html" rel="alternate"></link><published>2020-02-26T00:00:00+09:00</published><updated>2020-02-26T00:00:00+09:00</updated><author><name>山田</name></author><id>tag:None,2020-02-26:/previews/refs/heads/general/jinja2_version/blog/2020/02/shellscript_tutorial.html</id><summary type="html">&lt;h2&gt;シェルって？　コマンドってなに？&lt;/h2&gt;
&lt;p&gt;詳しくはググるなり下の記事等を見てもらえばよいのですが、  簡単にまとめると
- コマ …&lt;/p&gt;</summary><content type="html">&lt;h2&gt;シェルって？　コマンドってなに？&lt;/h2&gt;
&lt;p&gt;詳しくはググるなり下の記事等を見てもらえばよいのですが、  簡単にまとめると
- コマンド：マウスやトラックパッドを用いて操作するのではなく、キーボードでコンピュータに命令を与えるもの
- シェル：命令をコンピュータに伝えるプログラムのこと  &lt;/p&gt;
&lt;p&gt;つまるところ、Pythonに限らず&lt;strong&gt;プログラミングをやりたければ必須の内容&lt;/strong&gt;というわけです！&lt;br&gt;
これができないと、極論プログラミングを始めることもできないかもしれません。  （installすらできないかも...）&lt;br&gt;
ですが、複雑なものではないので、下を読んでさくっと学んでしまいましょう！&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;コマンドについてもっと知りたい方へ  &lt;/li&gt;
&lt;li&gt;&lt;a href="https://qiita.com/lrf141/items/6c01d2f7afff79cd7286"&gt;Linux初心者のシェルスクリプト入門 - Qiita&lt;/a&gt;  &lt;/li&gt;
&lt;li&gt;&lt;a href="https://eng-entrance.com/linux-what-is-command"&gt;【初心者用】Linuxのコマンドとは？とコマンドラインの表示方法&lt;/a&gt;  &lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.sejuku.net/blog/5465"&gt;ブクマ必至！Linuxコマンド一覧表【全33種】 | 侍エンジニア塾ブログ（Samurai Blog） - プログラミング入門者向けサイト&lt;/a&gt;  &lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;シェルコマンドを学ぶ上でのポイント&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;ムリにおぼえようとしない&lt;/li&gt;
&lt;li&gt;日頃使っていたら自然と覚えていく&lt;/li&gt;
&lt;li&gt;コマンドの名前は英語の省略かも？&lt;/li&gt;
&lt;li&gt;忘れたら、すぐググればよし&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;シェルコマンドってどういう風に書くの？&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ &lt;span class="nb"&gt;cd&lt;/span&gt;
$ ls
$ emacs
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;などのように、黒い画面（terminal、cmd）上にて、一つ一つの処理ごとに命令を書いてEnterキーで実行していきます。  &lt;/p&gt;
&lt;h2&gt;ランク別よく使うシェルコマンド&lt;/h2&gt;
&lt;p&gt;筆者の独断と偏見による、日頃よく使うコマンドを3段階にわけてまとめてみました。&lt;br&gt;
詳しい使い方は各自調べてもらいたいので、ここでは「何ができるか」だけ簡単に書いておきます。(&lt;strong&gt;自分で調べていく力&lt;/strong&gt;がプログラミングには大事ですよ！)&lt;br&gt;
ランク1、2あたりはググらずに使えるようになるといいと思います。&lt;br&gt;
もちろんこの他にも様々なコマンドがありますが、最初の1歩として学んでみて下さい。&lt;/p&gt;
&lt;h3&gt;ランク1&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;コマンド&lt;/th&gt;
&lt;th&gt;何ができるか&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;cd&lt;/td&gt;
&lt;td&gt;ディレクトリ移動&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;pwd&lt;/td&gt;
&lt;td&gt;カレントディレクトリを表示&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ls&lt;/td&gt;
&lt;td&gt;フォルダの内容をリスト形式で表示する&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ファイル操作編&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;mv&lt;/td&gt;
&lt;td&gt;ファイルを移動&lt;br&gt;ファイルの名前を編集&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;cp&lt;/td&gt;
&lt;td&gt;ファイルやフォルダをコピーする&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;rm&lt;/td&gt;
&lt;td&gt;ファイルやフォルダを削除&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;mkdir&lt;/td&gt;
&lt;td&gt;フォルダを作成&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;rmdir&lt;/td&gt;
&lt;td&gt;フォルダを削除&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;less&lt;/td&gt;
&lt;td&gt;テキストファイルを閲覧&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;more&lt;/td&gt;
&lt;td&gt;ファイルの中身を表示&lt;br&gt;（lessがおすすめ）&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;cat&lt;/td&gt;
&lt;td&gt;ファイルの内容を表示&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;grep&lt;/td&gt;
&lt;td&gt;指定した文字列がテキスト内に存在した場合その行を抽出&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3&gt;ランク2&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;コマンド&lt;/th&gt;
&lt;th&gt;何ができるか&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;chmod&lt;/td&gt;
&lt;td&gt;ファイルやフォルダのアクセス権限を変更&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;touch&lt;/td&gt;
&lt;td&gt;空のファイルを作成&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;emacs&lt;br&gt;vim&lt;br&gt;など&lt;/td&gt;
&lt;td&gt;（それぞれのエディタで）ファイルを新規作成&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;echo&lt;/td&gt;
&lt;td&gt;画面に文字列や数値、変数を表示&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;open&lt;/td&gt;
&lt;td&gt;Finderを開く&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3&gt;ランク3&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;コマンド&lt;/th&gt;
&lt;th&gt;何ができるか&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;ps&lt;/td&gt;
&lt;td&gt;現在動作しているプロセスを表示する&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ssh&lt;/td&gt;
&lt;td&gt;リモートマシンにSSHでログイン&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;zip&lt;br&gt;tar&lt;br&gt;gzip/gunzip&lt;/td&gt;
&lt;td&gt;ファイル・ディレクトリの解凍、圧縮&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;何度も使ってみておぼえていきましょう！&lt;/p&gt;
&lt;h2&gt;おまけ&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;シェル芸&lt;br&gt;
気になる方は下の記事でも読んでみて下さい。  &lt;/li&gt;
&lt;li&gt;&lt;a href="https://qiita.com/t_nakayama0714/items/bfe4852e0535858ee662"&gt;【シェル芸人への道】シェル芸人の第一歩 - Qiita&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href="https://qiita.com/_-_-_-_-_/items/214d537aae2c1488692c"&gt;【危険シェル芸】禁じられた闇の魔術とその防衛術💥 - Qiita&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Clipyなどのクリップボードを活用する&lt;br&gt;
よく使うコマンドを登録しておくと便利！&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;コマンドの次へ&lt;/h2&gt;
&lt;p&gt;上の文にもいくつかでてきているのですが、コマンドに入門した次に勉強するおすすめとして、以下の単語を調べてみましょう。&lt;br&gt;
それぞれ今度何度も目にする単語なので、早めに知っておいて損はないと思います。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;パスとは？&lt;br&gt;
キーワード：相対/絶対パス&lt;/li&gt;
&lt;li&gt;エディタとは？&lt;br&gt;
emacs/vim/atom/vscode...&lt;/li&gt;
&lt;/ol&gt;</content><category term="技術ブログ"></category><category term="Unix"></category><category term="Shell script"></category></entry><entry><title>バイオインフォマティクス技術者認定試験2019 解答速報？</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/12/bioinfoexam2019_answer.html" rel="alternate"></link><published>2019-12-11T00:00:00+09:00</published><updated>2019-12-23T00:00:00+09:00</updated><author><name>小川</name></author><id>tag:None,2019-12-11:/previews/refs/heads/general/jinja2_version/blog/2019/12/bioinfoexam2019_answer.html</id><summary type="html">&lt;p&gt;先日受験したバイオインフォマティクス認定試験をあらためて復習して、ついでに解答速報（全然速くない）と備忘録程度の解説を書きました。&lt;/p&gt;
</summary><content type="html">&lt;p&gt;先日受験したバイオインフォマティクス認定試験をあらためて復習して、ついでに解答速報（全然速くない）と備忘録程度の解説を書きました。&lt;/p&gt;
&lt;!-- PELICAN_END_SUMMARY --&gt;
&lt;h2&gt;模範解答 (?)&lt;/h2&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;1&lt;/th&gt;
&lt;th&gt;2&lt;/th&gt;
&lt;th&gt;3&lt;/th&gt;
&lt;th&gt;4&lt;/th&gt;
&lt;th&gt;5&lt;/th&gt;
&lt;th&gt;6&lt;/th&gt;
&lt;th&gt;7&lt;/th&gt;
&lt;th&gt;8&lt;/th&gt;
&lt;th&gt;9&lt;/th&gt;
&lt;th&gt;10&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;0&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;10&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;20&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;30&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;40&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;50&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;60&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;70&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;&lt;em&gt;4&lt;/em&gt;&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;(問題番号 = 縦列番号 + 横列番号)&lt;/p&gt;
&lt;p&gt;(2019.12.23 公式解答と全問一致でした。ただ問74は取消になりませんでした。)&lt;/p&gt;
&lt;h2&gt;解説&lt;/h2&gt;
&lt;h3&gt;バイオ（問1-20）&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;問1：答4：はい&lt;/li&gt;
&lt;li&gt;問2：答4：核小体で合成されるのはrRNA。なおさらにリボソームの組み立ても行われる。&lt;/li&gt;
&lt;li&gt;問3：答3：G1→S→G2なのでG2で倍になっている。&lt;/li&gt;
&lt;li&gt;問4：答3：mRNAにポリAが付加されるのは真核生物。
  （注：教科書的には多分そうなのだが、原核生物やミトコンドリアのmRNAでも大抵はポリA鎖が見られるらしい。ただ持たない例もあり、二次的に失われたと考えられている。一方、真核生物でそのような例は知られていない。いずれにせよ一般に正しいとまでは言えないという意味で、選択肢3が正解となる。消去法的に解けるとはいえ、実は難問。）&lt;/li&gt;
&lt;li&gt;問5：答2：リボソームの小サブユニットは1種、大サブユニットは真核で3種、原核（真正および古細菌）で2種のrRNAを含む。よって合計4種ないし3種である。&lt;/li&gt;
&lt;li&gt;問6：答2：ジスルフィド結合でなくリン酸エステル結合。&lt;/li&gt;
&lt;li&gt;問7：答4：引っ掛けに近いが、グリシンの側鎖はHのみである。&lt;/li&gt;
&lt;li&gt;問8：答1：1回膜貫通で普通チャネルはできない。&lt;/li&gt;
&lt;li&gt;問9：答2：ユビキチンはタンパク質なので糖鎖修飾ではない。&lt;/li&gt;
&lt;li&gt;問10：答2：これもちょっとした引っ掛け。解糖系で酸素は消費しない。&lt;/li&gt;
&lt;li&gt;問11：答2：はい&lt;/li&gt;
&lt;li&gt;問12：答1：はい&lt;/li&gt;
&lt;li&gt;問13：答3：ミトコンドリアは母親由来である。&lt;/li&gt;
&lt;li&gt;問14：答3：グリセリンはアミノ酸ですらない。Gはグリシン。&lt;/li&gt;
&lt;li&gt;問15：答4：プロモータ領域にあるGC含量の高い領域はGCボックスという。LINEはレトロトランスポゾンの一種。問62でも登場。&lt;/li&gt;
&lt;li&gt;問16：答2：PCRで変化させるのは溶液組成ではなく温度である。&lt;/li&gt;
&lt;li&gt;問17：答4：メタボローム解析とはその名の通り、低分子化合物を主とする代謝産物の網羅的解析である。DNAの配列決定とは無関係。&lt;/li&gt;
&lt;li&gt;問18：答3：はい&lt;/li&gt;
&lt;li&gt;問19：答1：2,3,4は正しいので消去法で決めることができる。&lt;/li&gt;
&lt;li&gt;問20：答3：はい&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;インフォマティクス（問21-40）&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;問21：答3：偶奇を決める演算を問われている。該当するのはXORしかない。&lt;/li&gt;
&lt;li&gt;問22：答4：GPGPUの省略前名称を与えてくれており、これが説明と矛盾することは知らなくてもわかる。GPGPUの本当の意味は名前の通りだが、特に現在のカジュアルな深層学習には必須の技術である（そのうち専用プロセッサが主流となれば死語になるかもしれない）。&lt;/li&gt;
&lt;li&gt;問23：答2：はい&lt;/li&gt;
&lt;li&gt;問24：答2：はい&lt;/li&gt;
&lt;li&gt;問25：答4：はい&lt;/li&gt;
&lt;li&gt;問26：答1：while中の条件&lt;code&gt;x&amp;lt;A[j]&lt;/code&gt;が満たされることは決してない。よって&lt;code&gt;i&lt;/code&gt;のループが&lt;code&gt;2&lt;/code&gt;から&lt;code&gt;n&lt;/code&gt;まで一巡するだけで終了するので、計算量は&lt;span class="math"&gt;\(\Theta(n)\)&lt;/span&gt;である。&lt;/li&gt;
&lt;li&gt;問27：答2：マージソートを知らなくても、&lt;span class="math"&gt;\(f(n) = n + 2f(n/2)\)&lt;/span&gt; をただ解くだけでよい。&lt;span class="math"&gt;\(f(n)=n\log_2 n\)&lt;/span&gt; はこの厳密解となるので、計算量オーダーは &lt;span class="math"&gt;\(\Theta(n\log n)\)&lt;/span&gt; である。&lt;/li&gt;
&lt;li&gt;問28：答1：20n個の中の上位n個に入る確率は1/20であり、n依存性は消滅する。&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;問29：答4：順に辿ると、E &amp;lt; F &amp;lt; G &amp;lt; H になることがわかる。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;問30：答3：&lt;span class="math"&gt;\({}_5C_{2}=10\)&lt;/span&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;問31：答1：(i, j)に達する経路は(i-1, j)からと(i, j-1)からの2パターン。AtCoderのD問題以上でも頻出。&lt;/li&gt;
&lt;li&gt;問32：答1：SQLはRDB用の言語。&lt;/li&gt;
&lt;li&gt;問33：答1：論理演算を注意深く考えれば良い。&lt;/li&gt;
&lt;li&gt;問34：答2：はい&lt;/li&gt;
&lt;li&gt;問35：答1：-1から2までfを積分すればよいので、原始関数を使うと選択肢1が自動的に出る。&lt;/li&gt;
&lt;li&gt;問36：答2：どちらも負の相関があるが、x-yグラフの方がばらついている、つまり相関係数の絶対値が小さい。回帰直線の傾きは関係ない（引っ掛けである）。&lt;/li&gt;
&lt;li&gt;問37：答3：勾配ベクトルは軌跡に接し、また等高線に直交する。向きが紛らわしいが、上り方向である。学習時の変分ベクトルは符号を変えて下り方向。&lt;/li&gt;
&lt;li&gt;問38：答4：はい&lt;/li&gt;
&lt;li&gt;問39：答1：隠れマルコフモデルがクラスタリングに使えるかわからなくても（実際僕は知らない）、2,3,4は明らかにクラスタリングに使えるアルゴリズムである。&lt;/li&gt;
&lt;li&gt;問40：答4：訓練用とテスト用が逆である。訓練用のデータはなるべく多く確保したい。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;バイオインフォマティクス（問41-80）&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;問41：答3：菌種によらず共通に必要な機能は多く存在する。それらを1菌種にまとめるようなことをしてはいけない。&lt;/li&gt;
&lt;li&gt;問42：答4：はい&lt;/li&gt;
&lt;li&gt;問43：答4：書いているかどうかチェックするだけ。選択肢4のようなことは書いていない。&lt;/li&gt;
&lt;li&gt;問44：答3：4塩基分前後にずれたところ（右下と左上）にも直線状プロットがなければならない。&lt;/li&gt;
&lt;li&gt;問45：答2：はい&lt;/li&gt;
&lt;li&gt;問46：答2：四角が表すのは代謝反応を触媒する酵素である。&lt;/li&gt;
&lt;li&gt;問47：答3：はい&lt;/li&gt;
&lt;li&gt;問48：答1：一般に次世代シークエンサは繰り返し配列を苦手とする。たとえ反復配列から多くのRNAが転写されていても、そこから「ゲノム上の反復配列」を復元するのは困難と思われる。&lt;/li&gt;
&lt;li&gt;問49：答4：シュードノットとは、2度ヘアピンで折り返して元と同じ向きに進むような構造。そもそも2塩基だけで作れるようなものではない。&lt;/li&gt;
&lt;li&gt;問50：答1：PAMスコア行列の計算は、まず近縁なタンパク質間の置換回数から変異確率行列（=マルコフ過程遷移行列）を求める。1/100の割合で置換=1PAM。これを行列積で&lt;span class="math"&gt;\(n\)&lt;/span&gt;乗した遷移行列から、対数オッズスコアを計算したものがPAM&lt;span class="math"&gt;\(n\)&lt;/span&gt;である。「様々なアミノ酸の物理化学的指標を組み合わせて評価」したものではない。&lt;/li&gt;
&lt;li&gt;問51：答2：P(G)は縦および横に足し算するだけ。結果は一致する（一致しなければおかしい）。次にP(T|G)は0.05/0.2=0.25となる。&lt;/li&gt;
&lt;li&gt;問52：答3：1文字目Gの出現確率がP(G)=0.2、P(T|G)=0.25、P(C|T)=0.06/0.3=0.2なので、掛け合わせれば0.01が出る。&lt;/li&gt;
&lt;li&gt;問53：答3：疎水性アミノ酸は5番目のI（イソロイシン）と10番目のV（バリン）なので、それらが内部に埋もれるものを探して選べばよい。&lt;/li&gt;
&lt;li&gt;問54：答1：配列同士を比較すると、残基2と11、3と10のペアがそれぞれセットで変異していることがわかる。よってこれら同士が隣接するものを探して選べばよい。&lt;/li&gt;
&lt;li&gt;問55：答3：意味の異なる文字や数字が隣接していても、ルールが明確であればプログラムによる判読は容易である。&lt;/li&gt;
&lt;li&gt;問56：答4：はい（見ればわかる）&lt;/li&gt;
&lt;li&gt;問57：答4：図中にMainly Beta-Beta Barrelと書かれている。&lt;/li&gt;
&lt;li&gt;問58：答4：一概にそのようなことは言えない。一般に立体構造は一次配列よりもよく保存される傾向があり、遠い昔に共通起源を持つタンパク質が分化したものである可能性もよく検討する必要がある。&lt;/li&gt;
&lt;li&gt;問59：答2：1,3,4は少なくとも正しいと思われるので、消去法で。&lt;/li&gt;
&lt;li&gt;問60：答3：はい&lt;/li&gt;
&lt;li&gt;問61：答1：超優性だけでは高々ヘテロ結合になるだけであり、1箇所に何種類もの変異を保持することはできない。&lt;/li&gt;
&lt;li&gt;問62：答3：AluはSINEの一種で、レトロトランスポゾンでありながら有効な逆転写酵素を持たない。&lt;/li&gt;
&lt;li&gt;問63：答2：機能的制約から、特異な構造を持つタンパク質があってもおかしくない。&lt;/li&gt;
&lt;li&gt;問64：答1：連鎖不平衡と遺伝的連鎖は違う場合がある。&lt;/li&gt;
&lt;li&gt;問65：答1：はい&lt;/li&gt;
&lt;li&gt;問66：答3：新しい枝を追加する場所の選択肢が7通りあるので、15x7=105である。一般には(2n-5)!!となる。&lt;/li&gt;
&lt;li&gt;問67：答4：変異が有利に働く場合なので、中立説での説明とは異なる。&lt;/li&gt;
&lt;li&gt;問68：答4：はい（何もかも間違い）&lt;/li&gt;
&lt;li&gt;問69：答2：はい&lt;/li&gt;
&lt;li&gt;問70：答1：自身を活性化するAを抑えるので、「増えることによりさらに増える」ことはない。&lt;/li&gt;
&lt;li&gt;問71：答1：はい&lt;/li&gt;
&lt;li&gt;問72：答2：通常、DNAメチル化は遺伝子発現の抑制に働く。&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;問73：答4：終止コドンはTAA、TAGと、TATでなくTGAである。正確に記憶していなくても、3つとも最初の2文字が共通ということはないこと、さらに2文字目と3文字目は両方プリンだったことなど、断片的な情報からも答えられるように作られた問題。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;問74：答4？：想定解答はおそらく4と思われるが、それも実は正しい模様（質量分析の情報が構造決定のために用いられる）。すると全選択肢が正しく、正答なしとなる。&lt;em&gt;全員正解扱いの可能性あり。&lt;/em&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;問75：答2：菌の割合を求めて細菌数に掛ければ各菌ごとの菌密度が求められ、菌Xの密度は試料Aで&lt;span class="math"&gt;\(1.0\times 10^5\)&lt;/span&gt; 、試料Bで &lt;span class="math"&gt;\(0.75\times 10^5\)&lt;/span&gt; となる。&lt;/li&gt;
&lt;li&gt;問76：答3：知らなくても、エントロピーという言葉がShannonのヒントになっている。&lt;/li&gt;
&lt;li&gt;問77：答4：タンパク質間相互作用があってもそれが元の遺伝子にフィードバックされるとは限らないため、一般に完全グラフになるというのは誤り。&lt;/li&gt;
&lt;li&gt;問78：答4：タンパク質とmRNAの量比を問題にしているので、直接は無関係な事象である。&lt;/li&gt;
&lt;li&gt;問79：答3：ポリクローナル抗体での解析で有意差が無かったのだから、これはおかしい。&lt;/li&gt;
&lt;li&gt;問80：答3：ベイジアンネットワーク推定ではループ構造が現れることはない。&lt;/li&gt;
&lt;/ul&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="技術ブログ"></category><category term="Bioinformatics"></category><category term="検定試験"></category></entry><entry><title>水色コーダー vs 応用情報技術者試験</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/10/ipa_ap.html" rel="alternate"></link><published>2019-10-21T00:00:00+09:00</published><updated>2019-12-23T00:00:00+09:00</updated><author><name>小川</name></author><id>tag:None,2019-10-21:/previews/refs/heads/general/jinja2_version/blog/2019/10/ipa_ap.html</id><summary type="html">&lt;h2&gt;国家試験&lt;/h2&gt;
&lt;p&gt;情報処理技術者試験は、IPA/経産省による国家試験です。
&lt;strong&gt;いわゆる国試&lt;/strong&gt;です。&lt;/p&gt;
&lt;p&gt;情報処理技術者試験のうち、分野を …&lt;/p&gt;</summary><content type="html">&lt;h2&gt;国家試験&lt;/h2&gt;
&lt;p&gt;情報処理技術者試験は、IPA/経産省による国家試験です。
&lt;strong&gt;いわゆる国試&lt;/strong&gt;です。&lt;/p&gt;
&lt;p&gt;情報処理技術者試験のうち、分野を限定しない一般的な試験には&lt;a href="https://www.jitec.ipa.go.jp/1_11seido/fe.html"&gt;基本情報技術者試験（レベル2）&lt;/a&gt;と&lt;a href="https://www.jitec.ipa.go.jp/1_11seido/ap.html"&gt;応用情報技術者試験（レベル3）&lt;/a&gt;の2種類があります。
試験は春秋の年2回。&lt;br&gt;
&lt;a href="/previews/refs/heads/general/jinja2_version/blog/2019/05/ipa_fe.html"&gt;春に選んだのは前者&lt;/a&gt;でしたが正直イマイチだったので、今回は後者の話になります。
結論だけ先に言うと、&lt;strong&gt;こちらはわりと良かった&lt;/strong&gt;です。&lt;/p&gt;
&lt;p&gt;前回同様に&lt;strong&gt;アンチ・ドーピング&lt;/strong&gt;、正々堂々と出題範囲も形式も知らないガチンコ勝負にします。
&lt;strong&gt;勉強が嫌だったり面倒だったり眠かったり競プロの方がやりたかったりとかは一切関係ありません。&lt;/strong&gt;&lt;/p&gt;
&lt;h2&gt;Materials &amp;amp; Methods&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;独自アルゴリズム&lt;/strong&gt;によりAtCoderの&lt;strong&gt;水色コーダーをN人無作為に&lt;/strong&gt;選ぶ。&lt;/li&gt;
&lt;li&gt;N人全員に応用情報技術者試験を事前情報なしで受けさせる。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;（実験リソースの都合上、以下N=1。）&lt;/p&gt;
&lt;h2&gt;試験経過&lt;/h2&gt;
&lt;p&gt;（本節は被験者〔試験日基準でレート1453〕の報告に基づく。）&lt;/p&gt;
&lt;h3&gt;午前試験：4択クイズ80問（150分）&lt;/h3&gt;
&lt;p&gt;基本情報技術者試験の午前と全く同じ形式で安心。
電卓も念のため持っていったけど午前午後とも使用不可だった。
マークシート用の太シャーペンは持ってきてよかった。&lt;/p&gt;
&lt;p&gt;第1問がこれまた&lt;a href="/previews/refs/heads/general/jinja2_version/blog/2019/05/ipa_fe.html#p-th"&gt;前回基情試験と同じ&lt;/a&gt;p進法問題でずっこけ。
&lt;strong&gt;計算問題系はせいぜい高校1年レベル&lt;/strong&gt;で、基情との違いすらよくわからない。
例えば統計検定準1級と比べると天地の差がある。&lt;/p&gt;
&lt;p&gt;一方で&lt;strong&gt;常識を問う問題などはなかなか良い&lt;/strong&gt;気がした。
虹彩認証とかソートアルゴリズムとかIPv6アドレスとか、あれ？どうだっけ？と悩まされると勉強しないといけない気持ちになる。&lt;/p&gt;
&lt;p&gt;あとは定番の呪文。
CRM, IFRS, BCP, PMO,... ごめんね、知らないよ。&lt;/p&gt;
&lt;h3&gt;午後試験：記述式選択問題（150分）&lt;/h3&gt;
&lt;p&gt;大問1が必答、大問2-11の10題から4題選択。
初めてマークシートじゃなくなったけど、記号や穴埋めが大半。
残りが20-40字の論述。  &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;選択の幅が広く、網羅的知識は必要ない。&lt;/strong&gt;
マネジメント等に関わる問題を捨てて純粋に技術的なものに限るとちょうど4題で、そういう選択が可能なように作られている模様。&lt;/p&gt;
&lt;p&gt;問題は&lt;strong&gt;結構難しかったり頭を使う&lt;/strong&gt;ものもあってレートが表れそう。
データベース問題でSQL文を書けと言われて白紙、とかやらかしたけど。。
なお非技術系の問題には常識と国語力で解けるものもあるかもだが、余分に解いて選ぶほどの時間はなかった。&lt;/p&gt;
&lt;h3&gt;合格発表&lt;/h3&gt;
&lt;p&gt;12/20(金)、、って2ケ月後。
長過ぎてとっくに忘れていると思われる。&lt;/p&gt;
&lt;h2&gt;分析・まとめ&lt;/h2&gt;
&lt;p&gt;合格基準は後で調べたところ午前午後とも60%、合格率も20%以上らしいです。&lt;/p&gt;
&lt;p&gt;AtCoderで水パフォ境界（1200）はABCでもAGCでも5000人中1000位程度、ほぼ20%です。
この試験の場合、合格者の再受験は稀と思われるので、受験者層がAtCoderを上回る道理はない。
そういう意味では水色が通るのは実験前から自明とも考えられます。
実際、60%を切ったとは思えないです。&lt;/p&gt;
&lt;p&gt;ただ、基本情報技術者試験とは明らかな差がありました。
基情は茶色以上なら受ける必要自体ない気がしますが、この応情は&lt;strong&gt;わりと面白くて復習する気にもなる&lt;/strong&gt;し、緑で落ちたりもあるかもしれない。&lt;/p&gt;
&lt;p&gt;そんなわけで、&lt;strong&gt;応用情報技術者試験は結構おすすめ&lt;/strong&gt;。
過去問だけでもいいし、暇なら受けてみるのもよいと思います。
おしまい。&lt;/p&gt;
&lt;h2&gt;追記&lt;/h2&gt;
&lt;p&gt;(2019年12月)&lt;/p&gt;
&lt;p&gt;結果は午前76.25、午後73でした。
&lt;a href="/previews/refs/heads/general/jinja2_version/blog/2019/05/ipa_fe.html"&gt;春の基本情報技術者試験&lt;/a&gt;は80と95。
やはり午前試験は難度的には基本と大差なく、午後は明らかにこちらが難しい、という感じのようです。
ただ午前試験も点差はともかく内容的には応用の方が、より技術的で良問のような気はしました。
あくまで印象でしかないので、実際には同じようなものだったりするかもしれませんが。
ご参考までに。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="検定試験"></category></entry><entry><title>機械学習のための最新GPU比較</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/10/gpus_for_ml.html" rel="alternate"></link><published>2019-10-07T00:00:00+09:00</published><updated>2019-10-07T00:00:00+09:00</updated><author><name>小川</name></author><id>tag:None,2019-10-07:/previews/refs/heads/general/jinja2_version/blog/2019/10/gpus_for_ml.html</id><summary type="html">&lt;p&gt;某所でGPU調達の必要があって、いまどきの事情を調べました。
ゲームのことは知りません。&lt;/p&gt;
&lt;h2&gt;主要GPU一覧&lt;/h2&gt;
&lt;p&gt;NVidia製Volta/Turing世代ハイエンドデスクトップ／ワークステーション用の主要GPUラインアップ。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;コア …&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;/table&gt;</summary><content type="html">&lt;p&gt;某所でGPU調達の必要があって、いまどきの事情を調べました。
ゲームのことは知りません。&lt;/p&gt;
&lt;h2&gt;主要GPU一覧&lt;/h2&gt;
&lt;p&gt;NVidia製Volta/Turing世代ハイエンドデスクトップ／ワークステーション用の主要GPUラインアップ。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;コア&lt;/th&gt;
&lt;th&gt;VRAM&lt;/th&gt;
&lt;th&gt;最大精度&lt;/th&gt;
&lt;th&gt;TDP&lt;/th&gt;
&lt;th&gt;放熱&lt;/th&gt;
&lt;th&gt;価格(税込)&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;GeForce RTX 2080Ti&lt;/td&gt;
&lt;td&gt;Turing (TU102)&lt;/td&gt;
&lt;td&gt;&lt;em&gt;11GB&lt;/em&gt;&lt;/td&gt;
&lt;td&gt;単精度&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;250W&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;外排気&lt;/td&gt;
&lt;td&gt;14万円〜&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Titan RTX&lt;/td&gt;
&lt;td&gt;Turing (TU102)&lt;/td&gt;
&lt;td&gt;24GB&lt;/td&gt;
&lt;td&gt;単精度&lt;/td&gt;
&lt;td&gt;&lt;em&gt;280W&lt;/em&gt;&lt;/td&gt;
&lt;td&gt;&lt;em&gt;内排気&lt;/em&gt;&lt;/td&gt;
&lt;td&gt;27.6万円〜※&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Quadro RTX 6000&lt;/td&gt;
&lt;td&gt;Turing (TU102)&lt;/td&gt;
&lt;td&gt;24GB&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;倍精度&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;260W&lt;/td&gt;
&lt;td&gt;外排気&lt;/td&gt;
&lt;td&gt;&lt;em&gt;41.5万円〜&lt;/em&gt;※&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Quadro RTX 8000&lt;/td&gt;
&lt;td&gt;Turing (TU102)&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;48GB&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;倍精度&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;260W&lt;/td&gt;
&lt;td&gt;外排気&lt;/td&gt;
&lt;td&gt;60万円〜※&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Titan V&lt;/td&gt;
&lt;td&gt;Volta (V102?)&lt;/td&gt;
&lt;td&gt;&lt;em&gt;12GB&lt;/em&gt;&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;倍精度&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;250W&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;外排気&lt;/td&gt;
&lt;td&gt;&lt;em&gt;40万円〜&lt;/em&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Tesla V100 32GB (参考)&lt;/td&gt;
&lt;td&gt;Volta (V100)&lt;/td&gt;
&lt;td&gt;32GB&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;倍精度&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;250W&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;外排気&lt;/td&gt;
&lt;td&gt;&lt;em&gt;99万円〜&lt;/em&gt;※&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;（&lt;strong&gt;すごい&lt;/strong&gt;。&lt;em&gt;いまいち&lt;/em&gt;。※はアカデミック価格。価格は2019年10月初頭調べ。）&lt;/p&gt;
&lt;h2&gt;ポイント&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;目を引くのはTuring世代ワークステーション用GPUの&lt;strong&gt;VRAM大容量化&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;Titan RTXでも24GB、Quadro RTX 8000に至っては&lt;strong&gt;泣く子も黙る48GB&lt;/strong&gt;。
サーバ用のTesla V100も凌ぐ。&lt;/li&gt;
&lt;li&gt;Titan RTXのみ内排気のため、多数枚の搭載には水冷システムが必要。&lt;/li&gt;
&lt;li&gt;Quadro 6000がやや割高なことを除けば、Turingコア製品の&lt;strong&gt;VRAM容量あたりの価格は概ね一定&lt;/strong&gt;なのが面白い。&lt;/li&gt;
&lt;li&gt;大きなネットワークを学習したい時など、GPU1基のメモリ容量はしばしば演算性能以上に重要。
例えばGPU予算が60万の場合、2080Tiを4枚かTitan RTXを2枚かQuadro 8000を1枚か、は用途次第。&lt;/li&gt;
&lt;li&gt;どれもTensorCore搭載。
FP16を使うように調整してやらないと本来の性能は出ない。&lt;/li&gt;
&lt;li&gt;倍精度演算機能は、実際のところ物理シミュレーションでもしない限り、あっても使わないので関係ない。遅いし。 &lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;まとめ&lt;/h2&gt;
&lt;p&gt;演算性能を妥協すれば、大容量VRAMの上位GPUにも実は手が出しやすくなっています。
用途に合わせて選びましょう。
選べる余地があるのはいいことですね。&lt;/p&gt;
&lt;p&gt;おしまい。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category><category term="ハードウェア"></category></entry><entry><title>試験 vs Python</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/09/exam_vs_python.html" rel="alternate"></link><published>2019-09-03T00:00:00+09:00</published><updated>2019-09-03T00:00:00+09:00</updated><author><name>小川</name></author><id>tag:None,2019-09-03:/previews/refs/heads/general/jinja2_version/blog/2019/09/exam_vs_python.html</id><summary type="html">&lt;h2&gt;クイズ丸暗記選手権&lt;/h2&gt;
&lt;p&gt;あさっては某科目の試験です。
クイズみたいな過去問をそのまま出すから理屈抜きで丸暗記し …&lt;/p&gt;</summary><content type="html">&lt;h2&gt;クイズ丸暗記選手権&lt;/h2&gt;
&lt;p&gt;あさっては某科目の試験です。
クイズみたいな過去問をそのまま出すから理屈抜きで丸暗記しろという、哲学的な出題だそうです。
そして僕は諸事情によりまったく勉強&lt;s&gt;して&lt;/s&gt;できていなかったので、何とかしないといけません。
&lt;s&gt;僕が悪いんじゃない世のなかが悪いんだ。&lt;/s&gt;&lt;/p&gt;
&lt;p&gt;こういうときは、もうPythonでスクリプトを書くしかないですね。&lt;br&gt;
過去問からコピペした問題リストより、ランダムに順次出題します。  &lt;/p&gt;
&lt;h2&gt;ソースコード&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;###&lt;/span&gt;
&lt;span class="c1"&gt;# 無限クイズ出題システム quiz.py&lt;/span&gt;
&lt;span class="c1"&gt;# Usage: $ python quiz.py problems_datafile.tsv&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# 問題→（キー）→解答→（キー）→問題→（無限に続く）&lt;/span&gt;
&lt;span class="c1"&gt;# &amp;#39;q&amp;#39; or &amp;#39;Q&amp;#39; or ESC で終了。&lt;/span&gt;
&lt;span class="c1"&gt;###&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;random&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;getch&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;getch&lt;/span&gt;
&lt;span class="c1"&gt;#from farbric import colors&lt;/span&gt;
&lt;span class="n"&gt;BLACK&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\033&lt;/span&gt;&lt;span class="s1"&gt;[30m&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;RED&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\033&lt;/span&gt;&lt;span class="s1"&gt;[91m&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;GREEN&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\033&lt;/span&gt;&lt;span class="s1"&gt;[92m&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;YELLOW&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\033&lt;/span&gt;&lt;span class="s1"&gt;[93m&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;BLUE&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\033&lt;/span&gt;&lt;span class="s1"&gt;[94m&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;PURPLE&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\033&lt;/span&gt;&lt;span class="s1"&gt;[95m&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;CYAN&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\033&lt;/span&gt;&lt;span class="s1"&gt;[96m&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;WHITE&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\033&lt;/span&gt;&lt;span class="s1"&gt;[97m&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;ENDC&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\033&lt;/span&gt;&lt;span class="s1"&gt;[0m&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;BOLD&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\033&lt;/span&gt;&lt;span class="s1"&gt;[1m&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;UNDERLINE&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\033&lt;/span&gt;&lt;span class="s1"&gt;[4m&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;ESC&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;27&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;filename&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;filename&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;problems.tsv&amp;#39;&lt;/span&gt;

&lt;span class="n"&gt;quit_ch&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nb"&gt;ord&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;q&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nb"&gt;ord&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Q&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;ESC&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;r&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;problem_set&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;rstrip&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\t&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;N&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;problem_set&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;n&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;span class="n"&gt;k&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;
&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;n&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
    &lt;span class="n"&gt;k_prev&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;k&lt;/span&gt;
    &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="n"&gt;k&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;k_prev&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;problem_set&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;k&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;k&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;randint&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;prb&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ans&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;problem_set&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;k&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;第&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;問&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BLUE&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;prb&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ENDC&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;key&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;ord&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;getch&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;quit_ch&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;break&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;解答&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;RED&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ans&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ENDC&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;key&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;ord&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;getch&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;quit_ch&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;break&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;実行例&lt;/h2&gt;
&lt;p&gt;$ python quiz.py parasitology_problems.tsv&lt;br&gt;
第1問&lt;br&gt;
 &lt;span style="color:blue"&gt;世界的に広く分布し、日本においては、STDの一種である。5億人の感染者の〜95%は無症状感染者 (asymptomatic cyst carrier) である。腸管に寄生し、ミトコンドリアが変化したマイトソームという細胞小器官を持つ。&lt;/span&gt;&lt;br&gt;
解答&lt;br&gt;
 &lt;span style="color:red"&gt;赤痢アメーバ&lt;/span&gt;  &lt;/p&gt;
&lt;p&gt;第2問&lt;br&gt;
 &lt;span style="color:blue"&gt;成虫は消化管粘膜に寄生し幼虫を産出するが、幼虫は宿主の外に出ることなく同じ宿主の横紋筋で被嚢し、この宿主がほかの肉食動物に捕食されるのを待つ。&lt;/span&gt;&lt;br&gt;
解答&lt;br&gt;
 &lt;span style="color:red"&gt;旋毛虫&lt;/span&gt; &lt;/p&gt;
&lt;p&gt;第3問&lt;br&gt;
 &lt;span style="color:blue"&gt;奄美、沖縄になお多くの感染者が存在し、自家感染で虫体数が増加する。&lt;/span&gt;&lt;br&gt;
解答&lt;br&gt;
 &lt;span style="color:red"&gt;糞線虫&lt;/span&gt;  &lt;/p&gt;
&lt;p&gt;第4問&lt;br&gt;
...&lt;/p&gt;
&lt;h2&gt;結論&lt;/h2&gt;
&lt;p&gt;まじめに勉強するしかないようです。&lt;br&gt;
&lt;s&gt;（試験はクイズじゃなくて競プロにしてくれたらいいのに）&lt;/s&gt;&lt;/p&gt;
&lt;p&gt;おしまい。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="勉学支援"></category></entry><entry><title>基礎配属と企業インターン</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/07/kisohai-intern.html" rel="alternate"></link><published>2019-07-14T00:00:00+09:00</published><updated>2021-03-15T00:00:00+09:00</updated><author><name>小川</name></author><id>tag:None,2019-07-14:/previews/refs/heads/general/jinja2_version/blog/2019/07/kisohai-intern.html</id><summary type="html">&lt;h2&gt;概要&lt;/h2&gt;
&lt;p&gt;来年以降に&lt;a href="http://www.edu.med.osaka-u.ac.jp/assignment/"&gt;基礎配属&lt;/a&gt;の1-2年生向けです。
基礎配属を利用して中期の企業インターンに行く、という多分そんなに例のないこと …&lt;/p&gt;</summary><content type="html">&lt;h2&gt;概要&lt;/h2&gt;
&lt;p&gt;来年以降に&lt;a href="http://www.edu.med.osaka-u.ac.jp/assignment/"&gt;基礎配属&lt;/a&gt;の1-2年生向けです。
基礎配属を利用して中期の企業インターンに行く、という多分そんなに例のないことを試みているので、参考までに。&lt;/p&gt;
&lt;p&gt;要はいろいろ可能性があるので前例に縛られずに考えてみると良い、ということです。&lt;/p&gt;
&lt;h2&gt;夏季休暇・基礎配属の予定&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;8月・9月：&lt;a href="https://www.preferred.jp"&gt;Preferred Networks株式会社&lt;/a&gt;（PFN社）の東京本社でインターン。
医療系機械学習の研究開発をする予定。&lt;/li&gt;
&lt;li&gt;10月・11月：所属研究室（生命機能/CiNet）でのんびり研究。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;これまでの準備日程&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;2019.03下旬&lt;/strong&gt;&lt;br&gt;
和佐教授（教育センター長）にメールで問い合わせ。&lt;br&gt;
Q.「基礎配属で企業に行ってもいいですか」→ A.「受入研究室からの派遣ならOKです」&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;2019.04.16(火)&lt;/strong&gt;&lt;br&gt;
基礎配属期間でインターンを行うことについて、PFN社に問い合わせる。
基本的に問題ないとの返事。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;2019.04.18(木)&lt;/strong&gt;&lt;br&gt;
PFN社のインターンに応募。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;2019.05.06(月)&lt;/strong&gt;&lt;br&gt;
応募直後に送られてきた&lt;a href="/previews/refs/heads/general/jinja2_version/blog/2019/05/gnnfrom0.html"&gt;コーディング課題の提出&lt;/a&gt;締切。&lt;br&gt;
なんだかんだで実質2日くらいしか掛けられなかった。そして風邪をひいた。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;2019.05.17(金)&lt;/strong&gt;&lt;br&gt;
一次選考の通過通知。
面接の日程調整。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;2019.05.31(金)&lt;/strong&gt;&lt;br&gt;
面接。
オンラインも可だったが、ちょうど翌日に東京で研究会参加予定だったので、この日夕方の対面を希望した。
午後の講義をさぼったことは秘密。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;2019.06.11(火)&lt;/strong&gt;&lt;br&gt;
基礎配属説明会。
教室インタビュー申込は6/28(金)まで。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;2019.06.25(火)&lt;/strong&gt;&lt;br&gt;
インターン採用通知。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;2019.06.28(金)&lt;/strong&gt;&lt;br&gt;
教室インタビュー申込締切。
実質2ヶ月になる説明を添えて4研究室に打診、うち1つは不可だったので3つ。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;2019.06.30(日)&lt;/strong&gt;&lt;br&gt;
インターン日程を8/7(水)-9/27(金)に確定。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;2019.07.02(火)-04(木)&lt;/strong&gt;&lt;br&gt;
教室インタビュー。&lt;br&gt;
この頃、東京の宿舎（マンスリーマンション）の予約・契約もする。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;2019.07.10(水)&lt;/strong&gt;&lt;br&gt;
基礎配属希望提出締切。&lt;br&gt;
結局、インタビューに行ったところではなく普段の研究室でのんびりやることにした。
夏休みもないからね。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;コメント&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;先例は全く聞いたことがなかったが、3月にまず学内で問い合わせをしたのは正解。
条件付きでOKと即答を頂けたので、企業側にも堂々と説明することができた（どこの企業もだと思うが、学期中に学業をさぼって参加することは認められていない）。&lt;/li&gt;
&lt;li&gt;結局PFNのみ、1社しか応募しなかった。
正直面倒で風邪もひいて気力がわかなかっただけなので、真似はしないでください(笑)。
準備や問い合わせももっと早めにした方がきっといいです。&lt;/li&gt;
&lt;li&gt;上記の通り、採用通知と基礎配選択の日程がかなり詰まっていて、ずれこむと面倒になるのでちょっと不安だった。
結果的には遅延もなくぎりぎりセーフ。&lt;/li&gt;
&lt;li&gt;PFNのインターンは2ヶ月までだけど、社によっては3ヶ月以上などのところもあります。
基礎配をフルに使えばそういうものもおそらく可能。あるいは2社以上に行くこともできるでしょう。
（僕はあんまり無理しないことにした。）&lt;/li&gt;
&lt;li&gt;今回程度であれば外部実習を認めてくれる研究室は上記の通り少なくないようなので、そこはさほど心配しなくてよい。
それ以上の長期になると不明。
普段繋がりのある研究室に形式的に所属する形をとるのが最も簡単ではあると思う。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;後日談など&lt;/h2&gt;
&lt;p&gt;(2021年3月追記)&lt;/p&gt;
&lt;p&gt;インターンも基礎配属も、結果的に予定通り問題なく終えることができました。
9月上旬には&lt;a href="/previews/refs/heads/general/jinja2_version/blog/2019/09/exam_vs_python.html"&gt;試験&lt;/a&gt;のために東京大阪の複数回とんぼ返りを強いられたりしましたが、、どうにか落ちることもなく（試験日程は確認しておいた方がいいでしょう）。&lt;/p&gt;
&lt;p&gt;ともあれ、3月から色々と頑張ってやりくりした以上の価値は間違いなくあったと言い切れます。&lt;/p&gt;
&lt;p&gt;研究室配属期間の利用は中期以上の企業インターンに医学生が参加するほぼ唯一の方法でもあり、今はまだマイナーですが、もっと広がらないかなと個人的には思っています。
興味を持ったら、ぜひ積極的に動いてみてください。&lt;/p&gt;
&lt;p&gt;おしまい。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="企業インターン"></category></entry><entry><title>AtCoder Beginners Selection 雑感</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/06/atcoder_beginners_selection.html" rel="alternate"></link><published>2019-06-24T00:00:00+09:00</published><updated>2019-06-24T00:00:00+09:00</updated><author><name>加藤</name></author><id>tag:None,2019-06-24:/previews/refs/heads/general/jinja2_version/blog/2019/06/atcoder_beginners_selection.html</id><summary type="html">&lt;p&gt;プログラミング初心者の加藤です。勉強会の時に、とりあえずやってみたらいいよと言われたので、よく分からないま …&lt;/p&gt;</summary><content type="html">&lt;p&gt;プログラミング初心者の加藤です。勉強会の時に、とりあえずやってみたらいいよと言われたので、よく分からないままやってみました。その概要と雑感です。&lt;/p&gt;
&lt;h2&gt;AtCoderとは？&lt;/h2&gt;
&lt;p&gt;まず始めにAtCoderの説明から。AtCoderとは、オンライン上で競技プログラミングのコンテストを提供しているサイトのことです(&lt;a href="https://atcoder.jp/?lang=ja"&gt;https://atcoder.jp/?lang=ja&lt;/a&gt;)。  &lt;/p&gt;
&lt;p&gt;定期的にコンテストを主催していたり、企業から(広告や人材獲得戦略の一環として) コンテストが開かれることもあります。コンテストに参加する以外にも、コンテストで使用された問題を解くこともでき、初心者でも、「プログラミング勉強したいけど本をなぞるだけじゃつまらない！」っていう僕みたいなわがままな人にはちょうどいいモチベーションアッパーになると思います。&lt;/p&gt;
&lt;h2&gt;AtCoder Beginners Selectionを解こう！&lt;/h2&gt;
&lt;p&gt;チュートリアルを読むと、「何をすれば良いか分からない人は、&lt;a href="https://atcoder.jp/contests/abs"&gt;AtCoder Beginners Selection&lt;/a&gt;から、まずいくつかの問題を解いてみましょう。」と書いてあります。ページに飛んでみると、さらに、「このコンテストは、『AtCoderに登録したけど何をしていいか分からない・・・！』という人に向けて作られた初心者向け問題集です。」とも書いてます。&lt;/p&gt;
&lt;p&gt;何も分かってない子羊ちゃんは素直に優しい言葉に付いて行くのでした。 以下いくつかの問題をピックアップしてみます。&lt;/p&gt;
&lt;h3&gt;問題０：はじめてのあっとこーだー&lt;/h3&gt;
&lt;p&gt;わざわざ平仮名で表記しちゃってまあどんな接待をしてくれるのやら...。問題文を読みます。&lt;/p&gt;
&lt;hr&gt;

&lt;h4&gt;問題文&lt;/h4&gt;
&lt;p&gt;高橋君はデータの加工が行いたいです。
整数 &lt;span class="math"&gt;\(a,b,c\)&lt;/span&gt;と、文字列 &lt;span class="math"&gt;\(s\)&lt;/span&gt; が与えられます。整数 &lt;span class="math"&gt;\(a+b+c\)&lt;/span&gt; の計算結果と、文字列 &lt;span class="math"&gt;\(s\)&lt;/span&gt; を並べて表示しなさい。&lt;/p&gt;
&lt;h4&gt;制約&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;span class="math"&gt;\(1\leq a, b, c \leq 1,000\)&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class="math"&gt;\(1\leq | s | \leq 100\)&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;入力&lt;/h4&gt;
&lt;p&gt;入力は次の形式で与えられる。
&lt;/p&gt;
&lt;div class="math"&gt;$$
\begin{align*}
&amp;amp;a\\
&amp;amp;b\quad c\\
&amp;amp;s
\end{align*}
$$&lt;/div&gt;
&lt;h4&gt;出力&lt;/h4&gt;
&lt;p&gt;&lt;span class="math"&gt;\(a+b+c\)&lt;/span&gt;と&lt;span class="math"&gt;\(s\)&lt;/span&gt;を空白区切りで1行に出力せよ。&lt;/p&gt;
&lt;hr&gt;

&lt;p&gt;ん？入力ってなんだ？(競プロ初心者並感)
いや入力はinputを使えばいい、でも「b c」はどうやって入力するんだ？(Python初心者並感)&lt;/p&gt;
&lt;p&gt;そもそも複数行の入力ってどうするんだ？(プログラミング初心者並感)&lt;/p&gt;
&lt;p&gt;......(思考停止)&lt;/p&gt;
&lt;p&gt;数問解いた後の話ですが、気付きました。 ああこれが競技プログラミングなのか。 あれです、初心者あるあるの「思ってたのと違う」ってやつです。今回のは悪い意味ではないのですが。言語つながりで、例えば英語の問題なら、文法や読解、和文英訳など受験でさんざんやった形式のものが思い浮かびます。てっきりそういう類いの問題が出るのかなと思っていたら、完全に実践形式の問題で驚きました。英語始めたばっかりで、いきなり英会話しようと言われたら誰だってそうなるでしょう。&lt;/p&gt;
&lt;p&gt;このように競技プログラミングでは答えが決まってはなく、かなりのバリエーションがあり、独自に考えたプログラムが答えになり得るというのが面白みの一つですね。また、同じ方針でも表記の仕方がたくさんあって、まるで方言のようです。&lt;/p&gt;
&lt;p&gt;まとめっぽくなりましたが問題に戻ります。考えても分かる訳なさそうなので、この問題にだけついている解答例を見ます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# -*- coding: utf-8 -*-&lt;/span&gt;
&lt;span class="c1"&gt;# 整数の入力&lt;/span&gt;
&lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;span class="c1"&gt;# スペース区切りの整数の入力&lt;/span&gt;
&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;c&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;span class="c1"&gt;# 文字列の入力&lt;/span&gt;
&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="c1"&gt;# 出力&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s2"&gt; &lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;いまさらですが言語はPython3です。 なるほど、入力が複数行に分かれているのは文字列にエンターが含まれているからなのか、input１回だけで全て読み込めるのではないのだな。行が分かれているというのは本質的ではなく、入力をそのまま表示した結果なのか。いつものインタプリタと同じだ。というのがこの問題で一番印象に残った事です。&lt;/p&gt;
&lt;p&gt;map とかフォーマットとか、多分見るのが２ヶ月ぶりとかで、ああそういえばそんなのあったな状態です。&lt;/p&gt;
&lt;h3&gt;問題４：Coins&lt;/h3&gt;
&lt;p&gt;コンピューターっぽくて印象的な問題です。よくみる整数問題ですね。これは簡単に解けると思いきや...？こういう問題は受験数学的にはパパッと場合分けが浮かびますが、その条件分けを実装するのは面倒です。そう、受験問題では入力が１つだけですが、競技プログラミングでは複数の入力がなされるため、全ての場合分けに対応しないといけません。できないことはないですが、正直言ってかなり面倒です。&lt;/p&gt;
&lt;hr&gt;

&lt;h4&gt;問題文&lt;/h4&gt;
&lt;p&gt;あなたは、500円玉を&lt;span class="math"&gt;\(A\)&lt;/span&gt;枚、100円玉を&lt;span class="math"&gt;\(B\)&lt;/span&gt;枚、50円玉を&lt;span class="math"&gt;\(C\)&lt;/span&gt;枚持っています。これらの硬貨の中から何枚かを選び、合計金額をちょうど&lt;span class="math"&gt;\(X\)&lt;/span&gt;円にする方法は何通りありますか。
同じ種類の硬貨同士は区別できません。２通りの硬貨の選び方は、ある種類の硬貨についてその硬貨を選ぶ枚数が異なるとき区別されます。&lt;/p&gt;
&lt;h4&gt;制約&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;span class="math"&gt;\(0 \leq A, B, C \leq 50\)&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class="math"&gt;\(A+B+C \geq 1\)&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class="math"&gt;\(50 \leq X \leq 20,000\)&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class="math"&gt;\(A,B,C\)&lt;/span&gt; は整数である&lt;/li&gt;
&lt;li&gt;&lt;span class="math"&gt;\(X\)&lt;/span&gt;は50の倍数である&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;入力&lt;/h4&gt;
&lt;p&gt;入力は以下の形式で標準入力から与えられる。
&lt;/p&gt;
&lt;div class="math"&gt;$$
\begin{align*}
　&amp;amp;A\\
　&amp;amp;B\\
　&amp;amp;C\\
　&amp;amp;X
\end{align*}
$$&lt;/div&gt;
&lt;h4&gt;出力&lt;/h4&gt;
&lt;p&gt;硬貨を選ぶ方法の個数を出力せよ。&lt;/p&gt;
&lt;hr&gt;

&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;)])&lt;/span&gt;
&lt;span class="n"&gt;ans&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;j&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;k&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="mi"&gt;500&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;j&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="mi"&gt;100&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;k&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="mi"&gt;50&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="n"&gt;ans&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ans&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;(&lt;a href="http://delta114514.hatenablog.jp/entry/2018/03/15/014555"&gt;http://delta114514.hatenablog.jp/entry/2018/03/15/014555&lt;/a&gt; より引用)&lt;/p&gt;
&lt;p&gt;しばらく場合分けを考えていましたが、ギブアップして答えを検索。ABSは有名らしく色んな人が色んな言語で解答をあげています。
このコードはつまるところ、総当たりをして条件を満たすものをカウントしてるんですね。なるほど！ヒトが計算するならこんな面倒なことはしないけれどコンピューターならできる。はっとしました。&lt;/p&gt;
&lt;h3&gt;問題７：Kagami Mochi&lt;/h3&gt;
&lt;hr&gt;

&lt;h4&gt;問題文&lt;/h4&gt;
&lt;p&gt;&lt;span class="math"&gt;\(X\)&lt;/span&gt;段重ねの鏡餅(&lt;span class="math"&gt;\(X\geq 1\)&lt;/span&gt;) とは&lt;span class="math"&gt;\(X\)&lt;/span&gt;枚の円形の餅を縦に積み重ねたものであって、どの餅もその真下の餅より直径が小さい（一番下の餅を除く）もののことです。
例えば、直径10、8、6センチメートルの餅をこの順に下から積み重ねると3段重ねの鏡餅になり、
餅を一枚だけ置くと1段重ねの鏡餅になります。
ダックスフンドのルンルンは&lt;span class="math"&gt;\(N\)&lt;/span&gt;枚の円形の餅を持っていて、そのうち&lt;span class="math"&gt;\(i\)&lt;/span&gt; 枚目の餅の直径は&lt;span class="math"&gt;\(d_i\)&lt;/span&gt;センチメートルです。これらの餅のうち一部または全部を使って鏡餅を作るとき、
最大で何段重ねの鏡餅を作ることができるでしょうか。&lt;/p&gt;
&lt;h4&gt;制約&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;span class="math"&gt;\(1 \leq N \leq 100\)&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class="math"&gt;\(1 \leq d_i \leq 100\)&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;入力値は全て整数である。&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;入力&lt;/h4&gt;
&lt;p&gt;入力は以下の形式で標準入力から与えられる。
&lt;/p&gt;
&lt;div class="math"&gt;$$
\begin{align*}
&amp;amp;N\\
&amp;amp;d_1\\
&amp;amp;：\\
&amp;amp;d_N
\end{align*}
$$&lt;/div&gt;
&lt;h4&gt;出力&lt;/h4&gt;
&lt;p&gt;作ることのできる鏡餅の最大の段数を出力せよ。&lt;/p&gt;
&lt;hr&gt;

&lt;h4&gt;普通の解法&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;n&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;set&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)]))))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;(&lt;a href="http://delta114514.hatenablog.jp/entry/2018/03/15/014555"&gt;http://delta114514.hatenablog.jp/entry/2018/03/15/014555&lt;/a&gt; より引用)&lt;br&gt;
入力をリストにしてからセットにして要素数を数える。当然ですね。僕はセットの存在を思い出せなかったので、次のようにしました。&lt;/p&gt;
&lt;h4&gt;僕の解法&lt;/h4&gt;
&lt;p&gt;ソートしてからリストのままでなんとか数えあげました。明らかに汚いですね。長いですし、n=1で場合分けしてますし。こんな初心者じみた答えでも合ってたらいいんです。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;n&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;sorted&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)])))&lt;/span&gt;
&lt;span class="n"&gt;ans&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]:&lt;/span&gt;
            &lt;span class="n"&gt;ans&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ans&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;問題９：Daydream&lt;/h3&gt;
&lt;p&gt;問題文の通りに、後ろから４単語のどれかを検索していくのが一番わかりやすいと思われます。が、わざわざeraseという単語を選んできたということは、こういうことでしょう。&lt;/p&gt;
&lt;hr&gt;

&lt;h4&gt;問題文&lt;/h4&gt;
&lt;p&gt;英小文字からなる文字列&lt;span class="math"&gt;\(S\)&lt;/span&gt; が与えられます。 &lt;span class="math"&gt;\(T\)&lt;/span&gt;が空文字列である状態から始め、
以下の操作を好きな回数繰り返すことで &lt;span class="math"&gt;\(S=T\)&lt;/span&gt; とすることができるか判定してください。
- &lt;span class="math"&gt;\(T\)&lt;/span&gt;の末尾に&lt;code&gt;dream dreamer erase eraser&lt;/code&gt; のいずれかを追加する。&lt;/p&gt;
&lt;h4&gt;制約&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;span class="math"&gt;\(1\leq |S|\leq 10^5\)&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class="math"&gt;\(S\)&lt;/span&gt;は英小文字からなる。&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;入力&lt;/h4&gt;
&lt;p&gt;入力は以下の形式で標準入力から与えられる。
&lt;/p&gt;
&lt;div class="math"&gt;$$S$$&lt;/div&gt;
&lt;h4&gt;出力&lt;/h4&gt;
&lt;p&gt;&lt;span class="math"&gt;\(S=T\)&lt;/span&gt;とすることができる場合&lt;code&gt;'YES'&lt;/code&gt;を、そうでない場合&lt;code&gt;'NO'&lt;/code&gt;を出力せよ。&lt;/p&gt;
&lt;hr&gt;

&lt;h4&gt;僕の解法&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;eraser&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;b&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;erase&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;c&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;dreamer&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;d&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;dream&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;strip&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;YES&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;NO&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;文字列の後ろからだけでなく、途中から抜いても、抜く単語の順番をうまく決めれば問題ないはずです。&lt;br&gt;
変数をいちいち置いているのが恥ずかしいですが、通ればいいんです。  &lt;/p&gt;
&lt;h4&gt;別解答&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;eraser&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;erase&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;dreamer&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;dream&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;NO&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;YES&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;(&lt;a href="http://delta114514.hatenablog.jp/entry/2018/03/15/014555"&gt;http://delta114514.hatenablog.jp/entry/2018/03/15/014555&lt;/a&gt; より引用)&lt;br&gt;
通ればなんでもいいはずなんですが、これはどうでしょう。この解答例だと、&lt;code&gt;'d erase r erase e erase a erase m'&lt;/code&gt; という文字列(スペースは抜いてください)もYESになってしまうはずなのですが、試しにこのコードを提出してみるとacceptされました。(嘘解法なんでしょうか？にしては同じような答えを書いてる人が大勢います。)&lt;/p&gt;
&lt;h2&gt;初学者にとっての競技プログラミング&lt;/h2&gt;
&lt;p&gt;解いてみた感想ですが、やはり考えるのは楽しいです。久々に数学的な頭の使い方をして懐かしさも覚えました。 また、何より、競技プログラミングは初学者にかなり便利なものだと感じました。ほんとに基礎的な部分しか学習してなくても解けるというのは取り組みやすいですし、結果がだせることは嬉しいです。過去問ならネット上にたくさん解説があるのでつまってもなんとかなります。&lt;/p&gt;
&lt;p&gt;他の人のコードを見ることができ、考え方の幅も広がります。上手く書けなかったコードを見直したり、異なった方針で書かれたコードを見るのはいい刺激になります。 特に基礎の文法に慣れるという点では一番だと思います。基礎を洗練させることは必ずこの先モジュールやパッケージを使っていくにしても、理解して扱えることができ役に立つことでしょう。&lt;/p&gt;
&lt;p&gt;もちろん万能ではありません。競技プログラミングの内容はプログラミング一般から見て偏っているらしいです。「競技プログラミング　デメリット」で調べると批判がたくさん出てきます。&lt;/p&gt;
&lt;p&gt;でも少なくともPython会に入ってる初心者の人は、ソフト開発のような能力ではなく、プログラミングをツールとして扱える能力を求めている人がほとんどでしょうから、うってつけの教材だと思います。&lt;/p&gt;
&lt;p&gt;簡単なブロック崩しのゲームを作ったことがありますが、今回の方がよっぽど練習になりました。もし興味があれば皆さんも是非試してみてください。&lt;/p&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="技術ブログ"></category><category term="競技プログラミング"></category></entry><entry><title>Estimation statisticsに基づいたデータの可視化ライブラリ -DABEST-</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/06/dabest_tutorial.html" rel="alternate"></link><published>2019-06-23T00:00:00+09:00</published><updated>2019-06-23T00:00:00+09:00</updated><author><name>山本</name></author><id>tag:None,2019-06-23:/previews/refs/heads/general/jinja2_version/blog/2019/06/dabest_tutorial.html</id><summary type="html">&lt;p&gt;データを可視化する手法としては、棒グラフ(&lt;strong&gt;Barplot&lt;/strong&gt;), 箱ひげ図(&lt;strong&gt;Boxplot&lt;/strong&gt;), &lt;strong&gt;Jitter plot&lt;/strong&gt;, &lt;strong&gt;Violin plot&lt;/strong&gt; などがよく用いられます。しかし、これらの可視化 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;データを可視化する手法としては、棒グラフ(&lt;strong&gt;Barplot&lt;/strong&gt;), 箱ひげ図(&lt;strong&gt;Boxplot&lt;/strong&gt;), &lt;strong&gt;Jitter plot&lt;/strong&gt;, &lt;strong&gt;Violin plot&lt;/strong&gt; などがよく用いられます。しかし、これらの可視化手法は &lt;strong&gt;有意差検定(null hypothesis significance testing; NHST)&lt;/strong&gt; の結果を表示するためのものです。有意差検定は様々な分野の研究において広く用いられていますが、統計検定の結果の評価に&lt;strong&gt;p値&lt;/strong&gt;を用いることは二分的な評価に繋がっています(例えばp&amp;lt;0.05ならOKでp&amp;gt;0.05ならダメ、という判断)。一方で、&lt;strong&gt;Estimation Statistics&lt;/strong&gt;はp値ではなく &lt;strong&gt;効果量(effect size)&lt;/strong&gt; に重きを置きます。つまり、効果がある/なしではなく、どのくらい効果があるか、を重視するということです。&lt;/p&gt;
&lt;p&gt;今回紹介する &lt;strong&gt;DABEST&lt;/strong&gt; (&lt;strong&gt;D&lt;/strong&gt;ata &lt;strong&gt;A&lt;/strong&gt;nalysis using &lt;strong&gt;B&lt;/strong&gt;ootstrap-coupled &lt;strong&gt;EST&lt;/strong&gt;imation)はEstimation Statisticsに基づいたデータの可視化を行うためのライブラリ（パッケージ）です。 &lt;strong&gt;Python, R, Matlab&lt;/strong&gt; に対応しています。以下はDABESTについての論文です。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;J. Ho, T. Tumkaya, S. Aryal, H. Choi, A. Claridge-Chang. &lt;strong&gt;Moving beyond P values: Everyday data analysis with estimation plots&lt;/strong&gt;. &lt;em&gt;Nature Methods&lt;/em&gt;. (2019), 1548-7105. 10.1038/s41592-019-0470-3. (&lt;a href="https://www.nature.com/articles/s41592-019-0470-3"&gt;Nature Methods&lt;/a&gt;, &lt;a href="https://www.biorxiv.org/content/10.1101/377978v2"&gt;bioRxiv&lt;/a&gt;)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3&gt;ライブラリ&lt;/h3&gt;
&lt;p&gt;DABESTにはPython(&lt;a href="https://github.com/ACCLAB/DABEST-python"&gt;DABEST-Python&lt;/a&gt;)とR(&lt;a href="https://github.com/ACCLAB/dabestr"&gt;dabestr&lt;/a&gt;), Matlab(&lt;a href="https://github.com/ACCLAB/DABEST-Matlab"&gt;DABEST-Matlab&lt;/a&gt;)での実装があります。&lt;strong&gt;この記事ではPythonのライブラリを使用します&lt;/strong&gt;。&lt;/p&gt;
&lt;h3&gt;Estimation Stats&lt;/h3&gt;
&lt;p&gt;このDABESTには著者らによる優れたHP(&lt;a href="https://www.estimationstats.com/#/"&gt;Estimation Stats&lt;/a&gt;)が存在します。このHPには&lt;a href="https://www.estimationstats.com/#/background"&gt;Estimation statisticsとDABESTで用いられる手法の解説&lt;/a&gt;があり、さらに&lt;strong&gt;csvファイルをアップロードするだけ&lt;/strong&gt;でEstimation statisticsに基づいたデータの可視化ができるページもあります。コードを書く必要はなく、効果量としてどの指標を用いるか(Mean difference, Median difference, Cohen's d, hedges' g, Cliff's deltaなど)も選択できます。&lt;/p&gt;
&lt;h2&gt;DABESTチュートリアル&lt;/h2&gt;
&lt;p&gt;DABESTのチュートリアルは既に用意されています(&lt;a href="https://acclab.github.io/DABEST-python-docs/tutorial.html"&gt;Tutorial-dabest 0.2.4 documentation&lt;/a&gt;)。以下ではインストールの方法と簡単な使い方の紹介をします。&lt;/p&gt;
&lt;h3&gt;インストール&lt;/h3&gt;
&lt;p&gt;DABEST(0.24)は次のライブラリに依存しています(括弧内はバージョン)： numpy(1.15), scipy(1.2), matplotlib(3.0), seaborn(0.9), pandas(0.24)。基本的なライブラリですが、必要に応じてバージョンアップ(またはダウン)しましょう。DABESTのインストールは次のコマンドによりpipで行うことができます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;pip install dabest
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;Quickstart&lt;/h3&gt;
&lt;p&gt;インストールしたら、とりあえずコードが動くか確認してみましょう。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pandas&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;pd&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;matplotlib.pyplot&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;plt&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;dabest&lt;/span&gt;

&lt;span class="c1"&gt;# Load the iris dataset. Requires internet access.&lt;/span&gt;
&lt;span class="n"&gt;iris&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pd&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read_csv&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://github.com/mwaskom/seaborn-data/raw/master/iris.csv&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# Load the above data into `dabest`.&lt;/span&gt;
&lt;span class="n"&gt;iris_dabest&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;dabest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;load&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;iris&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;species&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;petal_width&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                          &lt;span class="n"&gt;idx&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;setosa&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;versicolor&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;virginica&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

&lt;span class="c1"&gt;# Produce a Cumming estimation plot and save plot.&lt;/span&gt;
&lt;span class="n"&gt;iris_dabest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;mean_diff&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;plot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fig_size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;7&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;savefig&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;quick_start.png&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;以下のようなグラフが出力されれば成功です。&lt;br&gt;
&lt;img alt="quick_start" src="{attach}images/DABEST_tutorial_figs/quick_start.png"&gt;&lt;/p&gt;
&lt;p&gt;このグラフは &lt;strong&gt;Cumming plot&lt;/strong&gt; という可視化の方法です。Estimation statisticsにおける可視化の方法としてはもう1つ &lt;strong&gt;Gardner-Altman plot&lt;/strong&gt; というものがあります。以下ではこの2つの可視化方法の見方とコードについて紹介します。&lt;/p&gt;
&lt;h3&gt;Gardner-Altman plot&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Gardner-Altman plot&lt;/strong&gt; はM. GardnerとD. Altmanによって提案された描画法です。以下はGardner-Altman plotの例です。図の左側では両方の群のすべての観測値をJitter plotにより表示しています。右側にあるのは効果量の軸で、効果量の点推定(黒丸)と信頼区間(縦の黒棒)を表示しています。この効果量の信頼区間ですが、これは &lt;strong&gt;Bootstrap法&lt;/strong&gt; を用いて算出しています。なお、Bootstrap法に関しては後で詳しく述べます。&lt;br&gt;
&lt;img alt="ga1" src="{attach}images/DABEST_tutorial_figs/ga1.png"&gt;&lt;/p&gt;
&lt;p&gt;コードは次のようになっています。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;numpy&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;np&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pandas&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;pd&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;matplotlib.pyplot&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;plt&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;dabest&lt;/span&gt;

&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;seed&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;20190623&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# Generate toy dataset&lt;/span&gt;
&lt;span class="n"&gt;x1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;normal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loc&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;50&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;scale&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;50&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;x2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;normal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loc&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;60&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;scale&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;40&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;df&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pd&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;DataFrame&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;x1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;x2&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;
&lt;span class="n"&gt;df&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;columns&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Control&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Test&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;

&lt;span class="c1"&gt;# Load the above data into `dabest`.&lt;/span&gt;
&lt;span class="n"&gt;df_dabest&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;dabest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;load&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;df&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;idx&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Control&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Test&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;df_dabest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;mean_diff&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;plot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fig_size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="c1"&gt;#df_dabest.cohens_d.plot(fig_size=(5,4))&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;savefig&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;ga1.png&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;bbox_inches&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;tight&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Gardner-Altman plotには &lt;strong&gt;対応のある2群(paired)&lt;/strong&gt; のためのバージョンもあります。&lt;br&gt;
&lt;img alt="ga2" src="{attach}images/DABEST_tutorial_figs/ga2.png"&gt;&lt;/p&gt;
&lt;p&gt;ここでは効果量として &lt;strong&gt;Cohen's d&lt;/strong&gt; を用いています。コードは次のようになります(ライブラリのインポートは省略)。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# Generate toy dataset&lt;/span&gt;
&lt;span class="n"&gt;size&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;20&lt;/span&gt;
&lt;span class="n"&gt;idx&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arange&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;x1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;normal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loc&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;50&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;scale&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;x2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;normal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loc&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;60&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;scale&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;df&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pd&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;DataFrame&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;idx&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;x1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;x2&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;
&lt;span class="n"&gt;df&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;columns&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;idx&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Control&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Test&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;

&lt;span class="c1"&gt;# Load the above data into `dabest`.&lt;/span&gt;
&lt;span class="n"&gt;df_dabest&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;dabest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;load&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;df&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;idx&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Control&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Test&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                        &lt;span class="n"&gt;paired&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;id_col&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;idx&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;df_dabest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cohens_d&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;plot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fig_size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="c1"&gt;#df_dabest.mean_diff.plot(fig_size=(4,4))&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;savefig&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;ga2.png&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;bbox_inches&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;tight&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;Cumming plot&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Cumming plot&lt;/strong&gt; はG. Cummingによって提案された描画法です。複数の群に対して2つ以上の効果量およびそれらの信頼区間を、今度は観測データの下に描画しています。&lt;br&gt;
&lt;img alt="cumming" src="{attach}images/DABEST_tutorial_figs/cumming.png"&gt;&lt;/p&gt;
&lt;p&gt;ここでは効果量として &lt;strong&gt;hedges' g&lt;/strong&gt; を用いています。コードは次のようになります(ライブラリのインポートは省略)。  &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# Generate toy dataset&lt;/span&gt;
&lt;span class="n"&gt;size1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;20&lt;/span&gt;
&lt;span class="n"&gt;size2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;25&lt;/span&gt;

&lt;span class="n"&gt;xc1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;normal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loc&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;50&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;scale&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;20&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;size1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;xt1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;normal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loc&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;55&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;scale&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;size1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;xc2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;normal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loc&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;60&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;scale&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;size2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;xt2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;normal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loc&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;50&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;scale&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;25&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;size2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;df&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pd&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;DataFrame&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;xc1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;xt1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;xc2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;xt2&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;
&lt;span class="n"&gt;df&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;columns&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Control1&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Test1&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Control2&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Test2&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;

&lt;span class="c1"&gt;# Load the above data into `dabest`.&lt;/span&gt;
&lt;span class="n"&gt;df_dabest&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;dabest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;load&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;df&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;idx&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Control1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Test1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                                      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Control2&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Test2&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;

&lt;span class="c1"&gt;#df_dabest.cohens_d.plot(fig_size=(5,5))&lt;/span&gt;
&lt;span class="c1"&gt;#df_dabest.mean_diff.plot(fig_size=(5,5))&lt;/span&gt;
&lt;span class="n"&gt;df_dabest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;hedges_g&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;plot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fig_size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;savefig&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;cumming.png&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;bbox_inches&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;tight&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;Bootstrap Confidence Intervalについて&lt;/h2&gt;
&lt;p&gt;Bootstrap法で算出する信頼区間を &lt;strong&gt;Bootstrap Confidence Interval&lt;/strong&gt; といいます。信頼区間を出すためには多数のサンプルが必要ですが、Bootstrap法により疑似的に実験を繰り返し、2群間での効果量を算出することで多数の効果量のサンプルを得ることで解決します。  &lt;/p&gt;
&lt;p&gt;DABESTによる実装を用いずに効果量の信頼区間を描画してみます。正規分布に従う2つの群(N(50, 20&lt;sup&gt;2&lt;/sup&gt;), N(60, 20&lt;sup&gt;2&lt;/sup&gt;))からそれぞれ50サンプルを得たとします。効果量を平均の差として、5000回ブートストラップを行い、効果量のサンプルを5000個得ます。この場合のコードは以下のようになります。描画のためのコードが多いですが、&lt;code&gt;np.random.choice(x, size, replace=True)&lt;/code&gt;を用いればよい、というのが大事な部分です。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;numpy&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;np&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;matplotlib.pyplot&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;plt&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;seaborn&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;sns&lt;/span&gt;

&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;seed&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;20190623&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# generate observation (toy data)&lt;/span&gt;
&lt;span class="n"&gt;size&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;50&lt;/span&gt; &lt;span class="c1"&gt;# sample size&lt;/span&gt;
&lt;span class="n"&gt;sigma&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;20&lt;/span&gt;
&lt;span class="n"&gt;mu1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;50&lt;/span&gt;
&lt;span class="n"&gt;mu2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;60&lt;/span&gt;
&lt;span class="n"&gt;diff_mu&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;abs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mu2&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;mu1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;x1_obs&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;normal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loc&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;mu1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;scale&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;sigma&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;x2_obs&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;normal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loc&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;mu2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;scale&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;sigma&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;num_bootstrap&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;5000&lt;/span&gt;
&lt;span class="n"&gt;alpha&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mf"&gt;0.025&lt;/span&gt;

&lt;span class="n"&gt;es_bootstrap&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;zeros&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;num_bootstrap&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# array to save bootstrapped effect size&lt;/span&gt;

&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;num_bootstrap&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c1"&gt;# bootstrapping&lt;/span&gt;
    &lt;span class="n"&gt;x1_resampling&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;choice&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x1_obs&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;x2_resampling&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;choice&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x2_obs&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="c1"&gt;# calculate effect size (mean difference) and save.&lt;/span&gt;
    &lt;span class="n"&gt;mu&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;mean&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x2_resampling&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;mean&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x1_resampling&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;es_bootstrap&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;mu&lt;/span&gt;

&lt;span class="c1"&gt;# plot&lt;/span&gt;
&lt;span class="n"&gt;ax&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sns&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;kdeplot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;es_bootstrap&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;shade&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;data_x&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;data_y&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ax&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;lines&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_data&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;vlines&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ymin&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ymax&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;data_y&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;max&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;color&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;k&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;linestyle&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;dashed&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;vlines&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;diff_mu&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ymin&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ymax&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;data_y&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;max&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;color&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;r&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;linestyle&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;dashed&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;vlines&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;mean&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;es_bootstrap&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;ymin&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ymax&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;data_y&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;max&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;color&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;g&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;es_bootstrap_sorted&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sort&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;es_bootstrap&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# to plot 95% CI&lt;/span&gt;
&lt;span class="n"&gt;idx_alpha&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argmin&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;abs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data_x&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;es_bootstrap_sorted&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;num_bootstrap&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;alpha&lt;/span&gt;&lt;span class="p"&gt;)]))&lt;/span&gt;
&lt;span class="n"&gt;idx_one_m_alpha&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argmin&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;abs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data_x&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;es_bootstrap_sorted&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;num_bootstrap&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;alpha&lt;/span&gt;&lt;span class="p"&gt;))]))&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;vlines&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;es_bootstrap_sorted&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;num_bootstrap&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;alpha&lt;/span&gt;&lt;span class="p"&gt;)],&lt;/span&gt; &lt;span class="n"&gt;ymin&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ymax&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;data_y&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;idx_alpha&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;vlines&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;es_bootstrap_sorted&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;num_bootstrap&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;alpha&lt;/span&gt;&lt;span class="p"&gt;))],&lt;/span&gt; &lt;span class="n"&gt;ymin&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ymax&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;data_y&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;idx_one_m_alpha&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;xlabel&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Mean difference&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ylabel&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Density&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;#plt.show()&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;savefig&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;bootstrap_ci.png&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;結果は次のようになります。&lt;br&gt;
&lt;img alt="bootstrap_ci" src="{attach}images/DABEST_tutorial_figs/bootstrap_ci.png"&gt;&lt;/p&gt;
&lt;p&gt;横軸が平均の差、縦軸が密度です。黒破線は0, 赤破線は真の分布の平均の差(今回であれば10)、緑実線は効果量の点推定(要は平均値)です。黒実線は第1, 3四分位数で、この間を95%信頼区間と近似しています(この信頼区間の算出手法を &lt;strong&gt;パーセンタイル法&lt;/strong&gt; といいます)。これは簡易な手法ですが、他にも算出方法はあります。&lt;/p&gt;
&lt;h2&gt;まとめ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;p値と共に&lt;strong&gt;効果量も報告&lt;/strong&gt;しよう。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;効果量も図の中に表示&lt;/strong&gt;しよう。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;DABEST&lt;/strong&gt; を用いれば簡単に効果量とその精度(信頼区間)を表示できる。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;参考文献&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;https://en.wikipedia.org/wiki/Estimation_statistics&lt;/li&gt;
&lt;li&gt;https://en.wikipedia.org/wiki/Bootstrapping_(statistics)&lt;/li&gt;
&lt;li&gt;統計学の時間（&lt;a href="https://bellcurve.jp/statistics/course/12752.html"&gt;効果量1&lt;/a&gt;, &lt;a href="https://bellcurve.jp/statistics/course/12765.html"&gt;効果量2&lt;/a&gt;）&lt;/li&gt;
&lt;li&gt;岡田謙介. &lt;strong&gt;心理学における効果量をめぐる最近の話題&lt;/strong&gt;. (&lt;a href="http://www3.psy.senshu-u.ac.jp/~ken/DevPsy2015_okada.pdf"&gt;pdf&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;汪金芳. &lt;strong&gt;ブートストラップ法入門&lt;/strong&gt;. (&lt;a href="http://www.math.s.chiba-u.ac.jp/~wang/bootstrap.pdf"&gt;pdf&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;</content><category term="技術ブログ"></category><category term="Statistics"></category></entry><entry><title>がんゲノム変異シグネチャー解析</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/06/cancer_signature.html" rel="alternate"></link><published>2019-06-21T00:00:00+09:00</published><updated>2019-06-21T00:00:00+09:00</updated><author><name>山田</name></author><id>tag:None,2019-06-21:/previews/refs/heads/general/jinja2_version/blog/2019/06/cancer_signature.html</id><summary type="html">&lt;p&gt;がんゲノムの変異シグネチャーの推定にチャレンジしてみました。&lt;/p&gt;
&lt;p&gt;&lt;img src="{attach}images/cancer_signature_figs/1.png" width="400px"&gt;&lt;/p&gt;
&lt;h2&gt;きっかけ&lt;/h2&gt;
&lt;p&gt;先日の遺伝学の講義にて、がんゲノムの …&lt;/p&gt;</summary><content type="html">&lt;p&gt;がんゲノムの変異シグネチャーの推定にチャレンジしてみました。&lt;/p&gt;
&lt;p&gt;&lt;img src="{attach}images/cancer_signature_figs/1.png" width="400px"&gt;&lt;/p&gt;
&lt;h2&gt;きっかけ&lt;/h2&gt;
&lt;p&gt;先日の遺伝学の講義にて、がんゲノムの変異シグネチャーを教えていただき、やり方も詳しく書かれていたので、挑戦してみました。&lt;/p&gt;
&lt;p&gt;講義ではRでしたので、Pythonでも同じ結果が得られるか、Pythonの勉強も兼ねての挑戦記録です。&lt;/p&gt;
&lt;h2&gt;がんゲノムの変異シグネチャーとは？？&lt;/h2&gt;
&lt;p&gt;&lt;img alt="2" src="{attach}images/cancer_signature_figs/2.png"&gt;&lt;/p&gt;
&lt;p&gt;（がんゲノム情報学　中谷先生のスライドより）&lt;/p&gt;
&lt;h2&gt;トピックモデルとは？？&lt;/h2&gt;
&lt;p&gt;&lt;img alt="3" src="{attach}images/cancer_signature_figs/3.png"&gt;&lt;/p&gt;
&lt;p&gt;（&lt;a href="https://www.albert2005.co.jp/knowledge/machine_learning/topic_model/about_topic_model"&gt;https://www.albert2005.co.jp/knowledge/machine_learning/topic_model/about_topic_model&lt;/a&gt;より）&lt;/p&gt;
&lt;h3&gt;がんゲノムの場合のトピックは？？&lt;/h3&gt;
&lt;p&gt;&lt;img alt="4" src="{attach}images/cancer_signature_figs/4.png"&gt;&lt;/p&gt;
&lt;p&gt;（がんゲノム情報学　中谷先生のスライドより）&lt;/p&gt;
&lt;p&gt;一塩基ごとの変異情報がまとめられたテキストがDocumentsとして、がんの原因となる要素を一つ一つの「topic」、変異シグネチャーとして、トピックモデルを用いて推定します。&lt;/p&gt;
&lt;h2&gt;解析の方法&lt;/h2&gt;
&lt;p&gt;&lt;img alt="5" src="{attach}images/cancer_signature_figs/5.png"&gt;&lt;/p&gt;
&lt;p&gt;（がんゲノム情報学　中谷先生のスライドより）&lt;/p&gt;
&lt;p&gt;データベースにある変異データには、&lt;br&gt;
ゲノムの位置、その位置における変異前の塩基配列、変異後の配列&lt;br&gt;
の情報が書かれています。&lt;/p&gt;
&lt;p&gt;そこから変異の情報を、C&amp;gt;T_AGのような形でテキストファイルにIDごとに記録していきます。&lt;br&gt;
鋳型鎖と相補鎖の関係より、&lt;strong&gt;変異前がCかTの側のみ&lt;/strong&gt; を集計します。（＊注1）&lt;/p&gt;
&lt;p&gt;その後、各IDごとに変異データのテキストファイルを集め、変異情報をDocumentsとして、トピック、変異シグネチャーを推定していきます。&lt;/p&gt;
&lt;h2&gt;使用したツール&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;pandas  &lt;/li&gt;
&lt;li&gt;
&lt;p&gt;matplotlib&lt;br&gt;
Pythonでおなじみのツールですね。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;biopython&lt;br&gt;
Python 用の計算機分子生物学パッケージです。&lt;br&gt;
核酸やアミノ酸の配列情報を扱うためのFASTAファイルの処理が簡単になります。&lt;br&gt;
（ドキュメントは読み切れていないので、いずれ読みたいです…）&lt;br&gt;
公式：&lt;a href="https://biopython.org/"&gt;https://biopython.org/&lt;/a&gt;&lt;br&gt;
参考：&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="https://qiita.com/sato32ha6/items/6b762b0d0314a5db7dc3"&gt;https://qiita.com/sato32ha6/items/6b762b0d0314a5db7dc3&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href="https://bi.biopapyrus.jp/python/biopython/seq.html"&gt;https://bi.biopapyrus.jp/python/biopython/seq.html&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;gensim（topicmodel）&lt;br&gt;
今回の核となるトピックモデルについてはこちらを使います。&lt;br&gt;
gensimは、様々なトピックモデルを実装したPythonライブラリです。&lt;br&gt;
"&lt;em&gt;topic modeling for humans&lt;/em&gt;"とあるように、実装が大変なトピックモデルを簡単に使うことができます。&lt;br&gt;
今回はその中でも、LDA（Latent Dirichlet Allocation）を用います。&lt;br&gt;
参考：&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.sejuku.net/blog/67863"&gt;https://www.sejuku.net/blog/67863&lt;/a&gt;&lt;br&gt;
gensimの使い方についてはこれが一番わかりやすかったです）　　　&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href="https://www.machinelearningplus.com/nlp/topic-modeling-gensim-python/"&gt;https://www.machinelearningplus.com/nlp/topic-modeling-gensim-python/&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;wordcloud&lt;br&gt;
matplotlib を利用して Word Cloud を作成できる Python ライブラリです。&lt;br&gt;
wordcloud自体は、文章中で出現頻度が高い単語を複数選び出し、その頻度に応じた大きさで図示する手法です。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;実践　〜解析〜&lt;/h2&gt;
&lt;h3&gt;COSMICとは？&lt;/h3&gt;
&lt;p&gt;（HP：https://cancer.sanger.ac.uk/cosmic/）&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;COSMIC, the Catalogue Of Somatic Mutations In Cancer, is the world’s largest and most comprehensive resource for exploring the impact of somatic mutations in human cancer.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;（公式サイトより）&lt;/p&gt;
&lt;p&gt;がんと関連する体細胞変異の情報を集積したデータベースです。&lt;/p&gt;
&lt;p&gt;今回はこちらにある変異データを解析の対象としています。&lt;/p&gt;
&lt;p&gt;参考：統合TV　&lt;a href="https://togotv.dbcls.jp/20180127.html"&gt;https://togotv.dbcls.jp/20180127.html&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;データのダウンロード&lt;/h3&gt;
&lt;p&gt;がんゲノムの変異データをCOSMCのサイトからダウンロードします。
- &lt;a href="https://cancer.sanger.ac.uk/cosmic/download"&gt;https://cancer.sanger.ac.uk/cosmic/download&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;データを無料でダウンロードするには、学生としての登録が必要でした。
今回は様々なデータの中でも、Non coding variantsのものを使いました。
&lt;img alt="6" src="{attach}images/cancer_signature_figs/6.png"&gt;&lt;/p&gt;
&lt;h3&gt;リファレンス配列の入手&lt;/h3&gt;
&lt;p&gt;今回はUCSCからhg38をダウンロードしました。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ wget http://hgdownload.soe.ucsc.edu/goldenPath/hg38/bigZips/hg38.fa.gz
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;こちらのフォーマットはfastaで、&lt;/p&gt;
&lt;p&gt;&lt;img alt="7" src="{attach}images/cancer_signature_figs/7.png"&gt;&lt;/p&gt;
&lt;p&gt;のような感じで並んでいます。&lt;/p&gt;
&lt;p&gt;配列にAやaなど、大文字と小文字が並んでいるのは、大文字の A, C, G, T はコード領域、小文字の a, c, g, t はコード領域以外を表します。&lt;/p&gt;
&lt;h3&gt;変異データを覗いてみる&lt;/h3&gt;
&lt;p&gt;COSMICから入手したデータがどんなフォーマットなのか見てみました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="8" src="{attach}images/cancer_signature_figs/8.png"&gt;&lt;/p&gt;
&lt;p&gt;ここからサンプルID、ゲノムのposition、元の配列、変異後の配列、という形で抽出し手確認しました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="9" src="{attach}images/cancer_signature_figs/9.png"&gt;&lt;/p&gt;
&lt;p&gt;公式サイトによると、変異データのフォーマットは以下のようになっているようです。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;[column number:label] Heading&lt;/strong&gt;&lt;br&gt;
&lt;strong&gt;[1:A] Sample name,Sample id,Tumour id&lt;/strong&gt; – A sample is an instance of a portion of a tumour being examined for mutations. The sample name can be derived from a number of sources. In many cases it originates from the cell line name. Other sources include names assigned by the annotators, or an incremented number assigned during an anonymisation process. A number of samples can be taken from a single tumour and a number of tumours can be obtained from one individual. A sample id is used to identify a sample within the COSMIC database. There can be multiple ids, if the same sample has been entered into the database multiple times from different papers.&lt;br&gt;
&lt;strong&gt;[4:D] Primary Site&lt;/strong&gt; – The primary tissue/cancer from which the sample originated. More details on the tissue classification are avaliable from &lt;a href="https://cancer.sanger.ac.uk/cell_lines/classification"&gt;here&lt;/a&gt;. In COSMIC we have standard classification system for tissue types and sub types because they vary a lot between different papers.&lt;br&gt;
&lt;strong&gt;[5:E] Site Subtype 1&lt;/strong&gt; – Further sub classification (level 1) of the samples tissue of origin.&lt;br&gt;
&lt;strong&gt;[6:F] Site Subtype 2&lt;/strong&gt; – Further sub classification (level 2) of the samples tissue of origin.&lt;br&gt;
&lt;strong&gt;[7:G] Site Subtype 3&lt;/strong&gt; – Further sub classification (level 3) of the samples tissue of origin.&lt;br&gt;
&lt;strong&gt;[8:H] Primary Histology&lt;/strong&gt; – The histological classification of the sample.&lt;br&gt;
&lt;strong&gt;[9:I] Histology Subtype 1&lt;/strong&gt; – Further histological classification (level 1) of the sample.&lt;br&gt;
&lt;strong&gt;[10:J] Histology Subtype 2&lt;/strong&gt; – Further histological classification (level 2) of the sample.&lt;br&gt;
&lt;strong&gt;[11:K] Histology Subtype 3&lt;/strong&gt; – Further histological classification (level 3) of the sample.&lt;br&gt;
&lt;strong&gt;[12:L] Mutation Id&lt;/strong&gt; – unique mutation identifier.&lt;br&gt;
&lt;strong&gt;[13:M] Zygosity&lt;/strong&gt; – Information on whether the mutation was reported to be homozygous , heterozygous or unknown within the sample.&lt;br&gt;
&lt;strong&gt;[14:N] GRCh&lt;/strong&gt; – The coordinate system used –&lt;br&gt;
38 = GRCh38/Hg38&lt;br&gt;
37 = GRCh37/Hg19&lt;br&gt;
&lt;strong&gt;[15:O] Genome position&lt;/strong&gt; – The genomic cooridnate of the mutation.&lt;br&gt;
&lt;strong&gt;[16:P] Mutation somatic status&lt;/strong&gt; – Information on whether the sample was reported to be Confirmed Somatic, Previously Reported or Variant of unknown origin –&lt;br&gt;
Confirmed Somatic = if the mutation has been confimed to be somatic in the experiment by sequencing both the tumour and a matched normal from the same patient.&lt;br&gt;
variant of unknown origin = when the mutation is known to be somatic but the tumour was sequenced without a matched normal.&lt;br&gt;
Previously observed = when the mutation has been reported as somatic previously but not in current paper.&lt;br&gt;
&lt;strong&gt;[17:Q] WT SEQ&lt;/strong&gt; – wild type sequence.&lt;br&gt;
&lt;strong&gt;[18:R] MUT SEQ&lt;/strong&gt; – Mutated sequence.&lt;br&gt;
&lt;strong&gt;[19:S] SNP&lt;/strong&gt; – All the known SNPs are flagged as ‘y’ defined by the 1000 genomes project, dbSNP and a panel of 378 normal (non-cancer) samples from Sanger CGP sequencing.&lt;br&gt;
&lt;strong&gt;[20:T] FATHMM_MKL_NON_CODING_SCORE&lt;/strong&gt; – FATHMM-MKL non-coding score. A p-value ranging from 0 to 1 where &amp;gt;= 0.7 is functionally significant.&lt;br&gt;
&lt;strong&gt;[21:U] FATHMM_MKL_NON_CODING_GROUPS&lt;/strong&gt; – FATHMM-MKL group classification. More details from &lt;a href="https://cancer.sanger.ac.uk/cosmic/analyses"&gt;here&lt;/a&gt;.&lt;br&gt;
&lt;strong&gt;[22:V] FATHMM_MKL_CODING_SCORE&lt;/strong&gt; – FATHMM-MKL coding score (p-value ranging from 0 to 1).&lt;br&gt;
&lt;strong&gt;[23:W] FATHMM_MKL_CODING_GROUPS&lt;/strong&gt; – FATHMM-MKL group classification (coding). More details from &lt;a href="https://cancer.sanger.ac.uk/cosmic/analyses"&gt;here&lt;/a&gt;.&lt;br&gt;
&lt;strong&gt;[24:X] Whole Genome Reseq&lt;/strong&gt; – if the enitre genome is sequenced.&lt;br&gt;
&lt;strong&gt;[25:Y] Whole_Exome&lt;/strong&gt; – if the enitre exome is sequenced.&lt;br&gt;
&lt;strong&gt;[26:Z] Id Study&lt;/strong&gt; – Lists the unique Ids of studies that have involved this non coding mutation.&lt;br&gt;
&lt;strong&gt;[27:AA] Pubmed_PMID&lt;/strong&gt; – The PUBMED ID for the paper that the sample was noted in.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3&gt;変異ファイルの処理&lt;/h3&gt;
&lt;p&gt;ここが一番苦労しました。。。&lt;/p&gt;
&lt;h4&gt;簡単な流れ&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;変異データをpandasで読み込む&lt;/li&gt;
&lt;li&gt;MUT_SEQについて、genome_positionからリファレンス配列を参照して、変異配列の前後の配列を探し出す&lt;/li&gt;
&lt;li&gt;DataFrameの新しいcolumnとして配列を追加していく&lt;/li&gt;
&lt;li&gt;ID_tumorごとに、配列の変異をテキストファイルに書き出していく。&lt;/li&gt;
&lt;li&gt;tumorごとの変異についてのテキストファイルをもとに、トピックモデルをgensimを使って作成する。&lt;/li&gt;
&lt;li&gt;可視化する。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;以下実際のコードです。&lt;/p&gt;
&lt;h4&gt;ライブラリのimport&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pandas&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;pd&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;Bio&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;SeqIO&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;re&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h4&gt;COSMICの変異データをpandasでDataFrameとして読み込みます。&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;mut_file&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;CosmicNCV.tsv&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;ref_fasta&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hg38.fa&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;df_cosmic&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;pd&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read_table&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mut_file&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;df_cut&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;df_cosmic&lt;/span&gt;&lt;span class="p"&gt;[[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;ID_SAMPLE&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;ID_tumour&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;genome position&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;WT_SEQ&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;MUT_SEQ&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]]&lt;/span&gt;
&lt;span class="n"&gt;df_cut&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;head&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img alt="10" src="{attach}images/cancer_signature_figs/10.png"&gt;&lt;/p&gt;
&lt;p&gt;上記のようにDataFrameとしてきれいに読み込めました。&lt;/p&gt;
&lt;h4&gt;リファレンス配列の読み込み&lt;/h4&gt;
&lt;p&gt;ここではbiopythonを使って簡単に配列部分を取り出します。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;#リファレンスファイルについて&lt;/span&gt;
&lt;span class="n"&gt;list_id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt;
&lt;span class="n"&gt;list_desc&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt;
&lt;span class="n"&gt;list_seq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt;&lt;span class="c1"&gt;#biopythonを用いて、idやdesc、seqを抽出&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;record&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;SeqIO&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ref_fasta&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;fasta&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;span class="n"&gt;id_part&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;record&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;
&lt;span class="n"&gt;desc_part&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;record&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;description&lt;/span&gt;
&lt;span class="n"&gt;seq&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;record&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;seq&lt;/span&gt;

&lt;span class="n"&gt;list_id&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;id_part&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;list_desc&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;desc_part&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;list_seq&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;seq&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;塩基配列はlist_seqに入っています。&lt;/p&gt;
&lt;p&gt;&lt;img alt="11" src="{attach}images/cancer_signature_figs/11.png"&gt;&lt;/p&gt;
&lt;p&gt;全てリスト形式なので、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list_seq&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;49&lt;/span&gt;&lt;span class="p"&gt;]))&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list_desc&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;49&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;&lt;span class="mi"&gt;19829559&lt;/span&gt;

&lt;span class="n"&gt;chr3&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;のように各染色体ごとに見るこができます。&lt;/p&gt;
&lt;h4&gt;COSMICのdf（DataFrame）の操作&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;df_cutのgenome_positionについて、染色体番号とゲノムの位置に分割して新しいカラムとして追加します。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;#chr、genome position用の空のリストを作成&lt;/span&gt;

&lt;span class="n"&gt;list_cut_chr&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt;
&lt;span class="n"&gt;list_cut_pos&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut&lt;/span&gt;&lt;span class="p"&gt;)):&lt;/span&gt;
&lt;span class="n"&gt;list_cut_chr&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;[:-]&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;df_cut&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;genome position&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]))[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;span class="n"&gt;list_cut_pos&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;[:-]&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;df_cut&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;genome position&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]))[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;

&lt;span class="c1"&gt;#df_cutに新しいカラムとして追加。&lt;/span&gt;

&lt;span class="n"&gt;df_cut&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;chr&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;pd&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Series&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list_cut_chr&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;df_cut&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;single position&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;pd&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Series&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list_cut_pos&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;df_cut&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;head&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img alt="12" src="{attach}images/cancer_signature_figs/12.png"&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;MUT_SEQの欠損値、chr23、24、25を除く。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;#mutのdfからchr23、24、MUT_SEQのnanを除く&lt;/span&gt;
&lt;span class="n"&gt;df_cut_chr&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;df_cut&lt;/span&gt;&lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="n"&gt;df_cut&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;chr&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;23&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;amp&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="n"&gt;amp&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;chr&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;24&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;amp&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="n"&gt;amp&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;chr&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;25&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
&lt;span class="n"&gt;df_cut_chr&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dropna&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;subset&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;MUT_SEQ&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="n"&gt;inplace&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="c1"&gt;#indexを振り直す&lt;/span&gt;

&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;reset_index&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;なぜかCOSMICのデータにchr22以上のものが含まれていたので、除きました。&lt;/p&gt;
&lt;h4&gt;リファレンス配列から、MUT_SEQの前後の配列を抽出&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;#refから変異位置の前後の配列を抽出&lt;/span&gt;
&lt;span class="n"&gt;seq_before&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt;
&lt;span class="n"&gt;seq_after&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;)):&lt;/span&gt;
&lt;span class="n"&gt;seq_before&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list_seq&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;list_id&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;chr&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;chr&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;])][&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;single position&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;span class="n"&gt;seq_after&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list_seq&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;list_id&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;chr&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;chr&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;])][&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;single position&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;])])&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h4&gt;COSMICのdfと合わせていく。&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;変異の前後の配列について、dfに追加し、大文字に直す&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_before&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;pd&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Series&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;seq_before&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_after&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;pd&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Series&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;seq_after&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="c1"&gt;#大文字に変更&lt;/span&gt;
&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_before&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_before&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;str&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_after&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_after&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;str&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;ol&gt;
&lt;li&gt;前、変異、後の3つの配列を新しいカラムの中に追加する
（以下のようなややこしいカラムを作っているのは（＊注1）のためです）&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;#3文字の配列にする（seq_forwardが鋳型）&lt;/span&gt;
&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_forward&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_before&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;MUT_SEQ&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_after&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;#鋳型鎖の順番を逆にしたもの（相補鎖を作るため）&lt;/span&gt;
&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_forward_r&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_after&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;MUT_SEQ&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_before&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;ここまでで以下のようになります。（dfの右側だけ）&lt;/p&gt;
&lt;p&gt;&lt;img alt="13" src="{attach}images/cancer_signature_figs/13.png"&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;3つの配列について、相補鎖を作ります&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;#辞書型で相補鎖に変換&lt;/span&gt;
&lt;span class="n"&gt;dict_base&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;A&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;T&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;G&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;C&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;C&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;G&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;T&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;A&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;list_seq_reverse&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt;
&lt;span class="n"&gt;list_wt_seq_reverse&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;)):&lt;/span&gt;
&lt;span class="n"&gt;list_seq_reverse&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_forward_r&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;translate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;maketrans&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dict_base&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
&lt;span class="c1"&gt;#次のために、変異の配列も変換しておきます。 list_wt_seq_reverse.append((str(df_cut_chr_i[&amp;#39;WT_SEQ&amp;#39;][i])).translate(str.maketrans(dict_base)))&lt;/span&gt;
&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_reverse&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;pd&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Series&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list_seq_reverse&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;WT_seq_reverse&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;pd&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Series&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list_wt_seq_reverse&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h4&gt;変異の情報をテキストファイルに書き出す&lt;/h4&gt;
&lt;p&gt;いよいよ最後のステップです。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;#ID_tumorのカウント&lt;/span&gt;
&lt;span class="n"&gt;dict_tumor_id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;ID_tumour&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;value_counts&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_dict&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="n"&gt;list_tumor_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dict_tumor_id&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;keys&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;まずはIDをリストに格納します。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;ID_tumour&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;value_counts&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img alt="14" src="{attach}images/cancer_signature_figs/14.png"&gt;&lt;/p&gt;
&lt;p&gt;（上はテストファイルで行ったため、実際の数値とは異なります。）&lt;/p&gt;
&lt;p&gt;いろいろな試行錯誤したコードで、テキストファイルに書き出していきます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;df_index_for_id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;pd&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;DataFrame&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;list_tumor_id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="n"&gt;df_index_for_id&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;index_&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;pd&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Series&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;ID_tumour&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;j&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;df_index_for_id&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;index_&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;)]:&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;pd&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;isnull&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="k"&gt;continue&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;text_2/&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s2"&gt;.txt&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;a&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iloc&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;)])[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;WT_SEQ&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;C&amp;#39;&lt;/span&gt;&lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iloc&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;)])[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;WT_SEQ&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;T&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iloc&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;)])[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;WT_SEQ&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;amp;amp;gt;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iloc&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;)])[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;MUT_SEQ&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;\
&lt;span class="s1"&gt;&amp;#39;_&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iloc&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;)])[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_forward&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;\
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iloc&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;)])[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_forward&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39; &amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;elif&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iloc&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;)])[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;WT_SEQ&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;A&amp;#39;&lt;/span&gt;&lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iloc&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;)])[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;WT_SEQ&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;G&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iloc&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;)])[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;WT_seq_reverse&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;amp;amp;gt;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iloc&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;)])[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_reverse&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;\
&lt;span class="s1"&gt;&amp;#39;_&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iloc&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;)])[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_reverse&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;\
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df_cut_chr_i&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iloc&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;)])[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;seq_reverse&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39; &amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="k"&gt;continue&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;（特に速度のことは考えずに直感的にforで回したので、かなり時間がかかります。）
ここまでで変異のデータをIDごとに抽出することができました！&lt;/p&gt;
&lt;p&gt;上のスクリプトをサーバーにでも投げてしばらく待ちます。&lt;/p&gt;
&lt;h3&gt;トピックモデルを使ってみる&lt;/h3&gt;
&lt;p&gt;&lt;img alt="15" src="{attach}images/cancer_signature_figs/15.png"&gt;&lt;/p&gt;
&lt;p&gt;4までの操作で各IDごとの上のように、変異データが得られました。&lt;/p&gt;
&lt;p&gt;これをトピックモデルを使って解析していきます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;gensim&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;collections&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Counter&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;matplotlib.pyplot&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;plt&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;wordcloud&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;WordCloud&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h4&gt;ディレクトリ内のファイルリストを取得する&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;glob&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;

&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;chdir&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/Users/***/test/cancer_genome&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;list_file_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;glob&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;glob&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;./text_2/*&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;list_file_name&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h4&gt;変異データを一つのリスト内に格納する&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;list_text&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;list_file_name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;r&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;readlines&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;&lt;span class="o"&gt;!=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="k"&gt;continue&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="n"&gt;list_text&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;(((&lt;/span&gt;&lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;r&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;readlines&lt;/span&gt;&lt;span class="p"&gt;())[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h4&gt;トピックモデル&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;#辞書を作成&lt;/span&gt;
&lt;span class="n"&gt;dictionary&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gensim&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;corpora&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Dictionary&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;list_text&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;corpus&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;dictionary&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;doc2bow&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;text&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;list_text&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;#トピックモデルの学習&lt;/span&gt;
&lt;span class="n"&gt;num_topics&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;20&lt;/span&gt;

&lt;span class="n"&gt;lda&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gensim&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;models&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ldamodel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;LdaModel&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;span class="n"&gt;corpus&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;corpus&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="n"&gt;num_topics&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;num_topics&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="n"&gt;id2word&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;dictionary&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;トピック数（num_topics）については後述します。&lt;/p&gt;
&lt;p&gt;これでトピックモデルの学習ができました。ここは実行時間はそこまで長くありません。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;lda&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;show_topic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img alt="16" src="{attach}images/cancer_signature_figs/16.png"&gt;&lt;/p&gt;
&lt;p&gt;結果を見てみると、各トピックごとに、各変異がどれほどの割合を占めているのか、というのがわかります。&lt;/p&gt;
&lt;h4&gt;可視化&lt;/h4&gt;
&lt;p&gt;おなじみmatplotlibを使ってグラフにしてみます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;collections&lt;/span&gt;

&lt;span class="n"&gt;clist&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;16&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;\
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;17&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;orange&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),(&lt;/span&gt;&lt;span class="mi"&gt;32&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;orange&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;\
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;33&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;green&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),(&lt;/span&gt;&lt;span class="mi"&gt;48&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;green&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;\
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;49&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;salmon&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),(&lt;/span&gt;&lt;span class="mi"&gt;66&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;salmon&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;\
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;67&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),(&lt;/span&gt;&lt;span class="mi"&gt;83&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;\
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;84&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),(&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
&lt;span class="n"&gt;rvb&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;mcolors&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;LinearSegmentedColormap&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from_list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;clist&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;figure&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;figsize&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;30&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;30&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;dict_topic&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;sorted&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lda&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;show_topic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;items&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;
&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dict_topic&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ylim&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mf"&gt;0.2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;bar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dict_topic&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt; &lt;span class="n"&gt;dict_topic&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;values&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;align&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;center&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;color&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;rvb&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;xticks&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dict_topic&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt; &lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dict_topic&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;keys&lt;/span&gt;&lt;span class="p"&gt;()),&lt;/span&gt; &lt;span class="n"&gt;rotation&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;90&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;show&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img alt="17" src="{attach}images/cancer_signature_figs/17.png"&gt;&lt;/p&gt;
&lt;p&gt;リストで色を指定することで、このように変異の種類（T&amp;gt;C、T&amp;gt;A、C&amp;gt;Gなど）ごとに色づけすることができました。
- 参考：&lt;a href="https://stackoverflow.com/questions/42656585/barplot-colored-according-a-colormap"&gt;https://stackoverflow.com/questions/42656585/barplot-colored-according-a-colormap&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;これをトピックごとにグラフを作成し、画像として保存します。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;clist&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;aqua&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;16&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;aqua&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;\
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;17&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),(&lt;/span&gt;&lt;span class="mi"&gt;32&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;\
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;33&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),(&lt;/span&gt;&lt;span class="mi"&gt;48&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;\
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;49&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;gray&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),(&lt;/span&gt;&lt;span class="mi"&gt;66&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;gray&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;\
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;67&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;lime&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),(&lt;/span&gt;&lt;span class="mi"&gt;83&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;lime&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;\
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;84&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;pink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),(&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;pink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
&lt;span class="n"&gt;rvb&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;mcolors&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;LinearSegmentedColormap&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from_list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;clist&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lda&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;num_topics&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;figure&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;figsize&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;40&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="c1"&gt;#plt.subplot(lda.num_topics,2,i+1)&lt;/span&gt;
&lt;span class="n"&gt;dict_topic&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;sorted&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lda&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;show_topic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;items&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;
&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dict_topic&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;topic #&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;bar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dict_topic&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt; &lt;span class="n"&gt;dict_topic&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;values&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;align&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;center&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;color&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;rvb&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;102&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;xticks&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dict_topic&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt; &lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dict_topic&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;keys&lt;/span&gt;&lt;span class="p"&gt;()),&lt;/span&gt; &lt;span class="n"&gt;rotation&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;90&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;savefig&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;topic_pdf/topicmodel_ms_&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;.pdf&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;（色はCOSMICのグラフのものと揃えました）&lt;/p&gt;
&lt;p&gt;&lt;img alt="18" src="{attach}images/cancer_signature_figs/18.png"&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="19" src="{attach}images/cancer_signature_figs/19.png"&gt;&lt;/p&gt;
&lt;h3&gt;データベースのシグネチャと比較&lt;/h3&gt;
&lt;p&gt;COSMICには、今までに推定されてきたがんゲノムの変異シグネチャーが多数登録されています。
- &lt;a href="https://cancer.sanger.ac.uk/cosmic/signatures/SBS/"&gt;https://cancer.sanger.ac.uk/cosmic/signatures/SBS/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="20" src="{attach}images/cancer_signature_figs/20.png"&gt;&lt;/p&gt;
&lt;p&gt;シグネチャーのグラフと、関連するがんの原因が示されています。&lt;/p&gt;
&lt;h4&gt;推定&lt;/h4&gt;
&lt;p&gt;今回の課題は、「&lt;strong&gt;たばこ/紫外線のシグネチャーを見つけることができたか&lt;/strong&gt;」でした。&lt;/p&gt;
&lt;p&gt;データベースにあるグラフとどれほど一致しているか見ていきます。&lt;/p&gt;
&lt;p&gt;COSMICに掲載されているシグネチャーSBS1〜SBS85までのうち、&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;たばこ&lt;/strong&gt;（tobacco）が原因とされるもの→SBS4、5、29&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;紫外線&lt;/strong&gt;（ultraviolet light）が原因とされるもの→SBS7a〜d、38&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="21" src="{attach}images/cancer_signature_figs/21.png"&gt;&lt;/p&gt;
&lt;p&gt;であるとわかりました。&lt;/p&gt;
&lt;h4&gt;推定結果&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;-たばこ-&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;①SBS4&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;COSMIC&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="22" src="{attach}images/cancer_signature_figs/22.png"&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;推定&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="23" src="{attach}images/cancer_signature_figs/23.png"&gt;&lt;/p&gt;
&lt;p&gt;②SBS5&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;COSMIC&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="24" src="{attach}images/cancer_signature_figs/24.png"&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;推定&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="25" src="{attach}images/cancer_signature_figs/25.png"&gt;&lt;/p&gt;
&lt;p&gt;③SBS29&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;COSMIC&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="26" src="{attach}images/cancer_signature_figs/26.png"&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;推定&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="27" src="{attach}images/cancer_signature_figs/27.png"&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;-紫外線-&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;①SBS7a
- COSMIC&lt;/p&gt;
&lt;p&gt;&lt;img alt="28" src="{attach}images/cancer_signature_figs/28.png"&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;推定&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="29" src="{attach}images/cancer_signature_figs/29.png"&gt;&lt;/p&gt;
&lt;p&gt;②SBS7b&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;COSMIC&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="30" src="{attach}images/cancer_signature_figs/30.png"&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;推定&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="31" src="{attach}images/cancer_signature_figs/31.png"&gt;&lt;/p&gt;
&lt;p&gt;③SBS7c&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;COSMIC&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="32" src="{attach}images/cancer_signature_figs/32.png"&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;推定&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;類似しているシグネチャーは確認できませんでした。&lt;/p&gt;
&lt;p&gt;④SBS7d&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;COSMIC&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="33" src="{attach}images/cancer_signature_figs/33.png"&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;推定&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;類似しているシグネチャーは確認できませんでした。&lt;/p&gt;
&lt;p&gt;⑤SBS38&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;COSMIC&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="34" src="{attach}images/cancer_signature_figs/34.png"&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;推定&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;類似しているシグネチャーは確認できませんでした。&lt;/p&gt;
&lt;p&gt;どれも完全に一致しているとは言えないのですが、近いものはそれなりに類似しているグラフが作れたのではないかと思います。&lt;/p&gt;
&lt;p&gt;シグネチャーを見るだけでも、「たばこを原因とするがんは、変異の種類が多い」、「紫外線を原因とするがんは、変異の種類が少ない」という傾向も見て取れます。&lt;/p&gt;
&lt;h2&gt;おまけ -WordCloudによる可視化-&lt;/h2&gt;
&lt;p&gt;トピックモデルで単語を扱う際によく同時にやられているものとして、WordCloudがあったため、変異データでもやってみました。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;figure&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;figsize&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;30&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;30&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;t&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lda&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;num_topics&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;subplot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lda&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;show_topic&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;im&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;WordCloud&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;generate_from_frequencies&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;imshow&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;im&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;axis&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;off&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Topic #&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img alt="35" src="{attach}images/cancer_signature_figs/35.png"&gt;&lt;/p&gt;
&lt;h2&gt;今後やってみたいこと&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;がんゲノムの変異シグネチャーは、最初に発表された論文ではNon- negative Matrix Factorization(NMF)(非負値行列因子分解)を使って推定された。2019年になって「トピックモデル」を使って変異 シグネチャを推定する論文が二報発表された。&lt;br&gt;
1. Funnell, T. et al. Integrated structural variation and point mutation signatures in cancer genomes using correlated topic models. PLOS Computational Biology 15, e1006799 (2019).
2. Matsutani, T., Ueno, Y., Fukunaga, T. &amp;amp; Hamada, M. Discovering novel mutation signatures by latent Dirichlet allocation with variational Bayes inference. Bioinformatics doi:10.1093/bioinformatics/btz266&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;このような背景があったため今回はトピックモデルを使ってみたのですが、NMFを用いた推定もやってみたいです。&lt;/p&gt;
&lt;p&gt;変異シグネチャーの個数については、今回のセッティングが最適ではなく、丁寧にやるならhierarchical dirichlet process (HDP) を用いるか、perplexity、coherenceなどの評価指標を用いる必要があるのかと思いました。
- 参考：&lt;a href="https://www.randpy.tokyo/entry/word2vec_skip_gram_model"&gt;https://www.randpy.tokyo/entry/word2vec_skip_gram_model&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;今回のコード、作成したグラフ等はGitHubにあります。
- &lt;a href="https://github.com/ykohki/cancer_signature"&gt;https://github.com/ykohki/cancer_signature&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;トピックモデルを用いたがんゲノムの変異シグネチャー解析
- &lt;a href="https://ipsj.ixsq.nii.ac.jp/ej/index.php?active_action=repository_view_main_item_detail&amp;amp;page_id=13&amp;amp;block_id=8&amp;amp;item_id=182433&amp;amp;item_no=1"&gt;https://ipsj.ixsq.nii.ac.jp/ej/index.php?active_action=repository_view_main_item_detail&amp;amp;page_id=13&amp;amp;block_id=8&amp;amp;item_id=182433&amp;amp;item_no=1&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;がんゲノムビッグデータから喫煙による遺伝子異常を同定
- &lt;a href="https://www.ncc.go.jp/jp/information/pr_release/2016/1104/index.html"&gt;https://www.ncc.go.jp/jp/information/pr_release/2016/1104/index.html&lt;/a&gt;
- &lt;a href="https://science.sciencemag.org/content/354/6312/618"&gt;https://science.sciencemag.org/content/354/6312/618&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;同じ変異シグネチャーについて調べていて、特にたばこについて見ている論文でした
- https://www.nature.com/articles/nature12477#associating-cancer-aetiology-and-mutational-signatures&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Bioinformatics"></category></entry><entry><title>行列演算の初歩の初歩とNumPy</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/05/matrix_numpy.html" rel="alternate"></link><published>2019-05-16T00:00:00+09:00</published><updated>2021-08-28T00:00:00+09:00</updated><author><name>小川</name></author><id>tag:None,2019-05-16:/previews/refs/heads/general/jinja2_version/blog/2019/05/matrix_numpy.html</id><summary type="html">&lt;p&gt;機械学習をはじめ、何をやるにも行列演算は必須です。
本稿ではその初歩と、ライブラリ &lt;a href="https://numpy.org/"&gt;NumPy&lt;/a&gt; での基本的な実行方法を簡 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;機械学習をはじめ、何をやるにも行列演算は必須です。
本稿ではその初歩と、ライブラリ &lt;a href="https://numpy.org/"&gt;NumPy&lt;/a&gt; での基本的な実行方法を簡単に解説します。
(主に1年生向け。)&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;引用表記の部分&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;はやや発展的な内容なので、初めて読むときは飛ばしてOKです。&lt;/p&gt;
&lt;h2&gt;ベクトルの積&lt;/h2&gt;
&lt;h3&gt;定義&lt;/h3&gt;
&lt;p&gt;まず、&lt;strong&gt;ベクトルの積&lt;/strong&gt;を以下のように定義します。&lt;br&gt;
(Python流に0-index記法を採用。)&lt;/p&gt;
&lt;div class="math"&gt;$$
x=(x_0,x_1,...,x_{D-1}),
\quad
y=\left(\begin{array} 
\@
y_0 \\
y_1 \\
\vdots\\
y_{D-1} \\
\end{array}\right)
\quad\Rightarrow\quad
x\cdot y = x_0y_0+x_1y_1+\dots+x_{D-1}y_{D-1}
$$&lt;/div&gt;
&lt;p&gt;
高校で学ぶベクトルの内積と基本的に同じですが、&lt;strong&gt;行ベクトル (横ベクトル) と列ベクトル (縦ベクトル) を区別&lt;/strong&gt;するのが大事なところです。
掛け算は、同じ次元の&lt;strong&gt;「行ベクトル &lt;span class="math"&gt;\(\times\)&lt;/span&gt; 列ベクトル」の順序&lt;/strong&gt;でしか行えません。&lt;br&gt;
(本当は逆順でもできるが、結果は全く違うものになる。
どうなるか？最後まで読んだら考えてみましょう。)&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;行ベクトルと列ベクトルはそれぞれ互いに双対なベクトル空間の元 (の数ベクトル表現) です。
列ベクトル同士・行ベクトル同士で内積が定義できるのは、列ベクトルと行ベクトルを互いに変換する写像 (計量) が定義された&lt;strong&gt;計量ベクトル空間&lt;/strong&gt;に限られます。&lt;br&gt;
高校で習うベクトル空間に内積がしれっと入っているのは、空間上に自然なユークリッド計量が暗黙に仮定されているからです。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;行列：ベクトルを並べたもの&lt;/h2&gt;
&lt;p&gt;行列は、このように成分を2次元状 (&lt;span class="math"&gt;\(E\times D\)&lt;/span&gt;) に並べたもの。
&lt;/p&gt;
&lt;div class="math"&gt;$$
X = \left(
\begin{array}\@
x_{0,0}   &amp;amp; x_{0,1} &amp;amp; \dots  &amp;amp; x_{0,D-1} \\
x_{1,0}   &amp;amp; x_{1,1} &amp;amp;        &amp;amp; \vdots \\
\vdots    &amp;amp;         &amp;amp; \ddots &amp;amp; \\
x_{E-1,0} &amp;amp; \dots   &amp;amp;        &amp;amp; x_{E-1,D-1}
\end{array}
\right)
$$&lt;/div&gt;
&lt;p&gt;
これは&lt;br&gt;
(1)「&lt;span class="math"&gt;\(D\)&lt;/span&gt;次元行ベクトルを縦に&lt;span class="math"&gt;\(E\)&lt;/span&gt;個並べたもの」&lt;br&gt;
または&lt;br&gt;
(2)「&lt;span class="math"&gt;\(E\)&lt;/span&gt;次元列ベクトルを横に&lt;span class="math"&gt;\(D\)&lt;/span&gt;個並べたもの」&lt;br&gt;
です。&lt;br&gt;
&lt;strong&gt;どちらの解釈をしても構いません&lt;/strong&gt;。&lt;/p&gt;
&lt;h3&gt;(1) 列ベクトルとの掛け算&lt;/h3&gt;
&lt;p&gt;前者(1)の解釈をすると、上の列ベクトル&lt;span class="math"&gt;\(y\)&lt;/span&gt;と掛け算ができます。
&lt;/p&gt;
&lt;div class="math"&gt;$$
X\cdot y =
\left(\begin{array}
\@
x_{0,0}y_0+x_{0,1}y_1+\dots+x_{0,D-1}y_{D-1} \\
x_{1,0}y_0+x_{1,1}y_1+\dots+x_{1,D-1}y_{D-1} \\
\vdots \\
x_{E-1,0}y_0+x_{E-1,1}y_1+\dots+x_{E-1,D-1}y_{D-1}
\end{array}\right)
$$&lt;/div&gt;
&lt;p&gt;
結果は&lt;strong&gt;E次元列ベクトル&lt;/strong&gt;になりました。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;列ベクトルに (正しい次元の) 行列を左から掛ければ列ベクトルに&lt;/strong&gt;なります。&lt;/p&gt;
&lt;h3&gt;(2) 行ベクトルとの掛け算&lt;/h3&gt;
&lt;p&gt;一方で解釈(2) をとると、&lt;span class="math"&gt;\(E\)&lt;/span&gt; 次元行ベクトル &lt;span class="math"&gt;\(z=(z_0,z_1,\dots,z_{E-1})\)&lt;/span&gt; に対して、&lt;strong&gt;右からの掛け算&lt;/strong&gt;  &lt;span class="math"&gt;\(z\cdot X\)&lt;/span&gt; を行うことができます。
結果は &lt;strong&gt;D次元行ベクトル&lt;/strong&gt; になります。&lt;/p&gt;
&lt;p&gt;つまり、&lt;strong&gt;行ベクトルに（正しい次元の）行列を右から掛ければ行ベクトルになる&lt;/strong&gt;ことがわかります。&lt;/p&gt;
&lt;blockquote&gt;
&lt;h3&gt;掛け算の結合則&lt;/h3&gt;
&lt;p&gt;行列に対して、(1)(2) どちらの解釈をしても構わない、と言いました。
この意味は例えば
&lt;div class="math"&gt;$$
z\cdot X\cdot y
$$&lt;/div&gt;
という式が与えられた際に現れます。&lt;br&gt;
(1) の解釈をするなら、この式は&lt;span class="math"&gt;\(z\cdot(X\cdot y)\)&lt;/span&gt;と計算、(2) ならば&lt;span class="math"&gt;\((z\cdot X)\cdot y\)&lt;/span&gt;です。
どちらもただ一つの数を与えますが、実は両者は&lt;strong&gt;常に同じ&lt;/strong&gt;になることが、実際に計算すれば簡単に証明できます。&lt;br&gt;
これは後述の行列積にも拡張でき、行列積は全て順序によりません。
ただし&lt;strong&gt;交換則は成立しない&lt;/strong&gt; (&lt;span class="math"&gt;\(X\cdot Y\ne Y\cdot X\)&lt;/span&gt;) ので注意。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;行列同士の掛け算&lt;/h2&gt;
&lt;p&gt;ここまでくると、掛け算をさらに拡張できる。
&lt;span class="math"&gt;\(D\times F\)&lt;/span&gt; 行列 &lt;span class="math"&gt;\(Y\)&lt;/span&gt; を
&lt;/p&gt;
&lt;div class="math"&gt;$$
Y = 
\left(\begin{array}\@
y_{0,0}           &amp;amp; y_{0,1} &amp;amp; \dots  &amp;amp; y_{0,F-1} \\
y_{1,0}           &amp;amp; y_{1,1} &amp;amp;        &amp;amp; \vdots \\
\vdots            &amp;amp;         &amp;amp; \ddots &amp;amp; \\
y_{D-1} &amp;amp; \dots   &amp;amp;        &amp;amp; y_{D-1,F-1}
\end{array}\right)
$$&lt;/div&gt;
&lt;p&gt;
とするとき、行列同士の掛け算は
&lt;/p&gt;
&lt;div class="math"&gt;$$
X\cdot Y = W = 
\left(\begin{array}\@
w_{0,0} &amp;amp; \dots &amp;amp; w_{0,F-1} \\
\vdots  &amp;amp; \ddots &amp;amp; \vdots \\
w_{E-1,0} &amp;amp; \dots &amp;amp; w_{E-1,F-1}
\end{array}\right)
$$&lt;/div&gt;
&lt;div class="math"&gt;$$
w_{i,j} = x_{i,0}y_{0,j}+x_{i,1}y_{1,j}+\dots+x_{i,D-1}y_{D-1,j}
$$&lt;/div&gt;
&lt;p&gt;
となる。
左の &lt;span class="math"&gt;\(X\)&lt;/span&gt; から行ベクトル、右の &lt;span class="math"&gt;\(Y\)&lt;/span&gt; から列ベクトルを取り出して、それぞれ掛け算したものを順番に並べる。  &lt;/p&gt;
&lt;p&gt;&lt;span class="math"&gt;\(E\times D\)&lt;/span&gt; と &lt;span class="math"&gt;\(D\times F\)&lt;/span&gt; を掛けると真ん中の &lt;span class="math"&gt;\(D\)&lt;/span&gt; が潰れて &lt;span class="math"&gt;\(E\times F\)&lt;/span&gt; 行列、と覚えればいいです。
もちろん &lt;span class="math"&gt;\(D\)&lt;/span&gt; が揃っていないと掛け算できない。&lt;/p&gt;
&lt;h2&gt;ベクトル、行列、掛け算の意味&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;ベクトルは通常、「データ」とか「状態」などの、比較的直接的な意味を持ちます。
特に数式として書く場合、普通は列ベクトルにその役割を持たせます。&lt;/li&gt;
&lt;li&gt;データや状態がたくさんある場合、それら列ベクトルを横に並べれば行列になり、その行列がデータ／状態の集合を表します。
別の行列を左から掛ければ、各列に独立・一括で演算ができます。&lt;/li&gt;
&lt;li&gt;行列は基本的に、上で見た通り、&lt;strong&gt;列ベクトルに左から作用して別の列ベクトルを作る演算子&lt;/strong&gt;です。
行ベクトルも、列ベクトルに作用する行列のうち、行が一つしかない特別な場合と見なせます。&lt;/li&gt;
&lt;li&gt;例えば、画像を表すベクトルに行列を掛け算することで、&lt;strong&gt;画像の持つ特徴 (線の向きとか) を表す別のベクトルを得る&lt;/strong&gt;、といったことなどができます。
(CNN = 畳み込みニューラルネットワーク)&lt;/li&gt;
&lt;li&gt;行列の掛け算は合成関数のようなもの。掛け算の結合則があるので、ベクトル&lt;span class="math"&gt;\(x\)&lt;/span&gt;に順番に変換を施す操作 &lt;span class="math"&gt;\(A\cdot(B\cdot x)\)&lt;/span&gt; は、&lt;span class="math"&gt;\(=(A\cdot B)\cdot x\)&lt;/span&gt; のように予め左側を先に計算しておけます。
これにより、&lt;span class="math"&gt;\(x\)&lt;/span&gt; を様々に取り替えて計算する場合に計算量を低減できます。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;NumPyによる行列演算&lt;/h2&gt;
&lt;p&gt;Python の NumPy パッケージは強力な行列演算機能を備えています。
行列の定義は &lt;code&gt;np.array()&lt;/code&gt;、掛け算は &lt;code&gt;np.dot()&lt;/code&gt; または &lt;code&gt;@&lt;/code&gt;演算子 (Python3.5以降) で行えます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;numpy&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;np&lt;/span&gt;

&lt;span class="n"&gt;A&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;([[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;],[&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;6&lt;/span&gt;&lt;span class="p"&gt;]])&lt;/span&gt; &lt;span class="c1"&gt;# 2行3列(2x3)行列&lt;/span&gt;
&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;([[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;],[&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;],[&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;]])&lt;/span&gt;     &lt;span class="c1"&gt;# 3次元列ベクトル&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;これで、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;([[&lt;/span&gt;&lt;span class="mi"&gt;14&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
       &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;32&lt;/span&gt;&lt;span class="p"&gt;]])&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;と表示されれば成功。結果は2次元列ベクトル。&lt;/p&gt;
&lt;p&gt;他にも色々試してみてください。&lt;/p&gt;
&lt;p&gt;なお若干ややこしいことに、NumPy にはいくつも便利機能があり、数学的には不正な式でも適当に補完してやってくれたりします。
(例えば行列とベクトルの足し算などもできる。)&lt;br&gt;
ただ慣れるまでは、ひとまず数学的に忠実な記法を心掛けた方がいいでしょう。&lt;/p&gt;
&lt;p&gt;とりあえず以上。
おしまい。&lt;/p&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="技術ブログ"></category><category term="Python"></category></entry><entry><title>Graph Neural Network (GNN)をゼロから実装した話</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/05/gnnfrom0.html" rel="alternate"></link><published>2019-05-13T00:00:00+09:00</published><updated>2021-03-16T00:00:00+09:00</updated><author><name>小川</name></author><id>tag:None,2019-05-13:/previews/refs/heads/general/jinja2_version/blog/2019/05/gnnfrom0.html</id><summary type="html">&lt;p&gt;医学科3年の小川です。
最近どうも&lt;a href="https://atcoder.jp"&gt;某ネトゲ&lt;/a&gt;の話しかしていない気がするので、たまには少し違う話題。&lt;/p&gt;
&lt;h2&gt;某社の試験課題&lt;/h2&gt;
&lt;p&gt;その筋で有 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;医学科3年の小川です。
最近どうも&lt;a href="https://atcoder.jp"&gt;某ネトゲ&lt;/a&gt;の話しかしていない気がするので、たまには少し違う話題。&lt;/p&gt;
&lt;h2&gt;某社の試験課題&lt;/h2&gt;
&lt;p&gt;その筋で有名な某社の某イベント[&lt;a href="#note1"&gt;注1&lt;/a&gt;]に応募したところ、選抜試験として次の課題が送られてきました。  &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Graph Neural Network (GNN)を言語標準ライブラリのみで実装せよ。&lt;/strong&gt;
ただし行列演算ライブラリ（Pythonならnumpy、C++ならEigenなど）だけは用いてもよい。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;つまりTensorflowとか使ってはいけない。
広義のフルスクラッチ実装。&lt;/p&gt;
&lt;p&gt;本記事はそれでやってみた（GWに丸2日くらいかけて実装・実験した）ことの記録です。
主要部分を紹介解説しますが、コード全体を見てみたい方は&lt;a href="https://github.com/pybach/2019GNNfrom0/"&gt;こちら&lt;/a&gt;に置いてあります。&lt;/p&gt;
&lt;p&gt;（注：その方面では全然高度な話じゃないけれど、&lt;strong&gt;初心者には厳しめの内容&lt;/strong&gt;です。）&lt;/p&gt;
&lt;h2&gt;参考：オコゼ本&lt;/h2&gt;
&lt;p&gt;&lt;img src="https://www.oreilly.co.jp/books/images/picture_large978-4-87311-758-4.jpeg" width=18%&gt;&lt;/p&gt;
&lt;p&gt;ニューラルネットワークのフルスクラッチ実装は珍しいネタではなく、&lt;a href="https://www.oreilly.co.jp/books/9784873117584/"&gt;「ゼロから作るDeep Learning 〜Pythonで学ぶディープラーニングの理論と実装〜」（斎藤康毅著、O'Reilly Japan）&lt;/a&gt;は街の書店でも良く見掛けます。  &lt;/p&gt;
&lt;p&gt;実はこの本、全然読んだことがなかったのですが、後から見ると僕が書いたものと&lt;strong&gt;多くのコードがそっくり&lt;/strong&gt;で、&lt;strong&gt;これくらいの安直な実装は誰が書いても大差ない&lt;/strong&gt;ことを示唆しているのかもしれない。
誰が書いてもそっくり、は&lt;strong&gt;Pythonの売り&lt;/strong&gt;でもあります。&lt;br&gt;
（なお本記事で解説する&lt;strong&gt;メモリ共有&lt;/strong&gt;はこの本ではやっていない。
また&lt;strong&gt;クラスの継承&lt;/strong&gt;も使っていない。
どちらも概念的にやや複雑になるので避けた、のかも。）&lt;/p&gt;
&lt;p&gt;ともあれ、この本は読みやすいうえ、扱っている内容は当然本記事より広く、基本的な事項をかなりカバーしていてお勧めできます。&lt;br&gt;
（一応表面上は、知識ゼロでも読めるように書かれている。
とはいえ、パラパラ見て知らない単語だらけの場合は、まだやめておいた方が無難かも。）&lt;/p&gt;
&lt;h2&gt;Graph Neural Network (GNN)&lt;/h2&gt;
&lt;p&gt;画像データなどではなく、「ネットワークのデータ」を分類したりするのに用いられるニューラルネットワーク。
例えば化学物質の構造（どの原子と原子が結合している／していないか）を与えて物性や生理活性を予測するとか、そういうことをイメージしてもらえばよいです。
この例なら&lt;strong&gt;創薬に使う&lt;/strong&gt;ことなどが期待できます。&lt;/p&gt;
&lt;p&gt;最近流行していて、グラフ畳み込みネット(GCN)とか様々なバージョンが研究されていますが、ここでは最も単純なものを考えます。  &lt;/p&gt;
&lt;p&gt;無向重み無しグラフ&lt;span class="math"&gt;\(G=(\mathrm{nodes},\mathrm{edges})\)&lt;/span&gt;が与えられたとき、各頂点&lt;span class="math"&gt;\(i\in\mathrm{nodes}\)&lt;/span&gt;に付随する&lt;span class="math"&gt;\(D\)&lt;/span&gt;次元の初期状態ベクトル&lt;span class="math"&gt;\(x_i^{(0)}\)&lt;/span&gt;を適当に与える（整数&lt;span class="math"&gt;\(D\)&lt;/span&gt;はGNNの固定パラメータ）。
そこから以下の操作（&lt;strong&gt;集約&lt;/strong&gt;=aggregation）を定められた回数（&lt;span class="math"&gt;\(T\)&lt;/span&gt;回）反復する。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;集約1&lt;/strong&gt;：&lt;span class="math"&gt;\(a_i^{(t)} = \sum_{j\; s.t.\, (i,j)\in\mathrm{edges}}x_j^{(t)}\)&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;集約2&lt;/strong&gt;：&lt;span class="math"&gt;\(x_i^{(t+1)} = f(W\cdot a_i^{(t)})\)&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ここで&lt;span class="math"&gt;\(W\)&lt;/span&gt;はGNNの持つ&lt;span class="math"&gt;\(D\times D\)&lt;/span&gt;行列値の学習パラメータ。
&lt;span class="math"&gt;\(f(\cdot)\)&lt;/span&gt;は成分ごとに適用される適当な活性化関数(activation function)。
今回はReLU関数（x&amp;gt;0でxを、x&amp;lt;=0で0を返す関数）とする。&lt;/p&gt;
&lt;p&gt;集約を終えた後、全頂点ベクトルの総和として、グラフ&lt;span class="math"&gt;\(G\)&lt;/span&gt;の特徴ベクトル&lt;span class="math"&gt;\(h_G\)&lt;/span&gt;を返す（&lt;strong&gt;読み出し&lt;/strong&gt;=readout）。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;読み出し&lt;/strong&gt;：&lt;span class="math"&gt;\(h_G = \sum_{i\in\mathrm{nodes}} x_i^{(T)}\)&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;最後、この&lt;span class="math"&gt;\(h_G\)&lt;/span&gt;をロジスティック／ソフトマックス層などに突っ込んで、分類問題などを解くわけです。
ニューラルネットワークとしては再帰ニューラルネット(RNN)の特別な場合と見ることができます。&lt;/p&gt;
&lt;h2&gt;問題&lt;/h2&gt;
&lt;p&gt;実際に出された問題（要約）です。
4段階に分かれていて、順番に機能を追加実装していけ、という感じ。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;課題1&lt;/strong&gt;：行列&lt;span class="math"&gt;\(W\)&lt;/span&gt;を固定として、与えられたグラフ&lt;span class="math"&gt;\(G\)&lt;/span&gt;に対して&lt;span class="math"&gt;\(h_G\)&lt;/span&gt;を求めるGNN関数またはクラスを実装してテストせよ。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;課題2&lt;/strong&gt;：グラフに対する二値分類問題（&lt;span class="math"&gt;\(y=0, 1\)&lt;/span&gt;）を解くため、陽性確率を&lt;span class="math"&gt;\(p=\mathrm{Sigmoid}(s)\)&lt;/span&gt;、&lt;span class="math"&gt;\(s=A\cdot h_G+b\)&lt;/span&gt;、学習パラメータセットを&lt;span class="math"&gt;\(\theta=\{W,A,b\}\)&lt;/span&gt;として（&lt;span class="math"&gt;\(A\)&lt;/span&gt;は&lt;span class="math"&gt;\(D\)&lt;/span&gt;次元ベクトル、&lt;span class="math"&gt;\(b\)&lt;/span&gt;はスカラー）、単一データ&lt;span class="math"&gt;\((G,y)\)&lt;/span&gt;に対する勾配降下法を実装してテストせよ。&lt;br&gt;
（勾配は数値微分、損失関数はbinary crossentropyとする。)&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;課題3&lt;/strong&gt;：データセットに対する学習が行えるよう、確率的勾配降下法(SGD)およびmomentum SGDによるミニバッチ学習を実装し、与えられたN=2000の実データセットで性能評価せよ。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;課題4&lt;/strong&gt;：勾配降下をさらにAdamにするとか、&lt;span class="math"&gt;\(W\)&lt;/span&gt;を多層化するとか好きにやってみて、最後にラベルのないテストデータに対する予言値を提出せよ。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;使用言語は7言語（C, C++, Python, Ruby, Go, Java, Rust）から選択。
&lt;strong&gt;やっぱりPython&lt;/strong&gt;だよね、うん。&lt;br&gt;
（まあ実用的なプロジェクトならC++でしょうが、そもそもフルスクラッチとかしないし、Tensorflowのようなフレームワークを使う前提なら、余程でない限り&lt;strong&gt;結局Python&lt;/strong&gt;になります。）&lt;/p&gt;
&lt;h2&gt;実装&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;クラスとして実装&lt;/strong&gt;しました。というか他のやり方が事実上思いつかない。
（なので、言語選択肢の中でもCは勘弁願いたいです。）&lt;br&gt;
課題が進む毎に、&lt;strong&gt;前課題のクラスを継承して機能追加&lt;/strong&gt;した&lt;strong&gt;派生クラス&lt;/strong&gt;を作っていきます。&lt;/p&gt;
&lt;h3&gt;課題1 : 集約と読み出し&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;課題1&lt;/strong&gt;：行列&lt;span class="math"&gt;\(W\)&lt;/span&gt;を固定として、与えられたグラフ&lt;span class="math"&gt;\(G\)&lt;/span&gt;に対して&lt;span class="math"&gt;\(h_G\)&lt;/span&gt;を求めるGNN関数またはクラスを実装してテストせよ。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;code&gt;GNN1&lt;/code&gt;クラスとして実装。
Gを隣接行列で与えることにすると、集約は2段階とも単なる行列積（と活性化関数）です。numpyの&lt;strong&gt;np.dot()&lt;/strong&gt;で簡単・高速に行えます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# task1.py&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;numpy&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;np&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;GNN1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;W&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="o"&gt;...&lt;/span&gt;
    &lt;span class="o"&gt;...&lt;/span&gt;
    &lt;span class="nd"&gt;@staticmethod&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;f&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;frompyfunc&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;relu&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="nd"&gt;@staticmethod&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;aggregate1&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;aggregate2&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;W&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;readout&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;N&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;x0&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;_&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;aggregate1&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;aggregate2&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sum&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;axis&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;課題2 : 勾配降下&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;課題2&lt;/strong&gt;：グラフに対する二値分類問題 &lt;span class="math"&gt;\((y=0, 1)\)&lt;/span&gt; を解くため、陽性確率を &lt;span class="math"&gt;\(p=\mathrm{Sigmoid}(s)\)&lt;/span&gt;、&lt;span class="math"&gt;\(s=A\cdot h_G+b\)&lt;/span&gt;、学習パラメータセットを &lt;span class="math"&gt;\(\theta=\{W,A,b\}\)&lt;/span&gt; として（ &lt;span class="math"&gt;\(A\)&lt;/span&gt;は&lt;span class="math"&gt;\(D\)&lt;/span&gt;次元ベクトル、&lt;span class="math"&gt;\(b\)&lt;/span&gt;はスカラー）、単一データ &lt;span class="math"&gt;\((G,y)\)&lt;/span&gt; に対する勾配降下法を実装してテストせよ。&lt;br&gt;
（勾配は数値微分、損失関数はbinary crossentropyとする。)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;前課題の&lt;code&gt;GNN1&lt;/code&gt;クラスを継承し、&lt;strong&gt;損失関数や勾配を計算する機能を追加&lt;/strong&gt;した派生クラス&lt;code&gt;GNN2&lt;/code&gt;を作成します。&lt;/p&gt;
&lt;p&gt;実装のポイントは初期化時に&lt;strong&gt; &lt;code&gt;Theta&lt;/code&gt; と &lt;code&gt;(W,A,b)&lt;/code&gt; でメモリを共有&lt;/strong&gt;するようにしておくこと。
今の場合、&lt;code&gt;Theta&lt;/code&gt; は(D^2 +D+1)次元ベクトルであると&lt;strong&gt;同時に、&lt;/strong&gt;そのうち最初の&lt;span class="math"&gt;\(D^2\)&lt;/span&gt;成分は&lt;span class="math"&gt;\(DxD\)&lt;/span&gt;行列 &lt;code&gt;W&lt;/code&gt;、次のD成分はD次元ベクトル &lt;code&gt;A&lt;/code&gt;、最後の成分は &lt;code&gt;b&lt;/code&gt;、としてもアクセスできるようになっています。&lt;/p&gt;
&lt;p&gt;こうすることで、数値微分や勾配降下の際に&lt;strong&gt;学習パラメータの構造を何も考えなくてよい&lt;/strong&gt;という利点があります。
実際、&lt;code&gt;GNN2.grad()&lt;/code&gt; や &lt;code&gt;GNN2.shift_Theta()&lt;/code&gt; 関数の中には &lt;code&gt;W&lt;/code&gt; や &lt;code&gt;A&lt;/code&gt; の文字すら登場しません。&lt;br&gt;
（そのため、クラスを継承・拡張してパラメータ構造に変化があっても、修正する必要がない。）  &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# task2.py&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;task1&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;GNN2&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;GNN1&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;sigma&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                 &lt;span class="n"&gt;epsilon&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;1.0e-3&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt; &lt;span class="c1"&gt;# 数値微分の微小変分&lt;/span&gt;
        &lt;span class="o"&gt;...&lt;/span&gt;
    &lt;span class="o"&gt;...&lt;/span&gt;

    &lt;span class="c1"&gt;# 学習パラメータの初期化。Thetaと(W,A,b)でメモリを共有する。&lt;/span&gt;
    &lt;span class="c1"&gt;# bも1要素numpy配列にしておくこと。&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;init_Theta&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;sigma&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Theta&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;normal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;sigma&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;W&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;decode_Theta&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;decode_Theta&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Theta&lt;/span&gt;&lt;span class="p"&gt;[:&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;reshape&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;
                &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Theta&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)],&lt;/span&gt;
                &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Theta&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
        &lt;span class="c1"&gt;# numpy配列のスライスやreshapeはもとのオブジェクトとメモリを共有している。&lt;/span&gt;
        &lt;span class="c1"&gt;# （メモリのコピーを作成しない。）&lt;/span&gt;
        &lt;span class="c1"&gt;# 不意の副作用を気にすることが多いが、ここでは積極的に利用。&lt;/span&gt;

    &lt;span class="c1"&gt;# GNN1で定義したreadout()を用いて陽性確率／損失関数を計算する&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;s&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;h&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;readout&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;h&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;p&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;sigmoid&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;loss&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;binary_cross_entropy&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="c1"&gt;# 損失関数loss()の数値微分&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;grad&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;L0&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;loss&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;K&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Theta&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;dL&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;empty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;K&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;K&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Theta&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;epsilon&lt;/span&gt;
            &lt;span class="n"&gt;dL&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;loss&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;L0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;epsilon&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Theta&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;epsilon&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;dL&lt;/span&gt;

    &lt;span class="c1"&gt;# 勾配降下&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;shift_Theta&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;dTheta&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Theta&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;dTheta&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;descendant_update&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;alpha&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;shift_Theta&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;alpha&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;grad&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;課題3：データセットからのミニバッチ学習（SGD, momentum SGD）&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;課題3&lt;/strong&gt;：データセットに対する学習が行えるよう、確率的勾配降下法(SGD)およびmomentum SGDによるミニバッチ学習を実装し、与えられたN=2000の実データセットで性能評価せよ。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ここでは (momentum) SGDの実装を求められているわけですが、アルゴリズム個々に学習メソッドを実装するのはさすがに無駄が多過ぎます。&lt;br&gt;
実際は学習メソッドは &lt;code&gt;GNN3.fit()&lt;/code&gt; ひとつだけでいいです。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# task3.py&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;task2&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;GNN3&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;GNN2&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="o"&gt;...&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;fit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;   &lt;span class="c1"&gt;# 学習データ。&lt;/span&gt;
            &lt;span class="n"&gt;optimizer&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;      &lt;span class="c1"&gt;# Optimizer派生クラスのオブジェクトを与える。&lt;/span&gt;
            &lt;span class="n"&gt;epochs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;batchsize&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;16&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;validation&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;None&lt;/span&gt;     &lt;span class="c1"&gt;# 検証データ。タプル (vx,vy) で与える。&lt;/span&gt;
            &lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;n&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="o"&gt;...&lt;/span&gt;

        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;epochs&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="c1"&gt;# epoch毎にデータをランダムに並べ替える。&lt;/span&gt;
            &lt;span class="n"&gt;order&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;permutation&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

            &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;//&lt;/span&gt;&lt;span class="n"&gt;batchsize&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
                &lt;span class="n"&gt;start&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;batchsize&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt;
                &lt;span class="n"&gt;end&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;min&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;batchsize&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                &lt;span class="c1"&gt;# 勾配ミニバッチ平均&lt;/span&gt;
                &lt;span class="n"&gt;grad&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;mean&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;grad&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
                                 &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;order&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;end&lt;/span&gt;&lt;span class="p"&gt;]],&lt;/span&gt;&lt;span class="n"&gt;axis&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                &lt;span class="c1"&gt;# optimizerで変化量を求め、Thetaを動かす。&lt;/span&gt;
                &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;shift_Theta&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;optimizer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;grad&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
                &lt;span class="o"&gt;...&lt;/span&gt;
        &lt;span class="o"&gt;...&lt;/span&gt;
        &lt;span class="c1"&gt;# loss, accの履歴を返す。&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;batch_losses&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;epoch_losses&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;epoch_accs&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;batch_vlosses&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;epoch_vlosses&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;epoch_vaccs&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;ポイントは &lt;code&gt;optimizer&lt;/code&gt; 引数。
ここに &lt;code&gt;SGD()&lt;/code&gt; やら &lt;code&gt;MomentumSGD()&lt;/code&gt; やらを、&lt;code&gt;gnn3.fit(x,y,optimizer=SGD())&lt;/code&gt; のように与えて処理を切り替えます。&lt;br&gt;
（普段ニューラルネットワーク系のライブラリを使っていると、このあたりの設計は当然ですが。）&lt;/p&gt;
&lt;p&gt;また &lt;code&gt;order&lt;/code&gt; を順に見ていくことでエポック内非復元抽出を行います（さほど重要というほどではありませんが。オコゼ本では復元抽出）。&lt;/p&gt;
&lt;p&gt;オプティマイザの中身はこちら。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# task3.py つづき&lt;/span&gt;
&lt;span class="c1"&gt;### ほぼダミーの基底クラス。（抽象クラスにした方がすっきりするが、さぼった）&lt;/span&gt;
&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Optimizer&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="nd"&gt;@staticmethod&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;update&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;grad&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="c1"&gt;# 勾配を受け取り、内部状態を更新し、変化量を返すメソッド。&lt;/span&gt;
        &lt;span class="c1"&gt;# （派生クラスではそのような関数に再定義する。）&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;grad&lt;/span&gt;

&lt;span class="c1"&gt;### 確率的勾配降下法&lt;/span&gt;
&lt;span class="c1"&gt;# Optimizerを継承してupdate()を上書き再定義。&lt;/span&gt;
&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;SGD&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Optimizer&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;alpha&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;1.0e-4&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;alpha&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;alpha&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;update&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;grad&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="c1"&gt;# SGDは更新される内部状態を持たない。&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;alpha&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;grad&lt;/span&gt;

&lt;span class="c1"&gt;### 運動量付き確率的勾配降下法&lt;/span&gt;
&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;MomentumSGD&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Optimizer&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;alpha&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;1.0e-4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;eta&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.9&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;alpha&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;alpha&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;eta&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;eta&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;w&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;update&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;grad&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="c1"&gt;# 内部のwを更新しながら変化量を返す。&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;w&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;w&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;zeros&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;grad&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;w&lt;/span&gt; &lt;span class="o"&gt;*=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;eta&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;w&lt;/span&gt; &lt;span class="o"&gt;-=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;alpha&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;grad&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;w&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;これだけ。
処理が分離されているので、わかりやすいですよね？&lt;/p&gt;
&lt;h3&gt;課題4 : その他の工夫と未知データの推論&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;課題4&lt;/strong&gt;：勾配降下をさらにAdamにするとか、&lt;span class="math"&gt;\(W\)&lt;/span&gt;を多層化するとか好きにやってみて、最後にラベルのないテストデータに対する予言値を提出せよ。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4&gt;(a) Adamの実装&lt;/h4&gt;
&lt;p&gt;オプティマイザ派生クラスを作るだけ。GNNクラスには1ミリも触れなくてOK。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# task4a.py&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;task3&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;

&lt;span class="c1"&gt;# 原論文 https://arxiv.org/abs/1412.6980 の通り、愚直に実装する。&lt;/span&gt;
&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Adam&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Optimizer&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                 &lt;span class="n"&gt;alpha&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;1.0e-3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;beta1&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.9&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;beta2&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.999&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                 &lt;span class="n"&gt;epsilon&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;1.0e-8&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="c1"&gt;# 内部状態ベクトル m,v を初期化&lt;/span&gt;
        &lt;span class="o"&gt;...&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;update&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;grad&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="c1"&gt;# m,v を更新して変化量を返す&lt;/span&gt;
        &lt;span class="o"&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h4&gt;(b) 多層ニューラルネット化&lt;/h4&gt;
&lt;p&gt;祖先クラスである &lt;code&gt;GNN1&lt;/code&gt; や &lt;code&gt;GNN2&lt;/code&gt; で定義した関数を、&lt;code&gt;W&lt;/code&gt; の多層化に合わせて上書き再定義した派生クラス &lt;code&gt;GNN4&lt;/code&gt; を作る。
変更箇所はわりと少なく、実質これだけ。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# task4b.py&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;task3&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;GNN4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;GNN3&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;sigma&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                 &lt;span class="n"&gt;Nw&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt; &lt;span class="c1"&gt;# Wのlayer数。 W.shape=(Nw,D,D)&lt;/span&gt;
        &lt;span class="o"&gt;...&lt;/span&gt;

    &lt;span class="c1"&gt;### パラメータ初期化の関数2つを上書きする。&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;init_Theta&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;sigma&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Theta&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;normal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;sigma&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;Nw&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;W&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;decode_Theta&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;decode_Theta&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;Wsize&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Asize&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Nw&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Theta&lt;/span&gt;&lt;span class="p"&gt;[:&lt;/span&gt;&lt;span class="n"&gt;Wsize&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;reshape&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Nw&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;
                &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Theta&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Wsize&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;Wsize&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;Asize&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
                &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Theta&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Wsize&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;Asize&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;Wsize&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;Asize&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;

    &lt;span class="c1"&gt;### 集約2を多層ニューラルネットに変更。&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;aggregate2&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Nw&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;W&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]))&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;結果&lt;/h2&gt;
&lt;h3&gt;SGD, momentum SGD, Adamの学習曲線（単層ネットワーク）&lt;/h3&gt;
&lt;p&gt;与えられたN=2000のデータセットで、(学習,検証)=(1600,400) に分割してとりあえず描いてみた学習曲線。
とにかくAdamの性能が圧倒的にいいですね。
このグラフは1-shotだけど、反復しても傾向は同じ。&lt;/p&gt;
&lt;p&gt;&lt;a href="{attach}./images/GNNfrom0_figs/task4a_plot03.pdf"&gt;&lt;img src="{attach}./images/GNNfrom0_figs/task4a_plot03.png"&gt;&lt;/a&gt;
&lt;a href="{attach}./images/GNNfrom0_figs/task4a_plot03a.pdf"&gt;&lt;img src="{attach}./images/GNNfrom0_figs/task4a_plot03a.png"&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;多層化GNNの性能評価&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;単層&lt;code&gt;GNN3&lt;/code&gt;と&lt;code&gt;Nw=2&lt;/code&gt;の&lt;code&gt;GNN4&lt;/code&gt;で比較（Adamを使用）。
2層化で成績が向上しているとは言えないっぽい。。
どちらも正答率(vacc)は60%程度。
（図のaccはvaccの意味。）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;a href="{attach}./images/GNNfrom0_figs/task4b_plot04.pdf"&gt;&lt;img src="{attach}./images/GNNfrom0_figs/task4b_plot04.png"&gt;&lt;/a&gt;
&lt;a href="{attach}./images/GNNfrom0_figs/task4b_plot04a.pdf"&gt;&lt;img src="{attach}./images/GNNfrom0_figs/task4b_plot04a.png"&gt;&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;補足と反省&lt;ul&gt;
&lt;li&gt;後で試したところ、実は &lt;code&gt;Nw=6&lt;/code&gt; くらいまで深層化すると &lt;strong&gt;vacc&amp;gt;=0.65&lt;/strong&gt; くらいにはなることがわかった。
やはり多層化は無駄ではないらしい。&lt;/li&gt;
&lt;li&gt;ちゃんと評価するなら、データセットを (train,valid,test) に3分割し、validのスコアが高いパラメータセットを選んでtestを評価、という手順を踏むべきである。
今回はそこまでやっていない。&lt;/li&gt;
&lt;li&gt;さらに本気で学習＆パラメータ探索をするなら、cupy版を作ってGPUを使う方がいい。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;まとめ&lt;/h2&gt;
&lt;p&gt;GNNを一通り、少なくとも明白なバグなく、ミニバッチ学習までちゃんと動かすことができました。
時間が十分確保できず、最後のネットワーク改良を全然詰めることができなかった点は残念。
でもフルスクラッチで手書きした学習がちゃんと動いてそれなりに非自明な結果を出す、というのはなかなか楽しく、一種の全能感（？）を味わうことができます。&lt;/p&gt;
&lt;p&gt;またGNNって殆ど勉強したことがなかったのですが、実装・実験してみて感覚は何となくわかりました（小並感）。
折角なので拡張や理論をもう少しちゃんと勉強して、実際の研究にも使ってみたいと思います。&lt;/p&gt;
&lt;p&gt;おしまい。&lt;/p&gt;
&lt;h2&gt;注記&lt;/h2&gt;
&lt;h3&gt;&lt;span id="note1"&gt;&lt;/span&gt;注1 : 某社の某イベント&lt;/h3&gt;
&lt;p&gt;&lt;a href="https://www.preferred.jp"&gt;Preferred Networks社&lt;/a&gt; 2019年度夏季インターン、でした。&lt;/p&gt;
&lt;p&gt;本稿に掲載したコードほぼそのままで提出。
後日談となりますが、面接を経て採用して頂きました。&lt;/p&gt;
&lt;p&gt;インターン期間は8-9月で、医学科の夏休みは8月だけなのですが、ちょうど&lt;a href="http://www.edu.med.osaka-u.ac.jp/assignment/"&gt;基礎配属&lt;/a&gt;期間の一部を利用してフル参加することができた、という事情もあったりします。
詳しくは&lt;a href="/previews/refs/heads/general/jinja2_version/blog/2019/07/kisohai-intern.html"&gt;こちらの記事&lt;/a&gt;にて。&lt;/p&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category><category term="企業インターン"></category></entry><entry><title>IPA「基本情報技術者試験」受験録</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/05/ipa_fe.html" rel="alternate"></link><published>2019-05-12T00:00:00+09:00</published><updated>2019-12-23T00:00:00+09:00</updated><author><name>小川</name></author><id>tag:None,2019-05-12:/previews/refs/heads/general/jinja2_version/blog/2019/05/ipa_fe.html</id><summary type="html">&lt;p&gt;IPAの「&lt;a href="https://www.jitec.ipa.go.jp/1_11seido/fe.html"&gt;&lt;strong&gt;基本情報技術者試験&lt;/strong&gt;&lt;/a&gt;」 (2019年春期) を受験してきました。&lt;/p&gt;
&lt;p&gt;なんでも経済産業省管轄の&lt;strong&gt;国家試験&lt;/strong&gt;で、&lt;a href="https://kanpou.npb.go.jp/"&gt;&lt;strong&gt;官報公示&lt;/strong&gt;&lt;/a&gt;までされるらしい。&lt;strong&gt;よ …&lt;/strong&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;IPAの「&lt;a href="https://www.jitec.ipa.go.jp/1_11seido/fe.html"&gt;&lt;strong&gt;基本情報技術者試験&lt;/strong&gt;&lt;/a&gt;」 (2019年春期) を受験してきました。&lt;/p&gt;
&lt;p&gt;なんでも経済産業省管轄の&lt;strong&gt;国家試験&lt;/strong&gt;で、&lt;a href="https://kanpou.npb.go.jp/"&gt;&lt;strong&gt;官報公示&lt;/strong&gt;&lt;/a&gt;までされるらしい。&lt;strong&gt;よくわからないけどすごい&lt;/strong&gt;。
厚生労働省の&lt;a href="https://www.mhlw.go.jp/kouseiroudoushou/shikaku_shiken/ishi/"&gt;&lt;strong&gt;某国家試験&lt;/strong&gt;&lt;/a&gt;は受験資格が残念ながらまだないけれど、&lt;strong&gt;こないだ国試受けてきた&lt;/strong&gt;って言ってもたぶん嘘じゃないわけです。だからどうしたって話ではありますが。&lt;/p&gt;
&lt;p&gt;今回はその受験録です。&lt;/p&gt;
&lt;h2&gt;受験申込〜当日まで&lt;/h2&gt;
&lt;h3&gt;申込&lt;/h3&gt;
&lt;p&gt;特に何も目的などはないんですが、2月のBioinfo会でNさんが&lt;a href="https://www.jitec.ipa.go.jp/"&gt;&lt;strong&gt;情報処理技術者試験&lt;/strong&gt;&lt;/a&gt;のポスターを持ってこられ、締切直前だったこともあり、何となくその場の勢いでぽちる。&lt;br&gt;
試験はレベル1から最上位の4まで区分があり、これも何となく弱気にレベル2の本試験を選択。&lt;/p&gt;
&lt;h3&gt;会場変更&lt;/h3&gt;
&lt;p&gt;試験会場は阪大豊中キャンパス。&lt;br&gt;
…のはずが、なんか&lt;strong&gt;遠くの方の某大学&lt;/strong&gt;に変更。ちょっと気力を削がれる。&lt;/p&gt;
&lt;h3&gt;試験勉強など&lt;/h3&gt;
&lt;p&gt;結局、何もしませんでした。
勉強も過去問調査も一切無しの&lt;strong&gt;ガチンコ&lt;/strong&gt; (?) で本番に臨みます。&lt;br&gt;
(そもそも試験受験の目的って半分以上はそれを口実に勉強することだと思うので、何やってるのかよくわかりませんが。。)&lt;/p&gt;
&lt;h2&gt;試験当日&lt;/h2&gt;
&lt;p&gt;昨夜も&lt;a href="https://atcoder.jp/contests/tenka1-2019"&gt;競プロ&lt;/a&gt;の出来は微妙だったけど、検討はほどほどにして寝たよ。&lt;/p&gt;
&lt;h3&gt;午前試験（9:30〜12:00）&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;4択問題が80問。ひたすらマークしていく。  &lt;/li&gt;
&lt;li&gt;常識で解けるような問題も多い。
&lt;span id="p-th"&gt;第1問「10進数の7÷32の結果を2進数表記したものはどれか」&lt;/span&gt;…高校入試かな？  &lt;/li&gt;
&lt;li&gt;とはいえ、1/4くらいは確信がもてない／よくわからなかった。
第71問「IoTの応用事例のうちHEMSの説明はどれか」…知らないよ、ごめんね [&lt;a href="#note1"&gt;注1&lt;/a&gt;]。  &lt;/li&gt;
&lt;li&gt;でも&lt;strong&gt;結局は4択&lt;/strong&gt;だからね。期待値的に8割以上はあるはずだよ [&lt;a href="#note2"&gt;注2&lt;/a&gt;]。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;見直す気力も沸かないし、お昼が気になるから午前試験は途中退出。
近くにラーメン屋さんを見つけてがっつり食べてきたよ。眠い。。&lt;/p&gt;
&lt;h3&gt;午後試験（13:00〜15:30）&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;4択は少ないけど、やっぱり全問択一式。要求知識は午前より少なくて、&lt;strong&gt;問題文や選択肢の読解力&lt;/strong&gt;が一番のポイントっぽい気がする。
ちゃんと読んで理解できれば答えられる問題がほとんど。  &lt;/li&gt;
&lt;li&gt;「変更管理会議において、仕様変更依頼が採用された場合、担当PMは（　　）する」…うん、&lt;strong&gt;辞任&lt;/strong&gt;…と、、あれ？選択肢にない？
「&lt;strong&gt;仕様変更依頼の内容をプロジェクト計画に反映させて更新&lt;/strong&gt;」か、、記述なら死んでたよ。&lt;/li&gt;
&lt;li&gt;「ソフトウェア開発」という5言語から1題選択のセクションがある。&lt;br&gt;
C、COBOL、Java、アセンブラ、表計算。…あれ？？&lt;strong&gt;Pythonどこ？&lt;/strong&gt; [&lt;a href="#note3"&gt;注3&lt;/a&gt;] どこ？軽くパニック。
何回探しても出てこないから、しぶしぶCを解く。
レベル的には、昔のセンター試験（N88-BASIC）よりはちょっと上くらい？  &lt;/li&gt;
&lt;li&gt;結局、午後は午前より出来がよくて、9割あるんじゃないかな、たぶん [&lt;a href="#note2"&gt;注2&lt;/a&gt;]。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;そんなわけで終了。午後試験はちゃんと最後までいたよ。
マークがずれたりしてなければ合格だと思う。
結果発表は&lt;strong&gt;1ヶ月後&lt;/strong&gt;。全部マークシートなのに長いねえ。&lt;/p&gt;
&lt;h2&gt;全体を通しての感想&lt;/h2&gt;
&lt;p&gt;この試験の合格基準は午前午後とも&lt;strong&gt;各60%&lt;/strong&gt;です。
僕は理数系出身の学士編入生で、この種の試験には医学部生の中でも強い方だと思います。
しかしそれを差し引いても、少なくともボーダー60%の試験としては、&lt;strong&gt;難度がきわめて低い&lt;/strong&gt;と言わざるをえません。  &lt;/p&gt;
&lt;p&gt;ですので、情報処理技術者試験に興味があっても、能力証明という意味では&lt;strong&gt;レベル2の本試験は会員の皆さんにお勧めしません&lt;/strong&gt;。
レベル3の&lt;a href="https://www.jitec.ipa.go.jp/1_11seido/ap.html"&gt;&lt;strong&gt;応用情報技術者試験&lt;/strong&gt;&lt;/a&gt;を検討してみてください [&lt;a href="#note4"&gt;注4&lt;/a&gt;]。
尤も、午前試験の超高得点はそんなに簡単じゃないと思うので、勉強してみるのは悪くないかも。
そのあたりは&lt;a href="http://www.toukei-kentei.jp/about/grade1semi/"&gt;統計検定準1級&lt;/a&gt;などと似ていると思います。&lt;/p&gt;
&lt;p&gt;何はともあれ、&lt;strong&gt;基本情報技術者&lt;/strong&gt;というよくわからない肩書き（&lt;strong&gt;国家資格&lt;/strong&gt;？）を手に入れました（たぶん）。
おしまい。&lt;/p&gt;
&lt;h2&gt;注記&lt;/h2&gt;
&lt;h3&gt;&lt;span id="note1"&gt;&lt;/span&gt;注1 : HEMS&lt;/h3&gt;
&lt;p&gt;HEMS = Home Energy Management System.&lt;/p&gt;
&lt;h3&gt;&lt;span id="note2"&gt;&lt;/span&gt;注2 : 試験結果 (2019.06)&lt;/h3&gt;
&lt;p&gt;試験結果開示は午前80.00点、午後95.00点。
ほぼ手応え通りながら、午前試験でわからなかった部分は本当にランダム回答の正答率しかなかった模様。。  &lt;/p&gt;
&lt;h3&gt;&lt;span id="note3"&gt;&lt;/span&gt;注3 : Python導入 (2019.11)&lt;/h3&gt;
&lt;p&gt;2020年春期試験から、COBOLが廃止されPythonがめでたく導入されることになりました。&lt;br&gt;
&lt;a href="https://www.jitec.ipa.go.jp/1_00topic/topic_20191028.html"&gt;https://www.jitec.ipa.go.jp/1_00topic/topic_20191028.html&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;&lt;span id="note4"&gt;&lt;/span&gt;注4 : 応用情報技術者試験 (2019.12)&lt;/h3&gt;
&lt;p&gt;その後、秋試験で受験しました。
&lt;a href="/previews/refs/heads/general/jinja2_version/blog/2019/10/ipa_ap.html"&gt;こちらの記事&lt;/a&gt;にて。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="検定試験"></category></entry><entry><title>はじめての競プロ：入力アンチョコメモ</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/04/competition_input.html" rel="alternate"></link><published>2019-04-27T00:00:00+09:00</published><updated>2019-04-29T00:00:00+09:00</updated><author><name>小川</name></author><id>tag:None,2019-04-27:/previews/refs/heads/general/jinja2_version/blog/2019/04/competition_input.html</id><summary type="html">&lt;h2&gt;入力のパターン&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Python会競プロ部（？）へようこそ！&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;はじめての方には&lt;strong&gt;入力&lt;/strong&gt;が最初の鬼門だと思います。&lt;br&gt;
&lt;a href="https://atcoder.jp"&gt;AtCoder&lt;/a&gt; のABCで、&lt;strong&gt;これさえ覚えれば大丈夫！&lt;/strong&gt;な …&lt;/p&gt;</summary><content type="html">&lt;h2&gt;入力のパターン&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Python会競プロ部（？）へようこそ！&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;はじめての方には&lt;strong&gt;入力&lt;/strong&gt;が最初の鬼門だと思います。&lt;br&gt;
&lt;a href="https://atcoder.jp"&gt;AtCoder&lt;/a&gt; のABCで、&lt;strong&gt;これさえ覚えれば大丈夫！&lt;/strong&gt;な入力パターンは以下の通り。
最初は説明の意味がわからなくても、とりあえずコピペすれば動きます（何）。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;言語&lt;/strong&gt;は &lt;code&gt;Python3 (3.4.3)&lt;/code&gt; (または &lt;code&gt;PyPy3 (2.4.0)&lt;/code&gt;) を選択してね。&lt;/p&gt;
&lt;h3&gt;文字列を入力&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;S&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;整数ひとつを入力&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;A&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;int()&lt;/code&gt; が、文字列を整数 (integer) に変換する&lt;strong&gt;呪文&lt;/strong&gt;です。&lt;/p&gt;
&lt;h3&gt;整数2つ〜を一行（空白区切り）で入力&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;B&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;B&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;C&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;まず &lt;code&gt;split()&lt;/code&gt; で文字列を分割。
次に &lt;code&gt;map()&lt;/code&gt; で &lt;code&gt;int()&lt;/code&gt; をそれぞれに適用しています。&lt;/p&gt;
&lt;h3&gt;多数の整数を一行で入力&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;x&lt;/code&gt; は0番目から始まる配列になる。n番目は &lt;code&gt;x[n]&lt;/code&gt; で参照します。&lt;/p&gt;
&lt;h2&gt;使用例&lt;/h2&gt;
&lt;h3&gt;問題1&lt;/h3&gt;
&lt;p&gt;整数A, Bが1行 (空白区切り) で&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;A B
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;のように与えられる。和 &lt;code&gt;A+B&lt;/code&gt; を出力せよ。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;解答例&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;B&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;B&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;問題2&lt;/h3&gt;
&lt;p&gt;1行目に自然数 &lt;code&gt;N&lt;/code&gt;, &lt;code&gt;K&lt;/code&gt; (&lt;code&gt;N&amp;gt;=K&lt;/code&gt;)、2行目にN個の整数 &lt;code&gt;x1,..,xN&lt;/code&gt; が、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;N K
x1 x2 x3 ... xN
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;のように与えられる。
このうちK番目の整数xKを出力せよ。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;解答例&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;K&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;K&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;配列が0番目からであることに注意。
&lt;code&gt;N&lt;/code&gt; は実は使わなくてよい。&lt;br&gt;
ちょっと難しいパターンだが、B問題ではちょくちょく出てくる。&lt;/p&gt;
&lt;h3&gt;問題3&lt;/h3&gt;
&lt;p&gt;&lt;s&gt;(このパターンはたぶんC問題以降のみ。)&lt;/s&gt; B問題にも時々出ます。&lt;br&gt;
1行目に自然数 &lt;code&gt;N&lt;/code&gt;, &lt;code&gt;K&lt;/code&gt; (&lt;code&gt;N&amp;gt;=K&lt;/code&gt;)、2行目〜N+1行目に &lt;code&gt;N&lt;/code&gt;個の整数 &lt;code&gt;x1,..,xN&lt;/code&gt; が、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;N K
x1
x2
x3
...
...
xN
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;のように与えられる。
このうち &lt;code&gt;K&lt;/code&gt; 番目の整数 &lt;code&gt;xK&lt;/code&gt; を出力せよ。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;解答例&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;K&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;K&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;ループとの組み合わせ。&lt;s&gt;C問題&lt;/s&gt; B問題以降でときどき必要。&lt;/p&gt;
&lt;p&gt;以上です。おしまい。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="競技プログラミング"></category></entry><entry><title>5年次海外実習</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/03/study_abroad.html" rel="alternate"></link><published>2019-03-29T00:00:00+09:00</published><updated>2019-03-29T00:00:00+09:00</updated><author><name>佐藤</name></author><id>tag:None,2019-03-29:/previews/refs/heads/general/jinja2_version/blog/2019/03/study_abroad.html</id><summary type="html">&lt;p&gt;1月末から3月中旬までオーストラリアのメルボルンに海外実習に行ってました、５年生の佐藤です。基礎系の研究室に行ったのですが、僕がまだまだ勉強不足なところも多くこれからの勉強のモチベーションに …&lt;/p&gt;</summary><content type="html">&lt;p&gt;1月末から3月中旬までオーストラリアのメルボルンに海外実習に行ってました、５年生の佐藤です。基礎系の研究室に行ったのですが、僕がまだまだ勉強不足なところも多くこれからの勉強のモチベーションにもなりました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}images/study_abroad_figs/img_01.jpg"&gt;&lt;/p&gt;
&lt;p&gt;僕の実習内容についてはまだまとまっていないので、去年行った宮崎先輩の資料をもらいました。&lt;/p&gt;
&lt;iframe src="//www.slideshare.net/slideshow/embed_code/key/f3e0fxEFp9OQAq" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen&gt; &lt;/iframe&gt;
&lt;div style="margin-bottom:5px"&gt;

海外での生活は旅行も含めて初めてだったので本当に不安でしたが、寮の友達が親切に接してくれて本当に助かりました。ここでその暮らしぶりを少し書かせてもらおうと思います。

## 英語について

僕を含めて多くの人が海外留学する際に懸念していることかもしれません。IELTSはギリギリ6.0でかつ直前まで英語の勉強をサボっていたので非常に心配でした。なんとかなるかなーと割と楽観的だったのですが、空港でコーヒー頼む時に全然通じなくて絶望しました。

ただ、僕が滞在していた寮は留学生が多く住んでいる寮で英語を母国語としている人はそこまで多くなかったので助かりました。それでも最初は聞き取れませんでしたが、周りの人が割と根気強く伝えようとしてくれたのでありがたかったです。

日本に帰ってからもちゃんと英語勉強します。。。

## 寮生活について

今回僕は大学内にある寮的なところに滞在しました。朝晩食事付きで週34000円くらいです。オーストラリアにしてはだいぶ良心的ですが、それでも１ヶ月半いるとなるとばかにならないし、行かせてくれた親には超感謝してます。朝晩バイキング形式で食べるので、必然的に他の住人と話すことになるわけですが、結果的にこれがよかったです。用事を作らずとも自然に人と話す機会があるし、色々な人の色々な人生が聞けてすごく楽しいです。ここでたくさんの友達ができました。

部屋も結構快適で落ち着きます。風呂とトイレは共同と聞いていて結構ビビってたんですが、全然不快な感じはなかったです。

寮というものに住んだことがなかったので、とても新鮮でした。

![2]({attach}images/study_abroad_figs/img_02.jpg)
![3]({attach}images/study_abroad_figs/img_03.jpg)

## メルボルンという町について

ぶっちゃけ日本より住みやすい気がします。気温の年較差は小さく(冬でも10度前後)、日較差は大きいです(今は夏ですが、最低気温18度くらい)。昼間はラボに行っているので、外に出る時は5月くらいの気候で超気持ちいいです。日差しは強いのでオーストラリア来る時は日焼け止め必須です。

メルボルンはアートとスポーツの町です。そこらかしこに美術館や記念館があり、とても全部は行けないほどです。古い建築物が多く残っており、伝統的な西洋建築が立ち並ぶかと思いきや、流線形のドーム状の病院や路地裏にはストリートアート的なものがそこら中に描かれ、それらがいい意味で混じり合い独特の景観を形成しています。

先日全豪オープンが開かれたのもこの町です。ちょうど中之島のように中心地のすぐ近くにヤラ川という川が流れており、ボート競技も盛んに行われていました。

オーストラリアは移民の国で、色々な人種の人たちがいます。だいたい３割がアジア系(中国が最多)、アフリカ系の人も結構います。

![4]({attach}images/study_abroad_figs/img_04.jpg)
![5]({attach}images/study_abroad_figs/img_05.jpg)

## 海外の留学生について

アジア系の人たちが結構多かったです。特に中国はチャイナタウンもあるからなのか、非常に多くの学生が来ています。話を聞いていると、中国の学生の20%くらいの人が海外で修士、あるいは博士を取るらしく、英語は使えて当然のような雰囲気が伺えました。日本は自国の大学や研究機関以外の選択肢があまりないというか、海外に行く人が(少なくとも僕の周りには)少ないので驚きました。当然、speakingやlisteningの能力も程度の差こそあれ、日本人は劣っていると思います。カナダ人から「日本人ってシャイだしあんまり英語も喋れないよねー」って言われて、確かに、、、と納得してしまいました。海外に渡り、技術や知識を取り入れるのがスタンダードになろうとしている他のアジア諸国の人たちを見ていると、日本の将来を考えずにはいられませんでした。

## まとめ

海外での生活は予想よりもはるかに楽しかったです。これは寮の友達によるところが大きかったです。毎日誰かが寮のどこかでボードゲームなどで遊んでおり、それを見ているだけでも楽しく、また一緒にやろうぜと気軽に誘ってくれました。休日はみんなで出かけ、それぞれの故郷の料理を交互に食べ、文化について語り合う。考え方は人それぞれなのはもちろん、国や宗教に大きく影響を受けていることを知りました。

旅行ではなかなか味わえないたくさんの貴重な経験をさせてもらいました。

海外に行ってみたい、というミーハーな理由で海外実習を選びましたが、行って本当によかったです。皆さんも是非！！

![6]({attach}images/study_abroad_figs/img_06.jpg)
![7]({attach}images/study_abroad_figs/img_07.jpg)</content><category term="技術ブログ"></category><category term="海外留学"></category></entry><entry><title>NTT corevoチャレンジ: 話者の性別・年代識別</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/03/voice_recognition.html" rel="alternate"></link><published>2019-03-29T00:00:00+09:00</published><updated>2019-03-29T00:00:00+09:00</updated><author><name>佐藤</name></author><id>tag:None,2019-03-29:/previews/refs/heads/general/jinja2_version/blog/2019/03/voice_recognition.html</id><summary type="html">&lt;p&gt;&lt;a href="https://signate.jp"&gt;Signate&lt;/a&gt;内で開催されていた上記のコンペティションに参加してきました。以下試してみたこと、感想のまとめです。&lt;/p&gt;
&lt;div class="jetpack-video-wrapper"&gt;&lt;iframe src='https://www.slideshare.net/slideshow/embed_code/138387330' width='616' height='505' allowfullscreen webkitallowfullscreen mozallowfullscreen&gt;&lt;/iframe&gt;&lt;/div&gt;

&lt;p&gt;思って …&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;a href="https://signate.jp"&gt;Signate&lt;/a&gt;内で開催されていた上記のコンペティションに参加してきました。以下試してみたこと、感想のまとめです。&lt;/p&gt;
&lt;div class="jetpack-video-wrapper"&gt;&lt;iframe src='https://www.slideshare.net/slideshow/embed_code/138387330' width='616' height='505' allowfullscreen webkitallowfullscreen mozallowfullscreen&gt;&lt;/iframe&gt;&lt;/div&gt;

&lt;p&gt;思っていたよりも良い成績を残すことができて満足です。医学とはあまり関係なさそうですが、音声は脳波や心電図等と同じく時系列データなので、その扱いに慣れたことは良かったです。コンペなどに定期的に参加することで、機械学習を学ぶモチベーションになっているので、この調子で色々なコンペに参加していきたいと思います。&lt;/p&gt;
&lt;p&gt;2stage制なのになぜかstageごとにメダルをもらい、signate総合ランキング52位に入りました。ランキングはあんまり当てにならない気がします。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category><category term="Data Science Competition"></category></entry><entry><title>VELOCYTO</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/03/velocyto.html" rel="alternate"></link><published>2019-03-24T00:00:00+09:00</published><updated>2019-03-24T00:00:00+09:00</updated><author><name>廣瀬</name></author><id>tag:None,2019-03-24:/previews/refs/heads/general/jinja2_version/blog/2019/03/velocyto.html</id><summary type="html">&lt;p&gt;&lt;strong&gt;Velocyto&lt;/strong&gt; とは、RNAseq の結果に含まれるイントロンの割合からその細胞の分化指向性を算出するという解析手法です。&lt;/p&gt;
&lt;h2&gt;RNAseq でイン …&lt;/h2&gt;</summary><content type="html">&lt;p&gt;&lt;strong&gt;Velocyto&lt;/strong&gt; とは、RNAseq の結果に含まれるイントロンの割合からその細胞の分化指向性を算出するという解析手法です。&lt;/p&gt;
&lt;h2&gt;RNAseq でイントロン??&lt;/h2&gt;
&lt;p&gt;RNAseq においては totalRNA のうち 99%ともいわれる rRNA を除き mRNA のみを効率よくSequence する目的で、Poly(A)で成熟 mRNA を濃縮することがしばしば行われています。しかし、そのようなサンプルにおいても、実際の Sequence 結果ではイントロンにあたる配列が読まれてくることが指摘されており、この原因は Poly(A)類似モチーフの存在であると推察されています。&lt;/p&gt;
&lt;h2&gt;結果の例&lt;/h2&gt;
&lt;p&gt;概日時間の検討ではとてもきれいな結果が得られています。関連遺伝子のunspliced(u) とspliced(s)を観察していくと、circadian timeの経過とともにu がs に変化していきます。&lt;/p&gt;
&lt;p&gt;また、未分化細胞からの分化の方向性を見積もることも可能と報告されています。マウスのオリゴデンドロサイト前駆体細胞がオリゴデンドロサイトへ分化する方向に Velocityを持っていることが示されました。&lt;/p&gt;
&lt;h2&gt;実践編&lt;/h2&gt;
&lt;p&gt;Developer の WEB(&lt;a href="http://velocyto.org/"&gt;http://velocyto.org/&lt;/a&gt;)の tutorial を参考に手持ちの BAM で挑戦します。R 用と Python 用とあるようですが、もちろん Python です。二部構成となっており、前半はCommand lineでBAMファイルから.loomファイルを作成、後半では作成した.loomファイルから解析を行うとのことです。&lt;/p&gt;
&lt;h3&gt;準備&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ conda install numpy scipy cython numba matplotlib scikit-learn h5py click
$ pip install velocyto
$ pip install scanpy
$ pip install -U scvelo
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;※pysam は Windows 環境下では仮想環境下であってもインストールできないそうです。
- &lt;a href="https://qiita.com/chaoi/items/6d7702cd70430610f844"&gt;https://qiita.com/chaoi/items/6d7702cd70430610f844&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;これに気付かず数日はまりました。。&lt;/p&gt;
&lt;h3&gt;Genome annotation file のダウンロード&lt;/h3&gt;
&lt;p&gt;GENCODE のサイトから GTF ファイルをダウンロードし、適当な場所に保存して
gunzip。&lt;/p&gt;
&lt;h3&gt;実行&lt;/h3&gt;
&lt;p&gt;Sequence の手法ごとに Command を選べます。今回は smart-seq2 で行います。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ velocyto run-smartseq2 -e hogehoge /*.bam annotation.gtf
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;オプション&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;-o, --outputfolder&lt;/code&gt;：出力ディレクトリを作成・指定&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-e, --sampleid&lt;/code&gt;：出力ファイル名&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-m, --repmask&lt;/code&gt;：リピート配列をマスクする場合&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-t, --dtype&lt;/code&gt;：出力ファイルのデータ型(default は unit32)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-d, --dump&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-v, --verbose&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;サンプルごとに BAM があることを想定して複数ファイルを*で受け付けてくれます。BAM と GTF ファイルは必須です。なお、BAM の代わりに SAM を入れてもエラーは吐かないようです。これにより、hogehoge.loom ファイルが得られました。この中には、各分子のスプライシング状態が格納されています。&lt;/p&gt;
&lt;p&gt;※TOPHAT でアラインメントしたデータはそのままではうまく行かないようです。なので、TopHat-Recondition で unmap のデータを拾ってくればいけるかもしれません。今回はHISAT2 でアラインメントし直してから velocyto をかけ、改めてhogehoge.loom ファイルを得ました。&lt;/p&gt;
&lt;h3&gt;描画&lt;/h3&gt;
&lt;p&gt;Scanpy と組み合わせて使用するために scvelo を用いました。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;scanpy&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;sc&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;scvelo&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;scv&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;データ読み込み&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;adata&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sc&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;hogehoge.loom&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;次元圧縮&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;sc&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pca&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;adata&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;n_comps&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;速度計算&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;scv&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;moments&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;adata&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;scv&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;velocity&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;adata&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;描画&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;scv&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;velocity_embedding&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;adata&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img alt="1" src="{attach}images/velocyte_figs/picture1.png"&gt;&lt;/p&gt;
&lt;p&gt;※それぞれの細胞における特定遺伝子の発現レベルを色で表したり、PCA 以外の次元圧縮法を用いることもできます。この場合は tSNE のほうがきれいに見えるようです。パラメータはたくさん用意されているので、各データセットで最適な条件を検討する必要があるでしょう。&lt;/p&gt;
&lt;p&gt;&lt;img alt="2" src="{attach}images/velocyte_figs/picture2.png"&gt;
&lt;img alt="3" src="{attach}images/velocyte_figs/picture3.png"&gt;&lt;/p&gt;
&lt;h2&gt;参考文献&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.nature.com/articles/s41586-018-0414-6"&gt;https://www.nature.com/articles/s41586-018-0414-6&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://velocyto.org/velocyto.py/index.html"&gt;http://velocyto.org/velocyto.py/index.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://catway.jp/bioinformatics/qc/rmrepeat.html"&gt;http://catway.jp/bioinformatics/qc/rmrepeat.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/theislab/scvelo"&gt;https://github.com/theislab/scvelo&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><category term="技術ブログ"></category><category term="Bioinformatics"></category></entry><entry><title>必要n数の決定～研究計画～</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/03/n_number.html" rel="alternate"></link><published>2019-03-22T00:00:00+09:00</published><updated>2019-03-22T00:00:00+09:00</updated><author><name>依藤</name></author><id>tag:None,2019-03-22:/previews/refs/heads/general/jinja2_version/blog/2019/03/n_number.html</id><summary type="html">&lt;h2&gt;シングルセル解析での細胞数&lt;/h2&gt;
&lt;p&gt;① &lt;strong&gt;実現可能性&lt;/strong&gt;：金銭面、使用機器のスループットを考慮した細胞数&lt;br&gt;
② &lt;strong&gt;検出力&lt;/strong&gt;：統計学的検 …&lt;/p&gt;</summary><content type="html">&lt;h2&gt;シングルセル解析での細胞数&lt;/h2&gt;
&lt;p&gt;① &lt;strong&gt;実現可能性&lt;/strong&gt;：金銭面、使用機器のスループットを考慮した細胞数&lt;br&gt;
② &lt;strong&gt;検出力&lt;/strong&gt;：統計学的検討により細胞種間の差が充分に検出される症例数であるか&lt;br&gt;
③ &lt;strong&gt;倫理面&lt;/strong&gt;：ヒトサンプル、あるいはモデル動物サンプルの取り扱い  &lt;/p&gt;
&lt;p&gt;とくに②に関して：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;分類するclusterに関して過去の文献から予測する。&lt;/li&gt;
&lt;li&gt;想定されるcluster数&lt;/li&gt;
&lt;li&gt;1clusterあたりの最低細胞数&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;上記の見積もりができれば、ウェブサイトでの計算が可能。&lt;/p&gt;
&lt;h2&gt;臨床研究での症例数&lt;/h2&gt;
&lt;p&gt;① &lt;strong&gt;実現可能性&lt;/strong&gt;：それだけの症例数を集めることができるか&lt;br&gt;
② &lt;strong&gt;検出力&lt;/strong&gt;：統計学的検討によりoutcomeの差が充分に検出される症例数であるか&lt;br&gt;
③ &lt;strong&gt;倫理面&lt;/strong&gt;：不必要に多くの被験者を研究に参加させるべきではない  &lt;/p&gt;
&lt;p&gt;とくに②に関して：&lt;/p&gt;
&lt;p&gt;症例数の予測に必要なものを過去の文献やパイロット研究を行うことで予測する。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;outcomeの差&lt;/li&gt;
&lt;li&gt;データのばらつき(標準偏差)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;上記の見積もりができれば、ソフトウェアでの計算が可能。 (cf.) &lt;a href="http://biostat.mc.vanderbilt.edu/wiki/Main/PowerSampleSize"&gt;Power and Sample Size Calculation (PS)&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;まとめ&lt;/h2&gt;
&lt;p&gt;シングルセル解析では、やはり値段や機器の問題が大きくなってくるでしょうか。特に細胞種がかなり希少な場合に、細胞数(n)をどんどん増やすしかないとなると、その点が一番気になります。&lt;/p&gt;
&lt;p&gt;一方で臨床研究では、単施設で可能なのか、多施設共同でないと症例数(n)が集まらないのかという問題は切実です。そしてヒトを対象にする以上、症例数決定の明確な理由が必要です。&lt;a href="http://www.consort-statement.org/media/default/downloads/consort%202010%20checklist.pdf"&gt;CONSORT2010 checklist&lt;/a&gt;にも記載があります。&lt;/p&gt;
&lt;p&gt;いずれにせよ、事前の文献調査やプレ実験・パイロット研究によって着地点を明確にしておかないと、途中で頓挫してしまい、出るはずの結果がでない事態になりそうです。今後はシングルセル解析で前提となる統計手法に関しても勉強していこうと思っています。&lt;/p&gt;
&lt;h2&gt;参考文献&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;今日から使える医療統計　(新谷歩, 2015年, 医学書院)&lt;/li&gt;
&lt;li&gt;Tutorial: guidelines for the experimental design of single-cell RNA sequencing studies　(Atefeh Lafzi et el., Nature Protocols volume 13, pages2742–2757 (2018))&lt;/li&gt;
&lt;/ul&gt;</content><category term="技術ブログ"></category><category term="Statistics"></category></entry><entry><title>阪医Python会特製 RNA-seq pipeline ver. 1.0 リリース</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/03/original_rnaseq_pipeline.html" rel="alternate"></link><published>2019-03-19T00:00:00+09:00</published><updated>2019-03-19T00:00:00+09:00</updated><author><name>菅波</name></author><id>tag:None,2019-03-19:/previews/refs/heads/general/jinja2_version/blog/2019/03/original_rnaseq_pipeline.html</id><summary type="html">&lt;p&gt;阪医Python会のbioinformaticsチームの一つの成果として、RNA-seqのパイプラインのv1.0がリリースとなったので記事とさせていただきます。SRR idから遺伝子✕サンプルのテーブルにするまでには意外に大変ですが、それをすべて自動化しました。ダウンロード …&lt;/p&gt;</summary><content type="html">&lt;p&gt;阪医Python会のbioinformaticsチームの一つの成果として、RNA-seqのパイプラインのv1.0がリリースとなったので記事とさせていただきます。SRR idから遺伝子✕サンプルのテーブルにするまでには意外に大変ですが、それをすべて自動化しました。ダウンロード、詳細等は以下にあります。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href="https://github.com/yyoshiaki/auto_counttable_maker"&gt;https://github.com/yyoshiaki/auto_counttable_maker&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;なお、以下のイラストはikraのアイコンとなっています。&lt;/p&gt;
&lt;p&gt;&lt;img src="{attach}images/original_rnaseq_pipeline_figs/ikra.png" width="250px"&gt; &lt;/p&gt;
&lt;h2&gt;特徴&lt;/h2&gt;
&lt;p&gt;今回、自分たちの使いやすさを考えてツールの設計を行いました。他サンプルのファイル名の管理など、煩わしいところをすべて自動化することで、ミスも減らせると思います。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;準備するのは簡単なCSVファイル（テーブルだけ）で、極力パラメーターを減らした。&lt;/li&gt;
&lt;li&gt;すべてdocker上で動くため、ツールを各々インストールする必要がないし、バージョンに苦しむこともない。&lt;/li&gt;
&lt;li&gt;udockerにも対応しているため、ユーザー権限しかないサーバー上でも実行可能。&lt;/li&gt;
&lt;li&gt;outputは&lt;a href="http://bioinformatics.sdstate.edu/idep/"&gt;idep&lt;/a&gt;に対応。&lt;/li&gt;
&lt;li&gt;もちろんマルチスレッド対応。&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;使い方&lt;/h2&gt;
&lt;p&gt;必要なテーブルは&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;name&lt;/th&gt;
&lt;th&gt;SRR or fastq&lt;/th&gt;
&lt;th&gt;Layout&lt;/th&gt;
&lt;th&gt;condition1&lt;/th&gt;
&lt;th&gt;...&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Treg_LN_1&lt;/td&gt;
&lt;td&gt;SRR5385247&lt;/td&gt;
&lt;td&gt;SE&lt;/td&gt;
&lt;td&gt;Treg&lt;/td&gt;
&lt;td&gt;...&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Treg_LN_2&lt;/td&gt;
&lt;td&gt;SRR5385248&lt;/td&gt;
&lt;td&gt;SE&lt;/td&gt;
&lt;td&gt;Treg&lt;/td&gt;
&lt;td&gt;...&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;のような形式で、前3列が必須です。簡単ですね！データの集め方は、論文についているaccession number等をたどるのでもいいし、新しくなって爆速になった&lt;a href="http://sra.dbcls.jp/"&gt;DDBJ Search&lt;/a&gt;もおすすめ。&lt;/p&gt;
&lt;p&gt;コマンドはオプションが指定でき、リード数を100000に絞ったテストモードやマルチプロセスにも対応。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;Usage&lt;/span&gt;&lt;span class="err"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;bash&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;MakeCountTable_Illumina_trimgalore_SRR&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sh&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;experiment_table&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;csv&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;spiece&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;--test, --help, --without-docker, --udocker&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;--threads [VALUE&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="err"&gt;]&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="mf"&gt;1.&lt;/span&gt;&lt;span class="n"&gt;experiment&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;matrix&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;csv&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="mf"&gt;2.&lt;/span&gt;&lt;span class="n"&gt;reference&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;human&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="ow"&gt;or&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;mouse&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="nl"&gt;Options&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="o"&gt;--&lt;/span&gt;&lt;span class="n"&gt;test&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;test&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;mode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MAX_SPOT_ID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;100000&lt;/span&gt;&lt;span class="p"&gt;).(&lt;/span&gt;&lt;span class="n"&gt;dafault&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;False&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;u&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;--&lt;/span&gt;&lt;span class="n"&gt;udocker&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;w&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;--&lt;/span&gt;&lt;span class="k"&gt;without&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;docker&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;--&lt;/span&gt;&lt;span class="n"&gt;threads&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;h&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;--help Show usage.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;なお、自前のfastq filesからの実行はv1.1で載せようと思っています。また、出力はscaled TPMを採用。(Soneson, C., Love, M. I. &amp;amp; Robinson, M. D. Differential analyses for RNA-seq: transcript-level estimates improve gene-level inferences. F1000Research 4, 1521 (2015).)。&lt;/p&gt;
&lt;h2&gt;pipelineの構成&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;fasterq-dump : シーケンスデータの取得&lt;/li&gt;
&lt;li&gt;fastqc : QC&lt;/li&gt;
&lt;li&gt;trim-galore : トリミング&lt;/li&gt;
&lt;li&gt;salmon : RNA定量&lt;/li&gt;
&lt;li&gt;multiqc : QCログの回収、可視化&lt;/li&gt;
&lt;li&gt;tximport : 遺伝子テーブルの生成&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;となっています。各ツールの説明は省きますが、今時のツールの選定になっていると思います。&lt;/p&gt;
&lt;h2&gt;idep&lt;/h2&gt;
&lt;p&gt;本ツールは&lt;a href="http://bioinformatics.sdstate.edu/idep/"&gt;idep&lt;/a&gt;を意識した設計になっています。idepはRNA-seqの解析をinteractiveに行えるプラットフォームで、Differential expressed genes(DEGs)の検出だけではなく、遺伝子、サンプルのクラスタリング、パスウェイ解析、可視化などが行えます。idepについては以下がとても参考になります。&lt;/p&gt;
&lt;p&gt;&lt;a href="http://kazumaxneo.hatenablog.com/entry/2018/12/29/153838"&gt;macでインフォマティクス : インタラクティブなRNA seq解析webアプリケーション iDEP&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="2" src="{attach}images/original_rnaseq_pipeline_figs/screenshot-from-2019-03-19-23-14-31.png"&gt;&lt;/p&gt;
&lt;h2&gt;githubを用いたチーム開発&lt;/h2&gt;
&lt;p&gt;今回、githubを用いてチーム開発を行いました。githubはエンジニアの間では当たり前のツールで、チームでのソフト開発によく用いられます。bioinformatics界隈でチーム開発を経験できることは意外に少なく、非常にいい経験になりました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="3" src="{attach}images/original_rnaseq_pipeline_figs/ikra_git.png"&gt;&lt;/p&gt;
&lt;p&gt;雑多にはなりましたが、阪医Python会bioinformaticsチームの成果をアナウンスさせていただきました。完成までには3ヶ月ほどを要し、各人のアイデアや努力が詰まっております。今後もどんどん開発を進めていこうと思います。また、皆様のissue, Pull Requestもお待ちしております。&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Enjoy bioinformatics life!&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="4" src="{attach}images/original_rnaseq_pipeline_figs/ios-e381aee794bbe5838f.jpg"&gt;&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Bioinformatics"></category></entry><entry><title>JuliaとPythonと競技プログラミング</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/03/julia_python_competition.html" rel="alternate"></link><published>2019-03-16T00:00:00+09:00</published><updated>2019-03-21T00:00:00+09:00</updated><author><name>小川</name></author><id>tag:None,2019-03-16:/previews/refs/heads/general/jinja2_version/blog/2019/03/julia_python_competition.html</id><summary type="html">&lt;p&gt;最近友人と話していてJulia (&lt;a href="https://julialang.org"&gt;https://julialang.org&lt;/a&gt;)が話題になったことがあったので、少しだけ調べて試してみた話。&lt;/p&gt;
&lt;h2&gt;Juliaってなに？&lt;/h2&gt;
&lt;p&gt;Pythonのような動的型付けのスクリプト言語です。実行時にコン …&lt;/p&gt;</summary><content type="html">&lt;p&gt;最近友人と話していてJulia (&lt;a href="https://julialang.org"&gt;https://julialang.org&lt;/a&gt;)が話題になったことがあったので、少しだけ調べて試してみた話。&lt;/p&gt;
&lt;h2&gt;Juliaってなに？&lt;/h2&gt;
&lt;p&gt;Pythonのような動的型付けのスクリプト言語です。実行時にコンパイルを行いC言語にも迫る実行速度、科学技術系の数値計算もどんと来い、という触れ込みで、人気上昇中らしいです。Pythonを含む他言語のライブラリを読み込む仕組みを備えているのもすごいところ。&lt;br&gt;
&lt;s&gt;ただ、コードの見た目が激しくMatlab風味で思わず目を背けたくなります。&lt;/s&gt;&lt;/p&gt;
&lt;h2&gt;AtCoderでのJulia&lt;/h2&gt;
&lt;p&gt;ご多分に漏れず、実行速度に惹かれました。半年ほど前から参加している競技プログラミングサイト&lt;strong&gt;AtCoder&lt;/strong&gt; (&lt;a href="https://atcoder.jp"&gt;https://atcoder.jp&lt;/a&gt;)で、常用しているPython（← Python会だからね！）で実行時間切れ、C/C++に書き換えると正答、という経験を何度かしてきたので。&lt;/p&gt;
&lt;p&gt;そういうわけで、ここでは最近の&lt;strong&gt;第121回 AtCoder Beginner Contest (ABC121)&lt;/strong&gt; (&lt;a href="https://atcoder.jp/contests/abc121/"&gt;https://atcoder.jp/contests/abc121/&lt;/a&gt;)の問題で、Juliaのパフォーマンスを実際に見てみます。&lt;br&gt;
（言語知識0から数十分調べて書いたコードのため、動きはするが思わぬところで非効率、ということはあるかもしれません。）&lt;/p&gt;
&lt;h3&gt;AtCoder Beginner Contest 121 問題A "White Cells"&lt;/h3&gt;
&lt;p&gt;（問題はこちら → &lt;a href="https://atcoder.jp/contests/abc121/tasks/abc121_a"&gt;https://atcoder.jp/contests/abc121/tasks/abc121_a&lt;/a&gt;）&lt;/p&gt;
&lt;p&gt;入力値4個を読み込んで簡単な演算結果を返すだけの問題です。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c"&gt;# ABC121-A &amp;quot;White Cells&amp;quot; in Julia&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;inpl&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;readline&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;H&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;W&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;inpl&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;h&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;w&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;inpl&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;println&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;H&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;h&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;W&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;w&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;所要時間が入力にほぼ依存しない問題ですが、、各言語でのAtCoder上実行結果。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style="text-align: center;"&gt;言語&lt;/th&gt;
&lt;th style="text-align: right;"&gt;実行時間&lt;/th&gt;
&lt;th style="text-align: right;"&gt;消費メモリ&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style="text-align: center;"&gt;&lt;strong&gt;Julia&lt;/strong&gt;&lt;/td&gt;
&lt;td style="text-align: right;"&gt;&lt;strong&gt;360 ms&lt;/strong&gt;&lt;/td&gt;
&lt;td style="text-align: right;"&gt;&lt;strong&gt;110 MB&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: center;"&gt;PyPy3&lt;/td&gt;
&lt;td style="text-align: right;"&gt;180 ms&lt;/td&gt;
&lt;td style="text-align: right;"&gt;40 MB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: center;"&gt;Python3&lt;/td&gt;
&lt;td style="text-align: right;"&gt;17 ms&lt;/td&gt;
&lt;td style="text-align: right;"&gt;3 MB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: center;"&gt;C++&lt;/td&gt;
&lt;td style="text-align: right;"&gt;1 ms&lt;/td&gt;
&lt;td style="text-align: right;"&gt;256 kB&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;C++にもPythonにも、実行時間と消費メモリ双方で惨敗。 &lt;br&gt;
おそらくですが、&lt;strong&gt;実行ごとにまずコンパイルを行う&lt;/strong&gt;ので、簡単な問題だとそれが相対的に巨大なオーバーヘッドになってしまうようです。&lt;br&gt;
Pythonの半コンパイラ型実装であるPyPyはJuliaの半分程度でした。&lt;/p&gt;
&lt;!---

### AtCoder Beginner Contest 121-B

問題はこちら → &lt;https://atcoder.jp/contests/abc121/tasks/abc121_b&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c"&gt;# ABC121-B by Julia&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;inpl&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;readline&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;M&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;inpl&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;B&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;Array&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="p"&gt;}(&lt;/span&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;M&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;inpl&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;ans&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;B&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;C&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;ans&lt;/span&gt;&lt;span class="o"&gt;+=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="k"&gt;end&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;println&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ans&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;



---&gt;

&lt;h3&gt;AtCoder Beginner Contest 121 問題C "Energy Drink Collector"&lt;/h3&gt;
&lt;p&gt;（問題はこちら → &lt;a href="https://atcoder.jp/contests/abc121/tasks/abc121_c"&gt;https://atcoder.jp/contests/abc121/tasks/abc121_c&lt;/a&gt;）&lt;/p&gt;
&lt;p&gt;読み込んだ値の列をソートして、条件判定をしながら順番に足し上げていく問題。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c"&gt;# ABC121-C &amp;quot;Energy Drink Collector&amp;quot; in Julia&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;inpl&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;readline&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;M&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;inpl&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;Array&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="p"&gt;}(&lt;/span&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;inpl&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;sortrows&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;by&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;ans&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;M&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;ans&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;+=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;M&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;break&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;M&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;ans&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;+=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="k"&gt;end&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;println&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ans&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;なんと、テスト16個中15個でタイムアウト（2000ms以上）。。。&lt;/p&gt;
&lt;p&gt;Pythonのコードはこちら：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# ABC121-C &amp;quot;Energy Drink Collector&amp;quot; in Python3&lt;/span&gt;
&lt;span class="n"&gt;inpl&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;lambda&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nb"&gt;input&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;
&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;M&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;inpl&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;A&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
  &lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;inpl&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sort&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;lambda&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;span class="n"&gt;ans&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
  &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;=&lt;/span&gt; &lt;span class="n"&gt;M&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;ans&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;M&lt;/span&gt;
    &lt;span class="k"&gt;break&lt;/span&gt;
  &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;M&lt;/span&gt; &lt;span class="o"&gt;-=&lt;/span&gt; &lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="n"&gt;ans&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ans&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;こちらは最大466msでクリア（同一コードのPyPy3では733ms）。ここで134msのテストもJuliaではタイムアウト。悲しい。&lt;/p&gt;
&lt;p&gt;今回Juliaでタイムアウトになったのは、言語の特性や正しいコーディングの仕方を知らないから、という可能性は高いです。ただ実際にこの問題でJuliaを使って提出されている答案は、最速クリアのものでも1724ms（そもそもJuliaでの提出数自体が少ないですが）。やはり上の安直なPythonコードが圧勝しています。&lt;/p&gt;
&lt;h2&gt;Juliaは競技プログラミングに向かない？&lt;/h2&gt;
&lt;p&gt;Juliaの実行速度が速いこと自体は（今回検証していませんが、きっと）本当なんだと思います。しかしそれは時間のかかる複雑・大規模な処理の場合であって、競技プログラミングのような高々2-3秒の計算にはコンパイルのオーバーヘッドがやはり大きいのかな、という印象です。  &lt;/p&gt;
&lt;p&gt;AtCoderなどでは、C++などのあからさまなコンパイル型言語はコンパイル時間が実行時間に算入されず、一方でJuliaに対しては算入されます。やや理不尽な感じはしなくもないけれど、このルール下でJuliaの高速性能を生かすことは（あくまでAtCoderのような短時間型競技プログラミングの話ですが）なかなか難しそう。残念ながら、普通にやるとPythonよりもずっと遅い。  &lt;/p&gt;
&lt;p&gt;なので、当面の競技プログラミング用言語は&lt;strong&gt;やっぱりPython&lt;/strong&gt;（とC/C++）、と個人的には結論づけたところです。おしまい。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&amp;lt; History &amp;gt;&lt;/strong&gt;&lt;br&gt;
2019.03.21 ver1.0&lt;br&gt;
2019.03.21 ver1.1 微修正、PyPy3の成績を追記&lt;br&gt;
2019.03.21 ver1.2 JuliaとPythonのコードが対応するよう修正&lt;/p&gt;</content><category term="技術ブログ"></category><category term="競技プログラミング"></category><category term="その他言語"></category></entry><entry><title>Bioinformatics春合宿@三島</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/03/mishima.html" rel="alternate"></link><published>2019-03-10T00:00:00+09:00</published><updated>2019-03-10T00:00:00+09:00</updated><author><name>安水</name></author><id>tag:None,2019-03-10:/previews/refs/heads/general/jinja2_version/blog/2019/03/mishima.html</id><summary type="html">&lt;p&gt;平岡と安水は2019/03/04-09の一週間、静岡県三島市の国立遺伝学研究所にある&lt;a href="https://dbcls.rois.ac.jp/"&gt;DBCLS&lt;/a&gt;にてbioinformatics合宿をしていました。定量、アセンブリを始めとするトランスクリ …&lt;/p&gt;</summary><content type="html">&lt;p&gt;平岡と安水は2019/03/04-09の一週間、静岡県三島市の国立遺伝学研究所にある&lt;a href="https://dbcls.rois.ac.jp/"&gt;DBCLS&lt;/a&gt;にてbioinformatics合宿をしていました。定量、アセンブリを始めとするトランスクリプトーム解析やjuliaの入門、データベースのコツなど、たくさんのことを学びました。bioinformatics意外にも、坊農さんのグルメツアーや温泉、富士山など、季節ならではの三島を堪能することができました。詳しくは以下の日誌をご覧ください。&lt;/p&gt;
&lt;h3&gt;平岡&lt;/h3&gt;
&lt;p&gt;&lt;a href="https://github.com/yuna06/mishima2019/blob/master/README.md"&gt;mishima2019&lt;/a&gt;
 &lt;/p&gt;
&lt;h3&gt;安水&lt;/h3&gt;
&lt;p&gt;&lt;a href="https://github.com/yyoshiaki/mishima_gassyuku/blob/master/README.md"&gt;三島合宿日誌&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;最後に、合宿を快諾いただいた坊農さんはじめ、仲里さん、内藤さん、小野さん、大田さんには心よりお礼申し上げます。生涯忘れることない、大切な経験になりました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}images/mishima_figs/img_8242.jpg"&gt;&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Bioinformatics"></category></entry><entry><title>Mockinbirdを用いたPAR-CLIP解析</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/01/mockinbird_parclip.html" rel="alternate"></link><published>2019-01-18T00:00:00+09:00</published><updated>2019-01-18T00:00:00+09:00</updated><author><name>平岡</name></author><id>tag:None,2019-01-18:/previews/refs/heads/general/jinja2_version/blog/2019/01/mockinbird_parclip.html</id><summary type="html">&lt;p&gt;今回は &lt;strong&gt;PAR-CLIP&lt;/strong&gt; 解析のAll-in-oneパイプラインソフトウェアである、&lt;a href="http://wwwuser.gwdg.de/~compbiol/mockinbird/doc/intro.html"&gt;Mockinbird&lt;/a&gt;を紹介します。日本語での情報がほぼなく、説明が長くなってしまいそうなので、２回に分けて書きます。&lt;/p&gt;
&lt;h2&gt;PAR-CLIPって何？&lt;/h2&gt;
&lt;p&gt;PAR-CLIPは photoactivatable ribonucleoside-enhanced crosslinking and …&lt;/p&gt;</summary><content type="html">&lt;p&gt;今回は &lt;strong&gt;PAR-CLIP&lt;/strong&gt; 解析のAll-in-oneパイプラインソフトウェアである、&lt;a href="http://wwwuser.gwdg.de/~compbiol/mockinbird/doc/intro.html"&gt;Mockinbird&lt;/a&gt;を紹介します。日本語での情報がほぼなく、説明が長くなってしまいそうなので、２回に分けて書きます。&lt;/p&gt;
&lt;h2&gt;PAR-CLIPって何？&lt;/h2&gt;
&lt;p&gt;PAR-CLIPは photoactivatable ribonucleoside-enhanced crosslinking and immunoprecipitation の略でRNAやmicroRNA結合タンパクの結合サイトを特定するために使います。&lt;/p&gt;
&lt;p&gt;実験法としては、まず4SU（4-チオウリジン）を細胞培地中に添加し、4SUによるラベル標識を行います。次にUVの照射を行い、RNA結合タンパクとRNAの間で架橋反応を起こします。その後、RBPと結合したリードの抽出を行い、サンプルとして用います。&lt;/p&gt;
&lt;p&gt;サンプルRNAを逆転写するときに、4SUがシトシン( C )に置換されます(misread)。そのため、リードがピークを形成し、かつT -&amp;gt; C置換が入っていた場合、RBPと結合していた可能性が高いということになります。これによりあるタンパクが、RNAのどの領域に結合するのか？結合領域間でどのような相互作用があるのかを知ることができます。特に一塩基という高い解像度での解析ができることが特徴です。&lt;/p&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}images/mockinbird_parclip_figs/hits-clip-clip-seq-ptb-seq.png"&gt;&lt;/p&gt;
&lt;h2&gt;Mockinbirdとは？&lt;/h2&gt;
&lt;p&gt;&lt;a href="//wwwuser.gwdg.de/~compbiol/mockinbird/doc/intro.html”"&gt;公式ドキュメント&lt;/a&gt;、&lt;a href="//github.com/soedinglab/mockinbird)”"&gt;GitHub&lt;/a&gt;に詳細は記載されていますが、日本語での情報が少ない、というか全くない。のでまとめていきたいと思います。&lt;/p&gt;
&lt;p&gt;PAR-CLIPの解析は生のFASTQデータから、Quality Check -&amp;gt; Trimming -&amp;gt; Mapping -&amp;gt; Downstream Analysisという流れで行いますが、それらすべての解析をMockinbirdでは一気に行ってくれます。また、MockinbirdModule（詳細は後述）を使うことでmock PAR-CLIP experimentを考慮に入れた解析を行うことができるのも大きな特徴です。&lt;/p&gt;
&lt;p&gt;このソフトでは、２つにパイプラインが分かれており、preprocessing phaseとpostprocessing phaseと呼ばれています。タンパク結合サイトの情報が書かれたテーブルを出力するまでが、preprocessing phaseでそれ以降のDownstream解析をpostprocessing phaseと呼んでいます。それぞれにYAMLファイルが用意されており、ユーザーはYAMLファイルで解析したいサンプルデータ、使いたいリファレンスデータ、使いたいモジュール（Mappingの時にSTARやBowtieを選べたりする。）閾値などのパラメータを指定します。最後にコマンドを一行実行するだけで、解析がすべて自動で流れていきます。あるモジュールで出力されたファイルのパスが次のモジュールに自動で設定されていくシステムになっているので、慣れると非常に便利です。&lt;/p&gt;
&lt;p&gt;ただ、ドキュメントでも、既存の解析手法に完全に取って代わるものではなく、PAR-CLIP実験のコンディションのトラブルシューティングを再現可能性が高い状態で行なったり、研究の最初の仮説づくりを短時間で行うために使ってもらうことが目的と書かれていました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="2" src="{attach}images/mockinbird_parclip_figs/library.png"&gt;&lt;/p&gt;
&lt;h2&gt;環境構築&lt;/h2&gt;
&lt;p&gt;前置きが長くなりましたが、実際に環境構築から進めていきます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;conda create -n mockinbird -c bioconda -c conda-forge &lt;span class="nv"&gt;python&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;.6 mockinbird
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Anacondaでmockinbirdという名前の仮想環境を作ります。mockinbirdが仮想環境にインストールされることになり、これにより、下記のライブラリとツールが環境内で使えるようになります。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nb"&gt;source&lt;/span&gt; activate mockinbird
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;でmockinbirdの仮想環境を立ち上げ、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nb"&gt;source&lt;/span&gt; deactivate mockinbird
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;で仮想環境を閉じます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;conda remove --all -n mockinbird
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;で環境を削除します。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;git clone https://github.com/soedinglab/mockinbird.git
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;でgithubからクローンします。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; mockinbird/mockinbird/data
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;とディレクトリを進めていくと、&lt;code&gt;preprocess.yaml&lt;/code&gt;, &lt;code&gt;postprocess.yaml&lt;/code&gt;というファイルがあります。基本はこの二つのYAMLファイルを調整していくことになります。terminalでコマンドを出すときも &lt;code&gt;mockinbird/mockinbird/data&lt;/code&gt;ディレクトリで実行するのが個人的にはおすすめです（ファイルの構成が綺麗になる。パスの調整も楽）。&lt;/p&gt;
&lt;p&gt;&lt;a href="http://wwwuser.gwdg.de/~compbiol/mockinbird/doc/getting_started.html#tutorial"&gt;Tutorialデータ&lt;/a&gt;がドキュメントの方に書かれていましたが、私が見たときはリンクがNotFoundになっていました。ので、私は&lt;a href="http://wwwuser.gwdg.de/~compbiol/mockinbird/doc/"&gt;公式ドキュメント&lt;/a&gt;や&lt;a href="https://github.com/soedinglab/mockinbird"&gt;GitHub&lt;/a&gt;を参考にYAMLファイルの調整などを行いました。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;preprocess&lt;/code&gt;, &lt;code&gt;postprocess&lt;/code&gt;の実行のコードは以下のようになっています。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# mockinbird preprocess [parclip_fastq] [output_dir] [prefix] [config_file]&lt;/span&gt;
$ mockinbird preprocess nrd1.fastq nrd1 nrd1 preprocess.yaml

&lt;span class="c1"&gt;# mockinbird postprocess {{genomefasta}} {{output_dir}} {{output_dir}} {{script_dir}}&lt;/span&gt;
$ mockinbird postprocess nrd1 nrd1_pp postprocess.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;ですが、コードの実行はYAMLの設定ができてからになります。ということでYAMLの中身について説明していきます。&lt;/p&gt;
&lt;h3&gt;preprocess.yaml&lt;/h3&gt;
&lt;p&gt;preprocess.yamlの４つの区画から構成されています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;① 変数設定。&lt;/li&gt;
&lt;li&gt;② general. 必須情報の設定。&lt;/li&gt;
&lt;li&gt;③ reads. リードについての情報。&lt;/li&gt;
&lt;li&gt;④ pipeline. 使うモジュールと各引数の設定。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;① 変数設定
下記のコードはドキュメントから引用していますが、モジュールで使う、ディレクトリの変数化と、mock_processing をFalseに設定しています。（ここ重要！）&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="p p-Indicator"&gt;{&lt;/span&gt;&lt;span class="err"&gt;%&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;set data_dir = &amp;quot;data&amp;quot; %&lt;/span&gt;&lt;span class="p p-Indicator"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;{&lt;/span&gt;&lt;span class="err"&gt;%&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;set genome_fasta = data_dir + &amp;quot;/genome.fa&amp;quot; %&lt;/span&gt;&lt;span class="p p-Indicator"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p p-Indicator"&gt;{&lt;/span&gt;&lt;span class="err"&gt;%&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;set mock_pileup = data_dir + &amp;quot;/mock.mpileup&amp;quot; %&lt;/span&gt;&lt;span class="p p-Indicator"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p p-Indicator"&gt;{&lt;/span&gt;&lt;span class="err"&gt;%&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;set mock_statistics = data_dir + &amp;quot;/mock_stat.json&amp;quot; %&lt;/span&gt;&lt;span class="p p-Indicator"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p p-Indicator"&gt;{&lt;/span&gt;&lt;span class="err"&gt;%&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;set norm_pileup = data_dir + &amp;quot;/normalization.mpileup&amp;quot; %&lt;/span&gt;&lt;span class="p p-Indicator"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p p-Indicator"&gt;{&lt;/span&gt;&lt;span class="err"&gt;%&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;set bowtie_index = data_dir + &amp;quot;/bowtie_index/genome&amp;quot; %&lt;/span&gt;&lt;span class="p p-Indicator"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="c1"&gt;# setting mock_processing to True will only process the mock. Setting to `False` will run the full&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="c1"&gt;# pipeline&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p p-Indicator"&gt;{&lt;/span&gt;&lt;span class="err"&gt;%&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;set mock_processing = False %&lt;/span&gt;&lt;span class="p p-Indicator"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;② general. 必須情報の設定
アダプター配列の指定、リファレンスデータの指定、UMI(Unique molecular identifiers)の有無、スレッド数の指定。&lt;/p&gt;
&lt;p&gt;③ reads. リードについての情報
リードの最短長、T -&amp;gt; C mutationの指定&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nt"&gt;general&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;adapter5prime&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;GTTCAGAGTTCTACAGTCCGACGATC&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;adapter3prime&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;TGGAATTCTCGGGTGCCAAGG&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;genomefasta&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p p-Indicator"&gt;{{&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;genome_fasta&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p p-Indicator"&gt;}}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;normalization_pileup&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p p-Indicator"&gt;{{&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;norm_pileup&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p p-Indicator"&gt;}}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;rmTemp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;yes&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;n_threads&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;4&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="nt"&gt;reads&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;bc_5prime&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;5&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;bc_3prime&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;0&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;min_len&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;20&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;reference_nucleotide&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;T&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;mutation_nucleotide&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;C&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;④ pipeline. 使うモジュールと各引数の設定
クオリティチェック -&amp;gt; トリミング -&amp;gt; マッピング&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="x"&gt;pipeline:&lt;/span&gt;
&lt;span class="x"&gt;  - FastQCModule:&lt;/span&gt;
&lt;span class="x"&gt;      outdir_name: fastQC_raw&lt;/span&gt;

&lt;span class="x"&gt;  - UmiToolsExtractModule&lt;/span&gt;

&lt;span class="x"&gt;  - SkewerAdapterClippingModule&lt;/span&gt;

&lt;span class="x"&gt;  - ClippyAdapterClippingModule:&lt;/span&gt;
&lt;span class="x"&gt;      clipped_5prime_bc: True&lt;/span&gt;

&lt;span class="x"&gt;  - FastQCModule:&lt;/span&gt;
&lt;span class="x"&gt;      outdir_name: fastQC_clipped&lt;/span&gt;
&lt;span class="x"&gt;      genome_index: &lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;bowtie_index&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;

&lt;span class="x"&gt;  - BamPPModule:&lt;/span&gt;
&lt;span class="x"&gt;      remove_n_edge_mut: 2&lt;/span&gt;
&lt;span class="x"&gt;      max_mut_per_read: 1&lt;/span&gt;
&lt;span class="x"&gt;      min_mismatch_quality: 20&lt;/span&gt;

&lt;span class="x"&gt;  - SortIndexModule:&lt;/span&gt;
&lt;span class="x"&gt;     keep_all: yes&lt;/span&gt;

&lt;span class="x"&gt;  - UmiToolsDedupModule&lt;/span&gt;

&lt;span class="x"&gt;  - SortIndexModule:&lt;/span&gt;
&lt;span class="x"&gt;     keep_all: yes&lt;/span&gt;

&lt;span class="x"&gt;  - PileupModule:&lt;/span&gt;
&lt;span class="x"&gt;     keep_all: yes&lt;/span&gt;

&lt;span class="x"&gt;  - BamStatisticsModule&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;MockinbirdModuleを使うことでmock PAR-CLIP experimentを考慮に入れた解析ができますと、すでに書きましたが、Mock Experimentの結果をバックグラウンドとして処理して、PAR-CLIP Experimentの結果を出すことができます。&lt;/p&gt;
&lt;p&gt;具体的な方法としては、まず
&lt;code&gt;mock_processing = True&lt;/code&gt;とし、
&lt;code&gt;mockinbird preprocess nrd1_mock.fastq nrd1_mock nrd1_mock preprocess.yaml&lt;/code&gt;を実行します。これで&lt;code&gt;{% if not mock_processing %}&lt;/code&gt;までで解析がストップします。&lt;/p&gt;
&lt;p&gt;PileupModule, BamStatisticsModuleによって、Mock Experimentの.mpileupファイルと_stat.jsonファイルがそれぞれ生成されます。（この二つのファイルを次に使うことになります。）&lt;/p&gt;
&lt;p&gt;次に&lt;code&gt;mock_processing = False&lt;/code&gt;に戻し、
&lt;code&gt;$ mockinbird preprocess nrd1.fastq nrd1 nrd1 preprocess.yaml&lt;/code&gt;を実行します。すると下記のコードも一緒に実行されます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="k"&gt;not&lt;/span&gt; &lt;span class="nv"&gt;mock_processing&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;

&lt;span class="x"&gt;    - PredictionSitesModule:&lt;/span&gt;
&lt;span class="x"&gt;        sites_file: &lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;data_dir&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;/genome.sites&lt;/span&gt;
&lt;span class="x"&gt;        fasta_file: &lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;genome_fasta&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;        transition_nucleotide: T&lt;/span&gt;

&lt;span class="x"&gt;    - MockTableModule:&lt;/span&gt;
&lt;span class="x"&gt;        mock_table: &lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;data_dir&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;/mock.table&lt;/span&gt;
&lt;span class="x"&gt;        mock_pileup: &lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;mock_pileup&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;

&lt;span class="x"&gt;    - TransitionTableModule&lt;/span&gt;

&lt;span class="x"&gt;    - LearnMockModule:&lt;/span&gt;
&lt;span class="x"&gt;        mock_model: mock_model/model.pkl&lt;/span&gt;
&lt;span class="x"&gt;        mock_statistics: &lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;mock_statistics&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;        n_mixture_components: 5&lt;/span&gt;
&lt;span class="x"&gt;        em_iterations: 250&lt;/span&gt;

&lt;span class="x"&gt;    - MockinbirdModule&lt;/span&gt;

&lt;span class="x"&gt;    - NormalizationModule&lt;/span&gt;
&lt;span class="x"&gt;    - QuantileCapModule&lt;/span&gt;
&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;endif&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;これによって、Mock Experimentの&lt;code&gt;.mpileupファイル&lt;/code&gt;と&lt;code&gt;_stat.jsonファイル&lt;/code&gt;を受け取りつつ、最終的なCLIP-seqのテーブルを作ることができ、preprocessは終了となります。下記のようなテーブルが出力され、これをもとにpostprocessに進んでいくことになります。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;seqid   position        transitions     coverage        score   strand  occupancy       posterior
chrI    32601   4       4       6.352710158543762       -       0.15384615384615385     0.772109761967
chrI    35562   4       5       5.292152965717071       +       0.0223463687150838      0.539841709238
chrI    35805   5       5       9.376254703871467       +       0.03184713375796178     0.98585024515
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;長くなってしまったので、モジュールとpostprocessの説明は次回に回したいと思います。長い間お付き合いいただきありがとうございました。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Bioinformatics"></category></entry><entry><title>Pythonで可視化入門</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/01/python_visualization.html" rel="alternate"></link><published>2019-01-18T00:00:00+09:00</published><updated>2019-01-18T00:00:00+09:00</updated><author><name>宮崎</name></author><id>tag:None,2019-01-18:/previews/refs/heads/general/jinja2_version/blog/2019/01/python_visualization.html</id><summary type="html">&lt;p&gt;Pythonでいい感じのグラフを書いてみたい！でも面倒！よくわからない！&lt;/p&gt;
&lt;p&gt;これを読めばそんなあなたも簡単にいい感じのグラフがかける！&lt;/p&gt;
&lt;p&gt;この記事では、Pythonのライブラリである、定番の …&lt;/p&gt;</summary><content type="html">&lt;p&gt;Pythonでいい感じのグラフを書いてみたい！でも面倒！よくわからない！&lt;/p&gt;
&lt;p&gt;これを読めばそんなあなたも簡単にいい感じのグラフがかける！&lt;/p&gt;
&lt;p&gt;この記事では、Pythonのライブラリである、定番のmatplotlibとseaborn、pandasを使った可視化、インタラクティブなplotly、複数グラフ表示が簡単にできるラッパーであるholoviewsの簡単な解説をします。&lt;/p&gt;
&lt;h2&gt;Pythonの可視化ライブラリ&lt;/h2&gt;
&lt;h3&gt;matplotlib：&lt;u&gt;&lt;a href="https://seaborn.pydata.org/"&gt;https://matplotlib.org/&lt;/a&gt;&lt;/u&gt;(公式)&lt;/h3&gt;
&lt;p&gt;定番のmatplotlibです。まずはギャラリー ( &lt;u&gt;&lt;a href="https://matplotlib.org/gallery/index.html"&gt;https://matplotlib.org/gallery/index.html&lt;/a&gt;&lt;/u&gt;)でいろいろなグラフを見てみましょう。グラフがたくさん並んでいて楽しいですね！&lt;/p&gt;
&lt;h3&gt;seaborn：&lt;u&gt;&lt;a href="https://seaborn.pydata.org/"&gt;https://seaborn.pydata.org/&lt;/a&gt;&lt;/u&gt;(公式)&lt;/h3&gt;
&lt;p&gt;matplotlibをベースにしたseabornです。こちらもギャラリー(&lt;u&gt;&lt;a href="https://seaborn.pydata.org/examples/index.html"&gt;https://seaborn.pydata.org/examples/index.htm&lt;/a&gt;&lt;a href="https://seaborn.pydata.org/examples/index.html"&gt;l&lt;/a&gt;&lt;/u&gt;)を見てみましょう。ヒートマップがおしゃれですね！&lt;/p&gt;
&lt;h3&gt;pandas：&lt;u&gt;&lt;a href="https://pandas.pydata.org/index.html"&gt;https://pandas.pydata.org/index.html&lt;/a&gt;&lt;/u&gt;(公式)&lt;/h3&gt;
&lt;p&gt;表計算で便利なpandasです。DataFrame形式のデータをpandas.DataFrame.plot(&lt;u&gt;&lt;a href="http://pandas.pydata.org/pandas-docs/stable/visualization.html"&gt;http://pandas.pydata.org/pandas-docs/stable/visualization.html&lt;/a&gt;&lt;/u&gt;)でグラフを書くのが一番手間がかからない気がします。bar(棒グラフ)やhistogramやscatter(散布図)を作るならこれで十分なことが多いです。DataFrameの.describe (&lt;u&gt;&lt;a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.describe.html"&gt;https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.describe.html&lt;/a&gt;&lt;/u&gt;)で統計量が簡単に計算できるので、グラフがあっているかの確認も一連の流れでできます。&lt;/p&gt;
&lt;h3&gt;plotly：&lt;u&gt;&lt;a href="https://plot.ly/"&gt;https://plot.ly/&lt;/a&gt;&lt;/u&gt;(公式)&lt;/h3&gt;
&lt;p&gt;インタラクティブに動かせるplotlyです。&lt;u&gt;&lt;a href="https://plot.ly/python/"&gt;https://plot.ly/python/&lt;/a&gt;&lt;/u&gt;(Python用) を見てみると、なんとグラフを動かせます！楽しい！Kaggleでもよく見ます。データ構造を調べるのに便利だからかもしれないですね。(例&lt;u&gt;&lt;a href="https://www.kaggle.com/andresionek/what-makes-a-kaggler-valuable?utm_medium=social&amp;amp;utm_source=twitter.com&amp;amp;utm_campaign=Weekly-Kernel-Awards"&gt;https://www.kaggle.com/andresionek/what-makes-a-kaggler-valuable?utm_medium=social&amp;amp;utm_source=twitter.com&amp;amp;utm_campaign=Weekly-Kernel-Awards&lt;/a&gt;&lt;/u&gt;) Dashと組み合わせると ( &lt;u&gt;&lt;a href="https://plot.ly/products/dash/"&gt;https://plot.ly/products/dash/&lt;/a&gt;&lt;/u&gt;) 簡単にWebアプリにできます。&lt;/p&gt;
&lt;h3&gt;holoview：&lt;u&gt;&lt;a href="http://holoviews.org/"&gt;http://holoviews.org/&lt;/a&gt;&lt;/u&gt;(公式)&lt;/h3&gt;
&lt;p&gt;Pythonの可視化ツールはHoloViewsが標準になるかもしれない(&lt;u&gt;&lt;a href="https://qiita.com/driller/items/53be86cea3c3201e7e0f"&gt;https://qiita.com/driller/items/53be86cea3c3201e7e0f&lt;/a&gt;&lt;/u&gt;)とまで言われるholoviewは、matplotlibやplotly、bokehを簡単に使えるようにするラッパーです。特筆すべき機能として、introduction(&lt;u&gt;&lt;a href="http://holoviews.org/getting_started/Introduction.html"&gt;http://holoviews.org/getting_started/Introduction.html&lt;/a&gt;&lt;/u&gt;)をみるとわかるのですが、複数グラフ表示は足し算(例：&lt;code&gt;Compositional Layouts layout =scatter +hv.Histogram&lt;/code&gt;)、オーバーレイは掛け算(例：&lt;code&gt;Compositional Overlays image +image*points&lt;/code&gt;)で定義できとてもシンプルに書くことができます。&lt;/p&gt;
&lt;p&gt;可視化のまとめ(kaggle：&lt;u&gt;&lt;a href="https://www.kaggle.com/maheshdadhich/strength-of-visualization-python-visuals-tutorial"&gt;https://www.kaggle.com/maheshdadhich/strength-of-visualization-python-visuals-tutorial&lt;/a&gt;&lt;/u&gt;)もよくまとまっていて非常に勉強になります。&lt;/p&gt;
&lt;p&gt;そのほかにも、tensorflowの embedding &lt;u&gt;&lt;a href="https://www.tensorflow.org/guide/embedding"&gt;https://www.tensorflow.org/guide/embedding&lt;/a&gt;&lt;/u&gt;から Mnist や Word2Vecのデモ &lt;u&gt;&lt;a href="http://projector.tensorflow.org/"&gt;http://projector.tensorflow.org/&lt;/a&gt;&lt;/u&gt;(重いかも) や &lt;u&gt;&lt;a href="https://distill.pub/"&gt;https://distill.pub/&lt;/a&gt;&lt;/u&gt;も動かしてみると楽しいです！&lt;/p&gt;
&lt;h2&gt;まとめ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;holoview最強説(plotlyも使えるラッパーなので)&lt;/li&gt;
&lt;li&gt;楽にしたいならpandasのplot、動かしたければplotly！&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;keywordでググると詳しい記事がたくさん出てきます。上記以外の可視化手法や面白いものあれば教えてください！&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Python"></category></entry><entry><title>Twitter自動投稿あれこれ</title><link href="/previews/refs/heads/general/jinja2_version/blog/2019/01/twitter_automation.html" rel="alternate"></link><published>2019-01-18T00:00:00+09:00</published><updated>2019-01-18T00:00:00+09:00</updated><author><name>川崎</name></author><id>tag:None,2019-01-18:/previews/refs/heads/general/jinja2_version/blog/2019/01/twitter_automation.html</id><summary type="html">&lt;p&gt;突如TwitterのBotを作ってみたくなり試行錯誤した結果をまとめてみました。&lt;/p&gt;
&lt;h2&gt;きっかけ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;講義棟の音出し禁止時間を毎日6時に通知してくれるBOTが欲しい。&lt;/li&gt;
&lt;li&gt;幸い音出し禁止時間はネット上に記載されているので、毎日取得 …&lt;/li&gt;&lt;/ul&gt;</summary><content type="html">&lt;p&gt;突如TwitterのBotを作ってみたくなり試行錯誤した結果をまとめてみました。&lt;/p&gt;
&lt;h2&gt;きっかけ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;講義棟の音出し禁止時間を毎日6時に通知してくれるBOTが欲しい。&lt;/li&gt;
&lt;li&gt;幸い音出し禁止時間はネット上に記載されているので、毎日取得して呟くだけなら実装は簡単そう。&lt;/li&gt;
&lt;li&gt;何よりPython会の記事のネタになる。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Twitter APIの取得&lt;/h2&gt;
&lt;p&gt;Botを作るにはAPI （アプリケーション・プログラミング・インタフェイス）が必要です。&lt;/p&gt;
&lt;p&gt;まあアカウント作ったら一発やろーと高を括っていたのですが、最近Twitter APIの使用申請が厳格化されたらしくなんだか不安。&lt;/p&gt;
&lt;p&gt;&lt;a href="https://developer.twitter.com/"&gt;https://developer.twitter.com/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;とりあえずここにアクセスし、利用登録を進めていきます。&lt;/p&gt;
&lt;p&gt;慣れない英語を読みすすめるとどうやら必要なのが&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用用途を英語で入力(400字程度)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;大学入試以来の英作文です。&lt;/p&gt;
&lt;p&gt;しかしそんな英語力は無いので適当に文章作ってGoogle翻訳(https://translate.google.co.jp/?hl=ja)にぶち込みます。小学生並みの文章が出来上がりました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1.I decided to use the Twitter API to study programming.In order to know what many people are interested in, I would like to learn what kind of program to write. 2....&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;若干嘘が混じっている気もしますが気にしません。早速フォームに入力して送信しました。&lt;/p&gt;
&lt;p&gt;なお事前に調べた情報ではここでTwitter社からなかなか返信が返って来ず断念するケースが多いみたいです。緊張します。&lt;/p&gt;
&lt;p&gt;しかしドキドキする間もなく一瞬で申請が通りました。どうしてでしょうか。&lt;/p&gt;
&lt;p&gt;実は「chat bot」など自動化に関する単語が含まれていると検閲に引っかかりやすいらしく、婉曲表現を用いて危険なワードを巧みに回避していたのでした。下調べは大切ですね。&lt;/p&gt;
&lt;p&gt;晴れて使用権限を得たので早速使っていきます。BOT作成に必要な値は次の4つです。ログインすれば見ることができます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;CONSUMER_KEY = &amp;quot;***********************************************&amp;quot;
CONSUMER_SECRET = &amp;quot;********************************************&amp;quot;
ACCESS_TOKEN = &amp;quot;**********************************************&amp;quot;
ACCESS_TOKEN_SECRET = &amp;quot;******************************************&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;上のようにしてconfig.pyとしてまとめておくと後々楽です。&lt;/p&gt;
&lt;h2&gt;書く&lt;/h2&gt;
&lt;p&gt;事前に&lt;code&gt;pip install requests&lt;/code&gt;と&lt;code&gt;pip install requests_oauthlib&lt;/code&gt;しておきます。&lt;/p&gt;
&lt;p&gt;先ほど取得した4つのKeyはconfig.pyとして同じ階層に忘れずに置いておきます。&lt;/p&gt;
&lt;p&gt;内容は1.取ってきて 2.整形して 3.ツイートする という流れです。シンプルですね。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;requests&lt;/span&gt;　&lt;span class="c1"&gt;#スクレイピング&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;json&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nn"&gt;config&lt;/span&gt; &lt;span class="c1"&gt;#jsonモジュールとconfig.pyの読み込み&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;requests_oauthlib&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;OAuth1Session&lt;/span&gt; &lt;span class="c1"&gt;#OAuthのライブラリの読み込みURL = &amp;quot;hoge&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;UserAgent&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;huga&amp;quot;&lt;/span&gt;

&lt;span class="n"&gt;headers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;User-Agent&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;UserAgent&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;requests&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Session&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;resp&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;URL&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;headers&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;headers&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;#HTML取得&lt;/span&gt;

&lt;span class="n"&gt;lines&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;text&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# (中略)(HTMLから整形する作業)&lt;/span&gt;

&lt;span class="n"&gt;CK&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CONSUMER_KEY&lt;/span&gt;
&lt;span class="n"&gt;CS&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CONSUMER_SECRET&lt;/span&gt;
&lt;span class="n"&gt;AT&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ACCESS_TOKEN&lt;/span&gt;
&lt;span class="n"&gt;ATS&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ACCESS_TOKEN_SECRET&lt;/span&gt;
&lt;span class="n"&gt;twitter&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;OAuth1Session&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;CK&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;CS&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;AT&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ATS&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;#認証処理&lt;/span&gt;

&lt;span class="n"&gt;url&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;https://api.twitter.com/1.1/statuses/update.json&amp;quot;&lt;/span&gt;

&lt;span class="n"&gt;tweet&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="sa"&gt;u&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;おはようッピ！&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s2"&gt;月&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s2"&gt;日(&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s2"&gt;)の音出し禁止時間をお知らせするッピ！&lt;/span&gt;&lt;span class="se"&gt;\n\n&lt;/span&gt;&lt;span class="s2"&gt;『&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s2"&gt;』&lt;/span&gt;&lt;span class="se"&gt;\n\n&lt;/span&gt;&lt;span class="s2"&gt;今日も一日がんばるッピ！！&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;w&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;notify&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;params&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;status&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;tweet&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;res&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;twitter&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;post&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;params&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;#post送信&lt;/span&gt;
&lt;span class="c1"&gt;#print(tweet) #テスト表示&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;res&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;status_code&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="c1"&gt;#成功した場合&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Success.&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Failed. : &lt;/span&gt;&lt;span class="si"&gt;%d&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;res&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;status_code&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;実行結果&lt;/h2&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}images/twitter_automation_figs/picture1.png"&gt;&lt;/p&gt;
&lt;p&gt;成功です。語尾は適当です。&lt;/p&gt;
&lt;p&gt;(この後自動投稿するまでの流れがありますが締め切りが来てしまったので一旦提出します。)&lt;/p&gt;</content><category term="技術ブログ"></category><category term="自動化"></category></entry><entry><title>【論文まとめ】医師国家試験問題自動生成AI</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/12/doctor_exam_ai.html" rel="alternate"></link><published>2018-12-20T00:00:00+09:00</published><updated>2018-12-20T00:00:00+09:00</updated><author><name>秋山</name></author><id>tag:None,2018-12-20:/previews/refs/heads/general/jinja2_version/blog/2018/12/doctor_exam_ai.html</id><summary type="html">&lt;p&gt;以下の論文を軽く紹介。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Shen S, Li Y, Du N, Wu X, Xie Y, Ge S, et al.  On the Generation of Medical Question-Answer Pairs. &lt;em&gt;arXiv&lt;/em&gt;. 2018.
&lt;a href="http://arxiv.org/abs/1811.00681"&gt;http://arxiv.org/abs/1811.00681&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;概要&lt;/h2&gt;
&lt;p&gt;Tensent Mediacal AI lab Internからの論文。&lt;br&gt;
Deep learning技術により質問文に対して回答するAI (&lt;strong&gt;question answering …&lt;/strong&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;以下の論文を軽く紹介。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Shen S, Li Y, Du N, Wu X, Xie Y, Ge S, et al.  On the Generation of Medical Question-Answer Pairs. &lt;em&gt;arXiv&lt;/em&gt;. 2018.
&lt;a href="http://arxiv.org/abs/1811.00681"&gt;http://arxiv.org/abs/1811.00681&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;概要&lt;/h2&gt;
&lt;p&gt;Tensent Mediacal AI lab Internからの論文。&lt;br&gt;
Deep learning技術により質問文に対して回答するAI (&lt;strong&gt;question answering, QA&lt;/strong&gt;)が発展している。しかし、QAを医療に応用するためにはAIを学習させるためのデータが不足している。そこで質問文と解答のペアを自動生成するモデルを提案した。&lt;/p&gt;
&lt;h2&gt;手法&lt;/h2&gt;
&lt;h3&gt;Key Phrase Detector&lt;/h3&gt;
&lt;p&gt;質問文の各フレーズが解答の決め手となるキーフレーズであるかを評価する。キーフレーズであるかどうかは特定の解答に対して高頻度で質問文に出現するフレーズがキーフレーズであるとしてdetectorを学習させる。例えば「日本脳炎」が解答である場合「項部硬直」などがキーフレーズとなる。&lt;/p&gt;
&lt;h3&gt;Conditional Variational Autoencoder (CVAE)&lt;/h3&gt;
&lt;p&gt;キーフレーズは維持しつつ、それ以外のフレーズを生成モデルCVAEによって言い換える。これによって答が同じな新たな質問文が作られる。&lt;/p&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}images/doctor_exam_ai_figs/doctor_exam_ai.png"&gt;&lt;/p&gt;
&lt;h2&gt;データ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;中国医師国家試験18,798問&lt;/li&gt;
&lt;li&gt;中国のWikipedia風医療サイト ([http://xywy.com/])&lt;/li&gt;
&lt;li&gt;医学辞書19冊&lt;/li&gt;
&lt;li&gt;医学論文2,130,128本&lt;/li&gt;
&lt;li&gt;医学専門書518冊&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;実験結果&lt;/h2&gt;
&lt;p&gt;アルゴリズムによる評価、人間による評価ともにベースラインを上回った。&lt;/p&gt;
&lt;h2&gt;読んだ感想&lt;/h2&gt;
&lt;p&gt;生成された問題文の例が載ってないのですごいのかよくわからなかった。データの量はすごい。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category><category term="論文まとめ"></category></entry><entry><title>Pythonの変数と代入について</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/12/python_value.html" rel="alternate"></link><published>2018-12-20T00:00:00+09:00</published><updated>2018-12-20T00:00:00+09:00</updated><author><name>小川</name></author><id>tag:None,2018-12-20:/previews/refs/heads/general/jinja2_version/blog/2018/12/python_value.html</id><summary type="html">&lt;p&gt;Pythonの変数、ふだん何気なく使っていますが、やっていることは実は結構複雑です。主にC/C++と対比しつつ簡単にまとめてみま …&lt;/p&gt;</summary><content type="html">&lt;p&gt;Pythonの変数、ふだん何気なく使っていますが、やっていることは実は結構複雑です。主にC/C++と対比しつつ簡単にまとめてみます。&lt;/p&gt;
&lt;p&gt;実際のところ、よく知らなくてもあまり影響がない場合が殆どです。が、複雑な操作を行ったり何か変数の挙動が不審な場合などは、思い出してみるのもよさそうです。&lt;/p&gt;
&lt;h2&gt;変数は参照である&lt;/h2&gt;
&lt;p&gt;一言でいえば表題の通り。
Pythonでの&lt;strong&gt;変数への代入とは、変数の参照するメモリ（インスタンス）を切り替えること&lt;/strong&gt;であり、&lt;strong&gt;メモリの内容を書き換えることではない&lt;/strong&gt;。これが多くの言語（C/C++など）と大きく違うところです。&lt;/p&gt;
&lt;h2&gt;変数の代入(1)&lt;/h2&gt;
&lt;p&gt;例えばこんなコード。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# Python3&lt;/span&gt;
&lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  &lt;span class="c1"&gt;# 1を出力&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;C++で書き換えると、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;// C++&lt;/span&gt;
&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;cout&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;endl&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;// 1を出力&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;なのか？？
（#include\とかint main(void){...}とかは全部省略。）  &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;実は違う&lt;/strong&gt;のです。&lt;br&gt;
C++の方では&lt;code&gt;a&lt;/code&gt;で表されるメモリ領域を一つ確保し、そこにまず&lt;code&gt;0&lt;/code&gt;をセット、次に&lt;code&gt;1&lt;/code&gt;を、&lt;strong&gt;同じメモリ領域を書き換えて&lt;/strong&gt;セットしています。  &lt;/p&gt;
&lt;p&gt;Pythonの方はそうではありません。まず&lt;code&gt;0&lt;/code&gt;の値を持つメモリ領域を確保し、&lt;strong&gt;変数&lt;code&gt;a&lt;/code&gt;がそこを指すように&lt;/strong&gt;します。次に&lt;code&gt;1&lt;/code&gt;の値を持つ&lt;strong&gt;別のメモリ領域を確保&lt;/strong&gt;し、変数&lt;code&gt;a&lt;/code&gt;がそこを指すように切り替えます。&lt;/p&gt;
&lt;p&gt;C++で無理矢理それっぽいものを書くと、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;// C++&lt;/span&gt;
&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;cout&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;endl&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;// 1を出力&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;のようになります。&lt;br&gt;
（C++に参照定数はあるが参照変数がないため、ポインタで書いた。）&lt;/p&gt;
&lt;p&gt;実はこのC++コード、2行目で確保した&lt;code&gt;int(0)&lt;/code&gt;メモリを3行目の&lt;code&gt;int(1)&lt;/code&gt;代入時に&lt;strong&gt;放棄&lt;/strong&gt;していて、&lt;strong&gt;メモリリーク&lt;/strong&gt;が起こっています。C++では、これを処理（メモリ解放）するためのコードを本当は書き加えないといけません。&lt;br&gt;
しかし、Pythonではそれを&lt;strong&gt;ガベージコレクタ&lt;/strong&gt;という仕組みが&lt;strong&gt;勝手に代行&lt;/strong&gt;してくれます。逆にこれがないと、Pythonではメモリリークが頻繁に起こって大変なことになります。&lt;/p&gt;
&lt;h2&gt;変数の代入(2)&lt;/h2&gt;
&lt;p&gt;問題です。次のコードは何を出力するでしょうか。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# Python3&lt;/span&gt;
&lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;span class="n"&gt;b&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;
&lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  &lt;span class="c1"&gt;# 何が出る？&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;答えは「&lt;code&gt;0&lt;/code&gt;」&lt;/strong&gt;です。&lt;br&gt;
C++で書いた似たようなコード、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;// C++&lt;/span&gt;
&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;cout&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;endl&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;// 出力は「0」&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;も結果は同じなのですが、内部動作は全く異なります。&lt;strong&gt;Pythonでの変数代入は参照の切り替え&lt;/strong&gt;であることがやはりポイントです。&lt;/p&gt;
&lt;p&gt;一方で、過程は違えどPythonもC++も結果は変わりません。&lt;strong&gt;気にしなくても大抵はうまくいく&lt;/strong&gt;、というのも大事なところです(笑)。&lt;/p&gt;
&lt;h2&gt;関数引数はすべて参照渡し&lt;/h2&gt;
&lt;p&gt;「変数が全て参照」であることから、関数引数もまた&lt;strong&gt;参照渡し&lt;/strong&gt;となります。C/C++のデフォルトである&lt;strong&gt;値渡し&lt;/strong&gt;と異なり、メモリのコピーなどは行われません。&lt;/p&gt;
&lt;p&gt;では再び問題。次のコードは何を出力するでしょう？&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# Python3&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;func&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;

&lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;# ここまで。このprint()は何を出力するか？0？1？&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;「参照渡し」を知っている人ほど、「1」と答えたくなりそうですが、、  &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;答えは「0」&lt;/strong&gt;です。何故か？&lt;br&gt;
&lt;code&gt;func(a)&lt;/code&gt;を呼び出した時点では、&lt;strong&gt;&lt;code&gt;a&lt;/code&gt;と&lt;code&gt;x&lt;/code&gt;の指すメモリは同じ&lt;code&gt;0&lt;/code&gt;&lt;/strong&gt;ですが、&lt;code&gt;x = 1&lt;/code&gt;で&lt;code&gt;x&lt;/code&gt;の指すメモリは&lt;strong&gt;別に確保された&lt;code&gt;1&lt;/code&gt;&lt;/strong&gt;に切り替わります。&lt;strong&gt;&lt;code&gt;a&lt;/code&gt;および、&lt;code&gt;a&lt;/code&gt;の指す&lt;code&gt;0&lt;/code&gt;には何の変化も無い&lt;/strong&gt;のです。このあたりは前項の問題とほとんど同じです。&lt;/p&gt;
&lt;h2&gt;「変数への代入」ではない場合&lt;/h2&gt;
&lt;p&gt;例えばこんなとき。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# Python3&lt;/span&gt;
&lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;b&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;
&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  &lt;span class="c1"&gt;# 出力は[2,1]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;3行目で&lt;code&gt;b&lt;/code&gt;と&lt;code&gt;a&lt;/code&gt;は同じリストを参照するようになります。4行目では、そのリスト（これも参照の列みたいなもの）の最初の成分を、&lt;code&gt;0&lt;/code&gt;でなく&lt;code&gt;2&lt;/code&gt;のメモリを参照するように切り替えます。全体として見れば&lt;code&gt;a&lt;/code&gt;と&lt;code&gt;b&lt;/code&gt;が同じリストを参照していることに変わりはないので、この変更は&lt;code&gt;b&lt;/code&gt;にも反映されています。&lt;/p&gt;
&lt;p&gt;これは、前項の関数引数で若干の問題を引き起こします。&lt;br&gt;
次のコード、前項で見たものにそっくりですが、、、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# Python3&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;func2&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;

&lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;func2&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;前項とは違い、この出力は「&lt;code&gt;1&lt;/code&gt;」&lt;/strong&gt;です。&lt;br&gt;
関数が呼び出されると&lt;strong&gt;&lt;code&gt;a&lt;/code&gt;と&lt;code&gt;x&lt;/code&gt;の指すリストは一貫して同じ&lt;/strong&gt;で、その一部が書き換えられるからです。これは&lt;strong&gt;リストでなくnumpy配列の場合もほぼ同じ&lt;/strong&gt;です。&lt;/p&gt;
&lt;h2&gt;まとめ&lt;/h2&gt;
&lt;p&gt;以上見てきたように、Pythonの変数は全て参照、関数引数は全て参照渡しです。これらが組み合わさると、結果的に全てを値渡しにした場合（C/C++）と殆ど違いが見えなくなり、あまり意識することなくプログラムを書けるようになっています。&lt;/p&gt;
&lt;p&gt;しかし、リストや配列（や、もっと複雑なクラスオブジェクトなど）のように部分的に書き換え可能なものを扱う場合などには、この違いはかなり重要になってきます。怪しいと思ったら、各変数が何を参照しているか、互いに同じか違うかなどを、その都度考えてみてください。&lt;/p&gt;
&lt;p&gt;ひとまず今回はここまで。おしまい。
※画像は&lt;a href="https://www.python.org/"&gt;公式&lt;/a&gt;のものです。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Python"></category></entry><entry><title>Common Workflow Language入門</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/12/cwl.html" rel="alternate"></link><published>2018-12-07T00:00:00+09:00</published><updated>2018-12-07T00:00:00+09:00</updated><author><name>安水</name></author><id>tag:None,2018-12-07:/previews/refs/heads/general/jinja2_version/blog/2018/12/cwl.html</id><summary type="html">&lt;p&gt;先日&lt;a href="https://github.com/manabuishii/workflow-meetup/wiki/20181126"&gt;workflow-meetup&lt;/a&gt;にお誘いを頂いて参加してきました。そこでThe Common Workflow Language(CWL)というものを習ったので忘れないうちに&lt;strong&gt;医学部生に …&lt;/strong&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;先日&lt;a href="https://github.com/manabuishii/workflow-meetup/wiki/20181126"&gt;workflow-meetup&lt;/a&gt;にお誘いを頂いて参加してきました。そこでThe Common Workflow Language(CWL)というものを習ったので忘れないうちに&lt;strong&gt;医学部生にもわかりやすく&lt;/strong&gt;まとめます。&lt;/p&gt;
&lt;h2&gt;CWLって？&lt;/h2&gt;
&lt;p&gt;&lt;img alt="cwl" src="https://github.com/common-workflow-language/cwl-website/blob/master/site/CWL-Logo-Header.png?raw=true"&gt;&lt;/p&gt;
&lt;p&gt;一言で言うと、bioinformatics処理の自動化です。どういうことかもうちょっと詳しく見てみましょう。&lt;/p&gt;
&lt;p&gt;&amp;gt;ソフトウェアを組み合わせて構成される一連の作業手順 (ワークフロー) を記述するための仕組みや言語、GUI ソフトウェアは既に多く存在します。しかし、それらは特定の実行環境 (ハードウェア、ソフトウェア) に依存したものであり、異なる環境の間でワークフローを共有、再実行することは困難です。この問題を解決するために、異なるワークフロー実行ソフトウェア (実行エンジン) の間で共通してインポート/エクスポートできるフォーマットを目指して、Common Workflow Language (CWL) の開発が始まりました。&lt;/p&gt;
&lt;p&gt;&lt;a href="https://github.com/pitagora-galaxy/cwl/wiki/CWL-Start-Guide-JP"&gt;素晴らしい日本語ドキュメント&lt;/a&gt;から取ってきました。要はbioinformaticsなど、複数のソフトの連携が必要な処理を自動化、共有がスムーズになるような仕組みです。ローカルでテストして、サーバーやクラウドに持っていくのも簡単です。最近はSangerやBroad Institute(ハーバードとMITの共同研究施設)などでも使われているとのことです。&lt;/p&gt;
&lt;p&gt;まずは&lt;strong&gt;&lt;a href="https://www.youtube.com/embed/86eY8xs-Vo8?cc_load_policy=1&amp;amp;cc_lang_pref=ja&amp;amp;autoplay=1"&gt;60秒でわかるCWL - youtube&lt;/a&gt;&lt;/strong&gt;をみてください。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;.cwl&lt;/code&gt;で記述できるのはtoolとworkflowの二種類です。toolは例えばSTARやkallistoなど一つのツールを一つのcwlファイルに記述します。workflowはそれらのtoolをbindして実際のworkflowにします。更に、workflowをnestして新しいworkflowを作ったりも出来ます。&lt;/p&gt;
&lt;h2&gt;始め方&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href="https://github.com/pitagora-galaxy/cwl/wiki/CWL-Start-Guide-JP"&gt;素晴らしい日本語ドキュメント&lt;/a&gt;を読みましょう。10分もあれば読めると思います。&lt;/li&gt;
&lt;li&gt;&lt;a href="https://docs.google.com/presentation/d/13K6BKQoimiaOIFSnComw8in3HlCxEm820OASP8_jnDI/edit?usp=sharing"&gt;cwl-intro-gui-workshop スライド&lt;/a&gt;をやってみましょう。1時間ほどです。&lt;/li&gt;
&lt;li&gt;&lt;a href="http://www.commonwl.org/user_guide/"&gt;user guide&lt;/a&gt;をやりましょう。3時間ほどで終わるように設計されています。(理論値)&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;CWLのここがすごい&lt;/h2&gt;
&lt;p&gt;入門は各サイトにお任せするとして、今回は私がCWLをさわってみてすごいと思ったところをまとめてみます。素人目線です。&lt;/p&gt;
&lt;h3&gt;rabix composerのGUIがきれいすぎる&lt;/h3&gt;
&lt;p&gt;&lt;img alt="rabix gif" src="https://github.com/rabix/composer/raw/master/doc/images/workflows.gif"&gt;&lt;/p&gt;
&lt;p&gt;画像はbioinformaticsでお馴染みのSTARをrabix composerで操っているところです。&lt;a href="http://rabix.io/"&gt;rabix composer&lt;/a&gt;を使えば、GUIで直感的にCWLが触れます。更に出来たworkflowをクラウドやサーバーにそのまま持っていってCLI越しに使うことが出来ます。&lt;/p&gt;
&lt;h3&gt;dockerをベースにして完全にreproducibleにできる&lt;/h3&gt;
&lt;p&gt;いかにも今どきなのですが、toolの記述はすべてdockerのコンテナを使って記述することが出来ます。つまり、環境が変わってインストールし直す手間がまったく無いということです。すばらしいですね。さらに&lt;code&gt;--user-space-docker-cmd=udocker&lt;/code&gt;というオプション一つで、udockerというUser権限しか無い環境でも使えるdockerを使って動かすことができるようです。&lt;/p&gt;
&lt;h3&gt;すでにいろいろなソフトのcwlが出来ている&lt;/h3&gt;
&lt;p&gt;Communityで管理されている&lt;a href="https://github.com/common-workflow-language/workflows"&gt;CWL Tools &amp;amp; Workflows&lt;/a&gt;があります。ほかにもDBCLS太田さんの管理されている&lt;a href="https://github.com/pitagora-galaxy/cwl"&gt;Pitagora Workflows in CWL&lt;/a&gt;もいろいろ揃っています。&lt;/p&gt;
&lt;h3&gt;cwltoolの安定感がすごい&lt;/h3&gt;
&lt;p&gt;出来たcwlファイルをCLI環境で使うにはcwltoolを使います。感動したのはヘルプが自動で生成されるところ。しかも、pythonで書かれていてpythonに組み込むことも出来ます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;cwltool.factory&lt;/span&gt;
&lt;span class="n"&gt;fac&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cwltool&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;factory&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Factory&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;echo&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;fac&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;make&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;echo.cwl&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;echo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;inp&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;foo&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# result[&amp;quot;out&amp;quot;] == &amp;quot;foo&amp;quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;日本人contributerが多い&lt;/h3&gt;
&lt;p&gt;困ったときに助けてくれるやさしいcontributerの方々が日本に何人かいます。また、日本語ドキュメントも多くてとても助かります。更に、開発者の&lt;a href="https://twitter.com/biocrusoe"&gt;Michael R. Crusoe&lt;/a&gt;は来日しており、&lt;a href="https://twitter.com/hashtag/CommonWLjp?src=hash"&gt;#CommonWLjp&lt;/a&gt;などでCWLの輪を広げています。&lt;/p&gt;
&lt;blockquote class="twitter-tweet" data-lang="ja"&gt;&lt;p lang="en" dir="ltr"&gt;On my way to the 11th &lt;a href="https://twitter.com/NBDC_info?ref_src=twsrc%5Etfw"&gt;@NBDC_info&lt;/a&gt; / &lt;a href="https://twitter.com/dbcls?ref_src=twsrc%5Etfw"&gt;@dbcls&lt;/a&gt; &lt;a href="https://twitter.com/hashtag/biohack18?src=hash&amp;amp;ref_src=twsrc%5Etfw"&gt;#biohack18&lt;/a&gt; (with a week long stop in Tokyo for &lt;a href="https://twitter.com/hashtag/usegalaxyjp?src=hash&amp;amp;ref_src=twsrc%5Etfw"&gt;#usegalaxyjp&lt;/a&gt; meeting and other &lt;a href="https://twitter.com/hashtag/CommonWL?src=hash&amp;amp;ref_src=twsrc%5Etfw"&gt;#CommonWL&lt;/a&gt; presentations and a bilingual workshop) &lt;a href="https://t.co/W4gsO9bnA1"&gt;pic.twitter.com/W4gsO9bnA1&lt;/a&gt;&lt;/p&gt;&amp;mdash; Michael R. Crusoe (@biocrusoe) &lt;a href="https://twitter.com/biocrusoe/status/1069104245100748801?ref_src=twsrc%5Etfw"&gt;2018年12月2日&lt;/a&gt;&lt;/blockquote&gt;

&lt;h2&gt;kallistoをCWL + Rabix Composerで試してみる&lt;/h2&gt;
&lt;p&gt;まずは実際の作業工程を見てみましょう。&lt;/p&gt;
&lt;p&gt;&lt;img alt="gif" src="https://github.com/yyoshiaki/cwl_user_guide/blob/master/kallisto/kallisto.gif?raw=true"&gt;&lt;/p&gt;
&lt;p&gt;ちゃんとkallistoのoutputが生成されていますね！データは&lt;a href="https://github.com/yyoshiaki/cwl_user_guide/tree/master/kallisto"&gt;github&lt;/a&gt;にまとめておきました。テスト用のシーケンスデータも付けてあるので、クローンして遊んでみてください。&lt;code&gt;kallisto-index.cwl&lt;/code&gt;と&lt;code&gt;kallisto-quant.cwl&lt;/code&gt;は公式の&lt;a href="https://github.com/common-workflow-language/workflows"&gt;CWL Tools &amp;amp; Workflows&lt;/a&gt;から取ってきました。もちろんこれらはdocker imageを使っています。新しいworkflowを作ってみましょう。動画のように直感的にできると思います。&lt;/p&gt;
&lt;p&gt;今回、errorが出て進まなかった場所があったのですが、石井さん、西田さんの応援や、cwlの作者のMichaelやRabixの作者のKaushikがerrorに対処してくれました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href="https://github.com/rabix/composer/issues/418#issuecomment-444257454"&gt;issue : kallisto workflow is incompatible with Rabix composer #418&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;この対応のフレンドリーさはbioinformaticsならではですね。&lt;/p&gt;
&lt;h2&gt;workflow業界のあれこれ&lt;/h2&gt;
&lt;p&gt;ここで一旦workflowについて広く見てみましょう。ハーバードを始めとする海外の研究所ではサーバーを研究所ごとに管理するのに変えて、クラウドの利用が盛んになってきています。そういう時代感もあり、workflowやコンテナなど、reproducibleな環境の整備というのはますます重要視されてきています。workflow業界ではcwlの他に古き良き&lt;a href="http://wiki.pitagora-galaxy.org/wiki/index.php/Workflows"&gt;Galaxy&lt;/a&gt;、Broad Instituteが開発している&lt;a href="https://software.broadinstitute.org/wdl/"&gt;WDL&lt;/a&gt;や&lt;a href="https://www.nextflow.io/"&gt;nextflow&lt;/a&gt;、Pythonで書かれている&lt;a href="https://snakemake.readthedocs.io/en/stable/"&gt;Snakemake&lt;/a&gt;など、さまざまな選択肢があります。どのworkflowが好きか、Cambridgeの&lt;a href="https://twitter.com/@AlbertVilella"&gt;@AlbertVilella&lt;/a&gt;が世界中のbioinformaticianにアンケートをとっていました。&lt;/p&gt;
&lt;blockquote class="twitter-tweet" data-lang="ja"&gt;&lt;p lang="en" dir="ltr"&gt;90 responses in &lt;a href="https://t.co/hbaY7ShocR"&gt;https://t.co/hbaY7ShocR&lt;/a&gt; &lt;a href="https://twitter.com/nextflowio?ref_src=twsrc%5Etfw"&gt;@nextflowio&lt;/a&gt; &lt;a href="https://twitter.com/SBGenomics?ref_src=twsrc%5Etfw"&gt;@SBGenomics&lt;/a&gt; &lt;a href="https://twitter.com/commonwl?ref_src=twsrc%5Etfw"&gt;@commonwl&lt;/a&gt; Snamemake &lt;a href="https://t.co/1kc1DaXdBa"&gt;pic.twitter.com/1kc1DaXdBa&lt;/a&gt;&lt;/p&gt;&amp;mdash; Albert Vilella (@AlbertVilella) &lt;a href="https://twitter.com/AlbertVilella/status/1070219898306084865?ref_src=twsrc%5Etfw"&gt;2018年12月5日&lt;/a&gt;&lt;/blockquote&gt;

&lt;blockquote class="twitter-tweet" data-lang="ja"&gt;&lt;p lang="en" dir="ltr"&gt;No votes so far for &lt;a href="https://twitter.com/ensembl?ref_src=twsrc%5Etfw"&gt;@ensembl&lt;/a&gt; Hive, Apache Taverna or &lt;a href="https://twitter.com/arvados?ref_src=twsrc%5Etfw"&gt;@arvados&lt;/a&gt; , even though we know they have plenty of users &lt;a href="https://t.co/Db2el8vPDt"&gt;https://t.co/Db2el8vPDt&lt;/a&gt; &lt;a href="https://twitter.com/hashtag/Bioinformatics?src=hash&amp;amp;ref_src=twsrc%5Etfw"&gt;#Bioinformatics&lt;/a&gt; &lt;a href="https://twitter.com/hashtag/Workflows?src=hash&amp;amp;ref_src=twsrc%5Etfw"&gt;#Workflows&lt;/a&gt; &lt;a href="https://t.co/hbaY7ShocR"&gt;https://t.co/hbaY7ShocR&lt;/a&gt;&lt;/p&gt;&amp;mdash; Albert Vilella (@AlbertVilella) &lt;a href="https://twitter.com/AlbertVilella/status/1070579264192462849?ref_src=twsrc%5Etfw"&gt;2018年12月6日&lt;/a&gt;&lt;/blockquote&gt;

&lt;p&gt;どうやら一番twitter界隈のbioinformaticianはnextflowが好きなようです。ただ、下のspreadsheetを見ると、githubではGalaxy,bcbioについで三番目に盛んなようです。&lt;/p&gt;
&lt;p&gt;他にも、cwlやnextflowを取り上げたgenome解析の論文も出ていたりします。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href="https://bmcbioinformatics.biomedcentral.com/articles/10.1186/s12859-018-2446-1"&gt;Baichoo, S. et al. Developing reproducible bioinformatics analysis workflows for heterogeneous computing environments to support African genomics. BMC Bioinformatics 19, 457 (2018).&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;結論　みんなでCWLを使おう！&lt;/h2&gt;
&lt;p&gt;医学部生にできるだけわかりやすく書いてみました。みんなでcwlを使ってどんどん解析を楽にしましょう！&lt;/p&gt;
&lt;p&gt;国試も自動化できたらなあ。。。&lt;/p&gt;
&lt;h2&gt;参考資料&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.commonwl.org/"&gt;CWL公式ページ&lt;/a&gt; : リンク集がついている。&lt;/li&gt;
&lt;li&gt;&lt;a href="https://docs.google.com/presentation/d/13K6BKQoimiaOIFSnComw8in3HlCxEm820OASP8_jnDI/edit?usp=sharing"&gt;cwl-intro-gui-workshop スライド&lt;/a&gt; : 二階堂研石井さんのスライド。わかりやすいです。&lt;/li&gt;
&lt;/ul&gt;</content><category term="技術ブログ"></category><category term="Bioinformatics"></category></entry><entry><title>PythonとKerasでどうぶつしょうぎ</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/12/animalshogi.html" rel="alternate"></link><published>2018-12-06T00:00:00+09:00</published><updated>2018-12-06T00:00:00+09:00</updated><author><name>小川</name></author><id>tag:None,2018-12-06:/previews/refs/heads/general/jinja2_version/blog/2018/12/animalshogi.html</id><summary type="html">&lt;h2&gt;はじめに&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;「どうぶつしょうぎ」&lt;/strong&gt; というゲームをご存知でしょうか。（&lt;a href="https://ja.wikipedia.org/wiki/どうぶつしょうぎ"&gt;wikipediaの解説&lt;/a&gt;）&lt;/p&gt;
&lt;p&gt;普及・教育用のミニ将棋として考案されたもので …&lt;/p&gt;</summary><content type="html">&lt;h2&gt;はじめに&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;「どうぶつしょうぎ」&lt;/strong&gt; というゲームをご存知でしょうか。（&lt;a href="https://ja.wikipedia.org/wiki/どうぶつしょうぎ"&gt;wikipediaの解説&lt;/a&gt;）&lt;/p&gt;
&lt;p&gt;普及・教育用のミニ将棋として考案されたもので、本将棋が盤9x9、駒8種のところを盤3x4、駒4種までコンパクトにしたものです。&lt;br&gt;
駒の名前もひよこ（歩）、ぞう（弱い角）、きりん（弱い飛車）、ライオン（玉）、にわとり（ひよこの成り駒＝と金）、のように、かわいいです。&lt;br&gt;
駒に描かれているイラストも、大変、かわいいです。  &lt;/p&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}images/animalshogi_figs/1024px-doubutsu-shogi.jpg"&gt;&lt;/p&gt;
&lt;p&gt;ゲーム空間の規模がそこそこ小さいため、すでに随分前に&lt;a href="https://www.tanaka.ecc.u-tokyo.ac.jp/ktanaka/dobutsushogi/"&gt;完全解析もされています&lt;/a&gt;。
双方最善を尽くすと78手まで後手勝ち、だそうです。&lt;/p&gt;
&lt;p&gt;今回は、&lt;a href="https://www.nature.com/articles/nature16961"&gt;AlphaGo&lt;/a&gt;
(&lt;a href="https://www.nature.com/articles/nature24270"&gt;Zero&lt;/a&gt;)
を部分的に真似した深層強化学習で、PythonとKeras（初心者向けの深層学習フレームワーク）を使い、&lt;strong&gt;どうぶつしょうぎをプレイするプログラム&lt;/strong&gt; を作ってみました。&lt;br&gt;
ひとまず先読みは無しで、目の前の局面に対して直感的に手を選び、そこそこ強いもの、を目指します。&lt;/p&gt;
&lt;p&gt;今更な話題で研究としての価値はほぼないと思いますが、ただ論文を読むだけよりも実際に手を動かしてみると、色々とわかることもあるものです。  （たぶん。）&lt;/p&gt;
&lt;h2&gt;つくりかた概要&lt;/h2&gt;
&lt;p&gt;「プレイするプログラム」と大層なことを書きましたが、核心部分は「与えられた局面に対して次の指し手を返す」、これだけです。&lt;br&gt;
この部分を、深層ニューラルネットワーク「だけ」で作ります。  &lt;/p&gt;
&lt;p&gt;実はこれ、&lt;strong&gt;画像カテゴリ認識と殆ど同じ&lt;/strong&gt; です。
例えば手書き数字認識と対比すると、数字画像の代わりに局面データ、0-9の代わりに何番目の指し手か、が対応します。&lt;br&gt;
入力として局面を与え、各指し手のスコア（指す確率）を出力する、順伝搬型の深層ネットワークを作ればいいわけです。&lt;/p&gt;
&lt;h2&gt;ネットワーク構成&lt;/h2&gt;
&lt;h3&gt;入力：盤面と持駒の表現&lt;/h3&gt;
&lt;p&gt;どうぶつしょうぎの盤面は3x4。各マスを考えるとそれぞれ11通りの状態がありえます。
（駒が成駒含めて5種類、自分と相手の駒があり、空白マスとあわせて5x2+1=11です。）&lt;br&gt;
なので、盤面はサイズ(3,4,11)の3次元整数配列として与えましょう。
各マスで11チャネルのうち1つだけが1、残りは0をとるようにします。&lt;/p&gt;
&lt;p&gt;次に持駒ですが、持駒になるのはひよこ、ぞう、きりんの3種のみ。各最大2枚。&lt;br&gt;
こちらは(2,3,2)の3次元配列とします。次元は順に、自分か相手か、駒の種類、持駒の1枚目または2枚目、を表し、値はいずれも0または1です。&lt;/p&gt;
&lt;p&gt;入力は合わせて144ノード。ちょっと冗長すぎる気はしますが、ひとまず気にせず進めましょう。&lt;/p&gt;
&lt;h3&gt;出力：可能な指し手を網羅する&lt;/h3&gt;
&lt;p&gt;どうぶつしょうぎの指し手は、(1)駒の移動、(2)駒打ち、の2種類があります。&lt;br&gt;
これらは任意の局面に対して、&lt;br&gt;
(1)「動かす駒の位置」「移動後の位置」「成るか、成らないか」&lt;br&gt;
(2)「打つ駒の種類」「打つ位置」&lt;br&gt;
を与えると一意に決められます。&lt;br&gt;
一番強い駒であるライオンでも、盤の端から端まで一手で移動などはできないため、(1)には制限があります。実際に合法でありうる動きは61通り。(2)は単純に、打てる駒3種（ひよこ、ぞう、きりん）と打ち場所3x4で36通り。&lt;br&gt;
合わせて&lt;strong&gt;合法手の可能性は97通り&lt;/strong&gt;です。
ですからネットワークは、&lt;strong&gt;97ノードのソフトマックスを出力とすればよい&lt;/strong&gt; ことになります。&lt;/p&gt;
&lt;h3&gt;今回使ったネットワーク&lt;/h3&gt;
&lt;p&gt;入力と出力が決まったので、あとは工夫しだい。
今回は適当に、こんなネットワークでやってみます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;____________________________________________________________________________________________________
Layer (type)                     Output Shape          Param #     Connected to                     
====================================================================================================
input_1 (InputLayer)             (None, 3, 4, 11)      0                                            
____________________________________________________________________________________________________
input_2 (InputLayer)            (None, 2, 3, 2)       0                                            
____________________________________________________________________________________________________
flatten_1 (Flatten)              (None, 132)           0           input_1[0][0]                    
____________________________________________________________________________________________________
flatten_2 (Flatten)             (None, 12)            0           input_2[0][0]                   
____________________________________________________________________________________________________
concatenate_1 (Concatenate)      (None, 144)           0           flatten_1[0][0]                  
                                                                   flatten_2[0][0]                 
____________________________________________________________________________________________________
dense_1 (Dense)                 (None, 128)           18560       concatenate_1[0][0]              
____________________________________________________________________________________________________
dense_2 (Dense)                 (None, 128)           16512       dense_1[0][0]                   
____________________________________________________________________________________________________
dense_3 (Dense)                 (None, 128)           16512       dense_2[0][0]                   
____________________________________________________________________________________________________
dense_4 (Dense)                 (None, 128)           16512       dense_3[0][0]                   
____________________________________________________________________________________________________
dense_5 (Dense)                 (None, 128)           16512       dense_4[0][0]                   
____________________________________________________________________________________________________
dense_6 (Dense)                 (None, 128)           16512       dense_5[0][0]                   
____________________________________________________________________________________________________
dense_7 (Dense)                 (None, 97)            12513       dense_6[0][0]                   
====================================================================================================
Total params: 113,633
Trainable params: 113,633
Non-trainable params: 0
____________________________________________________________________________________________________
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;input_1とinput_2がそれぞれ盤面と持駒の入力です。中間層6層、活性化関数は途中全てReLU、最後はsoftmax。パラメータ数は11万余り。&lt;br&gt;
盤が小さいので、畳み込みも使わず全て全結合にしています。本将棋に拡張する場合は、畳み込みを使った方がいいでしょう。&lt;/p&gt;
&lt;h2&gt;強化学習：自己対戦と指し手評価&lt;/h2&gt;
&lt;p&gt;さて、ようやく本番の学習。基本は、自己対戦の結果による指し手評価です。&lt;/p&gt;
&lt;p&gt;そのためには、&lt;strong&gt;審判・履歴機能付きのどうぶつしょうぎ盤セット&lt;/strong&gt; をPythonのクラスとして実装することが必要です。実は全体の中でここが一番面倒なのですが、別に面白くはないので割愛。数時間頑張れば、動くものは作れます。そう、Pythonならね。&lt;/p&gt;
&lt;p&gt;自己対戦学習は多少試行錯誤して、いくつか工夫しました。これが良いかはよくわかりませんが。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;初期配置からいきなり自己対戦するのではなく、勝負がつかない範囲でランダムに数手〜数十手進めた局面から開始。&lt;/li&gt;
&lt;li&gt;出力中の反則手は無視し、合法手の中で、スコアに比例した確率で指す。&lt;/li&gt;
&lt;li&gt;自己対戦の終局後、勝者側の指し手全てを教師信号としてネットワークを学習する。&lt;/li&gt;
&lt;li&gt;敗者側の指し手は無視し、減点しない。また反則スコアが高くても減点しない。&lt;br&gt;
  （褒めて伸ばす。初期局面が敗勢だとどうしようもないから、という理由もあり。）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;今回は2^17局の自己対戦を行い、終局ごとに学習させました。1局あたりの平均手数は20手、このうち勝者側のみを学習するので、延べ130万局面程度を学習したことになります。&lt;br&gt;
計算は全てノートPC上で行い、計算時間は45分程度でした。&lt;/p&gt;
&lt;h2&gt;学習結果&lt;/h2&gt;
&lt;h3&gt;ルールの習得&lt;/h3&gt;
&lt;p&gt;まず、学習したネットワークはどうぶつしょうぎのルール（合法手の規則）をどれくらい学んでいるのか？を検証してみます。&lt;br&gt;
ランダムに指して生成した局面で、ルールの制限を外して自由に指させてみたところ、じつに &lt;strong&gt;合法手が98.7%&lt;/strong&gt; となりました。1.3%の指し手が反則です。&lt;br&gt;
これら局面での合法手は、平均して局面あたり6.5手程度しかありません。97手からランダムに指せば殆どが反則、合法手は7%にも満たないはず。&lt;br&gt;
ルールについてはかなり良く習得してきていることがわかります。&lt;/p&gt;
&lt;h3&gt;どれくらい強い？&lt;/h3&gt;
&lt;p&gt;自分で対戦してみたいところなのですが、インターフェースを作っていないのと客観性のため、学習前のランダムなネットワークと対戦させてみます。揺らぎが1%程度未満になるように、2^14局連続で対戦。先手後手はランダムです。  &lt;/p&gt;
&lt;p&gt;結果は、、、&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;勝率 53% !!!!!!&lt;/strong&gt; (´･ω･`)&lt;/p&gt;
&lt;p&gt;んと、、、まず、この数字は十分に有意であるといえます（ｷﾘｯ）。&lt;br&gt;
ランダムに指すのと比べて、確実に強いです。&lt;br&gt;
しかし、、この程度では、まだ人間と勝負できるレベルでないことも明らかでしょう。&lt;/p&gt;
&lt;p&gt;原因についてはネットワーク設計に問題がある可能性もありますが、おそらく学習量が全然足りないのだと思われます。&lt;br&gt;
強化学習の成長はゆっくりで、少しづつ高度な好手を順番に見出していく必要があります。  &lt;/p&gt;
&lt;p&gt;例えばまず最初に、ライオンが取れるときは取るのが好手だ、ということを学ぶ。すると、駒が多いとライオンを取れる機会も増えるので、駒を取るのがいいことを学ぶ。多分まだ、最初の段階の途中くらいと想像できます。&lt;br&gt;
そういうことを考えると、130万局面を評価した段階での勝率53%は、それなりに納得できる数字かもしれません。&lt;/p&gt;
&lt;p&gt;今回はノートPC上で1時間足らずの学習なので、また時間ができたらもっと大規模にやってみたいと思います。
自己対戦部分をCythonで高速化して、GPUサーバ上で学習するとか。&lt;/p&gt;
&lt;p&gt;ひとまず今回はここまで。おしまい。&lt;/p&gt;
&lt;h3&gt;追記1&lt;/h3&gt;
&lt;p&gt;強化学習をさらに2倍、総計2&lt;sup&gt;18&lt;/sup&gt;局の自己対戦まで行わせたところ、合法手率86.0%、学習前ネットワークに対する勝率51.7%までそれぞれ暴落。何が起こっているのか、やっぱりよくわかりません。学習方法をもう少し検討するとか、あとはやはりもっと計算資源を投入する必要はありそうですかね。&lt;/p&gt;
&lt;h3&gt;追記2&lt;/h3&gt;
&lt;p&gt;強化学習の方法についてですが、碁と将棋の違いとして、特に棋力が低い場合、将棋では終盤（終局間際）の指し手が勝敗に圧倒的に重要、ということがあるかもしれません。&lt;br&gt;
今の場合、最初はライオン取りを学ぶことが必要なのですが、最後にライオンを取るまでにライオン取りを見逃した手なども教師信号になってしまいます。&lt;br&gt;
最初は最終手だけ学ぶなどと人為的に重みをいじった方が、今のレベルでは良い結果が出るかも。王道は、マシンパワーの力尽くなのでしょうが。。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category></entry><entry><title>Gene Set Enrichment Analysis (GSEA)入門</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/11/gsea.html" rel="alternate"></link><published>2018-11-27T00:00:00+09:00</published><updated>2018-11-27T00:00:00+09:00</updated><author><name>西田</name></author><id>tag:None,2018-11-27:/previews/refs/heads/general/jinja2_version/blog/2018/11/gsea.html</id><summary type="html">&lt;h2&gt;GSEAとは&lt;/h2&gt;
&lt;p&gt;GSEAは発現差異解析の結果などで得られる遺伝子群がどういった機能のものかを明らかにするために用いられる解析手法です。機能表現として用いられる主なものとしてはKEGGのパスウェイ分類やGene Ontology(GO)があります。&lt;/p&gt;
&lt;h2&gt;clusterProfilerでGSEA入門&lt;/h2&gt;
&lt;p&gt;GSEA には様々なGSEAがあります。単に注目する遺伝子のリストを …&lt;/p&gt;</summary><content type="html">&lt;h2&gt;GSEAとは&lt;/h2&gt;
&lt;p&gt;GSEAは発現差異解析の結果などで得られる遺伝子群がどういった機能のものかを明らかにするために用いられる解析手法です。機能表現として用いられる主なものとしてはKEGGのパスウェイ分類やGene Ontology(GO)があります。&lt;/p&gt;
&lt;h2&gt;clusterProfilerでGSEA入門&lt;/h2&gt;
&lt;p&gt;GSEA には様々なGSEAがあります。単に注目する遺伝子のリストをGSEAへの入力とするもの、発現プロファイルを入力とするもの、機能のデータベースやGSEA手法を複数組み合わせたりするもの (EGSEA) など様々です。[余談ですがGeneを代謝物(Metabolite)に置き換えたMSEAもあります。]&lt;/p&gt;
&lt;p&gt;ここでは前述したものの内、最初の「単に注目する遺伝子のリストをGSEAへの入力とするもの」をbioconductorのパッケージ clusterProfiler を用いて体験してみましょう。&lt;/p&gt;
&lt;p&gt;(clusterProfilerのインストールについては省略します。)&lt;/p&gt;
&lt;p&gt;まず注目する遺伝子のリストを下記で用意します。&lt;/p&gt;
&lt;p&gt;※編集注 : 以下はすべてRでの実行になります。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;data&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;geneList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;package&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;DOSE&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;gene&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-&lt;/span&gt; &lt;span class="nf"&gt;names&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;geneList&lt;/span&gt;&lt;span class="p"&gt;)[&lt;/span&gt;&lt;span class="nf"&gt;abs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;geneList&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="m"&gt;2&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;gene&lt;/span&gt;
  &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;4312&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;8318&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;10874&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;55143&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;55388&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;991&amp;quot;&lt;/span&gt;    &lt;span class="s"&gt;&amp;quot;6280&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;2305&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;9493&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;1062&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;3868&amp;quot;&lt;/span&gt;  
 &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;12&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;4605&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;9833&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;9133&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;6279&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;10403&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;8685&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;597&amp;quot;&lt;/span&gt;    &lt;span class="s"&gt;&amp;quot;7153&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;23397&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;6278&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;79733&amp;quot;&lt;/span&gt;
 &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;23&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;259266&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;1381&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;3627&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;27074&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;6241&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;55165&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;9787&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;7368&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;11065&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;55355&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;9582&amp;quot;&lt;/span&gt;  
 &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;34&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;220134&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;55872&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;51203&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;3669&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;83461&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;22974&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;10460&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;10563&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;4751&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;6373&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;8140&amp;quot;&lt;/span&gt;  
 &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;45&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;79019&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;820&amp;quot;&lt;/span&gt;    &lt;span class="s"&gt;&amp;quot;10635&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;1844&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;4283&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;27299&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;55839&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;27338&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;890&amp;quot;&lt;/span&gt;    &lt;span class="s"&gt;&amp;quot;9415&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;983&amp;quot;&lt;/span&gt;   
 &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;56&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;54821&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;10232&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;4085&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;6362&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;9837&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;5080&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;7850&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;81930&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;5918&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;81620&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;332&amp;quot;&lt;/span&gt;   
 &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;67&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;55765&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;79605&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;3832&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;6286&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;5163&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;2146&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;3002&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;50852&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;7272&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;2568&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;64151&amp;quot;&lt;/span&gt;
 &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;78&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;51806&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;366&amp;quot;&lt;/span&gt;    &lt;span class="s"&gt;&amp;quot;2842&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;9212&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;140578&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;51659&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;8715&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;4902&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;8208&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;1111&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;9319&amp;quot;&lt;/span&gt;  
 &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;89&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;9055&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;3833&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;146909&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;23475&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;4321&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;11182&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;10112&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;3902&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;3620&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;3887&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;51514&amp;quot;&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;100&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;6790&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;4521&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;891&amp;quot;&lt;/span&gt;    &lt;span class="s"&gt;&amp;quot;57110&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;8544&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;1448&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;24137&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;6355&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;10578&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;4174&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;9232&amp;quot;&lt;/span&gt;  
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;111&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;643314&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;1307&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;776&amp;quot;&lt;/span&gt;    &lt;span class="s"&gt;&amp;quot;4129&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;9370&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;196740&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;25924&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;8857&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;1602&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;51161&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;3708&amp;quot;&lt;/span&gt;  
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;122&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;23090&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;10742&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;51760&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;9122&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;10699&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;8416&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;60598&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;79148&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;64799&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;4629&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;1556&amp;quot;&lt;/span&gt;  
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;133&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;55096&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;26289&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;6038&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;771&amp;quot;&lt;/span&gt;    &lt;span class="s"&gt;&amp;quot;51313&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;23704&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;3117&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;80129&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;23158&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;125&amp;quot;&lt;/span&gt;    &lt;span class="s"&gt;&amp;quot;4958&amp;quot;&lt;/span&gt;  
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;144&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;4857&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;1311&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;5105&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;5174&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;730&amp;quot;&lt;/span&gt;    &lt;span class="s"&gt;&amp;quot;2018&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;81563&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;2532&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;1308&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;4250&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;23362&amp;quot;&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;155&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;2167&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;51705&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;2593&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;652&amp;quot;&lt;/span&gt;    &lt;span class="s"&gt;&amp;quot;80736&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;4036&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;57502&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;5507&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;56521&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;22885&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;4137&amp;quot;&lt;/span&gt;  
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;166&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;8483&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;8839&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;2066&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;4693&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;4148&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;79083&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;1101&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;3158&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;3169&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;5346&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;1408&amp;quot;&lt;/span&gt;  
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;177&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;9547&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;2922&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;11283&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;64499&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;54829&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;1524&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;10234&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;1580&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;10647&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;25893&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;24141&amp;quot;&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;188&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;10351&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;2330&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;5304&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;79846&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;8614&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;2625&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;7021&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;7802&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;79689&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;11122&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;55351&amp;quot;&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="m"&gt;199&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;9&amp;quot;&lt;/span&gt;      &lt;span class="s"&gt;&amp;quot;4239&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;5241&amp;quot;&lt;/span&gt;   &lt;span class="s"&gt;&amp;quot;10551&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;10974&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;79838&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;79901&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;57758&amp;quot;&lt;/span&gt;  &lt;span class="s"&gt;&amp;quot;4969&amp;quot;&lt;/span&gt;  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;gene&lt;/code&gt;はヒト遺伝子のENTREZのIDです。&lt;/p&gt;
&lt;p&gt;この遺伝子リストを入力としてKEGGを対象としたGSEAを行ってみましょう。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nf"&gt;library&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;clusterProfiler&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;kk&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-&lt;/span&gt; &lt;span class="nf"&gt;enrichKEGG&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gene&lt;/span&gt;         &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gene&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="o"&gt;+&lt;/span&gt;                  &lt;span class="n"&gt;organism&lt;/span&gt;     &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;hsa&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="o"&gt;+&lt;/span&gt;                  &lt;span class="n"&gt;pvalueCutoff&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="m"&gt;0.05&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;head&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;kk&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
               &lt;span class="n"&gt;ID&lt;/span&gt;                             &lt;span class="n"&gt;Description&lt;/span&gt; &lt;span class="n"&gt;GeneRatio&lt;/span&gt;  &lt;span class="n"&gt;BgRatio&lt;/span&gt;       &lt;span class="n"&gt;pvalue&lt;/span&gt;     &lt;span class="n"&gt;p.adjust&lt;/span&gt;       &lt;span class="n"&gt;qvalue&lt;/span&gt;                                             &lt;span class="n"&gt;geneID&lt;/span&gt; &lt;span class="n"&gt;Count&lt;/span&gt;
&lt;span class="n"&gt;hsa04110&lt;/span&gt; &lt;span class="n"&gt;hsa04110&lt;/span&gt;                              &lt;span class="n"&gt;Cell&lt;/span&gt; &lt;span class="n"&gt;cycle&lt;/span&gt;     &lt;span class="m"&gt;11&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;90&lt;/span&gt; &lt;span class="m"&gt;123&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;7469&lt;/span&gt; &lt;span class="m"&gt;2.135411e-07&lt;/span&gt; &lt;span class="m"&gt;0.0000409999&lt;/span&gt; &lt;span class="m"&gt;4.023565e-05&lt;/span&gt; &lt;span class="m"&gt;8318&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;991&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;9133&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;890&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;983&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;4085&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;7272&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;1111&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;891&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;4174&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;9232&lt;/span&gt;    &lt;span class="m"&gt;11&lt;/span&gt;
&lt;span class="n"&gt;hsa04114&lt;/span&gt; &lt;span class="n"&gt;hsa04114&lt;/span&gt;                          &lt;span class="n"&gt;Oocyte&lt;/span&gt; &lt;span class="n"&gt;meiosis&lt;/span&gt;     &lt;span class="m"&gt;10&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;90&lt;/span&gt; &lt;span class="m"&gt;125&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;7469&lt;/span&gt; &lt;span class="m"&gt;2.216832e-06&lt;/span&gt; &lt;span class="m"&gt;0.0002128158&lt;/span&gt; &lt;span class="m"&gt;2.088489e-04&lt;/span&gt;    &lt;span class="m"&gt;991&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;9133&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;983&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;4085&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;51806&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;6790&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;891&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;9232&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;3708&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;5241&lt;/span&gt;    &lt;span class="m"&gt;10&lt;/span&gt;
&lt;span class="n"&gt;hsa04218&lt;/span&gt; &lt;span class="n"&gt;hsa04218&lt;/span&gt;                     &lt;span class="n"&gt;Cellular&lt;/span&gt; &lt;span class="n"&gt;senescence&lt;/span&gt;     &lt;span class="m"&gt;10&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;90&lt;/span&gt; &lt;span class="m"&gt;160&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;7469&lt;/span&gt; &lt;span class="m"&gt;2.014286e-05&lt;/span&gt; &lt;span class="m"&gt;0.0012891427&lt;/span&gt; &lt;span class="m"&gt;1.265113e-03&lt;/span&gt;     &lt;span class="m"&gt;2305&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;4605&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;9133&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;890&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;983&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;51806&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;1111&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;891&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;776&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;3708&lt;/span&gt;    &lt;span class="m"&gt;10&lt;/span&gt;
&lt;span class="n"&gt;hsa03320&lt;/span&gt; &lt;span class="n"&gt;hsa03320&lt;/span&gt;                  &lt;span class="n"&gt;PPAR&lt;/span&gt; &lt;span class="n"&gt;signaling&lt;/span&gt; &lt;span class="n"&gt;pathway&lt;/span&gt;      &lt;span class="m"&gt;7&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;90&lt;/span&gt;  &lt;span class="m"&gt;74&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;7469&lt;/span&gt; &lt;span class="m"&gt;2.724093e-05&lt;/span&gt; &lt;span class="m"&gt;0.0013075646&lt;/span&gt; &lt;span class="m"&gt;1.283191e-03&lt;/span&gt;                 &lt;span class="m"&gt;4312&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;9415&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;9370&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;5105&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;2167&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;3158&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;5346&lt;/span&gt;     &lt;span class="m"&gt;7&lt;/span&gt;
&lt;span class="n"&gt;hsa04914&lt;/span&gt; &lt;span class="n"&gt;hsa04914&lt;/span&gt; &lt;span class="n"&gt;Progesterone&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;mediated&lt;/span&gt; &lt;span class="n"&gt;oocyte&lt;/span&gt; &lt;span class="n"&gt;maturation&lt;/span&gt;      &lt;span class="m"&gt;7&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;90&lt;/span&gt;  &lt;span class="m"&gt;98&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;7469&lt;/span&gt; &lt;span class="m"&gt;1.657604e-04&lt;/span&gt; &lt;span class="m"&gt;0.0063651988&lt;/span&gt; &lt;span class="m"&gt;6.246549e-03&lt;/span&gt;                    &lt;span class="m"&gt;9133&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;890&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;983&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;4085&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;6790&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;891&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;5241&lt;/span&gt;     &lt;span class="m"&gt;7&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;kk&lt;/code&gt; がGSEAの結果になります。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;head(kk)&lt;/code&gt; でGSEAの結果を上から確からしいもの順にトップ5を出力しています。&lt;/p&gt;
&lt;p&gt;もし遺伝子リスト&lt;code&gt;gene&lt;/code&gt;が発現差異解析の結果であるなら、コントロールとターゲット間で&lt;code&gt;Cell cycle&lt;/code&gt;等に異変が起きているだろう、とこの結果から推測できるということになります。&lt;/p&gt;
&lt;p&gt;次に&lt;code&gt;kk&lt;/code&gt;の各列名の意味ですが&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;IDはKEGG pathwayのID&lt;/li&gt;
&lt;li&gt;DescriptionはKEGG pathwayの名前&lt;/li&gt;
&lt;li&gt;GeneRatioは入力&lt;code&gt;gene&lt;/code&gt;の遺伝子の内、何個の遺伝子がそのKEGG pathwayにマップされるか&lt;/li&gt;
&lt;li&gt;BgRatioは全KEGG pathwayにマップされる遺伝子の内、何個の遺伝子がそのKEGG pathwayにマップされるか&lt;/li&gt;
&lt;li&gt;p.adjust, qvalueは多重検定に伴う補正後のpvalueになり小さいほど確からしいことを示します。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;入力&lt;code&gt;gene&lt;/code&gt;に含まれる遺伝子がKEGG pathway上のどのgene productにmapされるかを可視化するには下記を実行します。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;browseKEGG(kk, &amp;#39;hsa04110&amp;#39;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img alt="KEGG map" src="{attach}images/gsea_figs/null9.png"&gt;&lt;/p&gt;
&lt;h2&gt;終わりに&lt;/h2&gt;
&lt;p&gt;最も簡単なGSEAを体験していただく例を示しました。&lt;/p&gt;
&lt;p&gt;追ってより進んだアンサンブル手法なども紹介できればと思っています。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Bioinformatics"></category></entry><entry><title>pandasのpivot_tableを用いた高速データ処理</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/11/pandas_pivot_table.html" rel="alternate"></link><published>2018-11-17T00:00:00+09:00</published><updated>2018-11-17T00:00:00+09:00</updated><author><name>金子</name></author><id>tag:None,2018-11-17:/previews/refs/heads/general/jinja2_version/blog/2018/11/pandas_pivot_table.html</id><summary type="html">&lt;h2&gt;概要&lt;/h2&gt;
&lt;p&gt;pandasのpivot_tableは強力な機能で、カテゴリごとの集計や計算を高速に行うことができます。&lt;/p&gt;
&lt;p&gt;pivot_tableを使った計算で個人的によく使う処理をまとめたものを&lt;a href="https://www.kaggle.com/nadare/feature-engenieering-with-pivot-table"&gt;kaggle のkernel&lt;/a&gt;で公開しました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}images/pandas_pivot_table_figs/pandas_pivot_table.png"&gt;&lt;/p&gt;
&lt;p&gt;このkernelでは簡単なダミーデータでpivot_tableに対する計算の仕方をまとめた後、実例として&lt;a href="https://www.kaggle.com/c/PLAsTiCC-2018"&gt;PLAsTiCC コン …&lt;/a&gt;&lt;/p&gt;</summary><content type="html">&lt;h2&gt;概要&lt;/h2&gt;
&lt;p&gt;pandasのpivot_tableは強力な機能で、カテゴリごとの集計や計算を高速に行うことができます。&lt;/p&gt;
&lt;p&gt;pivot_tableを使った計算で個人的によく使う処理をまとめたものを&lt;a href="https://www.kaggle.com/nadare/feature-engenieering-with-pivot-table"&gt;kaggle のkernel&lt;/a&gt;で公開しました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}images/pandas_pivot_table_figs/pandas_pivot_table.png"&gt;&lt;/p&gt;
&lt;p&gt;このkernelでは簡単なダミーデータでpivot_tableに対する計算の仕方をまとめた後、実例として&lt;a href="https://www.kaggle.com/c/PLAsTiCC-2018"&gt;PLAsTiCC コンペ&lt;/a&gt;の&lt;a href="https://www.kaggle.com/michaelapers/the-plasticc-astronomy-starter-kit"&gt;Starter Kit&lt;/a&gt;にあった特徴量の計算をpandasのpivot_tableを用いて高速化しました。&lt;/p&gt;
&lt;h2&gt;どんなことができるようになるの？&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;カテゴリごとに組み込みの集計関数より高度な関数を適用できる&lt;/li&gt;
&lt;li&gt;カテゴリごとの移動平均をかけるようになる&lt;/li&gt;
&lt;li&gt;未来のデータを含まないmean_encodingがかける&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;どれくらい早くなるの？&lt;/h2&gt;
&lt;p&gt;上記のkernelはEDA中に実際に僕が書いたコードに少し修正を加えたものですが、&lt;/p&gt;
&lt;p&gt;愚直なコード(1時間以上) → groupbyでの処理(2分半) → pivot_table(4秒)&lt;/p&gt;
&lt;p&gt;という感じで早くなりました。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Data Science Competition"></category></entry><entry><title>シェルスクリプト入門(2)</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/11/shellscript_2.html" rel="alternate"></link><published>2018-11-16T00:00:00+09:00</published><updated>2018-11-16T00:00:00+09:00</updated><author><name>水野</name></author><id>tag:None,2018-11-16:/previews/refs/heads/general/jinja2_version/blog/2018/11/shellscript_2.html</id><summary type="html">&lt;p&gt;※　編集注：前作&lt;a href="https://pythonoum.wordpress.com/2018/11/01/%E3%82%B7%E3%82%A7%E3%83%AB%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E5%85%A5%E9%96%801/"&gt;シェルスクリプト入門（1）&lt;/a&gt;の続編です。まだ読み終わってない方はそちらを先にどうぞ。&lt;/p&gt;
&lt;p&gt;テーブルファイル …&lt;/p&gt;</summary><content type="html">&lt;p&gt;※　編集注：前作&lt;a href="https://pythonoum.wordpress.com/2018/11/01/%E3%82%B7%E3%82%A7%E3%83%AB%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E5%85%A5%E9%96%801/"&gt;シェルスクリプト入門（1）&lt;/a&gt;の続編です。まだ読み終わってない方はそちらを先にどうぞ。&lt;/p&gt;
&lt;p&gt;テーブルファイルの操作と言えばRです。 (※　編集注：Pythonでもできます。)
が、そこまでbashで書いてきたのに、R呼び出して変数再設定して…面倒くさいから嫌だ！！
ってことないでしょうか。&lt;/p&gt;
&lt;p&gt;Rの機能を代替するのは無理ですが、せめてほんの少し、
例えば、テーブル中の値をそれぞれbashの変数に入れれたら、
Rを呼び出さずに完結できたりします。&lt;/p&gt;
&lt;p&gt;要は、&lt;code&gt;$ mat_i_j=i行j列目の要素&lt;/code&gt;で変数を格納していきます。&lt;/p&gt;
&lt;p&gt;対象ファイル名を、table.txtで、タブ区切り、中身は以下みたいの。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;a    b    c
1    2    3
d    e    f
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;これの各要素を、&lt;code&gt;$mat_i_j&lt;/code&gt; に格納していきます。
一例として、以下のスクリプトでできます。
配列つかったりしてもっといいスクリプトもきっとあります。&lt;/p&gt;
&lt;p&gt;bashは汚いスクリプトでもたいてい速く動いてくれるので成長しないですね。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="ch"&gt;#!/bin/bash&lt;/span&gt;
&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="c1"&gt;## 行番号に使う変数の設定。&lt;/span&gt;
&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="nb"&gt;read&lt;/span&gt; x1 x2 x3 &lt;span class="c1"&gt;## 解説①&lt;/span&gt;
&lt;span class="k"&gt;do&lt;/span&gt;
    &lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt;expr &lt;span class="nv"&gt;$row&lt;/span&gt; + &lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt; &lt;span class="c1"&gt;## 1行ずつ読んでくので、1ずつ足していく。&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; col &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="sb"&gt;`&lt;/span&gt;seq &lt;span class="m"&gt;1&lt;/span&gt; &lt;span class="m"&gt;3&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt; &lt;span class="c1"&gt;## 今読んでる行での列番号をfor文で回す。&lt;/span&gt;
    &lt;span class="k"&gt;do&lt;/span&gt;
        &lt;span class="nb"&gt;eval&lt;/span&gt; mat_&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;row&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;_&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;col&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt;&lt;span class="nb"&gt;eval&lt;/span&gt; &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="nv"&gt;$x&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;col&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt; &lt;span class="c1"&gt;## 解説②&lt;/span&gt;
    &lt;span class="k"&gt;done&lt;/span&gt;
&lt;span class="k"&gt;done&lt;/span&gt;&lt;span class="p"&gt;&amp;amp;&lt;/span&gt;lt&lt;span class="p"&gt;;&lt;/span&gt;table.txt

&lt;span class="c1"&gt;### 変数mat_$i_$j を使った処理が続く。&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;時間のある人用に解説です。
少し小技があります。&lt;/p&gt;
&lt;h2&gt;1) while readの使い方&lt;/h2&gt;
&lt;p&gt;よく見かけるのは、&lt;code&gt;cat&lt;/code&gt;からパイプで&lt;code&gt;while read&lt;/code&gt;につなぐやつです。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;cat table.txt &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="nb"&gt;read&lt;/span&gt; x1 x2 x3
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;ファイルを一行ずつ読んで、各列の要素を&lt;code&gt;read&lt;/code&gt;の後ろに置いた変数名&lt;code&gt;（x1,x2,x3）&lt;/code&gt;に格納していきます。変数名の個数は任意です。ここでは列の数に合わせてます。
各行ごとに、&lt;code&gt;do&lt;/code&gt;～&lt;code&gt;done&lt;/code&gt;の間で、&lt;code&gt;$x1&lt;/code&gt;,&lt;code&gt;$x2&lt;/code&gt;,&lt;code&gt;$x3&lt;/code&gt;が使えるようになります。&lt;/p&gt;
&lt;p&gt;が、しかし、パイプで&lt;code&gt;while&lt;/code&gt;に入ってしまうと、パイプ内はパイプ内で完結するため、
&lt;code&gt;do&lt;/code&gt;~&lt;code&gt;done&lt;/code&gt;の中で変数操作をしても、&lt;code&gt;done&lt;/code&gt;の後では、その中身が空っぽになっちゃいます。&lt;/p&gt;
&lt;p&gt;これを回避するためには、パイプを使わないということで、リダイレクトで、
&lt;code&gt;done&lt;/code&gt;の後ろに&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;done&lt;/span&gt;&amp;lt;table.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;を書きます。
読みにくいですよねー。&lt;/p&gt;
&lt;h2&gt;2) evalの使い方&lt;/h2&gt;
&lt;p&gt;今回の&lt;code&gt;mat_$i_$j&lt;/code&gt;のように、変数名に変数&lt;code&gt;($i,$j)&lt;/code&gt;を使って値を格納する時には、&lt;code&gt;eval&lt;/code&gt;を使います。
&lt;code&gt;eval&lt;/code&gt;は、その後に書いた文をもってきて、bashスクリプトとして評価（evaluate）します。&lt;/p&gt;
&lt;p&gt;なので、&lt;code&gt;i=2, j=3&lt;/code&gt; として、&lt;/p&gt;
&lt;p&gt;&lt;code&gt;eval mat_${i}_${j}=aaa&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;は、
&lt;code&gt;mat_2_3=aaa&lt;/code&gt; をスクリプトとして評価しろ、ということになり、
&lt;code&gt;mat_2_3&lt;/code&gt;という変数名に、&lt;code&gt;aaa&lt;/code&gt;が入ります。
（ちなみに、どこまでが変数名か分からなくなる状況では、変数名を{}でくくります。ここではiとj。）&lt;/p&gt;
&lt;p&gt;変数を使った変数名の中身を出力させる場合には、echoとevalを組み合わせます。
&lt;code&gt;col=1&lt;/code&gt;として、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nb"&gt;eval&lt;/span&gt; &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="se"&gt;\$&lt;/span&gt;x&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;col&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;と書けば、まず、&lt;code&gt;eval&lt;/code&gt;が&lt;code&gt;$col&lt;/code&gt;の中身を出してからスクリプトとして評価するので、
（xの&lt;span class="math"&gt;\(には\がかかってるので無視されます）
&lt;code&gt;echo $x1&lt;/code&gt;
と書いていることになり、通常の&lt;code&gt;echo&lt;/code&gt;で書いたように、&lt;code&gt;$x1&lt;/code&gt;の中身が出力されます。
xの\)&lt;/span&gt;にかかってた\は、&lt;code&gt;eval&lt;/code&gt;での評価で消費されて、&lt;code&gt;echo&lt;/code&gt;内にはなくなります。ここ重要。&lt;/p&gt;
&lt;p&gt;やりたいことは、&lt;code&gt;eval echo&lt;/code&gt; で出してきた値を、変数を使った変数名に格納することです。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;eval mat_${i}_${j}=aaa&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;の&lt;code&gt;aaa&lt;/code&gt;部分に&lt;code&gt;eval echo&lt;/code&gt;を直接もってきても、機能しません。
&lt;code&gt;eval echo&lt;/code&gt;のままでは、まだ値ではなくスクリプトだからです。&lt;/p&gt;
&lt;p&gt;なので、そのスクリプトを実行させて値を出力させたものを、&lt;code&gt;aaa&lt;/code&gt;の部分に書きます。
そういう時は、アクサングラーブ（` シフト押しながら＠）でくくります。&lt;/p&gt;
&lt;p&gt;アクサングラーブは、その中にあるスクリプトの実行結果を出力します。
なので、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nv"&gt;test&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="nv"&gt;$k&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;とすれば、&lt;code&gt;$k&lt;/code&gt;の中身が出力されて、&lt;code&gt;test&lt;/code&gt;に格納されます。
&lt;code&gt;row&lt;/code&gt;に1ずつ足していくとこでも使ってます。よく見る方法です。
&lt;code&gt;for&lt;/code&gt;文使わなくていいので、見た目がすっきりします。&lt;/p&gt;
&lt;p&gt;では、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;eval mat_&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;_&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;=`eval echo \&lt;span class="nv"&gt;$x&lt;/span&gt;&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;col&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;`
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;と書けば、&lt;code&gt;mat_2_3&lt;/code&gt;に&lt;code&gt;$x1&lt;/code&gt;の中身が代入されるはず！
となるのですが、不完全です。&lt;/p&gt;
&lt;p&gt;アクサングラーブでの評価で、&lt;code&gt;\&lt;/code&gt;が一個消費されてしまうので、実行する&lt;code&gt;eval echo&lt;/code&gt;の文が、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nb"&gt;eval&lt;/span&gt; &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="nv"&gt;$x&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;col&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;となるので、&lt;code&gt;eval&lt;/code&gt;での評価時に&lt;code&gt;$x&lt;/code&gt;の中身（設定してないので空っぽ）と&lt;code&gt;$col&lt;/code&gt;が出されてしまって、
&lt;code&gt;echo (空)1&lt;/code&gt;
となって、最終的に、&lt;code&gt;mat_2_3&lt;/code&gt;には&lt;code&gt;$x1&lt;/code&gt;ではなく、&lt;code&gt;$col&lt;/code&gt;の中身である1が代入されてしまいます。&lt;/p&gt;
&lt;p&gt;なので、&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;eval mat_&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;_&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;=`eval echo \\&lt;span class="nv"&gt;$x&lt;/span&gt;&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;col&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;`
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;と、\を一個増やして書けば、目的達成です。
めでたしめでたし。&lt;/p&gt;
&lt;p&gt;※ 編集注 : 記事はめでたく終わりましたが、アクサングラーブがマークダウンと干渉してしまいました。試行錯誤の結果、ところどころテキストが混じって読みにくくなってしまいました。すみません。&lt;/p&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="技術ブログ"></category><category term="Shell script"></category></entry><entry><title>TCGAbiolinksとその使い方</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/11/tcgabiolinks.html" rel="alternate"></link><published>2018-11-11T00:00:00+09:00</published><updated>2018-11-11T00:00:00+09:00</updated><author><name>淡田</name></author><id>tag:None,2018-11-11:/previews/refs/heads/general/jinja2_version/blog/2018/11/tcgabiolinks.html</id><summary type="html">&lt;p&gt;皆さん初めまして淡田公久と申します。
リレー投稿初週ということで、僕が現在基礎配属で使用していますデータや …&lt;/p&gt;</summary><content type="html">&lt;p&gt;皆さん初めまして淡田公久と申します。
リレー投稿初週ということで、僕が現在基礎配属で使用していますデータやツールに関してのお話をさせて頂きます。&lt;/p&gt;
&lt;h2&gt;TCGA&lt;/h2&gt;
&lt;p&gt;TCGAというサイトをご存じでしょうか？
TCGAは２００６年からアメリカが開始したガンゲノムプロジェクトで、２０種類以上の癌腫についての「ゲノム、メチル化異常、遺伝子発現」などの解析データをまとめている大型ゲノムバンクのような役割をしております。&lt;/p&gt;
&lt;p&gt;&lt;a href="https://cancergenome.nih.gov/"&gt;Home - The Cancer Genome Atlas - Cancer Genome - TCGA&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;実際に検索してみると分かりますが、データ数はほんとに膨大です（日本ではここまで大きのがなく、悲しいところ(´;ω;｀)）&lt;/p&gt;
&lt;p&gt;中には「contorlled」となっており、アクセスできないデータもありますが、多くは「open」となってアクセスできるものがほとんどなので解析などの際に困ることは無いはず。&lt;/p&gt;
&lt;h2&gt;TCGAbiolinks&lt;/h2&gt;
&lt;p&gt;では実際にそのデータを使ってどう解析するかといったときにどうするか？？&lt;/p&gt;
&lt;p&gt;ここで本題の&lt;strong&gt;TCGAbiolinks&lt;/strong&gt;のお話になります。
TCGAbiolinksとは、Rというツール上でTCGAのデータを解析するためのパッケージです。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href="http://bioconductor.org/packages/release/bioc/html/TCGAbiolinks.html"&gt;Bioconductor - TCGAbiolinks&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;こちらにインストールの方法やらが詳しく説明されています。&lt;/p&gt;
&lt;p&gt;先ほども述べた通り、TCGAにはメチル化データや、発現量データ（他にも臨床データなど）があるため、それぞれ解析方法は異なりますが、大枠のworkflowは&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;queryという関数でデータを引用&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="err"&gt;↓&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;downloadで引用データをダウンロード&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="err"&gt;↓&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;データーを&lt;/span&gt;&lt;span class="n"&gt;prepare&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="err"&gt;↓&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;目的に応じて解析&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="err"&gt;↓&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;結果を画像化&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;という流れです。
まぁ僕自身もまだこのツールにかんして半人前にもなっていないレベルなのですが（笑）、openソースの癌データをRというフリーツールで解析できるのはおもしろいのではないでしょうか？&lt;/p&gt;
&lt;p&gt;TCGAのデータ解析には他にもsubio platform（&lt;a href="https://www.subioplatform.com/ja/products/subioplatform/"&gt;マイクロアレイ・ＮＧＳの無料解析ソフト | Subio Platform&lt;/a&gt;）というものあるようですが、TCGAbiolinksのがメジャーではあるでしょう。&lt;/p&gt;
&lt;p&gt;このbiolinksに付随して&lt;strong&gt;elmer&lt;/strong&gt;というパッケージもあるのでそれについてもお話しできればと思います。&lt;/p&gt;
&lt;p&gt;ありがとうございました。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Bioinformatics"></category></entry><entry><title>シェルスクリプト入門(1)</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/11/shellscript_1.html" rel="alternate"></link><published>2018-11-01T00:00:00+09:00</published><updated>2018-11-01T00:00:00+09:00</updated><author><name>水野</name></author><id>tag:None,2018-11-01:/previews/refs/heads/general/jinja2_version/blog/2018/11/shellscript_1.html</id><summary type="html">&lt;p&gt;python会なのにpythonまだ触ったことありません。勉強せねば。&lt;/p&gt;
&lt;p&gt;データ整形の流れって、教わる機会なくないですか？
つまらないものですが、僕のやり方を紹介してみま …&lt;/p&gt;</summary><content type="html">&lt;p&gt;python会なのにpythonまだ触ったことありません。勉強せねば。&lt;/p&gt;
&lt;p&gt;データ整形の流れって、教わる機会なくないですか？
つまらないものですが、僕のやり方を紹介してみます。
始めたばかりの人は参考にしてください。
経験者の方、変なとこあったらどしどし突っ込みください！
そして皆さんの自己流も教えてもらえると嬉しいです。&lt;/p&gt;
&lt;h2&gt;1) scriptに起こす前&lt;/h2&gt;
&lt;p&gt;shell scriptに書き起こす前に、プロンプト画面（Mac,Ubuntuならterminal）でテストします。
僕はいつもcatでファイルにつないで、パイプの後に試したいコマンドを打ちます。
その後にパイプでheadにつないで、頭だけ出力してみます。たいていファイル重いので。
圧縮ファイルの時は、解凍する前にzcatでつないで試します。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;cat hogehoge.txt &lt;span class="p"&gt;|&lt;/span&gt; sed 1d（試したいコマンド）&lt;span class="p"&gt;|&lt;/span&gt; head
zcat hoge.gz &lt;span class="p"&gt;|&lt;/span&gt; cut –f1（試したいコマンド）&lt;span class="p"&gt;|&lt;/span&gt; head
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;一行が長くて確認しづらい！と思ったら、headからless –Sにつなぎます。
別画面で折り返しなしで見ることができます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;cat hogehoge &lt;span class="p"&gt;|&lt;/span&gt; sed 1d（試したいコマンド）&lt;span class="p"&gt;|&lt;/span&gt; head &lt;span class="p"&gt;|&lt;/span&gt; less -S
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;2) scriptを書く&lt;/h2&gt;
&lt;p&gt;うまくいきそうで、だいたい流れが思い描けたらshell scriptに書き起こします。
結局他のファイルも同じ処理をするはめになり、scriptに残しておけば・・と後悔することが多いからです。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;touch test.sh &lt;span class="c1"&gt;# ファイルつくって、&lt;/span&gt;
emacs test.sh &lt;span class="c1"&gt;# emacsで開く。&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="ch"&gt;#!/bin/bash # おまじない。&lt;/span&gt;
&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;filename &lt;span class="c1"&gt;# ファイルはいつも外から入れれるようにしてます。&lt;/span&gt;
rm –r ./folder &lt;span class="c1"&gt;# 一発で上手くいくことはないので、やり直しやすいように消去コマンド。&lt;/span&gt;
mkdir ./folder &lt;span class="c1"&gt;# 散らからないように専用フォルダを作成。&lt;/span&gt;
&lt;span class="nv"&gt;dir1&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;./folder&amp;quot;&lt;/span&gt; &lt;span class="c1"&gt;# フォルダ名をいつでも変えやすいようにパスを変数にいれる。&lt;/span&gt;
cat &lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$filename&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; sed 1d &amp;gt; &lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$dir1&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;/hogehoge2.txt &lt;span class="c1"&gt;#目的のコマンドで処理して保存。&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;3) 実行&lt;/h2&gt;
&lt;p&gt;書けたら、処理したいファイルを渡して実行してみます。
&lt;code&gt;&amp;amp;&lt;/code&gt;はバックグラウンド実行です。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;bash ./test.sh ./hogehoge.txt &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;時間がかかりそうで家に帰りたいときは、nohupでサーバーと切れても大丈夫なように。
screenを使うこともあります。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;nohup bash ./test.sh ./hogehoge.txt &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;4)　修正&lt;/p&gt;
&lt;p&gt;scriptを修正するときは、元の文は#をつけてコメントアウトしときます。
そうすれば、後でやり直しやすいです。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# cat &amp;quot;$filename&amp;quot; | sed 1d &amp;gt; &amp;quot;$dir1&amp;quot;/hogehoge2.txt # コメントアウトして置いておく。&lt;/span&gt;
cat &lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$filename&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; grep &lt;span class="s2"&gt;&amp;quot;blahblah&amp;quot;&lt;/span&gt; &amp;gt; &lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$dir1&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;/hogehoge2.txt &lt;span class="c1"&gt;# 新しい文。&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;どこでバグってるか分からない時は、とりあえずechoで変数を出してみたりしてチェックしてます。&lt;/p&gt;
&lt;h2&gt;5) 応用編&lt;/h2&gt;
&lt;p&gt;あとはひたすらコマンドを駆使して書き上げていきます。
以下の基本コマンドでだいたいのことはできるかと。
特にawkはたくさんのことができます。joinも重宝します。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;command&lt;/th&gt;
&lt;th&gt;説明&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;cat&lt;/td&gt;
&lt;td&gt;ファイルを縦につなぐ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;paste&lt;/td&gt;
&lt;td&gt;ファイルを横につなぐ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;sed&lt;/td&gt;
&lt;td&gt;指定行抜き出すor削除or文字置換&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;cut&lt;/td&gt;
&lt;td&gt;指定列抜き出すor削除&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;awk&lt;/td&gt;
&lt;td&gt;抜き出し方をいろいろカスタマイズ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;tr&lt;/td&gt;
&lt;td&gt;文字置換&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;sort&lt;/td&gt;
&lt;td&gt;整列&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;uniq&lt;/td&gt;
&lt;td&gt;重複行を削除or抜き出す&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;join&lt;/td&gt;
&lt;td&gt;2つのファイルを同じ項目で合わせる&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;grep&lt;/td&gt;
&lt;td&gt;特定の文字が入った行を出す&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;各コマンドのオプションの使い方が重要ですが、長くなってきたので詳細はまたの機会に。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Shell script"></category></entry><entry><title>MACS2とdeepToolsのbigwigファイルの比較</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/10/macs2_deeptools.html" rel="alternate"></link><published>2018-10-29T00:00:00+09:00</published><updated>2018-10-29T00:00:00+09:00</updated><author><name>安水</name></author><id>tag:None,2018-10-29:/previews/refs/heads/general/jinja2_version/blog/2018/10/macs2_deeptools.html</id><summary type="html">&lt;h2&gt;ChIP-seqとは&lt;/h2&gt;
&lt;p&gt;全身で37兆個あるといわれているヒトの細胞は、基本的にすべて同じDNA配列を有している。しかし、肝細胞、網膜、免疫細胞と細胞にはそれぞれの"個性"がある。更には正常の免疫 …&lt;/p&gt;</summary><content type="html">&lt;h2&gt;ChIP-seqとは&lt;/h2&gt;
&lt;p&gt;全身で37兆個あるといわれているヒトの細胞は、基本的にすべて同じDNA配列を有している。しかし、肝細胞、網膜、免疫細胞と細胞にはそれぞれの"個性"がある。更には正常の免疫細胞と暴走している免疫細胞など細胞には"状態"もある。これらを制御する大きな要素としてエピジェネティクスが挙げられ、DNAメチル化やクロマチン修飾などが知られている。ChIP-seq (chromatin immunoprecipitation sequence) は特異的クロマチン修飾を受けている領域を、抗体を用いて沈降、濃縮させ、どの細胞のどの領域でどういう修飾を受けているのかを調べるために用いられる。&lt;/p&gt;
&lt;h2&gt;今回のきっかけ&lt;/h2&gt;
&lt;p&gt;ChIP-seqの解析をする時に便利なフォーマットにbigwigがある。igvで表示したり、coverageを計算したり、様々な用途で使える。詳しくはdrbonobon（第一版）のp118に記載されている。ChIP-seqの解析には&lt;a href="https://github.com/taoliu/MACS"&gt;MACS2&lt;/a&gt;というソフトが良く使われ、bigwigの生成も可能だが、&lt;a href="https://deeptools.readthedocs.io/en/develop/index.html"&gt;deepTools&lt;/a&gt;でも&lt;code&gt;​bamCoverage&lt;/code&gt;や​&lt;code&gt;​bamComapre&lt;/code&gt;機能を使ってbigwigを作ることができる。挙動や使い所の違いを比較しようというのが今回の目的。&lt;/p&gt;
&lt;p&gt;ちなみに、通常のChIP-seq解析ならMACS2,HOMERなどを使ってやるのが無難かと思います。今回はdeeptToolsと戯れたかった。&lt;/p&gt;
&lt;h2&gt;Install&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ conda install -c bioconda deeptools

$ conda create -n py27_macs2 &lt;span class="nv"&gt;python&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;.7.5
$ conda activate py27_macs2
$ conda install -c bioconda macs2
$ conda install -c bioconda bedtools
$ conda install -c bioconda ucsc-bedgraphtobigwig
$ conda install -c bioconda ucsc-bedclip
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;condaでmacs2を入れようとするとxonshとdependency conflictしてしまった。諦めて仮想環境を作る。condaは入ってる前提。MACS2はいまだにpython2な時点で腰が引けるが、先に進む。&lt;/p&gt;
&lt;p&gt;※ python2.7.4以前だとエラーを吐くらしいので、python2.7.5にしてある。今考えると2.7.15でも良かったかもしれない。&lt;/p&gt;
&lt;h2&gt;今回使うsample&lt;/h2&gt;
&lt;p&gt;うちのラボの論文のデータを使ってみます。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Kitagawa, Y. et al. Guidance of regulatory T cell development by Satb1-dependent super-enhancer establishment. Nat. Immunol. 18, (2016).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ここからH3K27acのTregとTconvを使ってみます。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;SRR ID&lt;/th&gt;
&lt;th&gt;sample&lt;/th&gt;
&lt;th&gt;replicate&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;SRR5385260&lt;/td&gt;
&lt;td&gt;input&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;SRR5385344&lt;/td&gt;
&lt;td&gt;Treg H3K27ac&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;SRR5385345&lt;/td&gt;
&lt;td&gt;Treg H3K27ac&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;SRR5385346&lt;/td&gt;
&lt;td&gt;Tconv H3K27ac&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;SRR5385347&lt;/td&gt;
&lt;td&gt;Tconv H3K27ac&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;これらをお馴染みpfastq-dumpをつかって落としてきます。今回はSingle-endなのでsplitはいりません。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ mkdir data
$ prefetch SRR5385260 SRR5385344 SRR5385345 SRR5385346 SRR5385347
$ bash pfd.sh
$ fastqc -t &lt;span class="m"&gt;22&lt;/span&gt; -o data data/*.fastq
$ multiqc -n multiqc_report_raw.html ./data
$ bash make_bam.sh
$ fastqc -t &lt;span class="m"&gt;22&lt;/span&gt; -o data data/*.trimmed.fastq
$ multiqc -n multiqc_report_trimmed.html ./data
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;pdf.sh&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="ch"&gt;#!/bin/bash&lt;/span&gt;

&lt;span class="nv"&gt;sras&lt;/span&gt;&lt;span class="o"&gt;=(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;SRR5385260&amp;quot;&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;SRR5385344&amp;quot;&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;SRR5385345&amp;quot;&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;SRR5385346&amp;quot;&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;SRR5385347&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; s &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;sras&lt;/span&gt;&lt;span class="p"&gt;[@]&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;do&lt;/span&gt;
pfastq-dump --threads &lt;span class="m"&gt;22&lt;/span&gt; --outdir data ~/ncbi/public/sra/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;s&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.sra
&lt;span class="k"&gt;done&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;make_bam.sh&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="ch"&gt;#!/bin/bash&lt;/span&gt;

&lt;span class="nv"&gt;sras&lt;/span&gt;&lt;span class="o"&gt;=(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;SRR5385260&amp;quot;&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;SRR5385344&amp;quot;&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;SRR5385345&amp;quot;&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;SRR5385346&amp;quot;&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;SRR5385347&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; s &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;sras&lt;/span&gt;&lt;span class="p"&gt;[@]&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;do&lt;/span&gt;
trimmomatic &lt;span class="se"&gt;\&lt;/span&gt;
    SE                  &lt;span class="se"&gt;\&lt;/span&gt;
    -threads &lt;span class="m"&gt;22&lt;/span&gt;         &lt;span class="se"&gt;\&lt;/span&gt;
    -phred33            &lt;span class="se"&gt;\&lt;/span&gt;
    -trimlog log.&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;s&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.txt    &lt;span class="se"&gt;\&lt;/span&gt;
    data/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;s&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.fastq            &lt;span class="se"&gt;\&lt;/span&gt;
    data/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;s&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.trimmed.fastq          &lt;span class="se"&gt;\&lt;/span&gt;
    ILLUMINACLIP:adapters.fa:2:10:10  &lt;span class="se"&gt;\&lt;/span&gt;
    LEADING:20 &lt;span class="se"&gt;\&lt;/span&gt;
    TRAILING:20 &lt;span class="se"&gt;\&lt;/span&gt;
    MINLEN:30
bowtie2 -p &lt;span class="m"&gt;22&lt;/span&gt; -x ~/ref_sequence/bowtie2_indexes/mm10 -U data/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;s&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.trimmed.fastq -S data/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;s&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.trimmed.sam &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;gt&lt;span class="p"&gt;;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&lt;/span&gt; data/out.&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;s&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.txt
samtools sort -O bam -o data/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;s&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.trimmed.bam data/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;s&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.trimmed.sam
samtools index data/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;s&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.trimmed.bam data/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;s&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.trimmed.bai
&lt;span class="k"&gt;done&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;改行とコメントがうまく共存できなかったので、以下に注釈付きを示す。より詳しいことはおなじみ&lt;a href="https://bi.biopapyrus.jp/rnaseq/qc/trimmomatic.html"&gt;biopnpyrus&lt;/a&gt;を参照。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;trimmomatic \
    SE                  \  # single-end
    -threads 22         \  # スレッド数
    -phred33            \  # phred33 または -phred64 を指定
    -trimlog log.&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;.txt    \  # 実行ログの保存先
    data/&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;.fastq            \  # 入力 FASTQ
    data/&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;.trimmed.fastq          \  # 出力 FASTQ
    ILLUMINACLIP:adapters.fa:2:10:10  \ # アダプター除去条件の指定
    LEADING:20 \
    TRAILING:20 \
    MINLEN: 30   # 30bp を満たさないリードを除去
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;これでbamファイルが出来ているはず。&lt;/p&gt;
&lt;p&gt;igvで表示してみるとこんな感じ。
&lt;img alt="1" src="{attach}images/macs2_deeptools_figs/screenshot-from-2018-10-28-20-04-52.png"&gt;&lt;/p&gt;
&lt;h3&gt;補足 prefetchのoutputを変更する方法（Yoshiharaさんより）&lt;/h3&gt;
&lt;p&gt;デフォルトではプロジェクトのディレクトリの外にsraファイルを保存してしまう。また、データ用のストレージを分けている際もそちらに書き出してやりたい。そこでprefetchのoutputを変更したいという話になるわけだが、やり方は2つ。&lt;/p&gt;
&lt;h4&gt;1)&lt;/h4&gt;
&lt;p&gt;&lt;a href="https://github.com/ncbi/sra-tools/wiki/Toolkit-Configuration"&gt;Toolkit-Configuration&lt;/a&gt;をいじる方法。
公式にはこちらが推奨らしいが操作が面倒。&lt;/p&gt;
&lt;h4&gt;2)&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nb"&gt;echo&lt;/span&gt; ‘/repository/user/main/public/root &lt;span class="o"&gt;=&lt;/span&gt; “/outputDir”‘ &amp;gt; ~/.ncbi/user-settings.mkfg
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;こっちのほうが簡単。outputDirに指定してやって下さい。
この例だとpfastq-dumpでは&lt;code&gt;~/ncbi/public/sra/${s}.sra&lt;/code&gt; が &lt;code&gt;/outputDir/sra/${s}.sra&lt;/code&gt;になりますね。&lt;/p&gt;
&lt;h2&gt;MACS2によるピークコール&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;Zhang, Y. et al. Model-based Analysis of ChIP-Seq (MACS). Genome Biol. 9, R137 (2008).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ChIP-seq解析の定番ツールであるMACS2を使う。説明は&lt;a href="https://github.com/taoliu/MACS/wiki"&gt;公式wiki&lt;/a&gt;が詳しい。bigwigはpeakcallの副産物的な扱いで、メインはChIP-seqのピーク情報。bigwigは少し回りくどい作り方が必要。詳しくは&lt;a href="https://github.com/taoliu/MACS/wiki/Build-Signal-Track"&gt;こちら&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;まずはbdg2bwを用意する。&lt;code&gt;~/Programs&lt;/code&gt;はpathの通ったディレクトリとする。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ vim ~/Programs/bdg2bw &lt;span class="c1"&gt;# emacsでも。中身は以下。&lt;/span&gt;
$ chmod &lt;span class="m"&gt;755&lt;/span&gt; ~/Programs/bdg2bw
$ wget http://hgdownload.cse.ucsc.edu/goldenPath/mm10/database/chromInfo.txt.gz
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;bdg2bw&lt;/code&gt;の中身は以下。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="ch"&gt;#!/bin/bash&lt;/span&gt;

&lt;span class="c1"&gt;# check commands: slopBed, bedGraphToBigWig and bedClip&lt;/span&gt;

which bedtools &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&amp;amp;&lt;/span&gt;gt&lt;span class="p"&gt;;&lt;/span&gt;/dev/null &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;bedtools not found! Download bedTools: &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="nb"&gt;exit&lt;/span&gt; &lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;
which bedGraphToBigWig &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&amp;amp;&lt;/span&gt;gt&lt;span class="p"&gt;;&lt;/span&gt;/dev/null &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;bedGraphToBigWig not found! Download: &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="nb"&gt;exit&lt;/span&gt; &lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;
which bedClip &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&amp;amp;&lt;/span&gt;gt&lt;span class="p"&gt;;&lt;/span&gt;/dev/null &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;bedClip not found! Download: &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="nb"&gt;exit&lt;/span&gt; &lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="c1"&gt;# end of checking&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt; &lt;span class="nv"&gt;$#&lt;/span&gt; -lt &lt;span class="m"&gt;2&lt;/span&gt; &lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
    &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Need 2 parameters!  &amp;quot;&lt;/span&gt;
    &lt;span class="nb"&gt;exit&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;

&lt;span class="nv"&gt;F&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;
&lt;span class="nv"&gt;G&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nv"&gt;$2&lt;/span&gt;

bedtools slop -i &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;F&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; -g &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;G&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; -b &lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; bedClip stdin &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;G&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;F&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.clip

&lt;span class="nv"&gt;LC_COLLATE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;C sort -k1,1 -k2,2n &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;F&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.clip &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;gt&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;F&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.sort.clip

bedGraphToBigWig &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;F&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.sort.clip &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;G&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;F&lt;/span&gt;&lt;span class="p"&gt;/bdg/bw&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;

rm -f &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;F&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.clip &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;F&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.sort.clip
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;これで実行準備が整った。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ conda activate py27_macs2
$ mkdir macs2 &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="nb"&gt;cd&lt;/span&gt; macs2
$ macs2 callpeak -t ../data/SRR5385344.trimmed.bam -c ../data/SRR5385260.trimmed.bam -g mm -n Treg_H3K27ac_1 -p 1e-5 -f BAM -B --nomodel &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;gt&lt;span class="p"&gt;;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&lt;/span&gt; macs.SRR5385344.out &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&lt;/span&gt; bdg2bw Treg_H3K27ac_1_treat_pileup.bdg ../chromInfo.txt
$ macs2 callpeak -t ../data/SRR5385345.trimmed.bam -c ../data/SRR5385260.trimmed.bam -g mm -n Treg_H3K27ac_2 -p 1e-5 -f BAM -B --nomodel &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;gt&lt;span class="p"&gt;;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&lt;/span&gt; macs.SRR5385345.out &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&lt;/span&gt; bdg2bw Treg_H3K27ac_2_treat_pileup.bdg ../chromInfo.txt
$ macs2 callpeak -t ../data/SRR5385346.trimmed.bam -c ../data/SRR5385260.trimmed.bam -g mm -n Tconv_H3K27ac_1 -p 1e-5 -f BAM -B --nomodel &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;gt&lt;span class="p"&gt;;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&lt;/span&gt; macs.SRR5385346.out &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&lt;/span&gt; bdg2bw Tconv_H3K27ac_1_treat_pileup.bdg ../chromInfo.txt
$ macs2 callpeak -t ../data/SRR5385347.trimmed.bam -c ../data/SRR5385260.trimmed.bam -g mm -n Tconv_H3K27ac_2 -p 1e-5 -f BAM -B --nomodel &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;gt&lt;span class="p"&gt;;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&lt;/span&gt; macs.SRR5385347.out &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&amp;amp;&lt;/span&gt;amp&lt;span class="p"&gt;;&lt;/span&gt; bdg2bw Tconv_H3K27ac_2_treat_pileup.bdg ../chromInfo.txt
$ &lt;span class="nb"&gt;cd&lt;/span&gt; ..
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;-B&lt;/code&gt;でbdgというbedgraphファイルを保存するかどうか。
&lt;code&gt;--nomodel&lt;/code&gt;はshifting modelを作るかどうか。defaultでshiftは100。
実際はigvにはbdgファイルも読み込めてしまうので、特にbigwigにする必要はなかった。&lt;/p&gt;
&lt;h2&gt;deepToolsによるbwファイルの生成&lt;/h2&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}images/macs2_deeptools_figs/start_workflow1.png"&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Ramírez, F. et al. deepTools2: a next generation web server for deep-sequencing data analysis. Nucleic Acids Res. 44, W160–W165 (2016).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;MAX PLANCK INSTITUTE製のツールで、ChIP-seq, RNA-seq, MNase-seqなどに使えるツールとされている。多サンプルの比較などに向いている。QCや美しいvisualizationが可能。さらにdeepBlueの大量のデータも使える。CLIではもちろんのこと、Galaxyにも対応しているので、そちらでもいいし、Pythonで書かれていてAPIのドキュメントも手厚いのでそちらを使ってもいい。（ちょっとむずかしい。）&lt;/p&gt;
&lt;p&gt;今回はinputがあるので&lt;code&gt;bamCompare&lt;/code&gt;を使う。log2ratioがbwファイルに出力される。果たしていけるのか。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;bamCompare&lt;/code&gt;は&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;サンプルごとのスケーリング、depthの正規化&lt;/li&gt;
&lt;li&gt;operation(defaultはlog2ratio)&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;を行う。binはdefaultで50bp。log2ratioの代わりにlog2, ratio, subtract, add, mean, reciprocal_ratio, first, secondを取得することもできる。今回はsubtract(差分)も合わせて取得してみる。macs2と違ってmultiprocessも動くが、bamのindexが先に必要。macs2に比べるととてもsimpleでよい。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ mkdir deepTools    
$ bamCompare -p &lt;span class="m"&gt;22&lt;/span&gt; -b1 ./data/SRR5385344.trimmed.bam -b2 ./data/SRR5385260.trimmed.bam -o deepTools/Treg_H3K27ac_1_log2ratio.bw
$ bamCompare -p &lt;span class="m"&gt;22&lt;/span&gt; -b1 ./data/SRR5385345.trimmed.bam -b2 ./data/SRR5385260.trimmed.bam -o deepTools/Treg_H3K27ac_2_log2ratio.bw
$ bamCompare -p &lt;span class="m"&gt;22&lt;/span&gt; -b1 ./data/SRR5385346.trimmed.bam -b2 ./data/SRR5385260.trimmed.bam -o deepTools/Tconv_H3K27ac_1_log2ratio.bw
$ bamCompare -p &lt;span class="m"&gt;22&lt;/span&gt; -b1 ./data/SRR5385347.trimmed.bam -b2 ./data/SRR5385260.trimmed.bam -o deepTools/Tconv_H3K27ac_2_log2ratio.bw

$ bamCompare -p &lt;span class="m"&gt;22&lt;/span&gt; --operation subtract -b1 ./data/SRR5385344.trimmed.bam -b2 ./data/SRR5385260.trimmed.bam -o deepTools/Treg_H3K27ac_1_subtract.bw
$ bamCompare -p &lt;span class="m"&gt;22&lt;/span&gt; --operation subtract -b1 ./data/SRR5385345.trimmed.bam -b2 ./data/SRR5385260.trimmed.bam -o deepTools/Treg_H3K27ac_2_subtract.bw
$ bamCompare -p &lt;span class="m"&gt;22&lt;/span&gt; --operation subtract -b1 ./data/SRR5385346.trimmed.bam -b2 ./data/SRR5385260.trimmed.bam -o deepTools/Tconv_H3K27ac_1_subtract.bw
$ bamCompare -p &lt;span class="m"&gt;22&lt;/span&gt; --operation subtract -b1 ./data/SRR5385347.trimmed.bam -b2 ./data/SRR5385260.trimmed.bam -o deepTools/Tconv_H3K27ac_2_subtract.bw
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;※ 181107 subtractのoutput fileが間違えていたので修正しました。（Yoshiharaさんより）&lt;/p&gt;
&lt;h2&gt;igvによる比較&lt;/h2&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}images/macs2_deeptools_figs/screenshot-from-2018-10-28-20-36-19.png"&gt;&lt;/p&gt;
&lt;p&gt;上からmacs2, deepTools subtract, deepTools log2 fold changeになっている。macs2の結果はdeepToolsのsubtractに近いことがわかる。&lt;/p&gt;
&lt;p&gt;macs2のsummits.bedとnarrowPeakも表示してみた（下2つ）。これはこれで取り回しが効いて良い。narrowPeakはp valueに応じて色が変わっている。&lt;/p&gt;
&lt;p&gt;deepToolsが少しギザギザしているように見えるが、binを変えると細かくできる。&lt;/p&gt;
&lt;h2&gt;おまけ：deepToolsによる可視化&lt;/h2&gt;
&lt;p&gt;最後に、deepToolsの豊富な可視化機能の一部を試してみる。まず、&lt;a href="http://genome.ucsc.edu/cgi-bin/hgTables"&gt;UCSC&lt;/a&gt;よりmm10の遺伝子のbedを取得する。bigwigを用いた可視化は&lt;code&gt;computeMatrix&lt;/code&gt;した後&lt;code&gt;plotHeatmap&lt;/code&gt;などである。log2 fold changeのbigwigを用いて全遺伝子についてH3K27acのheatmapを書き、クラスタリングも同時にしてみる。全遺伝子についてなので&lt;code&gt;computeMatrix&lt;/code&gt;がとても重たくなってしまった。Tconvについては今回は省略。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ computeMatrix scale-regions &lt;span class="se"&gt;\&lt;/span&gt;
-S Treg_H3K27ac_1_log2ratio.bw Treg_H3K27ac_2_log2ratio.bw &lt;span class="se"&gt;\&lt;/span&gt;
-R mm10.genes.bed &lt;span class="se"&gt;\&lt;/span&gt;
--beforeRegionStartLength &lt;span class="m"&gt;3000&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
--regionBodyLength &lt;span class="m"&gt;5000&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
--afterRegionStartLength &lt;span class="m"&gt;3000&lt;/span&gt; --skipZeros -o matrix.mat.Treg.gz -p &lt;span class="m"&gt;8&lt;/span&gt;

&lt;span class="c1"&gt;# 赤が正になってほしいので_rでリバースする。&lt;/span&gt;
$ plotHeatmap -m matrix.mat.Treg.gz -out Heatmap.png &lt;span class="se"&gt;\&lt;/span&gt;
--colorMap RdYlBu_r --zMin -3 --zMax &lt;span class="m"&gt;3&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
--kmeans &lt;span class="m"&gt;4&lt;/span&gt; --samplesLabel Treg_H3K27ac_1  Treg_H3K27ac_2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img alt="1" src="{attach}images/macs2_deeptools_figs/heatmap-3.png"&gt;&lt;/p&gt;
&lt;p&gt;plotHeatmapのクラスタリングは複数のサンプルがある時は１つ目のサンプルでクラスタリングするみたい。せっかく他のサンプルもあるのだから、いろいろ混ぜてクラスタリングできたらいいな。
colormapは&lt;a href="https://matplotlib.org/examples/color/colormaps_reference.html"&gt;matplotlibでおなじみのもの&lt;/a&gt;である。fontsizeは変更する方法は見つからなかった。これは結構困りどころ。強いて言うならissueで自分で書いてみてねとの&lt;a href="https://github.com/deeptools/deepTools/issues/444"&gt;回答&lt;/a&gt;があった。&lt;/p&gt;
&lt;p&gt;deepToolsに関して、いつもお世話になっている&lt;a href="http://kazumaxneo.hatenablog.com/entry/2018/06/25/210934"&gt;macでインフォマティクス&lt;/a&gt;さんにも記事があった。とても詳しい。他にもいろいろな機能があったので是非。&lt;/p&gt;
&lt;h2&gt;感想&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;macs2はpeakcallを目的にしていて、副産物としてbigwigやbdgが出力される。deepToolsは複数のChIP-seqデータなどを扱うのに長けている。逆にdeepToolsはpeak call機能がない。&lt;/li&gt;
&lt;li&gt;deepToolsはIHECのQCに使われていたり、bw作成後のdownstream解析もできたり、&lt;a href="https://www.nature.com/articles/s41467-018-02866-0"&gt;RamDA-seq&lt;/a&gt;の解析に使われていたりと、頼れるツールの様なので、早いうちにマスターしようと思う。&lt;/li&gt;
&lt;li&gt;TregとTconvのデータを用意した割にはTreg-specific peaksを見るところまでは手が回らなかった。（論文読めば書いてあるが。)特異的ピーク検出をするなら&lt;a href="http://homer.ucsd.edu/homer/ngs/index.html"&gt;HOMER&lt;/a&gt;が安定感があって良さそうな。&lt;/li&gt;
&lt;li&gt;ChIP-seq解析のいい練習になりました。&lt;/li&gt;
&lt;li&gt;multi-omics人材になるぞ！&lt;/li&gt;
&lt;/ul&gt;</content><category term="技術ブログ"></category><category term="Bioinformatics"></category></entry><entry><title>GitHub desktopアプリの使い方</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/10/github_desktop.html" rel="alternate"></link><published>2018-10-28T00:00:00+09:00</published><updated>2018-10-28T00:00:00+09:00</updated><author><name>安水</name></author><id>tag:None,2018-10-28:/previews/refs/heads/general/jinja2_version/blog/2018/10/github_desktop.html</id><summary type="html">&lt;p&gt;githubとはなにかの説明は省略しています。githubについて知らない人は先にいろいろ調べてみましょう。今回は&lt;a href="https://desktop.github.com/"&gt;github desktop&lt;/a&gt;についてです。&lt;/p&gt;
&lt;h2&gt;レポジトリの読み込み（プロジェクト開始時の一回のみ。）&lt;/h2&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}images/github_desktop_figs/2018_10_1.png"&gt;&lt;/p&gt;
&lt;p&gt;github上のレポジトリとLocal pathを指定。&lt;/p&gt;
&lt;p&gt;&lt;img alt="2" src="{attach}images/github_desktop_figs/2018_10_2.png"&gt;&lt;/p&gt;
&lt;p&gt;これでうまくcloneされていたらOK&lt;/p&gt;
&lt;hr&gt;
&lt;h2&gt;毎回の流 …&lt;/h2&gt;</summary><content type="html">&lt;p&gt;githubとはなにかの説明は省略しています。githubについて知らない人は先にいろいろ調べてみましょう。今回は&lt;a href="https://desktop.github.com/"&gt;github desktop&lt;/a&gt;についてです。&lt;/p&gt;
&lt;h2&gt;レポジトリの読み込み（プロジェクト開始時の一回のみ。）&lt;/h2&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}images/github_desktop_figs/2018_10_1.png"&gt;&lt;/p&gt;
&lt;p&gt;github上のレポジトリとLocal pathを指定。&lt;/p&gt;
&lt;p&gt;&lt;img alt="2" src="{attach}images/github_desktop_figs/2018_10_2.png"&gt;&lt;/p&gt;
&lt;p&gt;これでうまくcloneされていたらOK&lt;/p&gt;
&lt;hr&gt;
&lt;h2&gt;毎回の流れ(基本編)&lt;/h2&gt;
&lt;p&gt;一日の作業の初めにFetchしてきて、最新の状態に同期する。&lt;/p&gt;
&lt;p&gt;&lt;img alt="3" src="{attach}images/github_desktop_figs/2018_10_3.png"&gt;&lt;/p&gt;
&lt;p&gt;ファイルを変更、加筆すると自動的にアプリに反映される&lt;/p&gt;
&lt;p&gt;&lt;img alt="4" src="{attach}images/github_desktop_figs/2018_10_4.png"&gt;&lt;/p&gt;
&lt;p&gt;作業の区切りがついたら左下のSummeryに適当にコメントを付け、commit to master。
コメントはもうちょっと丁寧に付けましょう。。。&lt;/p&gt;
&lt;p&gt;&lt;img alt="5" src="{attach}images/github_desktop_figs/2018_10_5.png"&gt;&lt;/p&gt;
&lt;p&gt;pushして変更を反映させる。&lt;/p&gt;
&lt;p&gt;&lt;img alt="6" src="{attach}images/github_desktop_figs/2018_10_6.png"&gt;&lt;/p&gt;
&lt;p&gt;まとめると、&lt;strong&gt;fetch(pull) -&amp;gt; commit -&amp;gt; push&lt;/strong&gt; のライフライクルです。&lt;/p&gt;
&lt;h2&gt;CLIでの操作&lt;/h2&gt;
&lt;p&gt;デスクトップアプリはwin,macではあるが、Ubuntuでは無いらしいので、同じ作業をCLIでやる必要がある。ただし、基本は同じで&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ git pull origin master
$ git add --all
$ git commit -m &lt;span class="s2"&gt;&amp;quot;コメント&amp;quot;&lt;/span&gt;
$ git push origin master
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;って感じでやればOK。branchやmerge、プルリクエストについては触れていません。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="GitHub"></category></entry><entry><title>LinuxでのBioinformatics環境構築</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/10/environment_bioinformatics.html" rel="alternate"></link><published>2018-10-16T00:00:00+09:00</published><updated>2018-10-16T00:00:00+09:00</updated><author><name>平岡</name></author><id>tag:None,2018-10-16:/previews/refs/heads/general/jinja2_version/blog/2018/10/environment_bioinformatics.html</id><summary type="html">&lt;p&gt;ただいま、私のMacbook Proが入院しておりまして、古いWindows10をUbuntuとデュアルブートして作業しております。下級生でもWindowsしか持っていない、でもBioinformaticsに関心があるという人が、スムーズに環境構築できるようにと今回の記事を書きます。なお、前提 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;ただいま、私のMacbook Proが入院しておりまして、古いWindows10をUbuntuとデュアルブートして作業しております。下級生でもWindowsしか持っていない、でもBioinformaticsに関心があるという人が、スムーズに環境構築できるようにと今回の記事を書きます。なお、前提として、Ubuntuのインストールが完了しているものとします。なお、筆者のインストールしたUbuntuは18.04.1 LTSです。&lt;/p&gt;
&lt;p&gt;今回は&lt;a href="https://oumpy.github.io/articles/2018/10/kallisto_rnaseq_pipeline.html"&gt;Kallistoを用いたRNA-seq解析パイプライン&lt;/a&gt;で使う、RNA-seq系のツールのインストールを行っていきますが、順次別の解析目的のツールインストールも紹介したいと考えております。今回の環境構築で、Kallistoを用いたRNA-seq解析パイプラインに進むことができます。&lt;/p&gt;
&lt;h2&gt;Pythonのインストール&lt;/h2&gt;
&lt;p&gt;Ubuntuのバージョンによってはpython2.7がデフォルトとなっている場合もあるので、python3系をダウンロードし、デフォルトに設定しよう。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# check the version of python.&lt;/span&gt;
$ python --version
&amp;gt;&amp;gt;&amp;gt; Python &lt;span class="m"&gt;2&lt;/span&gt;.7.15rc1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;Biocondaのインストール&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://www.anaconda.com/download/#macos"&gt;Anaconda&lt;/a&gt;のインストーラーをダウンロードします。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ bash ~/Downloads/Anaconda3-4.1.0-Linux-x86_64.sh
$ &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;export PATH=/home/user/anaconda3/bin:$PATH&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;gt&lt;span class="p"&gt;;&amp;amp;&lt;/span&gt;gt&lt;span class="p"&gt;;&lt;/span&gt; ~/.bashrc
$ conda -V
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ python --version
&amp;gt;&amp;gt;&amp;gt; Python &lt;span class="m"&gt;3&lt;/span&gt;.6.6+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;バイオインフォマティクスの分野では解析のために様々なツールを利用しますが、インストールのたびにパスを通すなどの作業をしていると大変煩雑ですし、バージョン管理もしにくくなります。パッケージマネージャーを使ってツールを一元管理するのが賢明です。
Homebrewなどのパッケージ管理システムは有名ですが、対応していないツールの多く、現状はBiocondaというパッケージマネージャーがおすすめです。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# Download a Miniconda package for linux python3&lt;/span&gt;
$ wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
$ bash Miniconda3-latest-Linux-x86_64.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;EnterやYesを入力していくとインストールが終了し、パスも通った状態になります。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# condaコマンドが正常に動作していれば成功です。（terminalを開き直しましょう。）&lt;/span&gt;
$ conda -h
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;biocondaのチャンネルを追加。biocondaチャンネルが最上位に来るように設定。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ conda config --add channels conda-forge
$ conda config --add channels defaults
$ conda config --add channels r
$ conda config --add channels bioconda
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;それでは早速ツールをインストールしていきましょう。基本 &lt;code&gt;conda install ???&lt;/code&gt;でインストールが完了し正常に動作していきます。非常に便利ですね。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ conda install parallel-fastq-dump
$ conda install fastqc
$ conda install multiqc
$ conda install trimmomatic
$ conda install kallisto
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;参照&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://imamachi-n.hatenablog.com/entry/2017/01/14/212719"&gt;http://imamachi-n.hatenablog.com/entry/2017/01/14/212719&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Rツールのインストール&lt;/h2&gt;
&lt;p&gt;Rのコンソールを開いて、Rのツールをインストールしていきます。
Tximportのインストール&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;source&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;https://bioconductor.org/biocLite.R&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;biocLite&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;tximport&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;DESeq2のインストール&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;source&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;https://bioconductor.org/biocLite.R&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;biocLite&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;DESeq2&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;参照&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://bioconductor.org/packages/release/bioc/html/tximport.html"&gt;https://bioconductor.org/packages/release/bioc/html/tximport.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://bioconductor.org/packages/release/bioc/html/DESeq2.html"&gt;https://bioconductor.org/packages/release/bioc/html/DESeq2.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><category term="技術ブログ"></category><category term="Bioinformatics"></category></entry><entry><title>Kallistoを用いたRNA-seq解析パイプライン</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/10/kallisto_rnaseq_pipeline.html" rel="alternate"></link><published>2018-10-16T00:00:00+09:00</published><updated>2018-10-16T00:00:00+09:00</updated><author><name>平岡</name></author><id>tag:None,2018-10-16:/previews/refs/heads/general/jinja2_version/blog/2018/10/kallisto_rnaseq_pipeline.html</id><summary type="html">&lt;p&gt;今回はKallistoを用いたRNA-seq解析パイプラインを紹介します。&lt;a href="https://oumpy.github.io/articles/2018/10/environment_bioinformatics.html"&gt;LinuxでのBioinformatics環境構築&lt;/a&gt;でこの記事への準備はすべて終了している流れになります。&lt;a href="https://ja.wikipedia.org/wiki/%E3%82%AB%E3%83%AA%E3%82%B9%E3%83%88_(%E5%B0%8F%E6%83%91%E6%98%9F)"&gt;Kallisto&lt;/a&gt;は小惑星の名前のようです。つっこみどこ …&lt;/p&gt;</summary><content type="html">&lt;p&gt;今回はKallistoを用いたRNA-seq解析パイプラインを紹介します。&lt;a href="https://oumpy.github.io/articles/2018/10/environment_bioinformatics.html"&gt;LinuxでのBioinformatics環境構築&lt;/a&gt;でこの記事への準備はすべて終了している流れになります。&lt;a href="https://ja.wikipedia.org/wiki/%E3%82%AB%E3%83%AA%E3%82%B9%E3%83%88_(%E5%B0%8F%E6%83%91%E6%98%9F)"&gt;Kallisto&lt;/a&gt;は小惑星の名前のようです。つっこみどころありましたら、コメントいただけると嬉しいです！それではいきましょう！&lt;/p&gt;
&lt;h2&gt;リファレンスのダウンロード&lt;/h2&gt;
&lt;p&gt;kallistoでは、transcriptにシュードアラインメントするので、リファレンスにはcDNAを用います。今回は&lt;a href="https://www.gencodegenes.org/"&gt;GenCodeGenes&lt;/a&gt;のヒトtranscript sequencesのデータを用いました。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ wget ftp://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_29/gencode.v29.transcripts.fa.gz
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;FASTQファイルをダウンロードする場合&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://www.ebi.ac.uk/arrayexpress/"&gt;ArrayExpress&lt;/a&gt;からFASTQファイルをダウンロード、解凍する。今回のデータは、ヒトES細胞と成熟膵島細胞のデータ。single-end readとなっている。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ wget ftp://ftp.sra.ebi.ac.uk/vol1/fastq/ERR266/ERR266335/ERR266335.fastq.gz
$ gunzip ERR266335.fastq.gz
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;ERR266349 ERR266351 ERR266338 ERR266347についても同様に！&lt;/p&gt;
&lt;h3&gt;参照：&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;次世代シークエンサーDRY解析教本 (細胞工学別冊)&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;SRAファイルをダウンロードする場合&lt;/h2&gt;
&lt;p&gt;DDBJの&lt;a href="https://ddbj.nig.ac.jp/DRASearch/"&gt;DRA search&lt;/a&gt;からSRAファイルをダウンロード、SRAファイルをFASTQに変換する。pfast-dumpで .sraをペアエンド.fastqに変換。 (&lt;strong&gt;kallistoはsraファイルを扱えない&lt;/strong&gt; ので、pfastq-dumpでfastqに変換する必要がある。）&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="ch"&gt;#!/bin/bash&lt;/span&gt;
&lt;span class="c1"&gt;# download sra files.&lt;/span&gt;
mkdir sra-fastq
&lt;span class="nv"&gt;id&lt;/span&gt;&lt;span class="o"&gt;=(&lt;/span&gt;ERR266335 ERR266337 ERR266338 ERR266347 ERR266349 ERR266351&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; item &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;id&lt;/span&gt;&lt;span class="p"&gt;[@]&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;do&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; start download &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;item&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.sra
wget ftp://ftp.ddbj.nig.ac.jp/ddbj_database/dra/sralite/ByExp/litesra/ERX/ERX182/ERX182652/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;item&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;item&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.sra
pfastq-dump -s &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;item&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; -t &lt;span class="m"&gt;8&lt;/span&gt; -O sra-fastq
&lt;span class="k"&gt;done&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;pfastq-dumpのオプション&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;-s&lt;/code&gt; : SRAファイルのID&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-t&lt;/code&gt; : スレッド数&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-O&lt;/code&gt; : 出力ファイル&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;今回はSRAファイルのダウンロードとpfastq-dumpを使ってsraをfastqに変換する処理をシェルスクリプトを使って行いました。共通項のあるかつ時間のかかるterminalでの処理はシェルスクリプトを使うと便利です。&lt;/p&gt;
&lt;h3&gt;SRAファイルとは？&lt;/h3&gt;
&lt;p&gt;Sequence Read Archiveの略。（かつてはNGSにリードが短い特徴があったのでShort Read Archiveと呼ばれていた。）NGSの登場により配列の品質情報を塩基配列とともに記述形式であるFASTQ形式が使用されるようになった時にできたバイナリ形式のデータフォーマット。よってpfastq-dumpなどのツールでFASTQに変換することができる。&lt;a href="https://en.wikipedia.org/wiki/International_Nucleotide_Sequence_Database_Collaboration"&gt;INSDC&lt;/a&gt;、&lt;a href="https://en.wikipedia.org/wiki/European_Bioinformatics_Institute"&gt;EBI&lt;/a&gt;、&lt;a href="https://en.wikipedia.org/wiki/DNA_Data_Bank_of_Japan"&gt;DDBJ&lt;/a&gt;が共同で運営しているデータベース&lt;a href="https://en.wikipedia.org/wiki/Sequence_Read_Archive"&gt;SRA&lt;/a&gt;に保存してある。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ less ERR266335.sra
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;バイナリデータなので、SRAファイルの中をのぞいてみると下のようになる。
&lt;img alt="1" src="{attach}images/kallisto_rnaseq_pipeline_figs/screen-shot-2018-10-31-at-19-29-38.png"&gt;&lt;/p&gt;
&lt;h3&gt;pfastq-dumpとは？&lt;/h3&gt;
&lt;p&gt;fastq-dumpを並列処理するbashスクリプト。Sequence Read Archive（wiki）からダウンロードされたシーケンスデータ（SRAフォーマット ）をfastq-dumpの並列処理で素早くfastqに変換することができる。&lt;a href="https://github.com/inutanoOhta"&gt;Ohta&lt;/a&gt;さんが公開されている。&lt;/p&gt;
&lt;h2&gt;Fastqc&lt;/h2&gt;
&lt;p&gt;クオリティチェック。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="ch"&gt;#!/bin/bash&lt;/span&gt;
&lt;span class="nv"&gt;id&lt;/span&gt;&lt;span class="o"&gt;=(&lt;/span&gt;ERR266335 ERR266337 ERR266338 ERR266347 ERR266349 ERR266351&lt;span class="o"&gt;)&lt;/span&gt;
mkdir fastqc
&lt;span class="k"&gt;for&lt;/span&gt; item &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;id&lt;/span&gt;&lt;span class="p"&gt;[@]&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;do&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; start quality check &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;item&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;
mkdir fastqc/fastqc_&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;item&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;
fastqc -t &lt;span class="m"&gt;8&lt;/span&gt; -o fastqc/fastqc_&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;item&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; sra-fastq/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;item&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.fastq -f fastq
&lt;span class="k"&gt;done&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;sra-fastq/${item}.fastq&lt;/code&gt;がインプットファイル。
fastqcのオプションについて&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;-t&lt;/code&gt; : スレッド数。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-O&lt;/code&gt; : 解析結果の保存先のディレクトリを指定する。今回はfastqcというディレクトリを作ってそこに入れている。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-f&lt;/code&gt; : インプットファイルのフォーマット。bam, samにも対応。.fastq.gzもfastqで指定する。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;実行結果は下記のようになる。&lt;/p&gt;
&lt;p&gt;&lt;img alt="2" src="{attach}images/kallisto_rnaseq_pipeline_figs/screen-shot-2018-10-31-at-19-58-17.png"&gt;&lt;/p&gt;
&lt;p&gt;fastqcディレクトリをのぞいてみる。fastqcのなかに&lt;code&gt;fastqc_${item}&lt;/code&gt;というディレクトリが自動生成されている。&lt;/p&gt;
&lt;p&gt;&lt;img alt="3" src="{attach}images/kallisto_rnaseq_pipeline_figs/screen-shot-2018-10-31-at-20-05-02.png"&gt;&lt;/p&gt;
&lt;p&gt;fastqc_ERR266335の中をのぞいてみると。htmlファイルとzipファイルが生成されている。&lt;/p&gt;
&lt;p&gt;&lt;img alt="4" src="{attach}images/kallisto_rnaseq_pipeline_figs/screen-shot-2018-10-31-at-20-07-03.png"&gt;&lt;/p&gt;
&lt;p&gt;htmlファイルをブラウザで開くことができる。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ open ERR266335_fastqc.html
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img alt="5" src="{attach}images/kallisto_rnaseq_pipeline_figs/screen-shot-2018-10-31-at-20-09-37.png"&gt;&lt;/p&gt;
&lt;h3&gt;参照：&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;次世代シークエンサーDRY解析教本&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Multiqc&lt;/h2&gt;
&lt;p&gt;クオリティチェックの結果、ログファイルなどをまとめていい感じにレポートにしてくれるツール。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="c1"&gt;# After analysis, run Multiqc by commands below. You can create report.&lt;/span&gt;
$ multiqc .
$ open multiqc_report.html
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;multiqcの実行により、関連ファイルが下記のように自動生成される。&lt;/p&gt;
&lt;p&gt;&lt;img alt="6" src="{attach}images/kallisto_rnaseq_pipeline_figs/screen-shot-2018-10-22-at-21-20-18.png"&gt;&lt;/p&gt;
&lt;p&gt;複数のリードのクオリティチェックの結果を同時に表示できる。&lt;/p&gt;
&lt;p&gt;&lt;img alt="7" src="{attach}images/kallisto_rnaseq_pipeline_figs/screen-shot-2018-10-31-at-20-02-17.png"&gt;&lt;/p&gt;
&lt;h3&gt;参照：&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://multiqc.info/"&gt;https://multiqc.info/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Trimmomatic&lt;/h2&gt;
&lt;p&gt;Java で書かれているアダプタートリミングツールである。 Trimmomatic はアダプターの除去のみならず、リードの末端から一定数の塩基をトリムしたりする、簡単なクオリティフィルタリングも行える。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ trimmomatic SE -phred33 ERR266335.fastq output_ERR266335.fastq ILLUMINACLIP:adapters.fa:2:30:10 LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:36
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;SE&lt;/code&gt;オプションでsingle-end readを指定している。pair-end readでは、オプションでPEとかき、paired outputとunpaired outputの出力先２つを指定する必要がある。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ILLUMINACLIP : 除去するアダプター配列をFASTA形式で与える。そのあとにミスマッチ許容数、palindrome clip threshold、simple clip thresholdの順に指定していく。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;参照&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://bi.biopapyrus.jp/rnaseq/qc/trimmomatic.html"&gt;https://bi.biopapyrus.jp/rnaseq/qc/trimmomatic.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://www.usadellab.org/cms/?page=trimmomatic"&gt;http://www.usadellab.org/cms/?page=trimmomatic&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Single-end, Pair-endってなに？？&lt;/h2&gt;
&lt;p&gt;&lt;img alt="8" src="{attach}images/kallisto_rnaseq_pipeline_figs/img_1051.jpg"&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="9" src="{attach}images/kallisto_rnaseq_pipeline_figs/img_1050.jpg"&gt;&lt;/p&gt;
&lt;p&gt;シーケンスする機器によって、cDNAのかた方のみ読む(single-end read)方法と両端を読む(pair-end read)方法があります。トリミング、アラインメントにおいて、single-endなのか、pair-endなのかを指定しあげる必要があります。&lt;/p&gt;
&lt;h2&gt;Kallisto&lt;/h2&gt;
&lt;p&gt;RNA-Seqデータ、またはより一般的にはハイスループットシーケンシングリードを用いて転写産物の量を定量化するためのプログラムである。&lt;/p&gt;
&lt;p&gt;kallisto や Salmon を利用して定量したデータを使って、edgeR や DESeq2 などで発現量の群間比較を行うことができる。この際に、Bioconductor の tximport パッケージを利用することで、簡単に kallisto/Salmon の定量結果を edgeR/DESEq2 に渡すことができる。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$ &lt;span class="nb"&gt;time&lt;/span&gt; kallisto/kallisto index -i hsGRCh38_kallisto Homo_sapiens.GRCh38.rna.fa.gz
$ &lt;span class="nb"&gt;time&lt;/span&gt; kallisto/kallisto quant -i hsGRCh38_kallisto sra_fastqc/ERR266335.fastq -o ERR266335exp_kallisto
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;kallisto quantにおいて、&lt;strong&gt;-iと-oのオプションは強制&lt;/strong&gt; である。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;-i&lt;/code&gt; :作成したインデックスの指定&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-o&lt;/code&gt; :出力結果の保存先&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;デフォルトではペアエンドを読もうとする&lt;/strong&gt; ので、シングルリードの場合は&lt;code&gt;--single&lt;/code&gt;オプションをつける。シングルの時は&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;-s&lt;/code&gt; : Estimated standard deviation of fragment lengthシーケンシング用のライブラリー中のフラグメントの長さの偏差&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-l&lt;/code&gt; : Estimated average fragment lengthシーケンシング用のライブラリー中のフラグメントの長さの平均&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;のオプションを追加するのが必須となる。
(kallistoはsraファイルを扱えないので、pfastq-dumpでfastqに変換する必要があった。)
ERR266337 ERR266349 ERR266351 ERR266338 ERR266347も同様に&lt;code&gt;kallisto_quant.sh&lt;/code&gt;というシェルスクリプトを書き実行した。今回に限らず、時間がかかるかつ繰り返しの処理はシェルスクリプトを書くと良い（私もこれから練習します）。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="ch"&gt;#!/bin/bash&lt;/span&gt;
&lt;span class="nv"&gt;id&lt;/span&gt;&lt;span class="o"&gt;=(&lt;/span&gt;ERR266335 ERR266337 ERR266349 ERR266351 ERR266338 ERR266347&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; item &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;id&lt;/span&gt;&lt;span class="p"&gt;[@]&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;do&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; start mapping &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;item&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; with Kallisto
&lt;span class="nv"&gt;result_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;item&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;_exp_kallisto
kallisto/kallisto quant -i hsGRCh38_kallisto -o &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;item&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; --single -l &lt;span class="m"&gt;200&lt;/span&gt; -s &lt;span class="m"&gt;20&lt;/span&gt; -b &lt;span class="m"&gt;100&lt;/span&gt; sra_fastqc/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;item&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.fastq
&lt;span class="k"&gt;done&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;abundance.tsv, target_id, length, eff_length, est_counts, tpm&lt;/p&gt;
&lt;h3&gt;参照&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://scilifelab.github.io/courses/rnaseq/labs/kallisto"&gt;https://scilifelab.github.io/courses/rnaseq/labs/kallisto&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://bi.biopapyrus.jp/rnaseq/mapping/kallisto/kallisto-single-end-reads.html"&gt;https://bi.biopapyrus.jp/rnaseq/mapping/kallisto/kallisto-single-end-reads.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://kazumaxneo.hatenablog.com/entry/2018/07/14/180503"&gt;http://kazumaxneo.hatenablog.com/entry/2018/07/14/180503&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://scilifelab.github.io/courses/rnaseq/labs/kallisto"&gt;https://scilifelab.github.io/courses/rnaseq/labs/kallisto&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;FPKM, RPKM, TPMとは？&lt;/h2&gt;
&lt;p&gt;転写産物にマッピングされるリードの数は、サンプル中の総リード数（sequence depth）と転写産物の長さに影響されるので、RNA-Seq データから得られたリードカウントデータは、そのまま転写産物（遺伝子）発現量を表すわけではない。そのため、RNA-Seq データから得られるリードカウントデータを転写産物発現量として利用するには、総リード数や転写産物長で補正する必要がある。&lt;/p&gt;
&lt;p&gt;補正計算として、かつてはFPKM,RPKMが用いられてきたが、現在ではかわりにTPMが用いられている。TPMではサンプルごとの値の合計が同じになるので、比較する目的のためにはTPMの方が都合が良い。&lt;/p&gt;
&lt;h3&gt;FPKM/RPKM の計算&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;FPKM : Fragments Per Kilobase of exon per Killion reads Mapped&lt;/li&gt;
&lt;li&gt;RPKM : Reads Per Kilobase of exon per Million mapped reads
&lt;div class="math"&gt;$$
FPKM_i = Y_i \frac{10^3}{L_i}\frac{10^6}{N}=\frac{Y_i}{L_i N}10^9
$$&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;&lt;span class="math"&gt;\(N\)&lt;/span&gt;: リファレンスにマッピングできた全リード数&lt;/li&gt;
&lt;li&gt;&lt;span class="math"&gt;\(Y_i\)&lt;/span&gt;: そのうち転写産物 &lt;span class="math"&gt;\(i\)&lt;/span&gt; の領域にマッピングされたリード数&lt;/li&gt;
&lt;li&gt;&lt;span class="math"&gt;\(L_i\)&lt;/span&gt;: 転写産物 &lt;span class="math"&gt;\(i\)&lt;/span&gt; の長さ&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;TPMの計算&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;TPM : Transcripts Per Kilobase Million&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="math"&gt;$$
T_t = \frac{Y_t}{L_t}10^3
$$&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;&lt;span class="math"&gt;\(Y_t\)&lt;/span&gt; : 転写産物 &lt;span class="math"&gt;\(t\)&lt;/span&gt; にマッピングされたリードカウント&lt;/li&gt;
&lt;li&gt;&lt;span class="math"&gt;\(L_t\)&lt;/span&gt;:  転写産物 &lt;span class="math"&gt;\(t\)&lt;/span&gt; の長さ&lt;/li&gt;
&lt;li&gt;&lt;span class="math"&gt;\(T_t\)&lt;/span&gt;: 転写産物 &lt;span class="math"&gt;\(t\)&lt;/span&gt; の 1,000 bp あたりのリード数&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="math"&gt;$$
TPM_t = T_t \frac{10^6}{\sum_t T_t}
$$&lt;/div&gt;
&lt;p&gt;転写産物長による補正後の総リードカウントが 100 万となるように補正&lt;/p&gt;
&lt;h3&gt;参照&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://bi.biopapyrus.jp/rnaseq/analysis/normalizaiton/fpkm.html"&gt;bipapyrus fpkm&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://bi.biopapyrus.jp/rnaseq/analysis/normalizaiton/tpm.html"&gt;bipapyrus tpm&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;

&lt;ul&gt;
&lt;li&gt;Tximport, DESeq2を用いた解析はコメントをいただき、ただ今編集中となっております。少々お待ちください。&lt;/li&gt;
&lt;/ul&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="技術ブログ"></category><category term="Bioinformatics"></category></entry><entry><title>いまさらGoogle Colaboratory入門</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/10/google_colaboratory.html" rel="alternate"></link><published>2018-10-08T00:00:00+09:00</published><updated>2018-10-08T00:00:00+09:00</updated><author><name>宮崎</name></author><id>tag:None,2018-10-08:/previews/refs/heads/general/jinja2_version/blog/2018/10/google_colaboratory.html</id><summary type="html">&lt;p&gt;いまさらGoogle Colaboratory触ってみた感じ、かなり便利なのでまとめておきます。動機は、研究室の環境とは別に、趣味のプログラミングの環境が欲 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;いまさらGoogle Colaboratory触ってみた感じ、かなり便利なのでまとめておきます。動機は、研究室の環境とは別に、趣味のプログラミングの環境が欲しかったからです。&lt;/p&gt;
&lt;p&gt;(あと、PCがクソザコなので、クラウドがいいかなーと思いました)&lt;/p&gt;
&lt;h2&gt;対象&lt;/h2&gt;
&lt;p&gt;初学者に非常に向いています。pythonの勉強会や趣味レベルまで対応している神環境だと思います。&lt;/p&gt;
&lt;h2&gt;特徴&lt;/h2&gt;
&lt;p&gt;一言でいうと：コードの共有に向いています。  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;無料&lt;/li&gt;
&lt;li&gt;install不要&lt;/li&gt;
&lt;li&gt;ブラウザさえ使えればどこでもできる&lt;/li&gt;
&lt;li&gt;google driveとの連携が便利&lt;/li&gt;
&lt;li&gt;githubとの連携が簡単(コピーする、というボタンだけでuploadできる)&lt;/li&gt;
&lt;li&gt;しかもGPU使える(TPUも)&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;使用&lt;/h2&gt;
&lt;p&gt;登録：&lt;a href="https://colab.research.google.com"&gt;https://colab.research.google.com&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;標準では書いたノートブックはGoogle Driveに保存されるようになっています。&lt;/p&gt;
&lt;p&gt;&lt;img alt="スクリーンショット" src="{attach}images/google_colaboratory_figs/2018-10-08-12-18-55.png"&gt;&lt;/p&gt;
&lt;p&gt;右上の共有コマンドから、Google Documentと同じようにリンクを作ったり、他の人と共有できます。&lt;/p&gt;
&lt;p&gt;ファイルの選択から、Google DriveやGitHubと連携ができます(すごい)。&lt;/p&gt;
&lt;h2&gt;感想&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;全部クラウドでできるので良い。&lt;/li&gt;
&lt;li&gt;notebookがGoogle用にチューニングされていて更に使いやすい。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;初学の時はpycharm使ってましたが、今から始めるなら間違いなくこれを使います。&lt;/p&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.codexa.net/how-to-use-google-colaboratory/#Google_Colab-4"&gt;https://www.codexa.net/how-to-use-google-colaboratory/#Google_Colab-4&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://karaage.hatenadiary.jp/entry/2018/03/21/073000"&gt;https://karaage.hatenadiary.jp/entry/2018/03/21/073000&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><category term="技術ブログ"></category><category term="Python"></category></entry><entry><title>Particle filter</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/10/particle_filter.html" rel="alternate"></link><published>2018-10-05T00:00:00+09:00</published><updated>2018-10-05T00:00:00+09:00</updated><author><name>柳澤</name></author><id>tag:None,2018-10-05:/previews/refs/heads/general/jinja2_version/blog/2018/10/particle_filter.html</id><summary type="html">&lt;p&gt;今回は&lt;strong&gt;パーティクルフィルター&lt;/strong&gt;の紹介をしたいと思います。
といってもやり始めたばっかなので、間違っていたらご …&lt;/p&gt;</summary><content type="html">&lt;p&gt;今回は&lt;strong&gt;パーティクルフィルター&lt;/strong&gt;の紹介をしたいと思います。
といってもやり始めたばっかなので、間違っていたらご指摘お願いします。&lt;/p&gt;
&lt;h2&gt;手順&lt;/h2&gt;
&lt;p&gt;基本は以下の４つのサイクルを繰り返すだけです。  &lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;リサンプリング  &lt;/li&gt;
&lt;li&gt;予測  &lt;/li&gt;
&lt;li&gt;観測  &lt;/li&gt;
&lt;li&gt;尤度計算 重みの更新  &lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;と言っても分かりにくかったんで、イメージで話すと&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;まず粒子（パーティクル）を全体に振りかけます  &lt;/li&gt;
&lt;li&gt;振りかけたなかで、あってそうな粒子だけ生き残ってもらい、それ以外は消えてもらいます。  &lt;/li&gt;
&lt;li&gt;あってそうなものは、尤度（確からしさ）を計算して其れに（おおよそ）従い新たに粒子を撒きなおします（ちょっとランダムウォークさせます）  &lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ってかんじで対象の動きを推定してくれます。&lt;/p&gt;
&lt;p&gt;なんでいきなりパーティクルフィルターの話をしたかというと、こいつは画像解析の分野ではノイズや予想外の動きによって影響を受けにくく、しっかりと標的のものを追ってくれるかなり有用な方法らしいからです。&lt;/p&gt;
&lt;p&gt;まあとりあえずやってみよう。ということでpython3+opencvを使いました。
Opencvをpythonで使えるようになったのは結構最近なので、なかなか良い本がないのですが、&lt;a href="http://labs.eecs.tottori-u.ac.jp/sd/Member/oyamada/OpenCV/html/py_tutorials/py_tutorials.html"&gt;公式のチュートリアル&lt;/a&gt;が結構役に立ちます。&lt;/p&gt;
&lt;p&gt;でも、やってたら結構間違いもあるので、注意してください。あと、有料ですがUdemyでもopencv+pythonの講座があるので、試してみても良いかもしれません。
先ほど紹介したコンピュータビジョン最先端ガイドも理論がわからない時便利です。&lt;/p&gt;
&lt;p&gt;うまくいった例はネットに大量にあるので、興味のある方は検索してみてください。&lt;/p&gt;
&lt;p&gt;ちなみにパーティクルフィルターでの一番の肝は、↑の4．尤度関数の設定の仕方です。
今回は色の尤度の他に、距離でも尤度を設定して（つまりある時点で散らばっている粒子の重心からの距離を考えるということ）それらをかけたものを最終の尤度のしました。
ブラウン運動ではなく、今回のように細胞の動きを追う場合では、次のフレームで動きそうなところの尤度を大きくすればもっと正確に動きを追いかけられるみたいです。難しい。。。&lt;/p&gt;
&lt;h2&gt;実装&lt;/h2&gt;
&lt;p&gt;以下、&lt;a href="https://www.udemy.com/pythonopencv/"&gt;『Udemy 【Pythonで学ぶ】OpenCVでの画像処理入門』&lt;/a&gt;のコードを参考にさせていただきました。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;cv2&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;numpy&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;np&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;matplotlib.pyplot&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;plt&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;tqdm&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;tqdm&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;time&lt;/span&gt;

&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;tqdm&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;100&lt;/span&gt;&lt;span class="p"&gt;)):&lt;/span&gt;
    &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sleep&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mf"&gt;0.1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;#プログレスバーの表示&lt;/span&gt;

&lt;span class="n"&gt;args&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt; &lt;span class="c1"&gt;#コマンドライン引数&lt;/span&gt;

&lt;span class="n"&gt;cap&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cv2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;VideoCapture&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/movie/lps.avi&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;cap&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;isOpened&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="kc"&gt;False&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;

&lt;span class="n"&gt;ret&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;frame&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cap&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;h&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;w&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;frame&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;shape&lt;/span&gt;&lt;span class="p"&gt;[:&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;#大きさを取得&lt;/span&gt;

&lt;span class="n"&gt;fourcc&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cv2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;VideoWriter_fourcc&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;mp4v&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;output_dst&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cv2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;VideoWriter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/output/test[&lt;/span&gt;&lt;span class="si"&gt;{0}&lt;/span&gt;&lt;span class="s2"&gt;,&lt;/span&gt;&lt;span class="si"&gt;{1}&lt;/span&gt;&lt;span class="s2"&gt;].m4v&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;]),&lt;/span&gt;&lt;span class="n"&gt;fourcc&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mf"&gt;5.0&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="n"&gt;w&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;h&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="c1"&gt;#動画出力の設定&lt;/span&gt;

&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;seed&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;100&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="c1"&gt;#乱数の初期化,毎回同じ乱数になる&lt;/span&gt;
&lt;span class="n"&gt;Np&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;50&lt;/span&gt;&lt;span class="c1"&gt;#粒子の数&lt;/span&gt;
&lt;span class="n"&gt;obj&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;float&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;])),&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;])]&lt;/span&gt; &lt;span class="c1"&gt;#目的の（追いかける）標的の座標0~512&lt;/span&gt;
&lt;span class="n"&gt;WD&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;100&lt;/span&gt;

&lt;span class="n"&gt;px&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;zeros&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="n"&gt;dtype&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;int64&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="c1"&gt;#粒子のx座標&lt;/span&gt;
&lt;span class="n"&gt;py&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;zeros&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="n"&gt;dtype&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;int64&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="c1"&gt;#粒子のy座標&lt;/span&gt;
&lt;span class="n"&gt;lc&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;zeros&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="c1"&gt;#粒子の色の尤度&lt;/span&gt;
&lt;span class="n"&gt;ls&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;zeros&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="c1"&gt;#粒子の空間の尤度&lt;/span&gt;
&lt;span class="n"&gt;lt&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;zeros&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="c1"&gt;#粒子の尤度total&lt;/span&gt;
&lt;span class="n"&gt;index&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arange&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;#objの周りに撒く&lt;/span&gt;
&lt;span class="n"&gt;d&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;10&lt;/span&gt;
&lt;span class="n"&gt;px&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;normal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;astype&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;py&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;normal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;astype&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;j&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;span class="n"&gt;artists&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt;
&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;ret&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;frame&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cap&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="c1"&gt;#１枚読み込み&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;ret&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="kc"&gt;False&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;break&lt;/span&gt;&lt;span class="c1"&gt;#最後になったらループから抜ける&lt;/span&gt;

    &lt;span class="n"&gt;gx&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;average&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;px&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;gy&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;average&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;py&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="c1"&gt;#１フレーム前の粒子の重心&lt;/span&gt;

    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;lc&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;frame&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;py&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="n"&gt;px&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]][&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="mf"&gt;255.0&lt;/span&gt;&lt;span class="c1"&gt;#色の尤度&lt;/span&gt;
        &lt;span class="n"&gt;ls&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;px&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;gx&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;py&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;gy&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;WD&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
        &lt;span class="n"&gt;lt&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;lc&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;ls&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="n"&gt;lt&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;lt&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="n"&gt;lt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sum&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="n"&gt;pnew_index&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;choices&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;population&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;weights&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;lt&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;k&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;pxnew&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;px&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;pnew_index&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;randint&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;pynew&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;py&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;pnew_index&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;randint&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;hist&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lt&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="c1"&gt;#リサンプリングした,ある程度ランダムウォーク&lt;/span&gt;
    &lt;span class="n"&gt;px&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;where&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pxnew&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;w&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;w&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;pxnew&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;py&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;where&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pynew&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;h&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;h&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;pynew&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;px&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;where&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;px&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;px&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;py&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;where&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;py&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;py&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="c1"&gt;#ランダムウォークで画面外に出る場合の処理&lt;/span&gt;

    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt; &lt;span class="c1"&gt;#画像の中に粒子を描く&lt;/span&gt;
        &lt;span class="n"&gt;cv2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;circle&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;frame&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="n"&gt;px&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="n"&gt;py&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]),&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;cv2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;imwrite&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/output/test_tiff/test&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;.tif&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;frame&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;#tiffでも保存&lt;/span&gt;
    &lt;span class="n"&gt;j&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;j&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;

    &lt;span class="n"&gt;output_dst&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;frame&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;結果&lt;/h2&gt;
&lt;p&gt;こんな感じです。&lt;/p&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}images/particle_filter_figs/result.gif"&gt;&lt;/p&gt;
&lt;p&gt;最初は尤度を計算するとき以下のようにやってました。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;pxnew&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;choices&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;population&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;px&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;weights&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;lt&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;k&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;randint&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;pynew&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;choices&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;population&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;py&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;weights&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;lt&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;k&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;randint&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;これではxとyを別々に計算してしまっているので、微妙に結果がおかしい感じになってました。（点が四角っぽくなる）
確かにそれはそうか。ランダムに選ぶのは１回でいいはず。。。。&lt;/p&gt;
&lt;p&gt;こういうとき、適当にindexとかおいてやるとうまくいくんですね。
今回もpnew_indexをおいてしまうという感じでやってます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;pnew_index&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;choices&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;population&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;weights&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;lt&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;k&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;pxnew&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;px&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;pnew_index&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;randint&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;pynew&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;py&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;pnew_index&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;randint&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;Np&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;参考文献&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.amazon.co.jp/%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%82%BF%E3%83%93%E3%82%B8%E3%83%A7%E3%83%B3%E6%9C%80%E5%85%88%E7%AB%AF%E3%82%AC%E3%82%A4%E3%83%891-CVIM%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA-%E5%80%89%E7%88%AA-%E4%BA%AE/dp/4915851346"&gt;コンピュータビジョン最先端ガイド&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category></entry><entry><title>【論文まとめ】Improving Breast Cancer Detection using Symmetry Information with Deep Learning</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/09/breast_cancer_detection.html" rel="alternate"></link><published>2018-09-25T00:00:00+09:00</published><updated>2018-09-25T00:00:00+09:00</updated><author><name>秋山</name></author><id>tag:None,2018-09-25:/previews/refs/heads/general/jinja2_version/blog/2018/09/breast_cancer_detection.html</id><summary type="html">&lt;blockquote&gt;
&lt;p&gt;Improving Breast Cancer Detection using Symmetry Information with Deep Learning.
&lt;a href="http://arxiv.org/abs/1808.08273"&gt;http://arxiv.org/abs/1808.08273&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;概要&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;放射線専門医がするようにマンモグラムの左右差を見て乳がんの判定を …&lt;/li&gt;&lt;/ul&gt;</summary><content type="html">&lt;blockquote&gt;
&lt;p&gt;Improving Breast Cancer Detection using Symmetry Information with Deep Learning.
&lt;a href="http://arxiv.org/abs/1808.08273"&gt;http://arxiv.org/abs/1808.08273&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;概要&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;放射線専門医がするようにマンモグラムの左右差を見て乳がんの判定をするCNNモデルを提案&lt;/li&gt;
&lt;li&gt;MICCAI (医療画像解析のトップ会議) 2018 採択&lt;/li&gt;
&lt;li&gt;1st authorは放射線科医&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;データセット&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;マンモグラフィー7k症例, 正常4k, 悪性腫瘍3k&lt;/li&gt;
&lt;li&gt;放射線専門医により腫瘍領域マスクをアノテーションした&lt;/li&gt;
&lt;li&gt;正常乳房は2年フォローして乳がん発症が無かったことを確認&lt;/li&gt;
&lt;li&gt;乳がん乳房は腫瘍領域を生検し悪性腫瘍であるとすべて診断されている&lt;/li&gt;
&lt;li&gt;非公開データ&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;前処理&lt;/h2&gt;
&lt;h4&gt;Fig. 1&lt;/h4&gt;
&lt;p&gt;&lt;img alt="Fig. 1" src="{attach}images/breast_cancer_detection_figs/2352f582-60c8-486b-a9ec-c247787510f7.png"&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;従来法の画像特徴量を用いた手法で腫瘍候補点を計算 (Fig.1, 赤点)&lt;/li&gt;
&lt;li&gt;候補点を中心に300x300 pixels (6cm x 6cm) を切り出し (Fig.1, 緑枠)&lt;/li&gt;
&lt;li&gt;左右差を比較するために反対側の領域を切り出し (Fig.1, 青枠)&lt;/li&gt;
&lt;li&gt;切り出した領域に腫瘍のマスク領域が含まれていれば悪性腫瘍のラベルを割り当てる&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;モデル&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;baseline model: 標準的なCNN (VGG like)&lt;/li&gt;
&lt;li&gt;symmetry model: 候補領域とその左右対称となる領域の2画像を入力とするCNN&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;Fig.2&lt;/h4&gt;
&lt;p&gt;&lt;img alt="Fig. 2" src="{attach}images/breast_cancer_detection_figs/67ac70b1-0afe-478b-b046-a2bacb1450f8.png"&gt;&lt;/p&gt;
&lt;h2&gt;結果&lt;/h2&gt;
&lt;p&gt;&lt;img alt="AUC table" src="{attach}images/breast_cancer_detection_figs/e382b9e382afe383aae383bce383b3e382b7e383a7e38383e38388-2018-09-25-17-28-58.png"&gt;&lt;/p&gt;
&lt;p&gt;AUCがわずかに改善 (有意差なし)&lt;/p&gt;
&lt;h4&gt;Fig.3a&lt;/h4&gt;
&lt;p&gt;&lt;img alt="Fig. 3a" src="{attach}images/breast_cancer_detection_figs/6aaac880-7ac2-4425-8be3-4d78367088e2.png"&gt;&lt;/p&gt;
&lt;p&gt;FROC曲線(偽陽性率を横軸, 感受性を縦軸) で比較すると有意に提案手法がよかった&lt;/p&gt;
&lt;h2&gt;考察&lt;/h2&gt;
&lt;h4&gt;Fig. 4&lt;/h4&gt;
&lt;p&gt;&lt;img alt="Fig. 4" src="{attach}images/breast_cancer_detection_figs/ef07a0c8-ed1e-4127-b747-f9103aa6095e.png"&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;a) baseline modelが正常と誤判定し, symmetry modelが正しく悪性腫瘍と判定した画像の例 (上下の画像が同じ患者の左右の乳房)&lt;/li&gt;
&lt;li&gt;b) baseline modelが悪性腫瘍と誤判定し, symmetry modelが正しく正常と判定した画像の例 (上下の画像が同じ患者の左右の乳房)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;暗めの悪性腫瘍, 明るい正常像は誤判定しやすいがsymmetry modelは左右の比較によって正しく判定していることが読み取れる&lt;/p&gt;
&lt;h2&gt;読んだ感想&lt;/h2&gt;
&lt;p&gt;性能差がちょっと微妙だけど考察の納得感はある&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category><category term="論文まとめ"></category></entry><entry><title>クラスター分析</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/09/cluster_analysis.html" rel="alternate"></link><published>2018-09-24T00:00:00+09:00</published><updated>2018-09-24T00:00:00+09:00</updated><author><name>柳澤</name></author><id>tag:None,2018-09-24:/previews/refs/heads/general/jinja2_version/blog/2018/09/cluster_analysis.html</id><summary type="html">&lt;p&gt;現在、クラスター分析の勉強をしています。
勉強し始めて数時間ですが、少しまとめてみたいと思います。&lt;/p&gt;
&lt;h2&gt;クラスター分 …&lt;/h2&gt;</summary><content type="html">&lt;p&gt;現在、クラスター分析の勉強をしています。
勉強し始めて数時間ですが、少しまとめてみたいと思います。&lt;/p&gt;
&lt;h2&gt;クラスター分析とは&lt;/h2&gt;
&lt;p&gt;簡単に言うと、クラスター分析とは異なる性質のものが混ざり合った集団から互いに似た性質を持つものを集める方法のことです。
あらかじめ分類の基準が決まっておらず分類のための外的基準や評価が与えられていない「教師無しの分類法」です。&lt;/p&gt;
&lt;h3&gt;グループ分けの対象&lt;/h3&gt;
&lt;p&gt;サンプルを分類するのか、変数を分類するのか&lt;/p&gt;
&lt;h3&gt;分類の形式（種類、生成）&lt;/h3&gt;
&lt;p&gt;階層的方法か非階層的方法か&lt;/p&gt;
&lt;h3&gt;分類に用いる対象間の距離（類似度）&lt;/h3&gt;
&lt;p&gt;ユークリッド距離、マハラノビス距離、コサイン距離 ・・・&lt;/p&gt;
&lt;h3&gt;クラスターの合併方法（クラスター間の距離の測定方法）&lt;/h3&gt;
&lt;p&gt;ウォード法、群平均法、最短距離法、最長距離法・・・&lt;/p&gt;
&lt;p&gt;クラスター分類するにはここら辺を決めなくてはいけません。
特に後ろ二つが馴染みがなく難しい。。。&lt;/p&gt;
&lt;h2&gt;デンドログラム&lt;/h2&gt;
&lt;p&gt;階層的クラスタリングを可視化する代表的な方法にデンドログラムがあります。Scikit-learnのirisデータセットで試しにやってみます。調べたところ、scikit-learnでデンドログラム描写はできないみたいだったので、Scipyからimportして使います。
（Scipyのクラスタリングアルゴリズムはscikit-learnのアルゴリズムを若干違うみたいです。）
上で書いた後ろ２つを以下で指定しています。&lt;/p&gt;
&lt;h3&gt;実装&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pandas&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;pd&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sklearn&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;datasets&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;scipy.cluster.hierarchy&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;dendrogram&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;linkage&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;matplotlib&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;pyplot&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;plt&lt;/span&gt;

&lt;span class="n"&gt;iris&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;datasets&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;load_iris&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="c1"&gt;# data load&lt;/span&gt;
&lt;span class="n"&gt;df&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pd&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;DataFrame&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;iris&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;columns&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;iris&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;feature_names&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# ウォード法 &amp;amp; ユークリッド距離&lt;/span&gt;
&lt;span class="n"&gt;linkage_result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;linkage&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;df&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;ward&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;metric&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;euclidean&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;fig&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;figure&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;figsize&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;dn&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;dendrogram&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;linkage_result&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;labels&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;iris&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;target_names&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;iris&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;target&lt;/span&gt;&lt;span class="p"&gt;]),&lt;/span&gt;
                              &lt;span class="n"&gt;above_threshold_color&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;grey&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# 各ラベルに色を割り当て&lt;/span&gt;
&lt;span class="n"&gt;label_colors&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;setosa&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;c&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;versicolor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;m&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;virginica&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;y&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;ax&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;gca&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;xlbls&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ax&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_xmajorticklabels&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;lbl&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;xlbls&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;lbl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_color&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;label_colors&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;lbl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_text&lt;/span&gt;&lt;span class="p"&gt;()])&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Dendrogram of Iris dataset &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ylabel&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Distance&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tight_layout&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;show&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;結果&lt;/h3&gt;
&lt;p&gt;縦軸がクラスタ間距離です。横軸のラベルでは、setosaをシアン、versicolorをマゼンタ、virginicaを黄色としました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}images/cluster_analysis_figs/dendrogram.png"&gt;&lt;/p&gt;
&lt;p&gt;setosaは綺麗に分かれますが、versicolorとvirginicaはうまく分けられていないのがわかります。なるほど。&lt;/p&gt;
&lt;p&gt;イメージング画像でクラスタリングしたいなあとか思っているんですが、
なかなかサンプル数とか特徴量の問題で難しそう。&lt;/p&gt;
&lt;p&gt;うまく特徴がつかめるような解析がしたいなあ。&lt;/p&gt;
&lt;p&gt;頑張って勉強してみます。
何かいいサイトや参考資料があったら教えてください。&lt;/p&gt;
&lt;h2&gt;参考資料&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://www.kamishima.net/jp/clustering/"&gt;http://www.kamishima.net/jp/clustering/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://datanongrata.com/2019/04/27/67/"&gt;http://datanongrata.com/2019/04/27/67/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://stackoverflow.com/questions/14802048/scipy-dendrogram-leaf-label-colours"&gt;https://stackoverflow.com/questions/14802048/scipy-dendrogram-leaf-label-colours&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Pythonではじめる機械学習 オライリー社&lt;/li&gt;
&lt;/ul&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category></entry><entry><title>寿司打タイピング自動化</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/09/sushi_typing.html" rel="alternate"></link><published>2018-09-20T00:00:00+09:00</published><updated>2018-09-20T00:00:00+09:00</updated><author><name>安水</name></author><id>tag:None,2018-09-20:/previews/refs/heads/general/jinja2_version/blog/2018/09/sushi_typing.html</id><summary type="html">&lt;p&gt;&lt;p&gt;&lt;span class="videobox"&gt;
  &lt;iframe width="640" height="390"
    src="https://www.youtube.com/embed/SqOO9I1tFjk"
    frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen&gt;
  &lt;/iframe&gt;&lt;/span&gt;&lt;/p&gt;&lt;/p&gt;
&lt;p&gt;寿司打の自動化についてです。上の動画のようになりました。寿司打は結構昔からあるタイピング練習サイトです。寿 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;p&gt;&lt;span class="videobox"&gt;
  &lt;iframe width="640" height="390"
    src="https://www.youtube.com/embed/SqOO9I1tFjk"
    frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen&gt;
  &lt;/iframe&gt;&lt;/span&gt;&lt;/p&gt;&lt;/p&gt;
&lt;p&gt;寿司打の自動化についてです。上の動画のようになりました。寿司打は結構昔からあるタイピング練習サイトです。寿司打は&lt;a href="http://typing.sakura.ne.jp/sushida/"&gt;こちら&lt;/a&gt;です。
1万円コースで1万円超えない人はタイピング遅いので特訓しましょう。&lt;/p&gt;
&lt;p&gt;自動化の流れとしては&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;スクリーンショットを取る(PIL)&lt;/li&gt;
&lt;li&gt;OCRで文字認識をする(pyocr)&lt;/li&gt;
&lt;li&gt;キーボード入力(pyautogui)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;です。
ご認識を防ぐため、調整用のところでできるだけ正確にローマ字部分が入るようにスクリーンショットの座標をあわせないといけません。&lt;/p&gt;
&lt;p&gt;今回はMBPをつかって一万円コース63120 円でした。OCRの部分が律速になっていそうなので、リソースかアルゴリズムでここを高速化するとプラトーになるのではと考えています。
一晩中自動でゲームを繰り返してスコアをメモし続けるように書き直したので、少し冗長なコードになっています。
ところで、ランキングをチェックすると、抜かれていたので、だれかリベンジしてください。&lt;/p&gt;
&lt;p&gt;&lt;a href="https://gist.github.com/yyoshiaki/a9a2eea1105a654e6b9beaaf2b854871"&gt;https://gist.github.com/yyoshiaki/a9a2eea1105a654e6b9beaaf2b854871&lt;/a&gt;&lt;/p&gt;</content><category term="技術ブログ"></category><category term="自動化"></category></entry><entry><title>ipynb破損時の対応</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/09/ipynb_broken.html" rel="alternate"></link><published>2018-09-15T00:00:00+09:00</published><updated>2020-05-16T00:00:00+09:00</updated><author><name>安水</name></author><id>tag:None,2018-09-15:/previews/refs/heads/general/jinja2_version/blog/2018/09/ipynb_broken.html</id><summary type="html">&lt;p&gt;先日１ヶ月以上を費やしてまとめていたipynbファイルが破損して開けなくなってしまい、やさぐれていました。
なんとかならないか調べても、壊れたファイルは戻ってこないよ的な塩対応しかなかっ …&lt;/p&gt;</summary><content type="html">&lt;p&gt;先日１ヶ月以上を費やしてまとめていたipynbファイルが破損して開けなくなってしまい、やさぐれていました。
なんとかならないか調べても、壊れたファイルは戻ってこないよ的な塩対応しかなかったので絶望していたのですが、pythonでなんとかできるのではないかとあがいてみました。
なんとか復旧したのでその方法を共有します。&lt;/p&gt;
&lt;p&gt;&lt;img alt="image01" src="{attach}./images/ipynb_broken_figs/image01.png"&gt;&lt;/p&gt;
&lt;p&gt;まず開こうと思ったらこんな感じでした。
絶望感しかありません。
ipynbファイルの弱点を見たような気がしました。&lt;/p&gt;
&lt;p&gt;そこで、新しいipynbを作り、jsonを読んでみました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="image02" src="{attach}./images/ipynb_broken_figs/image02.png"&gt;&lt;/p&gt;
&lt;p&gt;てことで677378行目付近を見てみる。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;less -N BAP_note.ipynb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Nオプションで行数が表示されます。
そして、&lt;code&gt;677378G&lt;/code&gt; と打つと677378行目に行けます。&lt;/p&gt;
&lt;p&gt;&lt;img alt="image03" src="{attach}./images/ipynb_broken_figs/image03.png"&gt;&lt;/p&gt;
&lt;p&gt;たしかに表示が崩れているので、&lt;code&gt;v&lt;/code&gt; で編集モード（vimモード）を立ち上げ、&lt;code&gt;dd&lt;/code&gt; でけしていきました。
&lt;code&gt;:x&lt;/code&gt; で保存できます。
（vimじゃなくてもemacs等でも行ける。）&lt;/p&gt;
&lt;p&gt;復活しました。
うれしい!!&lt;/p&gt;
&lt;p&gt;&lt;img alt="image04" src="{attach}./images/ipynb_broken_figs/image04.png"&gt;&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Python"></category></entry><entry><title>超高速次元圧縮アルゴリズムUMAP</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/09/umap.html" rel="alternate"></link><published>2018-09-15T00:00:00+09:00</published><updated>2018-09-15T00:00:00+09:00</updated><author><name>安水</name></author><id>tag:None,2018-09-15:/previews/refs/heads/general/jinja2_version/blog/2018/09/umap.html</id><summary type="html">&lt;h2&gt;tSNEとUMAP&lt;/h2&gt;
&lt;p&gt;世間では、高性能な次元圧縮アルゴリズムとしてtSNEがよく使われています。 tSNEは便利ですが、少し遅いです。（パラメーターも意外に面倒。 tSNEのパラメータについては以下のリンク参照）&lt;/p&gt;
&lt;p&gt;&lt;a href="https://deepage.net/machine_learning/2017/03/08/tsne.html"&gt;https://deepage.net/machine_learning/2017/03/08 …&lt;/a&gt;&lt;/p&gt;</summary><content type="html">&lt;h2&gt;tSNEとUMAP&lt;/h2&gt;
&lt;p&gt;世間では、高性能な次元圧縮アルゴリズムとしてtSNEがよく使われています。 tSNEは便利ですが、少し遅いです。（パラメーターも意外に面倒。 tSNEのパラメータについては以下のリンク参照）&lt;/p&gt;
&lt;p&gt;&lt;a href="https://deepage.net/machine_learning/2017/03/08/tsne.html"&gt;https://deepage.net/machine_learning/2017/03/08/tsne.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;そこで今回紹介するのは&lt;strong&gt;UMAP&lt;/strong&gt;。 arxivで今月publishされたばかりのアルゴリズムです(記事執筆時 2018年2月時点)。 試しにMNIST(手書き数字画像。28*28=764次元)70000枚の次元圧縮をしてみました。&lt;/p&gt;
&lt;p&gt;tSNEではちょうど1時間30分でしたが、UMAPではたったの1分でした。詳細は以下のリンクより。&lt;/p&gt;
&lt;p&gt;&lt;a href="https://github.com/lmcinnes/umap"&gt;https://github.com/lmcinnes/umap&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;コード&lt;/h2&gt;
&lt;p&gt;インストールは &lt;code&gt;pip install umap&lt;/code&gt;でok。&lt;/p&gt;
&lt;p&gt;こちらが今回のソースコード。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sklearn&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;datasets&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;matplotlib.pyplot&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;plt&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;matplotlib&lt;/span&gt; &lt;span class="n"&gt;inline&lt;/span&gt;
&lt;span class="n"&gt;digits&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;datasets&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fetch_mldata&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="err"&gt;‘&lt;/span&gt;&lt;span class="n"&gt;MNIST&lt;/span&gt; &lt;span class="n"&gt;original&lt;/span&gt;&lt;span class="err"&gt;’&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;digits&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="err"&gt;‘&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="err"&gt;’&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;shape&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;umap&lt;/span&gt;
&lt;span class="n"&gt;embedding&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;umap&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;UMAP&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fit_transform&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;digits&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;figure&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;figsize&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;12&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;scatter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;embedding&lt;/span&gt;&lt;span class="p"&gt;[:,&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="n"&gt;embedding&lt;/span&gt;&lt;span class="p"&gt;[:,&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;digits&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;target&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="err"&gt;‘&lt;/span&gt;&lt;span class="n"&gt;UMAP&lt;/span&gt;&lt;span class="err"&gt;’&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;savefig&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="err"&gt;‘&lt;/span&gt;&lt;span class="n"&gt;umap&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;png&lt;/span&gt;&lt;span class="err"&gt;’&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sklearn.manifold&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;TSNE&lt;/span&gt;
&lt;span class="n"&gt;model&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;TSNE&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n_components&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;tsne_result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;model&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fit_transform&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;digits&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;figure&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;figsize&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;12&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;scatter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tsne_result&lt;/span&gt;&lt;span class="p"&gt;[:,&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="n"&gt;tsne_result&lt;/span&gt;&lt;span class="p"&gt;[:,&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;digits&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;target&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="err"&gt;‘&lt;/span&gt;&lt;span class="n"&gt;tSNE&lt;/span&gt;&lt;span class="err"&gt;’&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;savefig&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="err"&gt;‘&lt;/span&gt;&lt;span class="n"&gt;tsne&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;png&lt;/span&gt;&lt;span class="err"&gt;’&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;結果&lt;/h2&gt;
&lt;h3&gt;tSNE&lt;/h3&gt;
&lt;p&gt;&lt;img alt="tsne" src="{attach}images/umap_figs/tsne.png"&gt;&lt;/p&gt;
&lt;h3&gt;UMAP&lt;/h3&gt;
&lt;p&gt;&lt;img alt="umap" src="{attach}images/umap_figs/umap.png"&gt;&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category></entry><entry><title>論文抄読で便利なサイト</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/09/article_reading.html" rel="alternate"></link><published>2018-09-09T23:00:00+09:00</published><updated>2018-09-09T23:00:00+09:00</updated><author><name>柳澤</name></author><id>tag:None,2018-09-09:/previews/refs/heads/general/jinja2_version/blog/2018/09/article_reading.html</id><summary type="html">&lt;h2&gt;論文抄読で便利なサイト&lt;/h2&gt;
&lt;p&gt;英語論文を読むのにものすごいハードルがある人（＝僕）や英語見るだけでなんとなく気持ち …&lt;/p&gt;</summary><content type="html">&lt;h2&gt;論文抄読で便利なサイト&lt;/h2&gt;
&lt;p&gt;英語論文を読むのにものすごいハードルがある人（＝僕）や英語見るだけでなんとなく気持ちがのらない人（＝僕）でも、論文を読まなければみたいな状況は訪れます。結局大事なことは英語で書いてあるし今後嫌でも読まなければいけないので、なんとか楽して読めないものか…ということで、いつも論文を読む時にどんなサイトを使っているかを一度書き起こしてみました。&lt;br&gt;
とりあえずハードルを下げることメインなので、「普通に読めるやろ」みたいな人はスルーでお願いします笑。5年の免疫内科の実習で論文の効率的な読み方を習って、もっと早く知ってればなあと思ったので、もし先生に「〇〇に関する論文読んできてねー」みたいなことを言われた時とかに参考にしてみてください。 &lt;a href="http://www.imed3.med.osaka-u.ac.jp/education/education01.html"&gt;大阪大学免疫内科のホームページ&lt;/a&gt;と被っていることも多いです。こちらも是非見てみてください。&lt;/p&gt;
&lt;h2&gt;論文を（ざっと）読む&lt;/h2&gt;
&lt;p&gt;とりあえずわからない単語が多すぎて全然読み進められない、いちいち単語を調べているとテンポが悪く全然頭に入らないみたいな時は、是非ライフサイエンス辞書の&lt;a href="https://lsd-project.jp/ja/service/etoj_v/index.html"&gt;EtoJ Vocabulary&lt;/a&gt;を使ってみてください。
論文の英語の文章を丸ごと一本コピー&amp;amp;ペーストして青くなっている単語をクリックすると下にその単語の日本語訳がでます。オプション設定で「ライフサイエンス辞書 + ejdic」にして使うことが多いです。論文一本読むか迷うような場合はとりあえずアブストだけe to jに入れて読むと数分でなんとなく何が書いてあるのかわかるのでおすすめ。なんか変に訳されていることもおおいので、そういう時はガシガシググりまくってます。ググると日本語ページなんかもあったりして大抵なんとかなります。よく英語の構造がわかんない時は&lt;a href="https://translate.google.co.jp/?hl=ja"&gt;google 翻訳&lt;/a&gt;に文章ごと突っ込んで雰囲気を理解します。略語に関しては、正式名称が論文のどこにも見当たらない時は&lt;a href="http://allie.dbcls.jp/ja"&gt;略語検索Allie&lt;/a&gt;っていうサイトを使います（かなり便利）。成句がわからない時もググるのですが、アルク社の英辞郎の方がweblioよりうまくいく気がします。あと免内のHPにも書いてありますが&lt;a href="https://www.ncbi.nlm.nih.gov"&gt;NCBI&lt;/a&gt;では遺伝子とかタンパクのデータを調べるとバックグラウンドが理解でき、今読んでいる論文がどんなことをしたいかがよくわかることが多いです。（余談ですが予算が減らされたらしくNCBIのサイトのアップデートできないみたいな話を聞いたんですがどうなったんだろう)。&lt;br&gt;
個人的にはアブストを読んだ後、イントロを読もうとして途中で心が折れることが多いのでイントロは飛ばしてResultsに行くようにしてます。とりあえずResultsの題名だけ読んでFigureをみて全体像を掴む→よくわからんところがあったら本文を見ていくって感じにすると意外と早く大体の内容が把握できます。&lt;/p&gt;
&lt;h2&gt;論文と（とりあえず）身近になる&lt;/h2&gt;
&lt;p&gt;有名な雑誌（Impact Factorの高い雑誌）に関しては免内のサイトをみてください。 日本語でいいから論文に触れる。を目標にして行きたい。 Nature とNEJMは題名とアブストを日本語で読める。興味のある記事が一目でわかります。Natureには日本語のご利用ガイドまで。ありがたいです。 AASJはほぼ毎日日本語で面白い論文を解説してくれています。&lt;a href="http://aasj.jp/watch.html"&gt;AASJ&lt;/a&gt;おすすめ あと&lt;a href="http://first.lifesciencedb.jp"&gt;ライフサイエンス新着論文レビュー&lt;/a&gt;, &lt;a href="http://leading.lifesciencedb.jp"&gt;領域融合レビュー&lt;/a&gt;もお世話になってます。論文執筆者がその論文について解説してくれていたり、その領域について概説してくれています。（DBCLSのサービスの一つなのですが、他にも前述のAllie含め色々なサービスがあります。うまく使いこなせるようになりたい。使いこなしてるって人は教えてください。サイトは→ &lt;a href="http://dbcls.rois.ac.jp/services"&gt;DBCLS&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;（有名どころの）論文を探す&lt;/h2&gt;
&lt;p&gt;せっかく読むんならたくさん引用されているすごい論文を読んだ方がかコスパがいい気がする！ということでその領域の代表的な論文を読みたいって時、結構pubmedでは検索しにくかったりします。キーワード入れたけどこれはどれくらいすごい論文なのかわからないという時はISI web of knowledgeを使ってます。ある領域で被引用回数の多い順に論文を見ることができたりいろいろ便利な機能があります。おおきな括りで調べる時（autophagyとかsepsisとか）は最近3年くらいで、何個か検索ワードを並べて検索する時には最近10年分くらいで検索するとうまく行くことが多いです。被引用回数の多い順に検索結果を並べかえて上位のものからいくつかアブストを読んでみて、面白いなあと思ったものの論文を実際に読むっていう感じにしてます。&lt;br&gt;
論文がどこにあるかわからなければ下の方に書いてあるpubmed idをコピーしてpubmedの検索のところにその番号を直接ペーストすると、お目当の論文が出てきます。阪大のwifiに繋がないと見れないですが、本当に役立ちます。あとはやっぱりgoogle scholarも使うことが多いです。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="論文関連"></category></entry><entry><title>組み込みでDeep Learningにつかえるハードについて</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/09/hardware_for_deeplearning.html" rel="alternate"></link><published>2018-09-09T00:00:00+09:00</published><updated>2018-09-09T00:00:00+09:00</updated><author><name>安水</name></author><id>tag:None,2018-09-09:/previews/refs/heads/general/jinja2_version/blog/2018/09/hardware_for_deeplearning.html</id><summary type="html">&lt;h2&gt;Rasberry pi&lt;/h2&gt;
&lt;p&gt;シングルボードコンピュータ。手のひらサイズで値段も５０００円とリーズナブルだが一人前のコンピューター。Linuxの練習にもうってつけ。クアッドコアだが機械学習としてはすこし非力。GPUもつかえない …&lt;/p&gt;</summary><content type="html">&lt;h2&gt;Rasberry pi&lt;/h2&gt;
&lt;p&gt;シングルボードコンピュータ。手のひらサイズで値段も５０００円とリーズナブルだが一人前のコンピューター。Linuxの練習にもうってつけ。クアッドコアだが機械学習としてはすこし非力。GPUもつかえない。電池で動く。何台もつなげてクラスター化する強者も。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://www.cenav.org/raspi2/"&gt;計算工学ナビ : RaspberryPiでスパコンを作ろう&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://qiita.com/kazunori279/items/bb58f0b3095f3c65b2a1"&gt;Qiita : RasPiとディープラーニングで我が家のトイレ問題を解決する&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;スマホ&lt;/h2&gt;
&lt;p&gt;やはり今の時代にハードとしてスマホに注目しないわけにはいかない。Tensorflowならスマホ組み込みも。まだ開発版のみだが、アンドロイドもiosもどちらも遊べるらしい。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.sejuku.net/blog/55188"&gt;侍エンジニア塾 : 【TensorFlow】スマホで動かせるLiteとは？&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;GPU&lt;/h2&gt;
&lt;p&gt;おなじみ。Deep Learning等は大量の行列演算を必要とする。GPUはもともとグラフィックスにフォーカスして作られていた演算回路だが、グラフィックス自体大量の行列演算だったため、Deep Learningに転用することで超高速な学習が可能になった。Deep learningやるなら必需品。ただ、これ自体を持ち出すのは困難。市販最速のNVIDIA GTX 1080 tiで１０万円くらい。&lt;/p&gt;
&lt;h2&gt;FPGA&lt;/h2&gt;
&lt;p&gt;Field Programmable Gate Arrayの略。デジタル回路を自分で設計できる集積回路。集積回路といえば単一タスクを低電力低コストで高速な演算が可能だが、専門家しか作れなかったし、そもそも作ること自体が大変だった。FPGAは集積回路の設計をソフトで行うことで、柔軟に専門設計が可能になった。ちっちゃいので組み込みにも向いている。最近Scienceにのって話題になったGohst CytometryもFPGA使ってるそうな。（阪大、東大、理研AIPのコラボ。下で書くjetson化も視野に入れているらしい。）最近では各社がFPGAに取り組みだしている。Tensorflowも動かせるらしい。ただしやはり専門外ではとっつきにくい。ピンキリだがやすいので１万５千円くらい。論理回路設計がもとめられるのでぶっちゃけよくわからん。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://qiita.com/kazunori279/items/a9e97a4463cab7dda8b9"&gt;Qiita : そろそろプログラマーもFPGAを触ってみよう！&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://science.sciencemag.org/content/360/6394/1246.full"&gt;Science : Gohst Cytometry&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;jetson&lt;/h2&gt;
&lt;p&gt;NVIDIA組み込みモジュール。安価かつ高速でポータブルなGPUが使える。NVIDIA製ということで、Tensorflowも使えるのが嬉しい。値段は開発キットが599ドル（1ドル＝114円換算で、6万8286円）で、製品に組み込んで出荷可能なProduction Moduleは1000個ロット時で399ドル（同、4万5486円）。256 CUDAコア（GTX 1080 tiで3584 cuda cores）なので、やはり学習済みモデルの運用がメインと思われる。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://qiita.com/ababa893/items/57b43e788d684c380866"&gt;Qiita : NVIDIA Jetson TX2でTensorFlowによる人体姿勢推定プログラムを動かせるようになるまで&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ディープラーニングに限らず、なにか作ったよとか、こんなの面白いよというのがあれば教えてください。最近ラズパイを持て余して困っています。&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category><category term="ハードウェア"></category></entry><entry><title>Parameter Tuning</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/09/parameter_tuning.html" rel="alternate"></link><published>2018-09-09T00:00:00+09:00</published><updated>2018-09-09T00:00:00+09:00</updated><author><name>佐藤</name></author><id>tag:None,2018-09-09:/previews/refs/heads/general/jinja2_version/blog/2018/09/parameter_tuning.html</id><summary type="html">&lt;p&gt;機械学習を行う際に大事なのがパラメーターの調整です。
今まで適当にデフォルトの値でそのままやったりGridearchで探したりしていましたが、結構 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;機械学習を行う際に大事なのがパラメーターの調整です。
今まで適当にデフォルトの値でそのままやったりGridearchで探したりしていましたが、結構時間かかるので他の有効な方法を探して、手元で実際に動かして見ました。以下の資料がわかりやすかったです。(図もこちらのものを引用しました)&lt;/p&gt;
&lt;p&gt;&lt;a href="http://neupy.com/2016/12/17/hyperparameter_optimization_for_neural_networks.html"&gt;http://neupy.com/2016/12/17/hyperparameter_optimization_for_neural_networks.html&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;Bayesian Optimization&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Bayesian Optimization&lt;/strong&gt; はパラメーターを&lt;span class="math"&gt;\(\boldsymbol{x}\)&lt;/span&gt;、評価値(精度とか)を&lt;span class="math"&gt;\(y\)&lt;/span&gt;として
&lt;/p&gt;
&lt;div class="math"&gt;$$
y=f(\boldsymbol{x})
$$&lt;/div&gt;
&lt;p&gt;
という関数を指定します(ブラックボックス関数)。中身は良くわかりませんが、この関数を最適化するパラメーターを見つけたいと思います。そこでBaysian Optimizationはこの関数が&lt;a href="http://www.yasuhisay.info/entry/20091011/1255189429"&gt;ガウス過程&lt;/a&gt;に従うと仮定します。&lt;/p&gt;
&lt;p&gt;下の図ではパラメーターの組み合わせをそれぞれ2,3個とって来て、その評価値を計算して結果をプロットしたグラフです。青い曲線はこの二点から導かれる関数の事後分布で、青い部分はこの分布の95%信頼区間です。&lt;/p&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}images/parameter_tuning_figs/gaussian-process-example.png"&gt;&lt;/p&gt;
&lt;p&gt;このグラフを見ると、観測点から離れた部分は信頼区間の幅が広い(=&lt;span class="math"&gt;\(\sigma\)&lt;/span&gt;が大きい)ことがわかります。&lt;/p&gt;
&lt;h3&gt;獲得関数(Acquisition Function)&lt;/h3&gt;
&lt;p&gt;獲得関数は、次にどこの点を観測するか決める関数です。これにはいろいろな関数がありますが、よく使われるのが  &lt;/p&gt;
&lt;div class="math"&gt;$$
g_\max (x)=\max(0,\ y_{\text{highest expected}}-y_{\max})
$$&lt;/div&gt;
&lt;p&gt;という &lt;strong&gt;Expected Improvement&lt;/strong&gt; [Mockus,1978]であったり、  &lt;/p&gt;
&lt;div class="math"&gt;$$
g_\max (x)=\mu(x)+\sigma(x)
$$&lt;/div&gt;
&lt;p&gt;のような &lt;strong&gt;Mutual Information&lt;/strong&gt; [Contal+2014]がよく使われます。後者は特に直感的にわかりやすいと思うのですが、私たちも次にどの点を選ぶかというときに&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;観測した点から推測して精度が良さそうな点を選びたい(&lt;span class="math"&gt;\(\mu\)&lt;/span&gt;が大きい)  &lt;/li&gt;
&lt;li&gt;まだ観測していない場所から選びたい( &lt;span class="math"&gt;\(\sigma\)&lt;/span&gt; が大きい)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ということを考えて選びそうなものです。よくできてますね。&lt;/p&gt;
&lt;p&gt;&lt;img alt="2" src="{attach}images/parameter_tuning_figs/expected-improvement-example.png"&gt;&lt;/p&gt;
&lt;h3&gt;実装&lt;/h3&gt;
&lt;p&gt;実装には&lt;a href="https://github.com/fmfn/BayesianOptimization"&gt;Bayesian Optimization&lt;/a&gt;を使いました。&lt;/p&gt;
&lt;p&gt;使用するデータはkaggleの&lt;a href="https://www.kaggle.com/c/otto-group-product-classification-challenge#evaluation"&gt;Otto Group Product Classification Challenge&lt;/a&gt;のデータで評価指標はmulti-class loglossです。定番のXGBoostのパラメータを最適化します。installはpipで入ります：&lt;code&gt;pip install bayesian-optimization&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pandas&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;pd&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;xgboost&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;xgb&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sklearn.preprocessing&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;LabelEncoder&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;bayes_opt&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;BayesianOptimization&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;調整したいパラメーターを引数にとる評価関数の指定、クロスバリデーション。bayesian-optimizationには評価関数の最大化のライブラリしかないので、小さい値ほどいいloglossは返り値に-1をかけます。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;xgb_evaluate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;min_child_weight&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;colsample_bytree&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                 &lt;span class="n"&gt;max_depth&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;subsample&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;gamma&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;alpha&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;min_child_weight&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;min_child_weight&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;cosample_bytree&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;max&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;min&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;colsample_bytree&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;max_depth&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;max_depth&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;subsample&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;max&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;min&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;subsample&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;gamma&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;max&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gamma&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;alpha&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;max&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;alpha&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;cv_result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;xgb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cv&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;xgtrain&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;num_boost_round&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;num_rounds&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;nfold&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                       &lt;span class="n"&gt;seed&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;random_state&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                       &lt;span class="n"&gt;callbacks&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;xgb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;early_stop&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;50&lt;/span&gt;&lt;span class="p"&gt;)])&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;cv_result&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;test-mlogloss-mean&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;values&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;いよいよ最適化！&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="vm"&gt;__name__&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;__main__&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;xgtrain&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;prepare_data&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="n"&gt;num_rounds&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;3000&lt;/span&gt;
    &lt;span class="n"&gt;random_state&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;2016&lt;/span&gt;
    &lt;span class="n"&gt;num_iter&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;25&lt;/span&gt;
    &lt;span class="n"&gt;init_points&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt;
    &lt;span class="n"&gt;params&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;eta&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;0.1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
              &lt;span class="s1"&gt;&amp;#39;silent&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
              &lt;span class="s1"&gt;&amp;#39;eval_metric&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;mlogloss&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
              &lt;span class="s1"&gt;&amp;#39;verbose_eval&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
              &lt;span class="s1"&gt;&amp;#39;seed&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;random_state&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
              &lt;span class="s1"&gt;&amp;#39;num_class&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

    &lt;span class="n"&gt;xgbBO&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;BayesianOptimization&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;xgb_evaluate&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                                 &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;min_child_weight&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;20&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                                  &lt;span class="s1"&gt;&amp;#39;colsample_bytree&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mf"&gt;0.1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                                  &lt;span class="s1"&gt;&amp;#39;max_depth&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                                  &lt;span class="s1"&gt;&amp;#39;subsample&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mf"&gt;0.5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                                  &lt;span class="s1"&gt;&amp;#39;gamma&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                                  &lt;span class="s1"&gt;&amp;#39;alpha&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;),})&lt;/span&gt;

    &lt;span class="n"&gt;xgbBO&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;maximize&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;init_points&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;init_points&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;n_iter&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;num_iter&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;結果&lt;/h3&gt;
&lt;p&gt;&lt;img alt="3" src="{attach}images/parameter_tuning_figs/result.png"&gt;
&lt;img alt="4" src="{attach}images/parameter_tuning_figs/result2.png"&gt;&lt;/p&gt;
&lt;p&gt;だいたい15回くらいの試行でloglossが0.46136まで下がりました。やってから気づいたんですが、max_depthとかって整数の値しかとらないですね、、、&lt;/p&gt;
&lt;p&gt;ただし、ベイズ最適化には弱点もいくつかあって、&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;カテゴリー変数の場合にうまくいかない。  &lt;/li&gt;
&lt;li&gt;偶然性に左右されたり、再現性が取れないことがある  &lt;/li&gt;
&lt;li&gt;パラメータが増えてきたら時間かかる&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;みたいなことになるらしいです。&lt;/p&gt;
&lt;h2&gt;Tree-structured Parzen Estimator(TPE)&lt;/h2&gt;
&lt;p&gt;このような弱点を修正したのがTPEという最適化手法です。ベイズとコンセプトは似ていますが、手法は全く異なります。一般的な方法として、まずRandom Searchを用いていくつか点をとってきます。プロットすると下の図のようになりました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="5" src="{attach}images/parameter_tuning_figs/tpe-observation-groups.png"&gt;&lt;/p&gt;
&lt;p&gt;次に精度が良かったもの(図では上位20%)とそうでなかったものに分けます。この2群の尤度関数を求めます。あまり尤度と言っても馴染みのない人が多いと思いますが、サンプリングされたデータは様々な確率分布のうち、どの分布から得られたものとするのが一番尤もらしいかを決めようとするものです。これにより2群の確率分布が出来上がります。&lt;/p&gt;
&lt;p&gt;TPEでもExpected Improvement関数の下のように定義します。精度良かったものを&lt;span class="math"&gt;\(l\)&lt;/span&gt;,そうではなかったものを&lt;span class="math"&gt;\(g\)&lt;/span&gt;として、&lt;/p&gt;
&lt;div class="math"&gt;$$
EI(x)=\frac{l(x)}{g(x)}
$$&lt;/div&gt;
&lt;p&gt;これをそれぞれの観測点に対して適用し、最もEIの値が大きかった場所が次の観測点になります。&lt;/p&gt;
&lt;p&gt;&lt;img alt="6" src="{attach}images/parameter_tuning_figs/tpe-sampled-candidates.png"&gt;
&lt;img alt="7" src="{attach}images/parameter_tuning_figs/tpe-expected-improvement.png"&gt;&lt;/p&gt;
&lt;h3&gt;実装&lt;/h3&gt;
&lt;p&gt;こっちも実装してみます。Pythonではhyperoptというライブラリがあってpipで入ります：&lt;code&gt;pip install hyperopt&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;hyperopt&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;hyperopt&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;hp&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tpe&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Trials&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;fmin&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;最適化するパラメータはbayesian optimizationと同じやつにしてみました。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;hyperopt_parameters&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;min_child_weight&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;hp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;uniform&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;min_child_weight&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;20&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                       &lt;span class="s1"&gt;&amp;#39;colsample_bytree&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;hp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;uniform&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;colsample_bytree&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mf"&gt;0.1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                       &lt;span class="s1"&gt;&amp;#39;max_depth&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;hp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;choice&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;max_depth&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arange&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;
                       &lt;span class="s1"&gt;&amp;#39;subsample&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;hp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;uniform&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;subsample&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mf"&gt;0.5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                       &lt;span class="s1"&gt;&amp;#39;gamma&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;hp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;uniform&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;gamma&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                       &lt;span class="s1"&gt;&amp;#39;alpha&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;hp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;uniform&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;alpha&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;),}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;最適化する関数の指定&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;objective&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;classifier&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;xgb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;XGBClassifier&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;stratifiedkfold&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;StratifiedKFold&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n_splits&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cross_val_score&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;classifier&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;train&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;drop&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;target&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="n"&gt;axis&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;train&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;target&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;cv&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;stratifiedkfold&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;scoring&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;neg_log_loss&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;mean&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;実行！&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;max_evals&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;50&lt;/span&gt;
&lt;span class="n"&gt;trials&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Trials&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="c1"&gt;# 実行結果を格納するインスタンス&lt;/span&gt;

&lt;span class="n"&gt;best&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;fmin&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;objective&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;hyperopt_parameters&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;algo&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tpe&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;suggest&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;max_evals&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;max_evals&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;trials&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;trials&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;verbose&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;結果&lt;/h3&gt;
&lt;p&gt;&lt;img alt="8" src="{attach}images/parameter_tuning_figs/loss.jpg"&gt;
&lt;img alt="9" src="{attach}images/parameter_tuning_figs/best_param.png"&gt;&lt;/p&gt;
&lt;p&gt;logloss最小値は0.4749でした。あれ、bayesian optimizaationより悪い、、、bayesianではmax_depthを整数に限定しなかったからかも、、
でも自分で手動でやった時は0.6とかだったんで、パラメーターチューニングの時にはこれからこれ使っていこうと思います。あとこのxgboost動かすのに8コアCPU使ってそれぞれ半日くらい回しました。GPU使ってたらもうちょい早かったと思うのですが、きちんとbuildとmakeしてもうまくいきませんでした。また挑戦します。&lt;/p&gt;
&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</content><category term="技術ブログ"></category><category term="Machine Learning"></category></entry><entry><title>食べログのWebScraping</title><link href="/previews/refs/heads/general/jinja2_version/blog/2018/09/webscraping.html" rel="alternate"></link><published>2018-09-09T00:00:00+09:00</published><updated>2018-09-09T00:00:00+09:00</updated><author><name>平岡</name></author><id>tag:None,2018-09-09:/previews/refs/heads/general/jinja2_version/blog/2018/09/webscraping.html</id><content type="html">&lt;p&gt;安水さんに教えてもらい、先週からpythonで遊んでいます。食べログをweb scrapingして大阪市のラーメン屋さんの評価点数とコメント数の相関係数と離散分布図を作成しました。&lt;/p&gt;
&lt;p&gt;&lt;img alt="1" src="{attach}images/webscraping_figs/1.jpg"&gt;
&lt;img alt="2" src="{attach}images/webscraping_figs/2.jpg"&gt;
&lt;img alt="3" src="{attach}images/webscraping_figs/3.jpg"&gt;&lt;/p&gt;</content><category term="技術ブログ"></category><category term="Python"></category></entry></feed>